# global [[[
user nobody;
worker_processes 24;
worker_priority -10;
worker_rlimit_nofile 262144;
pid /var/run/nginx.pid;
error_log /var/log/nginx/error_log notice;

events {
	worker_connections 262144;
	debug_connection  102.12.120.31;  # over ethernet
	debug_connection  102.12.85.128;  # over ethernet
	debug_connection  102.10.119.94;  # over ethernet
}
# ]]]
# http [[[
http {
	# common [[[
	# logformats
	log_format  nohost   '$remote_addr - $remote_user [$time_local] '
	                     '"$request" $status $bytes_sent "$http_referer" '
	                     '"$http_user_agent" "$uid_got" "$uid_set" $msec '
	                     # extended #
	                     'sa=$server_addr sp=$server_port '
	                     'hh="$http_host" hs="$scheme"'
	;
	log_format  timed    '$remote_addr - $remote_user [$time_local] '
	                     '"$request" $status $bytes_sent "$http_referer" '
	                     '"$http_user_agent" "$uid_got" "$uid_set" $msec '
	                     # extended #
	                     'rt=$request_time ut="$upstream_response_time" '
	                     'cs=$upstream_cache_status ua="$upstream_addr" us="$upstream_status" '
	                     'sa=$server_addr sp=$server_port '
	                     'hh="$http_host" hs="$scheme"'
	;
	log_format  subtimed '$remote_addr - $remote_user [$time_local] '
	                     '"INC $uri$is_args$args" $status $upstream_http_content_length "$http_referer" '
	                     '"$http_user_agent" "$uid_got" "$uid_set" $msec '
	                     # extended #
	                     'rt=$request_time ut="$upstream_response_time" '
	                     'cs=$upstream_cache_status ua="$upstream_addr" us="$upstream_status" '
	                     'sa=$server_addr sp=$server_port'
	;

	log_format  cookie   '$htcl $http_cookie';
	log_format  timedc   '$remote_addr - $remote_user [$time_local] '
	                     '"$request" $status $bytes_sent "$http_referer" '
	                     '"$http_user_agent" "$uid_got" "$uid_set" $msec '
	                     # extended #
	                     'rt=$request_time ut="$upstream_response_time" '
	                     'cs=$upstream_cache_status ua="$upstream_addr" uh=$uh us="$upstream_status" '
	                     'sa=$server_addr sp=$server_port '
	                     'na="$norm_args" xae=$upstream_http_x_accel_expires'
	;
	log_format  timedp2  '$remote_addr - $remote_user [$time_local] '
	                     '"$request" $status $bytes_sent "$http_referer" '
	                     '"$http_user_agent" "$uid_got" "$uid_set" $msec '
	                     # extended #
	                     'rt=$request_time ut="$upstream_response_time" '
	                     'cs=$upstream_cache_status ua="$upstream_addr" uh=$uh us="$upstream_status" '
	                     'sa=$server_addr sp=$server_port '
	                     'na="$norm_args" xae=$upstream_http_x_accel_expires sp2=$split_p2'
	;
	log_format subtimedc '$remote_addr - $remote_user [$time_local] '
	                     '"INC $uri$is_args$args" $status $upstream_http_content_length "$http_referer" '
	                     '"$http_user_agent" "$uid_got" "$uid_set" $msec '
	                     # extended #
	                     'rt=$request_time ut="$upstream_response_time" '
	                     'cs=$upstream_cache_status ua="$upstream_addr" us="$upstream_status" '
	                     'sa=$server_addr sp=$server_port '
	                     'na="$norm_args"'
	;
	log_format  timeds   '$remote_addr - $remote_user [$time_local] '
	                     '"$request" $status $bytes_sent "$http_referer" '
	                     '"$http_user_agent" "$uid_got" "$uid_set" $msec '
	                     # extended #
	                     'rt=$request_time ut="$upstream_response_time" '
	                     'cs=$upstream_cache_status ua="$upstream_addr" uh=$uh us="$upstream_status" '
	                     'sa=$server_addr sp=$server_port '
	                     'sl5=$split_bbbaaa5 slb=$split_bbbaaa_banner slr=$split_bbbaaa_ranking slm=$split_bbbaaa_mobile '
	                     'slp=$split_bbbaaa_perm uhl="$upstream_http_location" dp="$detected_protocol" '
	                     'cmr="$cookie_LM_REMAIL" wt3="$cookie_wt3_eid" sv="$cookie_sv" ms=$mobile_site '
	                     'dd=$ddos sp2=$split_p2'
	;

	# userid
	userid          log;
	userid_name     lid;
	userid_domain   .bugaga.ru;
	userid_path     /;
	userid_expires  max;
	userid_mark     A;
	userid_p3p      'CP="NON DSP NID ADMa DEVa TAIa PSAa PSDa OUR IND UNI COM NAV"';

	map $uid_got $uid_any  {
		default  $uid_got;
		''       $uid_set;
	}

	access_log /var/log/nginx/access_log nohost;

	# charsets
	include koi-win;
	include koi-utf;
	include win-utf;

	charset_map iso-8859-1 windows-1251 {}

	# mime types
	include mime.types;
	default_type application/octet-stream;

	# hashes
	server_names_hash_bucket_size 128;
	#map_hash_bucket_size 8192;
	#map_hash_max_size 4194304;

	variables_hash_max_size    1024;
	variables_hash_bucket_size  128;

	# client
	client_body_buffer_size   1m;
	client_max_body_size      200m;
	gzip                      on;
	gzip_types                application/javascript
	                          application/json
	                          application/x-javascript
	                          text/css
	                          text/javascript
	                          text/plain
	;
	keepalive_timeout         75 50;
	reset_timedout_connection on;
	send_timeout              2m;
	tcp_nodelay               on;
	tcp_nopush                on;

	# temp paths
	client_body_temp_path /spool/nginx/client;
	fastcgi_temp_path     /spool/nginx/fcgi;
	proxy_temp_path       /spool/nginx/proxy;
	scgi_temp_path        /spool/nginx/scgi;
	uwsgi_temp_path       /spool/nginx/uwsgi;

	# proxy
	proxy_buffer_size           64k;
	proxy_buffers               8 64k;
	proxy_connect_timeout       2s;
	proxy_read_timeout          10m;
	proxy_redirect              off;
	proxy_send_timeout          2s;
	proxy_temp_file_write_size  64k;
	### proxy-set-headers begin ###
	proxy_set_header  Host                  $host;
	proxy_set_header  X-Real-IP             $remote_addr;
	proxy_set_header  X-Forwarded-For       $remote_addr;
	proxy_set_header  X-Forwarded-Host      $host;
	proxy_set_header  X-Forwarded-Port      $server_port;
	proxy_set_header  X-Forwarded-Protocol  $scheme;
	### proxy-set-headers end ###

	proxy_next_upstream         error;

	# proxy cache
	proxy_cache_valid 10m;
	proxy_cache_use_stale error timeout
	                      invalid_header
	                      http_500
	                      http_502
	                      http_503
	                      http_504
	                      updating
	;

	# resolver
	resolver         127.0.0.1;
	resolver_timeout 10s;

	# ssi
	ssi_value_length 4k;

	# conditional GET
	#if_modified_since before;

	# ssl
	ssl_protocols TLSv1 TLSv1.1 TLSv1.2;

	# maps [[[
	map $http_user_agent $search_bot {
		~http://bsalsasas\.com/ 0;
		~http:// 1;
		default 0;
	}
	geo $geo_office {
		default    0;
		10.0.0.0/8 1;
	}
	geo $external_trusted {
		default            0;

		# Don't redirect internal services!
		#10.0.0.0/8         1;

		# WTF?!
		13.20.243.144/28  1;
		13.240.158.202    1;
		8.198.7.44        1;
	    7.230.55.75       1;
		2.113.99.57       1;

		# WTF?!
		76.74.15.206      1;
		78.140.146.135    1;
		8.208.58.13       1;
		8.208.58.26       1;
		8.208.58.89       1;
	}


	###########################
	# proxying https over http
	###########################
	map $http_x_forwarded_protocol $detected_protocol {
		''      $scheme;
		default $http_x_forwarded_protocol;
	}

	###################
	# mobile detecting
	###################
	map $arg_sv $mobile_cookie  {
		mob     'sv=mob; domain=.bbbaaa.ru; path=/; expires=Wed, 01-Apr-15 00:00:00 GMT';
		dsk     'sv=dsk; domain=.bbbaaa.ru; path=/; expires=Wed, 01-Apr-15 00:00:00 GMT';
		rst     'sv=; domain=.bbbaaa.ru; path=/; expires=Sun, 09-Sep-12 00:00:00 GMT';
		default '';
	}
	map $arg_sv $mobile_cookie_by  {
		mob     'sv=mob; domain=.bbbaaa.by; path=/; expires=Wed, 01-Apr-15 00:00:00 GMT';
		dsk     'sv=dsk; domain=.bbbaaa.by; path=/; expires=Wed, 01-Apr-15 00:00:00 GMT';
		rst     'sv=; domain=.bbbaaa.by; path=/; expires=Sun, 09-Sep-12 00:00:00 GMT';
		default '';
	}
	map $arg_sv $mobile_cookie_kz  {
		mob     'sv=mob; domain=.bbbaaa.kz; path=/; expires=Wed, 01-Apr-15 00:00:00 GMT';
		dsk     'sv=dsk; domain=.bbbaaa.kz; path=/; expires=Wed, 01-Apr-15 00:00:00 GMT';
		rst     'sv=; domain=.bbbaaa.kz; path=/; expires=Sun, 09-Sep-12 00:00:00 GMT';
		default '';
	}
	map $arg_sv $mobile_cookie_ua  {
		mob     'sv=mob; domain=.bbbaaa.ua; path=/; expires=Wed, 01-Apr-15 00:00:00 GMT';
		dsk     'sv=dsk; domain=.bbbaaa.ua; path=/; expires=Wed, 01-Apr-15 00:00:00 GMT';
		rst     'sv=; domain=.bbbaaa.ua; path=/; expires=Sun, 09-Sep-12 00:00:00 GMT';
		default '';
	}
	map $arg_sv $mobile_site {
		''      $mobile_site1;
		default 0;
	}
	map $detected_protocol $mobile_site1 {
		http    $mobile_site2;
		default 0;
	}
	map $search_bot $mobile_site2 {
		1 0;
		default $mobile_site3;
	}
	map $uri $mobile_site3 {
		~^/apps/     0;
		~^/overlays/ 0;
		~^/static/   0;
		default      $mobile_site4;
	}
	map $cookie_sv $mobile_site4 {
		mob     1;
		dsk     2;
		default $mobile_site5;
	}
	map $http_user_agent $mobile_site5 {
		~(iPhone|iPod) 1;
		~(Android\s3\.|Pad|pad|Tab|GT-P5100|GT-P7500|GT-P5110|GT-P7300|GT-P6200|GT-P6800|GT-P1000|GT-P3110|GT-P7510|GT-P7310|GT-P6210|GT-P7501|GT-P3100|GT-N8010|TF201|G100W|GT-N8000|GT-P6200|A211|TF201|A101|A100|SGPT13|chagall|XOOM|Xoom|IdeaPad|GT-P1010|SGPT211|GT-P7100|GT-P5113|GT-P3113|Cat\sNova|P9516|GT-P6200L|SGH-T859|tab|tablet|picasso|A701|A510|A210|A700|Mediapad|Kindle|ThinkPad|Vangogh|K1|PMP5080CPRO|TF101|M2|80\sG9|TF700T|A501|A500|TF300T|A511|S7-301w|A200|Nexus\s7|Opera(?!\sMobi)) 0;
		~(Android|app\.samsung|BlackBerry|BB10) 1;
		default 2;
	}
	map $host $ddos {
		default 0;
	}
	map $host $split_dir {
		default                none;
		site-beta-bs.bbbaaa.ru beta;
		site-beta-bs.bbbaaa.ua beta;
		site-beta-bs.bbbaaa.kz beta;
		www.bbbaaa.by          site-by;
		head.bbbaaa.by         site-by;
		tail.bbbaaa.by         tail-by;
		m-site-beta.bbbaaa.by  beta-by;
		site-beta.bbbaaa.by    beta-by;
		m.bbbaaa.by            m-by;
		tail-m.bbbaaa.by       tail-m-by;
		head.bbbaaa.kz         site-kz;
		www.bbbaaa.kz          site-kz;
		tail.bbbaaa.kz         tail-kz;
		site-beta.bbbaaa.kz    beta-kz;
		m.bbbaaa.kz            m-kz;
		tail-m.bbbaaa.kz       tail-m-kz;
		www.bbbaaa.ru          site;
		head.bbbaaa.ru         site;
		tail.bbbaaa.ru         tail;
		m-site-beta.bbbaaa.ru  beta;
		site-beta.bbbaaa.ru    beta;
		m.bbbaaa.ru            m;
		tail-m.bbbaaa.ru       tail-m;
		www.bbbaaa.ua          site-ua;
		head.bbbaaa.ua         site-ua;
		tail.bbbaaa.ua         tail-ua;
		m-site-beta.bbbaaa.ua  beta-ua;
		site-beta.bbbaaa.ua    beta-ua;
		m.bbbaaa.ua            m-ua;
		tail-m.bbbaaa.ua       tail-m-ua;
	}

	####################
	# SEO redirect
	####################
	map $search_bot $ui2086 {
		1       $ui2086_0;
		default 0;
	}
	map $uri $ui2086_0 {
		~^/b/   $ui2086_1;
		~^/c/   $ui2086_1;
		~^/p/   $ui2086_1;
		default 0;
	}
	map $args $ui2086_1 {
		''      0;
		default 1;
	}

	####################
	# R&D voodoo magic
	####################

	# SITE-585
	map "${search_bot}:${arg_rdr585}:${split_bbbaaa5}:${uri}" $site585 {
		~^0::([1-9]|10):/landing/tv_camp_main/    0;
		~^0::([1-9]|10):/landing/tv_camp_main1/   /landing/tv_camp_main/;
		~^0::(1[1-9]|20):/landing/tv_camp_main/   /landing/tv_camp_main1/;
		~^0::(1[1-9]|20):/landing/tv_camp_main1/  0;
		default                                   0;
	}
#	map $http_referer $is_landing_sale {
#		~^https?://(\w+\.)?bbbaaa.ru/landing/sale 0;
#		default 1;
#	}

	###############################
	# Splits override from cookies
	###############################
	map $cookie_split_bbbaaa5 $split_bbbaaa5 {
		''      $split_bbbaaa5_raw;
		default $cookie_split_bbbaaa5;
	}
	map $cookie_split_bbbaaa_banner $split_bbbaaa_banner {
		''      $split_bbbaaa_banner_raw;
		default $cookie_split_bbbaaa_banner;
	}
	map $cookie_split_bbbaaa_mobile $split_bbbaaa_mobile {
		''      $split_bbbaaa_mobile_raw;
		default $cookie_split_bbbaaa_mobile;
	}
	map $cookie_split_bbbaaa_perm $split_bbbaaa_perm {
		''      $split_bbbaaa_perm_raw;
		default $cookie_split_bbbaaa_perm;
	}
	map $cookie_split_bbbaaa_ranking $split_bbbaaa_ranking {
		''      $split_bbbaaa_ranking_raw;
		default $cookie_split_bbbaaa_ranking;
	}

	###############################
	# Splits override from args
	###############################
	map $arg_split_p2 $split_p2 {
		''      $split_p2_raw;
		default $arg_split_p2;
	}

	# ]]]
	# splits [[[
split_clients  "${uid_any}ABE"  $split_bbbaaa5_raw {
	5%   1;
	5%   2;
	5%   3;
	5%   4;
	5%   5;
	5%   6;
	5%   7;
	5%   8;
	5%   9;
	5%  10;
	5%  11;
	5%  12;
	5%  13;
	5%  14;
	5%  15;
	5%  16;
	5%  17;
	5%  18;
	5%  19;
	*   20;
}
split_clients  "${uid_any}ABF"  $split_bbbaaa_banner_raw {
	5%   1;
	5%   2;
	5%   3;
	5%   4;
	5%   5;
	5%   6;
	5%   7;
	5%   8;
	5%   9;
	5%  10;
	5%  11;
	5%  12;
	5%  13;
	5%  14;
	5%  15;
	5%  16;
	5%  17;
	5%  18;
	5%  19;
	*   20;
}
split_clients  "${uid_any}AC9"  $split_bbbaaa_mobile_raw {
	20%   1;
	20%   2;
	20%   3;
	20%   4;
	*     5;
}
split_clients  "${uid_any}AB4"  $split_bbbaaa_perm_raw {
	5%   1;
	5%   2;
	5%   3;
	5%   4;
	5%   5;
	5%   6;
	5%   7;
	5%   8;
	5%   9;
	5%  10;
	5%  11;
	5%  12;
	5%  13;
	5%  14;
	5%  15;
	5%  16;
	5%  17;
	5%  18;
	5%  19;
	*   20;
}
split_clients  "${uid_any}AC8"  $split_bbbaaa_ranking_raw {
	5%   1;
	5%   2;
	5%   3;
	5%   4;
	5%   5;
	5%   6;
	5%   7;
	5%   8;
	5%   9;
	5%  10;
	5%  11;
	5%  12;
	5%  13;
	5%  14;
	5%  15;
	5%  16;
	5%  17;
	5%  18;
	5%  19;
	*   20;
}
split_clients  "${uid_any}AC7"  $split_p2_raw {
	*     0;
}
	# ]]]
	# limits [[[
	# ]]]
	# real_ip [[[
	# myracloud
	set_real_ip_from 31.7.176.0/24;
	set_real_ip_from 31.7.184.0/24;
	set_real_ip_from 80.255.12.96/27;
	set_real_ip_from 82.199.130.0/27;
	set_real_ip_from 91.201.214.218;
	set_real_ip_from 93.190.71.0/25;
	set_real_ip_from 109.75.179.0/24;
	set_real_ip_from 109.234.104.192/27;
	set_real_ip_from 141.105.64.0/28;
	set_real_ip_from 158.255.7.192/27;
	set_real_ip_from 178.89.156.96/28;
	set_real_ip_from 195.210.46.68;
	set_real_ip_from 31.130.201.64/27;
	# ngenix
	set_real_ip_from 185.17.168.0/22;
	set_real_ip_from 212.193.144.0/21;
	set_real_ip_from 213.186.120.15/32;
	set_real_ip_from 37.220.160.0/21;
	set_real_ip_from 46.235.184.0/21;
	set_real_ip_from 78.41.104.0/21;
	set_real_ip_from 79.126.122.86/32;
	set_real_ip_from 93.93.88.0/21;
	# qrator
	set_real_ip_from 64.48.224.8;
	set_real_ip_from 64.48.224.9;
	set_real_ip_from 64.48.224.10;
	set_real_ip_from 64.48.224.11;
	set_real_ip_from 66.110.32.128;
	set_real_ip_from 66.110.32.129;
	set_real_ip_from 66.110.32.130;
	set_real_ip_from 66.110.32.131;
	set_real_ip_from 87.245.197.192;
	set_real_ip_from 87.245.197.193;
	set_real_ip_from 87.245.197.194;
	set_real_ip_from 87.245.197.195;
	set_real_ip_from 87.245.197.196;
	set_real_ip_from 134.90.144.224;
	set_real_ip_from 134.90.144.225;
	set_real_ip_from 134.90.144.226;
	set_real_ip_from 134.90.144.227;
	set_real_ip_from 83.234.15.112;
	set_real_ip_from 83.234.15.113;
	set_real_ip_from 83.234.15.114;
	set_real_ip_from 83.234.15.115;
	set_real_ip_from 83.234.15.116;
	set_real_ip_from 128.177.119.64;
	set_real_ip_from 128.177.119.65;
	set_real_ip_from 128.177.119.66;
	set_real_ip_from 128.177.119.67;
	set_real_ip_from 178.248.232.128/28;
	set_real_ip_from 178.248.233.128/28;
	set_real_ip_from 178.248.234.128/28;
	set_real_ip_from 178.248.235.128/28;
	set_real_ip_from 178.248.236.128/28;
	set_real_ip_from 178.248.237.128/28;
	set_real_ip_from 178.248.239.128/28;
	# ]]]
	# perl [[[
		perl_set $uhex 'sub { sprintf "%010X", shift->variable("uniq") }';
	perl_set $udec 'sub { sprintf "%013u", shift->variable("uniq") }';
	perl_set $uniq 'sub { int rand 0xFFFFFFFFFF }';
	perl_set $htcl 'sub { length( shift->variable("http_cookie") // "") }';
	perl_set $uh   'sub { my ( $r )=@_;
	                      ( $r->variable("upstream_http_cache_control") ? "C" : "c" ) .
	                      ( $r->variable("upstream_http_expires")       ? "E" : "e" ) .
	                      ( $r->variable("upstream_http_set_cookie")    ? "S" : "s" )
	}';
	perl_set $uid_val 'sub { (split "=",shift->variable("uid_any"))[1] }';
	perl_set $md5body 'sub { use Digest::MD5 qw(md5_hex); md5_hex shift->variable("request_body") }';
	perl_set $mtime     'sub { ( stat shift->filename )[ 9 ] }';
	perl_set $mtime1123 'sub { use POSIX qw(strftime); strftime "%a, %d %b %Y %H:%M:%S GMT", gmtime( ( stat shift->filename )[ 9 ] ) }';

	# geo variables
	perl_set $geo_id       'sub { ( split /:/,shift->variable("geo") )[0] }';
	perl_set $country_id   'sub { ( split /:/,shift->variable("geo") )[1] }';
	perl_set $country_name 'sub { ( split /:/,shift->variable("geo") )[2] }';
	perl_set $region_id    'sub { ( split /:/,shift->variable("geo") )[3] }';
	perl_set $region_name  'sub { ( split /:/,shift->variable("geo") )[4] }';
	perl_set $city_id      'sub { ( split /:/,shift->variable("geo") )[5] }';
	perl_set $city_name    'sub { ( split /:/,shift->variable("geo") )[6] }';

	perl_set $norm_args 'sub {
		join "&", sort grep { $_ } grep { !/^(?:actionpay|dclid|dp|ef_id|gclid|rec_[^=]+|sitelink|utm_[^=]+|wt_[^=]+|yclid)=/ } split /&/, shift->args;
	}';
	# ]]]
# geo [[[
	geo $geo {
		ranges;
		default 0:0::0::0:;
		include geo/geo.conf;
	}
# ]]]
	# ]]]
	# cache zones [[[
	proxy_cache_path /spool/nginx/cache/apigw
			  levels=1:2
			  keys_zone=apigw:64m
			  inactive=10m
			  max_size=2g
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/catalog
			  levels=1:2
			  keys_zone=catalog:64m
			  inactive=1h
			  max_size=16g
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/catalog-by
			  levels=1:2
			  keys_zone=catalog-by:16m
			  inactive=1h
			  max_size=4g
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/catalog-kz
			  levels=1:2
			  keys_zone=catalog-kz:16m
			  inactive=1h
			  max_size=4g
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/catalog-ua
			  levels=1:2
			  keys_zone=catalog-ua:16m
			  inactive=1h
			  max_size=4g
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/m-catalog
			  levels=1:2
			  keys_zone=m-catalog:16m
			  inactive=1h
			  max_size=2g
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/m-catalog-kz
			  levels=1:2
			  keys_zone=m-catalog-kz:16m
			  inactive=1h
			  max_size=1g
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/m-catalog-ua
			  levels=1:2
			  keys_zone=m-catalog-ua:16m
			  inactive=1h
			  max_size=1g
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/m-pages
			  levels=1:2
			  keys_zone=m-pages:1m
			  inactive=3h
			  max_size=16m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/m-pages-kz
			  levels=1:2
			  keys_zone=m-pages-kz:1m
			  inactive=3h
			  max_size=16m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/m-pages-ua
			  levels=1:2
			  keys_zone=m-pages-ua:1m
			  inactive=3h
			  max_size=16m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/m-product
			  levels=1:2
			  keys_zone=m-product:16m
			  inactive=2h
			  max_size=2g
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/m-product-kz
			  levels=1:2
			  keys_zone=m-product-kz:16m
			  inactive=2h
			  max_size=1g
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/m-product-ua
			  levels=1:2
			  keys_zone=m-product-ua:16m
			  inactive=2h
			  max_size=1g
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/m-ssi-recommend
			  levels=1:2
			  keys_zone=m-ssi-recommend:16m
			  inactive=5m
			  max_size=64m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/m-ssi-recommend-kz
			  levels=1:2
			  keys_zone=m-ssi-recommend-kz:16m
			  inactive=5m
			  max_size=32m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/m-ssi-recommend-ua
			  levels=1:2
			  keys_zone=m-ssi-recommend-ua:16m
			  inactive=5m
			  max_size=32m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/m-ssi-sizes
			  levels=1:2
			  keys_zone=m-ssi-sizes:16m
			  inactive=1m
			  max_size=64m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/m-ssi-sizes-kz
			  levels=1:2
			  keys_zone=m-ssi-sizes-kz:16m
			  inactive=1m
			  max_size=32m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/m-ssi-sizes-ua
			  levels=1:2
			  keys_zone=m-ssi-sizes-ua:16m
			  inactive=1m
			  max_size=32m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/m-suggest
			  levels=1:2
			  keys_zone=m-suggest:16m
			  inactive=1d
			  max_size=64m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/m-suggest-kz
			  levels=1:2
			  keys_zone=m-suggest-kz:16m
			  inactive=1d
			  max_size=32m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/m-suggest-ua
			  levels=1:2
			  keys_zone=m-suggest-ua:16m
			  inactive=1d
			  max_size=32m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/mixed
			  levels=1:2
			  keys_zone=mixed:1m
			  inactive=1h
			  max_size=64m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/pages
			  levels=1:2
			  keys_zone=pages:1m
			  inactive=3h
			  max_size=128m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/pages-by
			  levels=1:2
			  keys_zone=pages-by:1m
			  inactive=3h
			  max_size=64m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/pages-kz
			  levels=1:2
			  keys_zone=pages-kz:1m
			  inactive=3h
			  max_size=64m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/pages-ua
			  levels=1:2
			  keys_zone=pages-ua:1m
			  inactive=3h
			  max_size=64m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/product
			  levels=1:2
			  keys_zone=product:16m
			  inactive=6h
			  max_size=12g
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/product-by
			  levels=1:2
			  keys_zone=product-by:16m
			  inactive=6h
			  max_size=4g
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/product-kz
			  levels=1:2
			  keys_zone=product-kz:16m
			  inactive=6h
			  max_size=4g
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/product-ua
			  levels=1:2
			  keys_zone=product-ua:16m
			  inactive=6h
			  max_size=4g
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/quick
			  levels=1:2
			  keys_zone=quick:16m
			  inactive=6h
			  max_size=1g
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/quick-by
			  levels=1:2
			  keys_zone=quick-by:16m
			  inactive=6h
			  max_size=512m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/quick-kz
			  levels=1:2
			  keys_zone=quick-kz:16m
			  inactive=6h
			  max_size=512m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/quick-ua
			  levels=1:2
			  keys_zone=quick-ua:16m
			  inactive=6h
			  max_size=512m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/ssi-menu
			  levels=1:2
			  keys_zone=ssi-menu:4m
			  inactive=1d
			  max_size=256m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/ssi-menu-by
			  levels=1:2
			  keys_zone=ssi-menu-by:4m
			  inactive=1d
			  max_size=256m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/ssi-menu-kz
			  levels=1:2
			  keys_zone=ssi-menu-kz:4m
			  inactive=1d
			  max_size=256m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/ssi-menu-ua
			  levels=1:2
			  keys_zone=ssi-menu-ua:4m
			  inactive=1d
			  max_size=256m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/ssi-recommend
			  levels=1:2
			  keys_zone=ssi-recommend:16m
			  inactive=5m
			  max_size=256m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/ssi-recommend-by
			  levels=1:2
			  keys_zone=ssi-recommend-by:16m
			  inactive=5m
			  max_size=128m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/ssi-recommend-kz
			  levels=1:2
			  keys_zone=ssi-recommend-kz:16m
			  inactive=5m
			  max_size=128m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/ssi-recommend-ua
			  levels=1:2
			  keys_zone=ssi-recommend-ua:16m
			  inactive=5m
			  max_size=128m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/ssi-sizes
			  levels=1:2
			  keys_zone=ssi-sizes:32m
			  inactive=1m
			  max_size=256m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/ssi-sizes-by
			  levels=1:2
			  keys_zone=ssi-sizes-by:32m
			  inactive=1m
			  max_size=128m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/ssi-sizes-kz
			  levels=1:2
			  keys_zone=ssi-sizes-kz:32m
			  inactive=1m
			  max_size=128m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/ssi-sizes-ua
			  levels=1:2
			  keys_zone=ssi-sizes-ua:32m
			  inactive=1m
			  max_size=128m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/suggest
			  levels=1:2
			  keys_zone=suggest:16m
			  inactive=1d
			  max_size=128m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/suggest-by
			  levels=1:2
			  keys_zone=suggest-by:16m
			  inactive=1d
			  max_size=64m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/suggest-kz
			  levels=1:2
			  keys_zone=suggest-kz:16m
			  inactive=1d
			  max_size=64m
			  loader_files=10000
			  loader_threshold=1s
	;
	proxy_cache_path /spool/nginx/cache/suggest-ua
			  levels=1:2
			  keys_zone=suggest-ua:16m
			  inactive=1d
			  max_size=64m
			  loader_files=10000
			  loader_threshold=1s
	;
	# ]]]
	# upstreams [[[

	# [[[ addr_head
	upstream addr_head_upstream {
		server back101.addr.local max_fails=3 fail_timeout=10s;
		server back102.addr.local max_fails=3 fail_timeout=10s;
		server back103.addr.local max_fails=3 fail_timeout=10s;
		server back104.addr.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ addr_tail
	upstream addr_tail_upstream {
		server back01.addr.local max_fails=3 fail_timeout=10s;
		server back02.addr.local max_fails=3 fail_timeout=10s;
		server back03.addr.local max_fails=3 fail_timeout=10s;
		server back04.addr.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ adm_bs_head
	upstream adm_bs_head_upstream {
		server back101.adm.bs.local:8080 max_fails=3 fail_timeout=10s;
		server back109.adm.bs.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ adm_bs_tail
	upstream adm_bs_tail_upstream {
		server back01.adm.bs.local:8080 max_fails=3 fail_timeout=10s;
		server back09.adm.bs.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ adm_bs_beta
	upstream adm_bs_beta_upstream {
		server back.adm.bs.beta.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ analytics_head
	upstream analytics_head_upstream {
		server web01.analytics.local:3000 max_fails=3 fail_timeout=10s;
		server web09.analytics.local:3000 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ analytics_media_head
	upstream analytics_media_head_upstream {
		server web01.analytics.local max_fails=3 fail_timeout=10s;
		server web09.analytics.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ analytics_tail
	upstream analytics_tail_upstream {
		server web101.analytics.local:3000 max_fails=3 fail_timeout=10s;
		server web109.analytics.local:3000 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ analytics_media_tail
	upstream analytics_media_tail_upstream {
		server web101.analytics.local max_fails=3 fail_timeout=10s;
		server web109.analytics.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ apigw_beta
	upstream apigw_beta_upstream {
		server back.apigw.beta.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ apigw_head
	upstream apigw_head_upstream {
		server back101.apigw.local:8080 max_fails=3 fail_timeout=10s;
		server back102.apigw.local:8080 max_fails=3 fail_timeout=10s;
		server back103.apigw.local:8080 max_fails=3 fail_timeout=10s;
		server back104.apigw.local:8080 max_fails=3 fail_timeout=10s;
		server back105.apigw.local:8080 max_fails=3 fail_timeout=10s;
		server back106.apigw.local:8080 max_fails=3 fail_timeout=10s;
		server back107.apigw.local:8080 max_fails=3 fail_timeout=10s;
		server back108.apigw.local:8080 max_fails=3 fail_timeout=10s;
		server back109.apigw.local:8080 max_fails=3 fail_timeout=10s;
		server back110.apigw.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ apigw_tail
	upstream apigw_tail_upstream {
		server back01.apigw.local:8080 max_fails=3 fail_timeout=10s;
		server back02.apigw.local:8080 max_fails=3 fail_timeout=10s;
		server back03.apigw.local:8080 max_fails=3 fail_timeout=10s;
		server back04.apigw.local:8080 max_fails=3 fail_timeout=10s;
		server back05.apigw.local:8080 max_fails=3 fail_timeout=10s;
		server back06.apigw.local:8080 max_fails=3 fail_timeout=10s;
		server back07.apigw.local:8080 max_fails=3 fail_timeout=10s;
		server back08.apigw.local:8080 max_fails=3 fail_timeout=10s;
		server back09.apigw.local:8080 max_fails=3 fail_timeout=10s;
		server back10.apigw.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ apigw_by_head
	upstream apigw_by_head_upstream {
		server back101.apigw.by.local:8080 max_fails=3 fail_timeout=10s;
		server back102.apigw.by.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ apigw_by_tail
	upstream apigw_by_tail_upstream {
		server back01.apigw.by.local:8080 max_fails=3 fail_timeout=10s;
		server back02.apigw.by.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ apigw_kz_head
	upstream apigw_kz_head_upstream {
		server back01.apigw.kz.local:8080 max_fails=3 fail_timeout=10s;
		server back02.apigw.kz.local:8080 max_fails=3 fail_timeout=10s;
		server back03.apigw.kz.local:8080 max_fails=3 fail_timeout=10s;
		server back04.apigw.kz.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ apigw_kz_tail
	upstream apigw_kz_tail_upstream {
		server back101.apigw.kz.local:8080 max_fails=3 fail_timeout=10s;
		server back102.apigw.kz.local:8080 max_fails=3 fail_timeout=10s;
		server back103.apigw.kz.local:8080 max_fails=3 fail_timeout=10s;
		server back104.apigw.kz.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ apigw_ua_head
	upstream apigw_ua_head_upstream {
		server back05.apigw.ua.local:8080 max_fails=3 fail_timeout=10s;
		server back06.apigw.ua.local:8080 max_fails=3 fail_timeout=10s;
		server back07.apigw.ua.local:8080 max_fails=3 fail_timeout=10s;
		server back08.apigw.ua.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ apigw_ua_tail
	upstream apigw_ua_tail_upstream {
		server back105.apigw.ua.local:8080 max_fails=3 fail_timeout=10s;
		server back106.apigw.ua.local:8080 max_fails=3 fail_timeout=10s;
		server back107.apigw.ua.local:8080 max_fails=3 fail_timeout=10s;
		server back108.apigw.ua.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ apisearch_beta
	upstream apisearch_beta_upstream {
		server back.apisearch.beta.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ apisearch_head
	upstream apisearch_head_upstream {
		server back105.apisearch.local:8080 max_fails=3 fail_timeout=10s;
		server back106.apisearch.local:8080 max_fails=3 fail_timeout=10s;
		server back107.apisearch.local:8080 max_fails=3 fail_timeout=10s;
		server back108.apisearch.local:8080 max_fails=3 fail_timeout=10s;
		server back109.apisearch.local:8080 max_fails=3 fail_timeout=10s;
		server back110.apisearch.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ apisearch_tail
	upstream apisearch_tail_upstream {
		server back05.apisearch.local:8080 max_fails=3 fail_timeout=10s;
		server back06.apisearch.local:8080 max_fails=3 fail_timeout=10s;
		server back07.apisearch.local:8080 max_fails=3 fail_timeout=10s;
		server back08.apisearch.local:8080 max_fails=3 fail_timeout=10s;
		server back09.apisearch.local:8080 max_fails=3 fail_timeout=10s;
		server back10.apisearch.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ apisearch_by_head
	upstream apisearch_by_head_upstream {
		server back103.apisearch.by.local:8080 max_fails=3 fail_timeout=10s;
		server back104.apisearch.by.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ apisearch_by_tail
	upstream apisearch_by_tail_upstream {
		server back03.apisearch.by.local:8080 max_fails=3 fail_timeout=10s;
		server back04.apisearch.by.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ apisearch_kz_beta
	upstream apisearch_kz_beta_upstream {
		server back.apisearch.kz.beta.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ apisearch_kz_head
	upstream apisearch_kz_head_upstream {
		server back101.apisearch.kz.local:8080 max_fails=3 fail_timeout=10s;
		server back102.apisearch.kz.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ apisearch_kz_tail
	upstream apisearch_kz_tail_upstream {
		server back01.apisearch.kz.local:8080 max_fails=3 fail_timeout=10s;
		server back02.apisearch.kz.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ apisearch_ua_beta
	upstream apisearch_ua_beta_upstream {
		server back.apisearch.ua.beta.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ apisearch_ua_head
	upstream apisearch_ua_head_upstream {
		server back03.apisearch.ua.local:8080 max_fails=3 fail_timeout=10s;
		server back04.apisearch.ua.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ apisearch_ua_tail
	upstream apisearch_ua_tail_upstream {
		server back103.apisearch.ua.local:8080 max_fails=3 fail_timeout=10s;
		server back104.apisearch.ua.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ bob_head
	upstream bob_head_upstream {
		server back01.bob.local max_fails=3 fail_timeout=10s;
		server back02.bob.local max_fails=3 fail_timeout=10s;
		server back03.bob.local max_fails=3 fail_timeout=10s;
		server back04.bob.local max_fails=3 fail_timeout=10s;
		server back05.bob.local max_fails=3 fail_timeout=10s;
		server back06.bob.local max_fails=3 fail_timeout=10s;
		server back07.bob.local max_fails=3 fail_timeout=10s;
		server back08.bob.local max_fails=3 fail_timeout=10s;
		server back09.bob.local max_fails=3 fail_timeout=10s;
		server back10.bob.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ bob_tail
	upstream bob_tail_upstream {
		server back101.bob.local max_fails=3 fail_timeout=10s;
		server back102.bob.local max_fails=3 fail_timeout=10s;
		server back103.bob.local max_fails=3 fail_timeout=10s;
		server back104.bob.local max_fails=3 fail_timeout=10s;
		server back105.bob.local max_fails=3 fail_timeout=10s;
		server back106.bob.local max_fails=3 fail_timeout=10s;
		server back107.bob.local max_fails=3 fail_timeout=10s;
		server back108.bob.local max_fails=3 fail_timeout=10s;
		server back109.bob.local max_fails=3 fail_timeout=10s;
		server back110.bob.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ bob_by_head
	upstream bob_by_head_upstream {
		server back105.bob.by.local max_fails=3 fail_timeout=10s;
		server back106.bob.by.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ bob_by_tail
	upstream bob_by_tail_upstream {
		server back05.bob.by.local max_fails=3 fail_timeout=10s;
		server back06.bob.by.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ bob_ru_beta
	upstream bob_ru_beta_upstream {
		server back.bob.ru.beta.local  max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ bob_kz_head
	upstream bob_kz_head_upstream {
		server back105.bob.kz.local max_fails=3 fail_timeout=10s;
		server back106.bob.kz.local max_fails=3 fail_timeout=10s;
		server back107.bob.kz.local max_fails=3 fail_timeout=10s;
		server back108.bob.kz.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ bob_kz_tail
	upstream bob_kz_tail_upstream {
		server back05.bob.kz.local max_fails=3 fail_timeout=10s;
		server back06.bob.kz.local max_fails=3 fail_timeout=10s;
		server back07.bob.kz.local max_fails=3 fail_timeout=10s;
		server back08.bob.kz.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ bob_ua_head
	upstream bob_ua_head_upstream {
		server back101.bob.ua.local max_fails=3 fail_timeout=10s;
		server back102.bob.ua.local max_fails=3 fail_timeout=10s;
		server back103.bob.ua.local max_fails=3 fail_timeout=10s;
		server back104.bob.ua.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ bob_ua_tail
	upstream bob_ua_tail_upstream {
		server back01.bob.ua.local max_fails=3 fail_timeout=10s;
		server back02.bob.ua.local max_fails=3 fail_timeout=10s;
		server back03.bob.ua.local max_fails=3 fail_timeout=10s;
		server back04.bob.ua.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ bs_head
	upstream bs_head_upstream {
		server back01.bs.local:8080 max_fails=0;
		server back09.bs.local:8080 max_fails=0;
	}
	# ]]]
	# [[[ bs_tail
	upstream bs_tail_upstream {
		server back101.bs.local:8080 max_fails=0;
		server back109.bs.local:8080 max_fails=0;
	}
	# ]]]
	# [[[ bs_beta
	upstream bs_beta_upstream {
		server back.bs.beta.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
# [[[ citizen_head
upstream citizen_head_upstream {
	server back101.citizen.local max_fails=3 fail_timeout=10s;
	server back109.citizen.local max_fails=3 fail_timeout=10s;
}
# ]]]
# [[[ citizen_tail
upstream citizen_tail_upstream {
	server back01.citizen.local max_fails=3 fail_timeout=10s;
	server back09.citizen.local max_fails=3 fail_timeout=10s;
}
# ]]]
	# [[[ corp_head
	upstream corp_head_upstream {
		server back103.corp.local:3001 max_fails=3 fail_timeout=10s;
		server back104.corp.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ corp_media_head
	upstream corp_media_head_upstream {
		server back103.corp.local max_fails=3 fail_timeout=10s;
		server back104.corp.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ corp_tail
	upstream corp_tail_upstream {
		server back03.corp.local:3001 max_fails=3 fail_timeout=10s;
		server back04.corp.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ corp_media_tail
	upstream corp_media_tail_upstream {
		server back03.corp.local max_fails=3 fail_timeout=10s;
		server back04.corp.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ content_head
	upstream content_head_upstream {
		server back01.content.local max_fails=3 fail_timeout=10s;
		server back02.content.local max_fails=3 fail_timeout=10s backup;
	}
	# ]]]
	# [[[ content_tail
	upstream content_tail_upstream {
		server back101.content.local max_fails=3 fail_timeout=10s;
		server back102.content.local max_fails=3 fail_timeout=10s backup;
	}
	# ]]]
	# [[[ converter_head
	upstream converter_head_upstream {
		server back105.converter.local max_fails=3 fail_timeout=10s;
		server back106.converter.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ converter_tail
	upstream converter_tail_upstream {
		server back05.converter.local max_fails=3 fail_timeout=10s;
		server back06.converter.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ converter_beta
	upstream converter_beta_upstream {
		server back.converter.beta.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ converter_b2b_beta
	upstream converter_b2b_beta_upstream {
		server beta.b2b.converter.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ converter_uat_beta
	upstream converter_uat_beta_upstream {
		server back.uat.converter.beta.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ curr_head
	upstream curr_head_upstream {
		server back101.curr.local max_fails=3 fail_timeout=10s;
		server back102.curr.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ curr_tail
	upstream curr_tail_upstream {
		server back01.curr.local max_fails=3 fail_timeout=10s;
		server back02.curr.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ customer_head
	upstream customer_head_upstream {
		server back01.customer.local max_fails=3 fail_timeout=10s;
		server back02.customer.local max_fails=3 fail_timeout=10s;
		server back03.customer.local max_fails=3 fail_timeout=10s;
		server back04.customer.local max_fails=3 fail_timeout=10s;
		server back05.customer.local max_fails=3 fail_timeout=10s;
		server back06.customer.local max_fails=3 fail_timeout=10s;
		server back07.customer.local max_fails=3 fail_timeout=10s;
		server back08.customer.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ customer_tail
	upstream customer_tail_upstream {
		server back101.customer.local max_fails=3 fail_timeout=10s;
		server back102.customer.local max_fails=3 fail_timeout=10s;
		server back103.customer.local max_fails=3 fail_timeout=10s;
		server back104.customer.local max_fails=3 fail_timeout=10s;
		server back105.customer.local max_fails=3 fail_timeout=10s;
		server back106.customer.local max_fails=3 fail_timeout=10s;
		server back107.customer.local max_fails=3 fail_timeout=10s;
		server back108.customer.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ customer_beta
	upstream customer_beta_upstream {
		server back.customer.beta.local:8080 max_fails=3 fail_timeout=10s;
	}
	upstream customer_beta_static_upstream {
		server back.customer.beta.local:80 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ delivery_head
	upstream delivery_head_upstream {
		server back101.delivery.local max_fails=3 fail_timeout=10s;
		server back102.delivery.local max_fails=3 fail_timeout=10s;
		server back103.delivery.local max_fails=3 fail_timeout=10s;
		server back104.delivery.local max_fails=3 fail_timeout=10s;
		server back105.delivery.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ delivery_tail
	upstream delivery_tail_upstream {
		server back01.delivery.local max_fails=3 fail_timeout=10s;
		server back02.delivery.local max_fails=3 fail_timeout=10s;
		server back03.delivery.local max_fails=3 fail_timeout=10s;
		server back04.delivery.local max_fails=3 fail_timeout=10s;
		server back05.delivery.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ delivery_by_head
	upstream delivery_by_head_upstream {
		server back05.delivery.by.local max_fails=3 fail_timeout=10s;
		server back06.delivery.by.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ delivery_by_tail
	upstream delivery_by_tail_upstream {
		server back105.delivery.by.local max_fails=3 fail_timeout=10s;
		server back106.delivery.by.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ delivery_kz_head
	upstream delivery_kz_head_upstream {
		server back05.delivery.kz.local max_fails=3 fail_timeout=10s;
		server back06.delivery.kz.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ delivery_kz_tail
	upstream delivery_kz_tail_upstream {
		server back105.delivery.kz.local max_fails=3 fail_timeout=10s;
		server back106.delivery.kz.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ delivery_ua_head
	upstream delivery_ua_head_upstream {
		server back07.delivery.ua.local max_fails=3 fail_timeout=10s;
		server back08.delivery.ua.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ delivery_ua_tail
	upstream delivery_ua_tail_upstream {
		server back107.delivery.ua.local max_fails=3 fail_timeout=10s;
		server back108.delivery.ua.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ expconfig_head
	upstream expconfig_head_upstream {
		server web01.expconfig.local:3000 max_fails=3 fail_timeout=10s;
		server web09.expconfig.local:3000 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ expconfig_media_head
	upstream expconfig_media_head_upstream {
		server web01.expconfig.local max_fails=3 fail_timeout=10s;
		server web09.expconfig.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ expconfig_tail
	upstream expconfig_tail_upstream {
		server web101.expconfig.local:3000 max_fails=3 fail_timeout=10s;
		server web109.expconfig.local:3000 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ expconfig_media_tail
	upstream expconfig_media_tail_upstream {
		server web101.expconfig.local max_fails=3 fail_timeout=10s;
		server web109.expconfig.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ express_master_head
	upstream express_master_head_upstream {
		server back01.express.master.local max_fails=3 fail_timeout=10s;
		server back02.express.master.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ express_master_tail
	upstream express_master_tail_upstream {
		server back101.express.master.local max_fails=3 fail_timeout=10s;
		server back102.express.master.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ gazel
	upstream gazel_upstream {
		server gazel.jail.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ gazel_static
	upstream gazel_static_upstream {
		server gazel.jail.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ madmin_beta
	upstream madmin_beta_upstream {
		server back.madmin.beta.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ madmin_beta_static
	upstream madmin_beta_static_upstream {
		server back.madmin.beta.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ madmin_head
	upstream madmin_head_upstream {
		server back01.madmin.local:8080 max_fails=3 fail_timeout=10s;
		server back02.madmin.local:8080 max_fails=3 fail_timeout=10s;
		server back03.madmin.local:8080 max_fails=3 fail_timeout=10s;
		server back04.madmin.local:8080 max_fails=3 fail_timeout=10s;
		server back05.madmin.local:8080 max_fails=3 fail_timeout=10s;
		server back06.madmin.local:8080 max_fails=3 fail_timeout=10s;
		server back07.madmin.local:8080 max_fails=3 fail_timeout=10s;
		server back08.madmin.local:8080 max_fails=3 fail_timeout=10s;
		server back09.madmin.local:8080 max_fails=3 fail_timeout=10s;
		server back10.madmin.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ madmin_media_head
	upstream madmin_media_head_upstream {
		server back01.madmin.local max_fails=3 fail_timeout=10s;
		server back02.madmin.local max_fails=3 fail_timeout=10s;
		server back03.madmin.local max_fails=3 fail_timeout=10s;
		server back04.madmin.local max_fails=3 fail_timeout=10s;
		server back05.madmin.local max_fails=3 fail_timeout=10s;
		server back06.madmin.local max_fails=3 fail_timeout=10s;
		server back07.madmin.local max_fails=3 fail_timeout=10s;
		server back08.madmin.local max_fails=3 fail_timeout=10s;
		server back09.madmin.local max_fails=3 fail_timeout=10s;
		server back10.madmin.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ madmin_tail
	upstream madmin_tail_upstream {
		server back101.madmin.local:8080 max_fails=3 fail_timeout=10s;
		server back102.madmin.local:8080 max_fails=3 fail_timeout=10s;
		server back103.madmin.local:8080 max_fails=3 fail_timeout=10s;
		server back104.madmin.local:8080 max_fails=3 fail_timeout=10s;
		server back105.madmin.local:8080 max_fails=3 fail_timeout=10s;
		server back106.madmin.local:8080 max_fails=3 fail_timeout=10s;
		server back107.madmin.local:8080 max_fails=3 fail_timeout=10s;
		server back108.madmin.local:8080 max_fails=3 fail_timeout=10s;
		server back109.madmin.local:8080 max_fails=3 fail_timeout=10s;
		server back110.madmin.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ madmin_media_tail
	upstream madmin_media_tail_upstream {
		server back101.madmin.local max_fails=3 fail_timeout=10s;
		server back102.madmin.local max_fails=3 fail_timeout=10s;
		server back103.madmin.local max_fails=3 fail_timeout=10s;
		server back104.madmin.local max_fails=3 fail_timeout=10s;
		server back105.madmin.local max_fails=3 fail_timeout=10s;
		server back106.madmin.local max_fails=3 fail_timeout=10s;
		server back107.madmin.local max_fails=3 fail_timeout=10s;
		server back108.madmin.local max_fails=3 fail_timeout=10s;
		server back109.madmin.local max_fails=3 fail_timeout=10s;
		server back110.madmin.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ madmin_by_head
	upstream madmin_by_head_upstream {
		server back07.madmin.by.local:8080 max_fails=3 fail_timeout=10s;
		server back08.madmin.by.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ madmin_by_media_head
	upstream madmin_by_media_head_upstream {
		server back07.madmin.by.local max_fails=3 fail_timeout=10s;
		server back08.madmin.by.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ madmin_by_tail
	upstream madmin_by_tail_upstream {
		server back107.madmin.by.local:8080 max_fails=3 fail_timeout=10s;
		server back108.madmin.by.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ madmin_by_media_tail
	upstream madmin_by_media_tail_upstream {
		server back107.madmin.by.local max_fails=3 fail_timeout=10s;
		server back108.madmin.by.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ madmin_kz_head
	upstream madmin_kz_head_upstream {
		server back05.madmin.kz.local:8080 max_fails=3 fail_timeout=10s;
		server back06.madmin.kz.local:8080 max_fails=3 fail_timeout=10s;
		server back07.madmin.kz.local:8080 max_fails=3 fail_timeout=10s;
		server back08.madmin.kz.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ madmin_kz_media_head
	upstream madmin_kz_media_head_upstream {
		server back05.madmin.kz.local max_fails=3 fail_timeout=10s;
		server back06.madmin.kz.local max_fails=3 fail_timeout=10s;
		server back07.madmin.kz.local max_fails=3 fail_timeout=10s;
		server back08.madmin.kz.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ madmin_kz_tail
	upstream madmin_kz_tail_upstream {
		server back105.madmin.kz.local:8080 max_fails=3 fail_timeout=10s;
		server back106.madmin.kz.local:8080 max_fails=3 fail_timeout=10s;
		server back107.madmin.kz.local:8080 max_fails=3 fail_timeout=10s;
		server back108.madmin.kz.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ madmin_kz_media_tail
	upstream madmin_kz_media_tail_upstream {
		server back105.madmin.kz.local max_fails=3 fail_timeout=10s;
		server back106.madmin.kz.local max_fails=3 fail_timeout=10s;
		server back107.madmin.kz.local max_fails=3 fail_timeout=10s;
		server back108.madmin.kz.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ madmin_ua_head
	upstream madmin_ua_head_upstream {
		server back01.madmin.ua.local:8080 max_fails=3 fail_timeout=10s;
		server back02.madmin.ua.local:8080 max_fails=3 fail_timeout=10s;
		server back03.madmin.ua.local:8080 max_fails=3 fail_timeout=10s;
		server back04.madmin.ua.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ madmin_ua_media_head
	upstream madmin_ua_media_head_upstream {
		server back01.madmin.ua.local max_fails=3 fail_timeout=10s;
		server back02.madmin.ua.local max_fails=3 fail_timeout=10s;
		server back03.madmin.ua.local max_fails=3 fail_timeout=10s;
		server back04.madmin.ua.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ madmin_ua_tail
	upstream madmin_ua_tail_upstream {
		server back101.madmin.ua.local:8080 max_fails=3 fail_timeout=10s;
		server back102.madmin.ua.local:8080 max_fails=3 fail_timeout=10s;
		server back103.madmin.ua.local:8080 max_fails=3 fail_timeout=10s;
		server back104.madmin.ua.local:8080 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ madmin_ua_media_tail
	upstream madmin_ua_media_tail_upstream {
		server back101.madmin.ua.local max_fails=3 fail_timeout=10s;
		server back102.madmin.ua.local max_fails=3 fail_timeout=10s;
		server back103.madmin.ua.local max_fails=3 fail_timeout=10s;
		server back104.madmin.ua.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ prism_head
	upstream prism_head_upstream {
		server web101.prism.local:3001 max_fails=3 fail_timeout=10s;
		server web109.prism.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ prism_tail
	upstream prism_tail_upstream {
		server web01.prism.local:3001 max_fails=3 fail_timeout=10s;
		server web09.prism.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ rec_head
	upstream rec_head_upstream {
		server web101.rec.local:3001 max_fails=3 fail_timeout=10s;
		server web109.rec.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ rec_tail
	upstream rec_tail_upstream {
		server web01.rec.local:3001 max_fails=3 fail_timeout=10s;
		server web09.rec.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ rec_by_head
	upstream rec_by_head_upstream {
		server web01.rec.by.local:3001 max_fails=3 fail_timeout=10s;
		server web09.rec.by.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ rec_by_tail
	upstream rec_by_tail_upstream {
		server web101.rec.by.local:3001 max_fails=3 fail_timeout=10s;
		server web109.rec.by.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ rec_kz_head
	upstream rec_kz_head_upstream {
		server web101.rec.kz.local:3001 max_fails=3 fail_timeout=10s;
		server web109.rec.kz.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ rec_kz_tail
	upstream rec_kz_tail_upstream {
		server web01.rec.kz.local:3001 max_fails=3 fail_timeout=10s;
		server web09.rec.kz.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ rec_ua_head
	upstream rec_ua_head_upstream {
		server web01.rec.ua.local:3001 max_fails=3 fail_timeout=10s;
		server web09.rec.ua.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ rec_ua_tail
	upstream rec_ua_tail_upstream {
		server web101.rec.ua.local:3001 max_fails=3 fail_timeout=10s;
		server web109.rec.ua.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ site_beta
	upstream site_beta_upstream {
		server back.site.beta.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ site_beta_static
	upstream site_beta_static_upstream {
		server back.site.beta.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ site_beta_bs
	upstream site_beta_bs_upstream {
		server back.site.bs.beta.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ site_beta_bs_static
	upstream site_beta_bs_static_upstream {
		server back.site.bs.beta.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ site_kz_beta
	upstream site_kz_beta_upstream {
		server back.site.kz.beta.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ site_kz_beta_static
	upstream site_kz_beta_static_upstream {
		server back.site.kz.beta.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ site_ua_beta
	upstream site_ua_beta_upstream {
		server back.site.ua.beta.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ site_ua_beta_static
	upstream site_ua_beta_static_upstream {
		server back.site.ua.beta.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ site_head
	upstream site_head_upstream {
		server back101.site.local:3001 max_fails=3 fail_timeout=10s;
		server back102.site.local:3001 max_fails=3 fail_timeout=10s;
		server back103.site.local:3001 max_fails=3 fail_timeout=10s;
		server back104.site.local:3001 max_fails=3 fail_timeout=10s;
		server back105.site.local:3001 max_fails=3 fail_timeout=10s;
		server back106.site.local:3001 max_fails=3 fail_timeout=10s;
		server back107.site.local:3001 max_fails=3 fail_timeout=10s;
		server back108.site.local:3001 max_fails=3 fail_timeout=10s;
		server back109.site.local:3001 max_fails=3 fail_timeout=10s;
		server back110.site.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ site_head_static
	upstream site_head_static_upstream {
		server back101.site.local max_fails=3 fail_timeout=10s;
		server back102.site.local max_fails=3 fail_timeout=10s;
		server back103.site.local max_fails=3 fail_timeout=10s;
		server back104.site.local max_fails=3 fail_timeout=10s;
		server back105.site.local max_fails=3 fail_timeout=10s;
		server back106.site.local max_fails=3 fail_timeout=10s;
		server back107.site.local max_fails=3 fail_timeout=10s;
		server back108.site.local max_fails=3 fail_timeout=10s;
		server back109.site.local max_fails=3 fail_timeout=10s;
		server back110.site.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ site_tail
	upstream site_tail_upstream {
		server back01.site.local:3001 max_fails=3 fail_timeout=10s;
		server back02.site.local:3001 max_fails=3 fail_timeout=10s;
		server back03.site.local:3001 max_fails=3 fail_timeout=10s;
		server back04.site.local:3001 max_fails=3 fail_timeout=10s;
		server back05.site.local:3001 max_fails=3 fail_timeout=10s;
		server back06.site.local:3001 max_fails=3 fail_timeout=10s;
		server back07.site.local:3001 max_fails=3 fail_timeout=10s;
		server back08.site.local:3001 max_fails=3 fail_timeout=10s;
		server back09.site.local:3001 max_fails=3 fail_timeout=10s;
		server back10.site.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ site_tail_static
	upstream site_tail_static_upstream {
		server back01.site.local max_fails=3 fail_timeout=10s;
		server back02.site.local max_fails=3 fail_timeout=10s;
		server back03.site.local max_fails=3 fail_timeout=10s;
		server back04.site.local max_fails=3 fail_timeout=10s;
		server back05.site.local max_fails=3 fail_timeout=10s;
		server back06.site.local max_fails=3 fail_timeout=10s;
		server back07.site.local max_fails=3 fail_timeout=10s;
		server back08.site.local max_fails=3 fail_timeout=10s;
		server back09.site.local max_fails=3 fail_timeout=10s;
		server back10.site.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ site_by_head
	upstream site_by_head_upstream {
		server back107.site.by.local:3001 max_fails=3 fail_timeout=10s;
		server back108.site.by.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ site_by_head_static
	upstream site_by_head_static_upstream {
		server back107.site.by.local max_fails=3 fail_timeout=10s;
		server back108.site.by.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ site_by_tail
	upstream site_by_tail_upstream {
		server back07.site.by.local:3001 max_fails=3 fail_timeout=10s;
		server back08.site.by.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ site_by_tail_static
	upstream site_by_tail_static_upstream {
		server back07.site.by.local max_fails=3 fail_timeout=10s;
		server back08.site.by.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ site_kz_head
	upstream site_kz_head_upstream {
		server back105.site.kz.local:3001 max_fails=3 fail_timeout=10s;
		server back106.site.kz.local:3001 max_fails=3 fail_timeout=10s;
		server back107.site.kz.local:3001 max_fails=3 fail_timeout=10s;
		server back108.site.kz.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ site_kz_head_static
	upstream site_kz_head_static_upstream {
		server back105.site.kz.local max_fails=3 fail_timeout=10s;
		server back106.site.kz.local max_fails=3 fail_timeout=10s;
		server back107.site.kz.local max_fails=3 fail_timeout=10s;
		server back108.site.kz.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ site_kz_tail
	upstream site_kz_tail_upstream {
		server back05.site.kz.local:3001 max_fails=3 fail_timeout=10s;
		server back06.site.kz.local:3001 max_fails=3 fail_timeout=10s;
		server back07.site.kz.local:3001 max_fails=3 fail_timeout=10s;
		server back08.site.kz.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ site_kz_tail_static
	upstream site_kz_tail_static_upstream {
		server back05.site.kz.local max_fails=3 fail_timeout=10s;
		server back06.site.kz.local max_fails=3 fail_timeout=10s;
		server back07.site.kz.local max_fails=3 fail_timeout=10s;
		server back08.site.kz.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ site_ua_head
	upstream site_ua_head_upstream {
		server back01.site.ua.local:3001 max_fails=3 fail_timeout=10s;
		server back02.site.ua.local:3001 max_fails=3 fail_timeout=10s;
		server back03.site.ua.local:3001 max_fails=3 fail_timeout=10s;
		server back04.site.ua.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ site_ua_head_static
	upstream site_ua_head_static_upstream {
		server back01.site.ua.local max_fails=3 fail_timeout=10s;
		server back02.site.ua.local max_fails=3 fail_timeout=10s;
		server back03.site.ua.local max_fails=3 fail_timeout=10s;
		server back04.site.ua.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ site_ua_tail
	upstream site_ua_tail_upstream {
		server back101.site.ua.local:3001 max_fails=3 fail_timeout=10s;
		server back102.site.ua.local:3001 max_fails=3 fail_timeout=10s;
		server back103.site.ua.local:3001 max_fails=3 fail_timeout=10s;
		server back104.site.ua.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ site_ua_tail_static
	upstream site_ua_tail_static_upstream {
		server back101.site.ua.local max_fails=3 fail_timeout=10s;
		server back102.site.ua.local max_fails=3 fail_timeout=10s;
		server back103.site.ua.local max_fails=3 fail_timeout=10s;
		server back104.site.ua.local max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ sort_head
	upstream sort_head_upstream {
		server web101.sort.local:3001 max_fails=100 fail_timeout=10s;
		server web109.sort.local:3001 max_fails=100 fail_timeout=10s;
	}
	# ]]]
	# [[[ sort_tail
	upstream sort_tail_upstream {
		server web01.sort.local:3001 max_fails=3 fail_timeout=10s;
		server web09.sort.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ sort_beta
	upstream sort_beta_upstream {
		server web.sort.beta.local:3001 max_fails=3 fail_timeout=10s;
	}
	# ]]]
	# [[[ uakari_redis
	upstream uakari_redis_upstream {
		server ha.moda.local:6401;
		keepalive 32;
	}
	# ]]]
	# [[[ z_analytics
	upstream z_analytics_upstream {
		server back01.analytics.local max_fails=100 fail_timeout=10s;
		keepalive 32;
	}
	# ]]]
	# [[[ z_prism
	upstream z_prism_upstream {
		server back.prism.local max_fails=100 fail_timeout=10s;
		keepalive 32;
	}
	# ]]]
	# ]]]
	# default servers [[[
	server {
		listen      80 default;
		listen 127.0.0.1:80; # localhost
		listen 10.233.32.96:80; # primary
		listen 31.13.33.66:80; # secondary
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		listen 10.233.32.243:80; # carp243
		listen 10.233.32.244:80; # carp244
		listen 10.233.32.245:80; # carp245
		listen 10.233.32.246:80; # carp246
		listen 10.233.32.251:80; # carp251
		listen 10.233.32.252:80; # carp252
		listen 31.13.33.70:80; # carp70
		listen 31.13.33.71:80; # carp71
		listen 31.13.33.72:80; # carp72
		listen 31.13.33.73:80; # carp73
		listen 31.13.33.74:80; # carp74
		listen 31.13.33.75:80; # carp75
		listen 31.13.33.78:80; # carp78
		listen 31.13.33.79:80; # carp79
		server_name localhost;
		deny        all;

		location /cf/ {
			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
	
			alias /usr/local/etc/nginx/;
			autoindex  on;
			types  { }
			default_type  text/plain;
			location /cf/passwd/ {
				return 403;
			}
			location /cf/ssl/ {
				return 403;
			}
		}
		location = /mathopd.dmp {
			allow 127.0.0.1;
			deny  all;
			stub_status on;
		}

	}

	server {
		listen 31.13.33.70:443 ssl default;
		listen 31.13.33.71:443 ssl default;
		listen 10.233.32.219:443 ssl default;
		listen 10.233.32.220:443 ssl default;
		server_name localhost;
		deny        all;
		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ru.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ru.key;
	}
	server {
		listen 31.13.33.72:443 ssl default;
		listen 31.13.33.73:443 ssl default;
		listen 10.233.32.243:443 ssl default;
		listen 10.233.32.244:443 ssl default;
		server_name localhost;
		deny        all;
		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.kz.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.kz.key;
	}
	server {
		listen 31.13.33.74:443 ssl default;
		listen 31.13.33.75:443 ssl default;
		listen 10.233.32.245:443 ssl default;
		listen 10.233.32.246:443 ssl default;
		server_name localhost;
		deny        all;
		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ua.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ua.key;
	}
	server {
		listen 31.13.33.78:443 ssl default;
		listen 31.13.33.79:443 ssl default;
		listen 10.233.32.251:443 ssl default;
		listen 10.233.32.252:443 ssl default;
		server_name localhost;
		deny        all;
		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.by.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.by.key;
	}
	# ]]]
	# virtual servers [[[

	# addr [[[
	server { # addr.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name addr.local;
		access_log /var/log/nginx/addr.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://addr_head_upstream;
		}
		location = /favicon.ico {
			return 404;
		}
	} # ]]]
	server { # tail.addr.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name tail.addr.local;
		access_log /var/log/nginx/addr.tail.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.addr.local
        - host: back02.addr.local
        - host: back03.addr.local
        - host: back04.addr.local
        - host: back05.addr.local
          halt: true
        - host: back06.addr.local
          halt: true
        - host: back07.addr.local
          halt: true
        - host: back08.addr.local
          halt: true
        - host: back09.addr.local
          halt: true
        - host: back10.addr.local
          halt: true
    lolek:
        - host: back101.addr.local
        - host: back102.addr.local
        - host: back103.addr.local
        - host: back104.addr.local
        - host: back105.addr.local
          halt: true
        - host: back106.addr.local
          halt: true
        - host: back107.addr.local
          halt: true
        - host: back108.addr.local
          halt: true
        - host: back109.addr.local
          halt: true
        - host: back110.addr.local
          halt: true
head: lolek
super: super.back.addr.local
tail: bolek
';}

		location / {
			proxy_pass http://addr_tail_upstream;
		}
		location = /favicon.ico {
			return 404;
		}
	} # ]]]
	# end addr ]]]
	# apigw [[[
	server { # apigw.bbbaaa.ru [[[
		listen 31.13.33.70:80; # carp70
		listen 31.13.33.71:80; # carp71
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		listen 31.13.33.70:443 ssl;
		listen 31.13.33.71:443 ssl;
		listen 10.233.32.219:443 ssl;
		listen 10.233.32.220:443 ssl;
		server_name apigw.bbbaaa.ru;
		access_log /var/log/nginx/apigw.json.access_log timed;

		userid_service 1029;
		userid         on;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ru.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ru.key;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		rewrite_by_lua '
			local sl5 = ngx.var.split_bbbaaa5 or "-"
			local slr = ngx.var.split_bbbaaa_ranking or "-"
			local slm = ngx.var.split_bbbaaa_mobile or "-"
			local fn = "/data/expconfig/apigw/" .. sl5 .. "/" .. slr .. "/" .. slm

			local fh = io.open( fn )
			if fh then
				for line in fh:lines() do
					k,v = line:match("^([^: ]+): *(.*)")
					if k and v ~= "" then
						ngx.req.set_header( "X-" .. k,v )
					end
				end
				fh:close()
			end
		';

		location / {
			return 403;
		}
		location /json/ {
			proxy_pass http://apigw_head_upstream;
		}
		location /json/get_category_product_recommendations {
			proxy_cache         apigw;
			proxy_cache_key     $detected_protocol://apigw_upstream/json/get_category_product_recommendations?m5=$md5body;
			proxy_cache_methods POST;
			proxy_cache_valid   30m;
			proxy_pass http://apigw_head_upstream;
		}
		location /json/get_products_by_multifilter {
			proxy_cache         apigw;
			proxy_cache_key     $detected_protocol://apigw_upstream/get_products_by_multifilter?m5=$md5body;
			proxy_cache_methods POST;
			proxy_cache_valid   30m;
			proxy_pass http://apigw_head_upstream;
		}
		location /json/get_subcategories_by_path {
			proxy_cache         apigw;
			proxy_cache_key     $detected_protocol://apigw_upstream/get_subcategories_by_path?m5=$md5body;
			proxy_cache_methods POST;
			proxy_cache_valid   10m;
			proxy_pass http://apigw_head_upstream;
		}
		location /json/get_product_product_recommendations {
			proxy_cache         apigw;
			proxy_cache_key     $detected_protocol://apigw_upstream/json/get_product_product_recommendations?m5=$md5body;
			proxy_cache_methods POST;
			proxy_cache_valid   30m;
			proxy_pass http://apigw_head_upstream;
		}
		location /json/get_topsellers {
			proxy_cache         apigw;
			proxy_cache_key     $detected_protocol://apigw_upstream/json/get_topsellers?m5=$md5body;
			proxy_cache_methods POST;
			proxy_cache_valid   30m;
			proxy_pass http://apigw_head_upstream;
		}
		location = /lid {
			return 204;
		}
	} # ]]]
	server { # apigw.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name apigw.local;
		access_log /var/log/nginx/apigw.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = / {
			proxy_pass http://apigw_head_upstream;
		}
		location / {
			satisfy any;

			auth_basic "apigw";
			auth_basic_user_file passwd/apigw;

			allow 10.10.37.120;  # callcenter
			allow 10.233.0.0/20;
			allow 10.233.32.0/24;
			allow 10.10.44.0/24;
			deny  all;

			proxy_pass http://apigw_head_upstream;
		}
	} # ]]]
	server { # tail.apigw.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name tail.apigw.local;
		access_log /var/log/nginx/apigw.tail.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.apigw.local
        - host: back02.apigw.local
        - host: back03.apigw.local
        - host: back04.apigw.local
        - host: back05.apigw.local
        - host: back06.apigw.local
        - host: back07.apigw.local
        - host: back08.apigw.local
        - host: back09.apigw.local
        - host: back10.apigw.local
    lolek:
        - host: back101.apigw.local
        - host: back102.apigw.local
        - host: back103.apigw.local
        - host: back104.apigw.local
        - host: back105.apigw.local
        - host: back106.apigw.local
        - host: back107.apigw.local
        - host: back108.apigw.local
        - host: back109.apigw.local
        - host: back110.apigw.local
head: lolek
super: super.back.apigw.local
tail: bolek
';}

		location = / {
			proxy_pass http://apigw_tail_upstream;
		}
		location / {
			satisfy any;

			auth_basic "apigw";
			auth_basic_user_file passwd/apigw;

			allow 10.10.37.120;  # callcenter
			allow 10.233.0.0/20;
			allow 10.233.32.0/24;
			allow 10.10.44.0/24;
			deny  all;

			proxy_pass http://apigw_tail_upstream;

			location /json/ {
				rewrite_by_lua '
					local sl5 = ngx.var.split_bbbaaa5 or "-"
					local slr = ngx.var.split_bbbaaa_ranking or "-"
					local slm = ngx.var.split_bbbaaa_mobile or "-"
					local fn = "/data/expconfig/apigw-tail/" .. sl5 .. "/" .. slr .. "/" .. slm

					local fh = io.open( fn )
					if fh then
						for line in fh:lines() do
							k,v = line:match("^([^: ]+): *(.*)")
							if k and v ~= "" then
								ngx.req.set_header( "X-" .. k,v )
							end
						end
						fh:close()
					end
				';
				proxy_pass http://apigw_tail_upstream;
			}
		}
	} # ]]]
	server { # apigw.by.local [[[
		listen 10.233.32.251:80; # carp251
		listen 10.233.32.252:80; # carp252
		server_name apigw.by.local;
		access_log /var/log/nginx/apigw.by.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = / {
			proxy_pass http://apigw_by_head_upstream;
		}
		location / {
			satisfy any;

			auth_basic "apigw";
			auth_basic_user_file passwd/apigw;

			allow 10.10.37.120;  # callcenter
			allow 10.233.0.0/20;
			allow 10.233.32.0/24;
			allow 10.10.44.0/24;
			deny  all;

			proxy_pass http://apigw_by_head_upstream;
		}
	} # ]]]
	server { # tail.apigw.by.local [[[
		listen 10.233.32.251:80; # carp251
		listen 10.233.32.252:80; # carp252
		server_name tail.apigw.by.local;
		access_log /var/log/nginx/apigw.by.tail.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.apigw.by.local
        - host: back02.apigw.by.local
    lolek:
        - host: back101.apigw.by.local
        - host: back102.apigw.by.local
head: lolek
super: super.back.apigw.by.local
tail: bolek
';}

		location = / {
			proxy_pass http://apigw_by_tail_upstream;
		}
		location / {
			satisfy any;

			auth_basic "apigw";
			auth_basic_user_file passwd/apigw;

			allow 10.10.37.120;  # callcenter
			allow 10.233.0.0/20;
			allow 10.233.32.0/24;
			allow 10.10.44.0/24;
			deny  all;

			proxy_pass http://apigw_by_tail_upstream;
		}
	} # ]]]
	server { # apigw.bbbaaa.kz [[[
		listen 31.13.33.72:80; # carp72
		listen 31.13.33.73:80; # carp73
		listen 10.233.32.243:80; # carp243
		listen 10.233.32.244:80; # carp244
		listen 31.13.33.72:443 ssl;
		listen 31.13.33.73:443 ssl;
		listen 10.233.32.243:443 ssl;
		listen 10.233.32.244:443 ssl;
		server_name apigw.bbbaaa.kz;
		access_log /var/log/nginx/apigw.kz.json.access_log timed;

		userid_domain  .bbbaaa.kz;
		userid_service 1030;
		userid         on;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.kz.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.kz.key;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			return 403;
		}
		location /json/ {
			proxy_pass http://apigw_kz_head_upstream;
		}
		location = /lid {
			return 204;
		}
	} # ]]]
	server { # apigw.kz.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name apigw.kz.local;
		access_log /var/log/nginx/apigw.kz.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = / {
			proxy_pass http://apigw_kz_head_upstream;
		}
		location / {
			satisfy any;

			auth_basic "apigw";
			auth_basic_user_file passwd/apigw;

			allow 10.10.37.120;  # callcenter
			allow 10.233.0.0/20;
			allow 10.233.32.0/24;
			allow 10.10.44.0/24;
			deny  all;

			proxy_pass http://apigw_kz_head_upstream;
		}
	} # ]]]
	server { # tail.apigw.kz.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name tail.apigw.kz.local;
		access_log /var/log/nginx/apigw.kz.tail.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.apigw.kz.local
        - host: back02.apigw.kz.local
        - host: back03.apigw.kz.local
        - host: back04.apigw.kz.local
        - host: back05.apigw.kz.local
          halt: true
        - host: back06.apigw.kz.local
          halt: true
        - host: back07.apigw.kz.local
          halt: true
        - host: back08.apigw.kz.local
          halt: true
        - host: back09.apigw.kz.local
          halt: true
        - host: back10.apigw.kz.local
          halt: true
    lolek:
        - host: back101.apigw.kz.local
        - host: back102.apigw.kz.local
        - host: back103.apigw.kz.local
        - host: back104.apigw.kz.local
        - host: back105.apigw.kz.local
          halt: true
        - host: back106.apigw.kz.local
          halt: true
        - host: back107.apigw.kz.local
          halt: true
        - host: back108.apigw.kz.local
          halt: true
        - host: back109.apigw.kz.local
          halt: true
        - host: back110.apigw.kz.local
          halt: true
head: bolek
super: super.back.apigw.kz.local
tail: lolek
';}

		location = / {
			proxy_pass http://apigw_kz_tail_upstream;
		}
		location / {
			satisfy any;

			auth_basic "apigw";
			auth_basic_user_file passwd/apigw;

			allow 10.10.37.120;  # callcenter
			allow 10.233.0.0/20;
			allow 10.233.32.0/24;
			allow 10.10.44.0/24;
			deny  all;

			proxy_pass http://apigw_kz_tail_upstream;
		}
	} # ]]]
	server { # apigw.bbbaaa.ua [[[
		listen 31.13.33.74:80; # carp74
		listen 31.13.33.75:80; # carp75
		listen 10.233.32.245:80; # carp245
		listen 10.233.32.246:80; # carp246
		listen 31.13.33.74:443 ssl;
		listen 31.13.33.75:443 ssl;
		listen 10.233.32.245:443 ssl;
		listen 10.233.32.246:443 ssl;
		server_name apigw.bbbaaa.ua;
		access_log /var/log/nginx/apigw.ua.json.access_log timed;

		userid_domain  .bbbaaa.ua;
		userid_service 1026;
		userid         on;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ua.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ua.key;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			return 403;
		}
		location /json/ {
			proxy_pass http://apigw_ua_head_upstream;
		}
		location = /lid {
			return 204;
		}
	} # ]]]
	server { # apigw.ua.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name apigw.ua.local;
		access_log /var/log/nginx/apigw.ua.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = / {
			proxy_pass http://apigw_ua_head_upstream;
		}
		location / {
			satisfy any;

			auth_basic "apigw";
			auth_basic_user_file passwd/apigw;

			allow 10.10.37.120;  # callcenter
			allow 10.233.0.0/20;
			allow 10.233.32.0/24;
			allow 10.10.44.0/24;
			deny  all;

			proxy_pass http://apigw_ua_head_upstream;
		}
	} # ]]]
	server { # tail.apigw.ua.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name tail.apigw.ua.local;
		access_log /var/log/nginx/apigw.ua.tail.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.apigw.ua.local
          halt: true
        - host: back02.apigw.ua.local
          halt: true
        - host: back03.apigw.ua.local
          halt: true
        - host: back04.apigw.ua.local
          halt: true
        - host: back05.apigw.ua.local
        - host: back06.apigw.ua.local
        - host: back07.apigw.ua.local
        - host: back08.apigw.ua.local
        - host: back09.apigw.ua.local
          halt: true
        - host: back10.apigw.ua.local
          halt: true
    lolek:
        - host: back101.apigw.ua.local
          halt: true
        - host: back102.apigw.ua.local
          halt: true
        - host: back103.apigw.ua.local
          halt: true
        - host: back104.apigw.ua.local
          halt: true
        - host: back105.apigw.ua.local
        - host: back106.apigw.ua.local
        - host: back107.apigw.ua.local
        - host: back108.apigw.ua.local
        - host: back109.apigw.ua.local
          halt: true
        - host: back110.apigw.ua.local
          halt: true
head: bolek
super: super.back.apigw.ua.local
tail: lolek
';}

		location = / {
			proxy_pass http://apigw_ua_tail_upstream;
		}
		location / {
			satisfy any;

			auth_basic "apigw";
			auth_basic_user_file passwd/apigw;

			allow 10.10.37.120;  # callcenter
			allow 10.233.0.0/20;
			allow 10.233.32.0/24;
			allow 10.10.44.0/24;
			deny  all;

			proxy_pass http://apigw_ua_tail_upstream;
		}
	} # ]]]
	server { # apigw.beta.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name apigw.beta.local;
		access_log /var/log/nginx/apigw.beta.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://apigw_beta_upstream;

			location /json/ {
				rewrite_by_lua '
					local sl5 = ngx.var.split_bbbaaa5 or "-"
					local slr = ngx.var.split_bbbaaa_ranking or "-"
					local slm = ngx.var.split_bbbaaa_mobile or "-"
					local fn = "/data/expconfig/apigw-beta/" .. sl5 .. "/" .. slr .. "/" .. slm

					local fh = io.open( fn )
					if fh then
						for line in fh:lines() do
							k,v = line:match("^([^: ]+): *(.*)")
							if k and v ~= "" then
								ngx.req.set_header( "X-" .. k,v )
							end
						end
						fh:close()
					end
				';
				proxy_pass http://apigw_beta_upstream;
			}
		}
	} # ]]]
	# end apigw ]]]
	# apisearch [[[
	server { # apisearch.beta.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name apisearch.beta.local;
		access_log /var/log/nginx/apisearch.beta.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://apisearch_beta_upstream;
		}
	} # ]]]
	server { # apisearch.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name apisearch.local;
		access_log /var/log/nginx/apisearch.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://apisearch_head_upstream;
		}
	} # ]]]
	server { # tail.apisearch.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name tail.apisearch.local;
		access_log /var/log/nginx/apisearch.tail.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.apisearch.local
          halt: true
        - host: back02.apisearch.local
          halt: true
        - host: back03.apisearch.local
          halt: true
        - host: back04.apisearch.local
          halt: true
        - host: back05.apisearch.local
        - host: back06.apisearch.local
        - host: back07.apisearch.local
        - host: back08.apisearch.local
        - host: back09.apisearch.local
        - host: back10.apisearch.local
    lolek:
        - host: back101.apisearch.local
          halt: true
        - host: back102.apisearch.local
          halt: true
        - host: back103.apisearch.local
          halt: true
        - host: back104.apisearch.local
          halt: true
        - host: back105.apisearch.local
        - host: back106.apisearch.local
        - host: back107.apisearch.local
        - host: back108.apisearch.local
        - host: back109.apisearch.local
        - host: back110.apisearch.local
head: lolek
super: super.back.apisearch.local
tail: bolek
';}

		location / {
			proxy_pass http://apisearch_tail_upstream;
		}
	} # ]]]
	server { # apisearch.by.local [[[
		listen 10.233.32.251:80; # carp251
		listen 10.233.32.252:80; # carp252
		server_name apisearch.by.local;
		access_log /var/log/nginx/apisearch.by.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://apisearch_by_head_upstream;
		}
	} # ]]]
	server { # tail.apisearch.by.local [[[
		listen 10.233.32.251:80; # carp251
		listen 10.233.32.252:80; # carp252
		server_name tail.apisearch.by.local;
		access_log /var/log/nginx/apisearch.by.tail.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back03.apisearch.by.local
        - host: back04.apisearch.by.local
    lolek:
        - host: back103.apisearch.by.local
        - host: back104.apisearch.by.local
head: lolek
super: super.back.apisearch.by.local
tail: bolek
';}

		location / {
			proxy_pass http://apisearch_by_tail_upstream;
		}
	} # ]]]
	server { # apisearch.kz.beta.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name apisearch.kz.beta.local;
		access_log /var/log/nginx/apisearch.kz.beta.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://apisearch_kz_beta_upstream;
		}
	} # ]]]
	server { # apisearch.kz.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name apisearch.kz.local;
		access_log /var/log/nginx/apisearch.kz.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://apisearch_kz_head_upstream;
		}
	} # ]]]
	server { # tail.apisearch.kz.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name tail.apisearch.kz.local;
		access_log /var/log/nginx/apisearch.kz.tail.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.apisearch.kz.local
        - host: back02.apisearch.kz.local
        - host: back03.apisearch.kz.local
          halt: true
        - host: back04.apisearch.kz.local
          halt: true
        - host: back05.apisearch.kz.local
          halt: true
        - host: back06.apisearch.kz.local
          halt: true
        - host: back07.apisearch.kz.local
          halt: true
        - host: back08.apisearch.kz.local
          halt: true
        - host: back09.apisearch.kz.local
          halt: true
        - host: back10.apisearch.kz.local
          halt: true
    lolek:
        - host: back101.apisearch.kz.local
        - host: back102.apisearch.kz.local
        - host: back103.apisearch.kz.local
          halt: true
        - host: back104.apisearch.kz.local
          halt: true
        - host: back105.apisearch.kz.local
          halt: true
        - host: back106.apisearch.kz.local
          halt: true
        - host: back107.apisearch.kz.local
          halt: true
        - host: back108.apisearch.kz.local
          halt: true
        - host: back109.apisearch.kz.local
          halt: true
        - host: back110.apisearch.kz.local
          halt: true
head: lolek
super: super.back.apisearch.kz.local
tail: bolek
';}

		location / {
			proxy_pass http://apisearch_kz_tail_upstream;
		}
	} # ]]]
	server { # apisearch.ua.beta.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name apisearch.ua.beta.local;
		access_log /var/log/nginx/apisearch.ua.beta.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://apisearch_ua_beta_upstream;
		}
	} # ]]]
	server { # apisearch.ua.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name apisearch.ua.local;
		access_log /var/log/nginx/apisearch.ua.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://apisearch_ua_head_upstream;
		}
	} # ]]]
	server { # tail.apisearch.ua.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name tail.apisearch.ua.local;
		access_log /var/log/nginx/apisearch.ua.tail.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.apisearch.ua.local
          halt: true
        - host: back02.apisearch.ua.local
          halt: true
        - host: back03.apisearch.ua.local
        - host: back04.apisearch.ua.local
        - host: back05.apisearch.ua.local
          halt: true
        - host: back06.apisearch.ua.local
          halt: true
        - host: back07.apisearch.ua.local
          halt: true
        - host: back08.apisearch.ua.local
          halt: true
        - host: back09.apisearch.ua.local
          halt: true
        - host: back10.apisearch.ua.local
          halt: true
    lolek:
        - host: back101.apisearch.ua.local
          halt: true
        - host: back102.apisearch.ua.local
          halt: true
        - host: back103.apisearch.ua.local
        - host: back104.apisearch.ua.local
        - host: back105.apisearch.ua.local
          halt: true
        - host: back106.apisearch.ua.local
          halt: true
        - host: back107.apisearch.ua.local
          halt: true
        - host: back108.apisearch.ua.local
          halt: true
        - host: back109.apisearch.ua.local
          halt: true
        - host: back110.apisearch.ua.local
          halt: true
head: bolek
super: super.back.apisearch.ua.local
tail: lolek
';}

		location / {
			proxy_pass http://apisearch_ua_tail_upstream;
		}
	} # ]]]
	# end apisearch ]]]
	# bob [[[
	server { # app.bbbaaa.ru [[[
		listen 31.13.33.70:80; # carp70
		listen 31.13.33.71:80; # carp71
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		listen 31.13.33.70:443 ssl;
		listen 31.13.33.71:443 ssl;
		listen 10.233.32.219:443 ssl;
		listen 10.233.32.220:443 ssl;
		server_name app.bbbaaa.ru;
		access_log /var/log/nginx/bob.access_log timed;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ru.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ru.key;

		if ( $external_trusted != 1 ) {
			return 302 http://bob.local$request_uri;
		}
		if ( $https = '' ) {
			return 301 https://$host$request_uri;
		}

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://bob_head_upstream;
		}
		location = /favicon.ico {
			access_log /var/log/nginx/bob.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_head_upstream;
		}
		location /css/ {
			access_log /var/log/nginx/bob.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_head_upstream;
		}
		location /img/ {
			access_log /var/log/nginx/bob.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_head_upstream;
		}
		location /js/ {
			access_log /var/log/nginx/bob.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_head_upstream;
		}
		location /local/ {
			access_log /var/log/nginx/bob.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_head_upstream;
		}
		location /styles/ {
			access_log /var/log/nginx/bob.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_head_upstream;
		}
	} # ]]]
	server { # bob.local [[[
		listen 31.13.33.70:80; # carp70
		listen 31.13.33.71:80; # carp71
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name bob.local;
		access_log /var/log/nginx/bob.access_log timed;

		allow 10.0.0.0/8;
		deny  all;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://bob_head_upstream;
		}
	} # ]]]
	server { # dav.bob.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name dav.bob.local;
		access_log /var/log/nginx/dav.bob.access_log timed;

		allow 10.0.0.0/8;
		deny  all;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			return 403;
		}
		location /refund/ {
			root /data/bob/dav;
			autoindex on;
			autoindex_localtime on;
			create_full_put_path on;
			dav_access user:rw group:r all:r;
			dav_methods COPY DELETE MKCOL MOVE PUT;
		}
	} # ]]]
	server { # tail.bob.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name tail.bob.local;
		access_log /var/log/nginx/bob.tail.access_log timed;

		allow 10.0.0.0/8;
		deny  all;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.bob.local
        - host: back02.bob.local
        - host: back03.bob.local
        - host: back04.bob.local
        - host: back05.bob.local
        - host: back06.bob.local
        - host: back07.bob.local
        - host: back08.bob.local
        - host: back09.bob.local
        - host: back10.bob.local
    lolek:
        - host: back101.bob.local
        - host: back102.bob.local
        - host: back103.bob.local
        - host: back104.bob.local
        - host: back105.bob.local
        - host: back106.bob.local
        - host: back107.bob.local
        - host: back108.bob.local
        - host: back109.bob.local
        - host: back110.bob.local
head: bolek
super: super.back.bob.local
tail: lolek
';}

		location / {
			proxy_pass http://bob_tail_upstream;
		}
	} # ]]]
	server { # app-beta.bbbaaa.ru [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		listen 10.233.32.219:443 ssl;
		listen 10.233.32.220:443 ssl;
		server_name app-beta.bbbaaa.ru
		            app.beta.bbbaaa.ru
		;
		access_log /var/log/nginx/bob.ru.beta.access_log timed;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ru.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ru.key;

		allow 10.0.0.0/8;
		deny  all;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://bob_ru_beta_upstream;
		}
		location = /favicon.ico {
			access_log /var/log/nginx/bob.ru.beta.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_ru_beta_upstream;
		}
		location /css/ {
			access_log /var/log/nginx/bob.ru.beta.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_ru_beta_upstream;
		}
		location /img/ {
			access_log /var/log/nginx/bob.ru.beta.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_ru_beta_upstream;
		}
		location /js/ {
			access_log /var/log/nginx/bob.ru.beta.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_ru_beta_upstream;
		}
		location /local/ {
			access_log /var/log/nginx/bob.ru.beta.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_ru_beta_upstream;
		}
		location /styles/ {
			access_log /var/log/nginx/bob.ru.beta.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_ru_beta_upstream;
		}
	} # ]]]
	server { # bob.by.local [[[
		listen 10.233.32.251:80; # carp251
		listen 10.233.32.252:80; # carp252
		server_name bob.by.local;
		access_log /var/log/nginx/bob.by.access_log timed;

		allow 10.0.0.0/8;
		deny  all;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://bob_by_head_upstream;
		}
	} # ]]]
	server { # dav.bob.by.local [[[
		listen 10.233.32.251:80; # carp251
		listen 10.233.32.252:80; # carp252
		server_name dav.bob.by.local;
		access_log /var/log/nginx/dav.bob.by.access_log timed;

		allow 10.0.0.0/8;
		deny  all;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			return 403;
		}
		location /refund/ {
			root /data/bob-by/dav;
			autoindex on;
			autoindex_localtime on;
			create_full_put_path on;
			dav_access user:rw group:r all:r;
			dav_methods COPY DELETE MKCOL MOVE PUT;
		}
	} # ]]]
	server { # tail.bob.by.local [[[
		listen 10.233.32.251:80; # carp251
		listen 10.233.32.252:80; # carp252
		server_name tail.bob.by.local;
		access_log /var/log/nginx/bob.by.tail.access_log timed;

		allow 10.0.0.0/8;
		deny  all;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back05.bob.by.local
        - host: back06.bob.by.local
    lolek:
        - host: back105.bob.by.local
        - host: back106.bob.by.local
head: lolek
super: super.back.bob.by.local
tail: bolek
';}

		location / {
			proxy_pass http://bob_by_tail_upstream;
		}
	} # ]]]
	server { # app.bbbaaa.kz [[[
		listen 31.13.33.72:80; # carp72
		listen 31.13.33.73:80; # carp73
		listen 10.233.32.243:80; # carp243
		listen 10.233.32.244:80; # carp244
		listen 31.13.33.72:443 ssl;
		listen 31.13.33.73:443 ssl;
		listen 10.233.32.243:443 ssl;
		listen 10.233.32.244:443 ssl;
		server_name app.bbbaaa.kz;
		access_log /var/log/nginx/bob.kz.access_log timed;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.kz.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.kz.key;

		if ( $external_trusted != 1 ) {
			return 302 http://bob.kz.local$request_uri;
		}
		if ( $https = '' ) {
			return 301 https://$host$request_uri;
		}

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://bob_kz_head_upstream;
		}
		location = /favicon.ico {
			access_log /var/log/nginx/bob.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_kz_head_upstream;
		}
		location /css/ {
			access_log /var/log/nginx/bob.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_kz_head_upstream;
		}
		location /img/ {
			access_log /var/log/nginx/bob.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_kz_head_upstream;
		}
		location /js/ {
			access_log /var/log/nginx/bob.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_kz_head_upstream;
		}
		location /local/ {
			access_log /var/log/nginx/bob.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_kz_head_upstream;
		}
		location /styles/ {
			access_log /var/log/nginx/bob.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_kz_head_upstream;
		}
	} # ]]]
	server { # bob.kz.local [[[
		listen 31.13.33.72:80; # carp72
		listen 31.13.33.73:80; # carp73
		listen 10.233.32.243:80; # carp243
		listen 10.233.32.244:80; # carp244
		server_name bob.kz.local;
		access_log /var/log/nginx/bob.kz.access_log timed;

		allow 10.0.0.0/8;
		deny  all;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://bob_kz_head_upstream;
		}
		location = /favicon.ico {
			access_log /var/log/nginx/bob.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_kz_head_upstream;
		}
		location /css/ {
			access_log /var/log/nginx/bob.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_kz_head_upstream;
		}
		location /img/ {
			access_log /var/log/nginx/bob.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_kz_head_upstream;
		}
		location /js/ {
			access_log /var/log/nginx/bob.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_kz_head_upstream;
		}
		location /local/ {
			access_log /var/log/nginx/bob.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_kz_head_upstream;
		}
		location /styles/ {
			access_log /var/log/nginx/bob.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_kz_head_upstream;
		}
	} # ]]]
	server { # dav.bob.kz.local [[[
		listen 10.233.32.243:80; # carp243
		listen 10.233.32.244:80; # carp244
		server_name dav.bob.kz.local;
		access_log /var/log/nginx/dav.bob.kz.access_log timed;

		allow 10.0.0.0/8;
		deny  all;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			return 403;
		}
		location /refund/ {
			root /data/bob-kz/dav;
			autoindex on;
			autoindex_localtime on;
			create_full_put_path on;
			dav_access user:rw group:r all:r;
			dav_methods COPY DELETE MKCOL MOVE PUT;
		}
	} # ]]]
	server { # tail.bob.kz.local [[[
		listen 10.233.32.243:80; # carp243
		listen 10.233.32.244:80; # carp244
		server_name tail.bob.kz.local;
		access_log /var/log/nginx/bob.kz.tail.access_log timed;

		allow 10.0.0.0/8;
		deny  all;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.bob.kz.local
          halt: true
        - host: back02.bob.kz.local
          halt: true
        - host: back03.bob.kz.local
          halt: true
        - host: back04.bob.kz.local
          halt: true
        - host: back05.bob.kz.local
        - host: back06.bob.kz.local
        - host: back07.bob.kz.local
        - host: back08.bob.kz.local
        - host: back09.bob.kz.local
          halt: true
        - host: back10.bob.kz.local
          halt: true
    lolek:
        - host: back101.bob.kz.local
          halt: true
        - host: back102.bob.kz.local
          halt: true
        - host: back103.bob.kz.local
          halt: true
        - host: back104.bob.kz.local
          halt: true
        - host: back105.bob.kz.local
        - host: back106.bob.kz.local
        - host: back107.bob.kz.local
        - host: back108.bob.kz.local
        - host: back109.bob.kz.local
          halt: true
        - host: back110.bob.kz.local
          halt: true
head: lolek
super: super.back.bob.kz.local
tail: bolek
';}

		location / {
			proxy_pass http://bob_kz_tail_upstream;
		}
	} # ]]]
	server { # app.bbbaaa.ua [[[
		listen 31.13.33.74:80; # carp74
		listen 31.13.33.75:80; # carp75
		listen 10.233.32.245:80; # carp245
		listen 10.233.32.246:80; # carp246
		listen 31.13.33.74:443 ssl;
		listen 31.13.33.75:443 ssl;
		listen 10.233.32.245:443 ssl;
		listen 10.233.32.246:443 ssl;
		server_name app.bbbaaa.ua;
		access_log /var/log/nginx/bob.ua.access_log timed;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ua.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ua.key;

		if ( $external_trusted != 1 ) {
			return 302 http://bob.ua.local$request_uri;
		}
		if ( $https = '' ) {
			return 301 https://$host$request_uri;
		}

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://bob_ua_head_upstream;
		}
		location = /favicon.ico {
			access_log /var/log/nginx/bob.ua.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_ua_head_upstream;
		}
		location /css/ {
			access_log /var/log/nginx/bob.ua.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_ua_head_upstream;
		}
		location /img/ {
			access_log /var/log/nginx/bob.ua.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_ua_head_upstream;
		}
		location /js/ {
			access_log /var/log/nginx/bob.ua.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_ua_head_upstream;
		}
		location /local/ {
			access_log /var/log/nginx/bob.ua.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_ua_head_upstream;
		}
		location /styles/ {
			access_log /var/log/nginx/bob.ua.static.access_log timed;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1d;
			proxy_pass http://bob_ua_head_upstream;
		}
	} # ]]]
	server { # bob.ua.local [[[
		listen 31.13.33.74:80; # carp74
		listen 31.13.33.75:80; # carp75
		listen 10.233.32.245:80; # carp245
		listen 10.233.32.246:80; # carp246
		server_name bob.ua.local;
		access_log /var/log/nginx/bob.ua.access_log timed;

		allow 10.0.0.0/8;
		deny  all;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://bob_ua_head_upstream;
		}
	} # ]]]
	server { # dav.bob.ua.local [[[
		listen 10.233.32.245:80; # carp245
		listen 10.233.32.246:80; # carp246
		server_name dav.bob.ua.local;
		access_log /var/log/nginx/dav.bob.ua.access_log timed;

		allow 10.0.0.0/8;
		deny  all;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			return 403;
		}
		location /refund/ {
			root /data/bob-ua/dav;
			autoindex on;
			autoindex_localtime on;
			create_full_put_path on;
			dav_access user:rw group:r all:r;
			dav_methods COPY DELETE MKCOL MOVE PUT;
		}
	} # ]]]
	server { # tail.bob.ua.local [[[
		listen 10.233.32.245:80; # carp245
		listen 10.233.32.246:80; # carp246
		server_name tail.bob.ua.local;
		access_log /var/log/nginx/bob.ua.tail.access_log timed;

		allow 10.0.0.0/8;
		deny  all;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.bob.ua.local
        - host: back02.bob.ua.local
        - host: back03.bob.ua.local
        - host: back04.bob.ua.local
        - host: back05.bob.ua.local
          halt: true
        - host: back06.bob.ua.local
          halt: true
        - host: back07.bob.ua.local
          halt: true
        - host: back08.bob.ua.local
          halt: true
        - host: back09.bob.ua.local
          halt: true
        - host: back10.bob.ua.local
          halt: true
    lolek:
        - host: back101.bob.ua.local
        - host: back102.bob.ua.local
        - host: back103.bob.ua.local
        - host: back104.bob.ua.local
        - host: back105.bob.ua.local
          halt: true
        - host: back106.bob.ua.local
          halt: true
        - host: back107.bob.ua.local
          halt: true
        - host: back108.bob.ua.local
          halt: true
        - host: back109.bob.ua.local
          halt: true
        - host: back110.bob.ua.local
          halt: true
head: lolek
super: super.back.bob.ua.local
tail: bolek
';}

		location / {
			proxy_pass http://bob_ua_tail_upstream;
		}
	} # ]]]
	# end bob ]]]
	# bs [[[
	server { # bs.local [[[
		listen 127.0.0.1:80; # localhost
		# added for webdav
		listen 10.233.32.96:80; # primary
		listen 31.13.33.70:80; # carp70
		listen 31.13.33.71:80; # carp71
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name bs.local
		            bs.bbbaaa.ru
		;

		access_log /var/log/nginx/bs.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		# don't inherit standard proxy headers from upper context
		proxy_set_header Host $host;

		if_modified_since off;
		ssi on;

		location / {
			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://bs_head_upstream;
		}
		location /bs-ssi/ {
			internal;
			alias /data/bs/ssi/;
		}
		location /click/ {
			proxy_set_header X-LID $uid_any;
			proxy_pass http://bs_head_upstream;
		}
		location /dav/ {
			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
	
			root /data/bs;
			autoindex on;
			autoindex_localtime on;
			create_full_put_path on;
			dav_access user:rw group:r all:r;
			dav_methods COPY DELETE MKCOL MOVE PUT;
		}
		location /hit/ {
			error_page 400 401 403 404 500 502 503 504 = @zero;

			proxy_connect_timeout 10ms;
			proxy_read_timeout    200ms;
			proxy_pass_request_headers off;

			proxy_set_header  Host                  bs.local;
			proxy_set_header  X-Real-IP             $remote_addr;
			proxy_set_header  X-Forwarded-For       $remote_addr;
			proxy_set_header  X-Forwarded-Host      $host;
			proxy_set_header  X-Forwarded-Port      $server_port;
			proxy_set_header  X-Forwarded-Protocol  $scheme;
			proxy_set_header  X-LID                 $uid_any;
			proxy_set_header  X-Splits              banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header  Referer               $scheme://$http_host$request_uri;
			proxy_set_header  Rereferer             $http_referer;
			proxy_set_header  X-City-ID             $city_id;
			proxy_set_header  X-Region-ID           $region_id;

			proxy_pass http://bs_head_upstream;
		}
	} # ]]]
	server { # tail.bs.local [[[
		# added for webdav
		listen 10.233.32.96:80; # primary
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name tail.bs.local;
		access_log /var/log/nginx/bs.tail.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.bs.local
        - host: back09.bs.local
    lolek:
        - host: back101.bs.local
        - host: back109.bs.local
head: bolek
super: super.back.bs.local
tail: lolek
';}

		# don't inherit standard proxy headers from upper context
		proxy_set_header Host $host;

		if_modified_since off;
		ssi on;

		location / {
			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://bs_tail_upstream;
		}
		location /bs-ssi/ {
			internal;
			alias /data/bs/ssi/;
		}
		location /click/ {
			proxy_set_header X-LID $uid_any;
			proxy_pass http://bs_tail_upstream;
		}
		location /dav/ {
			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
	
			root /data/bs;
			autoindex on;
			autoindex_localtime on;
			create_full_put_path on;
			dav_access user:rw group:r all:r;
			dav_methods COPY DELETE MKCOL MOVE PUT;
		}
		location /hit/ {
			proxy_pass http://bs_tail_upstream;
		}
	} # ]]]
	server { # bs.beta.local [[[
		# added for webdav
		listen 10.233.32.96:80; # primary
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name bs.beta.local;
		access_log /var/log/nginx/bs.beta.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		# don't inherit standard proxy headers from upper context
		proxy_set_header Host $host;

		if_modified_since off;
		ssi on;

		location / {
			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://bs_beta_upstream;
		}
		location /bs-ssi/ {
			internal;
			alias /data/bs-beta/ssi/;
		}
		location /click/ {
			proxy_set_header X-LID $uid_any;
			proxy_pass http://bs_beta_upstream;
		}
		location /dav/ {
			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
	
			root /data/bs-beta;
			autoindex on;
			autoindex_localtime on;
			create_full_put_path on;
			dav_access user:rw group:r all:r;
			dav_methods COPY DELETE MKCOL MOVE PUT;
		}
		location /hit/ {
			error_page 400 401 403 404 500 502 503 504 = @zero;

			proxy_connect_timeout 10ms;
			proxy_read_timeout    200ms;
			proxy_pass_request_headers off;

			proxy_set_header  Host                  bs.local;
			proxy_set_header  X-Real-IP             $remote_addr;
			proxy_set_header  X-Forwarded-For       $remote_addr;
			proxy_set_header  X-Forwarded-Host      $host;
			proxy_set_header  X-Forwarded-Port      $server_port;
			proxy_set_header  X-Forwarded-Protocol  $scheme;
			proxy_set_header  X-LID                 $uid_any;
			proxy_set_header  X-Splits              banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header  Referer               $scheme://$http_host$request_uri;
			proxy_set_header  Rereferer             $http_referer;
			proxy_set_header  X-City-ID             $city_id;
			proxy_set_header  X-Region-ID           $region_id;

			proxy_pass http://bs_beta_upstream;
		}
	} # ]]]
	server { # adm.bs.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		listen 10.233.32.219:443 ssl;
		listen 10.233.32.220:443 ssl;
		server_name adm.bs.local
		            adm-bs.bbbaaa.ru
		;

		access_log /var/log/nginx/adm.bs.access_log timed;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ru.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ru.key;

		if ( $https = '' ) {
			return 301 https://$host$request_uri;
		}

	### proxy-set-headers begin ###
	proxy_set_header  Host                  $host;
	proxy_set_header  X-Real-IP             $remote_addr;
	proxy_set_header  X-Forwarded-For       $remote_addr;
	proxy_set_header  X-Forwarded-Host      $host;
	proxy_set_header  X-Forwarded-Port      $server_port;
	proxy_set_header  X-Forwarded-Protocol  $scheme;
	### proxy-set-headers end ###
		proxy_set_header X-LID $uid_any;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://adm_bs_head_upstream;
		}
	} # ]]]
	server { # tail.adm.bs.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		listen 10.233.32.219:443 ssl;
		listen 10.233.32.220:443 ssl;
		server_name tail.adm.bs.local;
		access_log /var/log/nginx/adm.bs.tail.access_log timed;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ru.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ru.key;

		if ( $https = '' ) {
			return 301 https://$host$request_uri;
		}

	### proxy-set-headers begin ###
	proxy_set_header  Host                  $host;
	proxy_set_header  X-Real-IP             $remote_addr;
	proxy_set_header  X-Forwarded-For       $remote_addr;
	proxy_set_header  X-Forwarded-Host      $host;
	proxy_set_header  X-Forwarded-Port      $server_port;
	proxy_set_header  X-Forwarded-Protocol  $scheme;
	### proxy-set-headers end ###
		proxy_set_header X-LID $uid_any;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.adm.bs.local
        - host: back09.adm.bs.local
    lolek:
        - host: back101.adm.bs.local
        - host: back109.adm.bs.local
head: lolek
super: super.back.adm.bs.local
tail: bolek
';}

		location / {
			proxy_pass http://adm_bs_tail_upstream;
		}
	} # ]]]
	server { # adm.bs.beta.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		listen 10.233.32.219:443 ssl;
		listen 10.233.32.220:443 ssl;
		server_name adm.bs.beta.local;

		access_log /var/log/nginx/adm.bs.beta.access_log timed;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ru.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ru.key;

		if ( $https = '' ) {
			return 301 https://$host$request_uri;
		}

	### proxy-set-headers begin ###
	proxy_set_header  Host                  $host;
	proxy_set_header  X-Real-IP             $remote_addr;
	proxy_set_header  X-Forwarded-For       $remote_addr;
	proxy_set_header  X-Forwarded-Host      $host;
	proxy_set_header  X-Forwarded-Port      $server_port;
	proxy_set_header  X-Forwarded-Protocol  $scheme;
	### proxy-set-headers end ###
		proxy_set_header X-LID $uid_any;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://adm_bs_beta_upstream;
		}
	} # ]]]
	server { # site-beta-bs.bbbaaa [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		listen 10.233.32.243:80; # carp243
		listen 10.233.32.244:80; # carp244
		listen 10.233.32.245:80; # carp245
		listen 10.233.32.246:80; # carp246
		server_name site-beta-bs.bbbaaa.ru
		            site-beta-bs.bbbaaa.ua
		            site-beta-bs.bbbaaa.kz
		;
		access_log /var/log/nginx/bbbaaa.beta.bs.access_log timeds;

		if ( $arg_split_bbbaaa5 ) {
			set $split_bbbaaa5 $arg_split_bbbaaa5;
		}
		if ( $arg_split_bbbaaa_banner ) {
			set $split_bbbaaa_banner $arg_split_bbbaaa_banner;
		}
		if ( $arg_split_bbbaaa_mobile ) {
			set $split_bbbaaa_mobile $arg_split_bbbaaa_mobile;
		}
		if ( $arg_split_bbbaaa_perm ) {
			set $split_bbbaaa_perm $arg_split_bbbaaa_perm;
		}
		if ( $arg_split_bbbaaa_ranking ) {
			set $split_bbbaaa_ranking $arg_split_bbbaaa_ranking;
		}

		set $easycheckout 1;
		set $fullcheckout 1;

		ssi on;

	### proxy-set-headers begin ###
	proxy_set_header  Host                  $host;
	proxy_set_header  X-Real-IP             $remote_addr;
	proxy_set_header  X-Forwarded-For       $remote_addr;
	proxy_set_header  X-Forwarded-Host      $host;
	proxy_set_header  X-Forwarded-Port      $server_port;
	proxy_set_header  X-Forwarded-Protocol  $scheme;
	### proxy-set-headers end ###
		proxy_set_header X-LID    $uid_any;
		proxy_set_header X-Splits banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;

		proxy_intercept_errors on;

		error_page 401 402 404 /err/404.html;
		error_page 403 /err/403.html;
		error_page 500 /err/500.html;
		error_page 502 /err/502.html;
		error_page 503 /err/503.html;
		error_page 504 /err/504.html;

		### zero-location begin ###
		location @zero {
			return 204;
		}
		### zero-locations end  ###
		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://site_beta_bs_upstream;
		}
		location = /apple-touch-icon.png {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timeds;
			root /data/site/misc;
		}
		location /bs-click/ {
			proxy_set_header Host $proxy_host;
			proxy_pass http://bs.beta.local/click/;
		}
		location /bs-hit/ {
			internal;
			proxy_set_header  Host                  $proxy_host;
			proxy_set_header  X-Real-IP             $remote_addr;
			proxy_set_header  X-Forwarded-For       $remote_addr;
			proxy_set_header  X-Forwarded-Host      $host;
			proxy_set_header  X-Forwarded-Port      $server_port;
			proxy_set_header  X-Forwarded-Protocol  $scheme;
			proxy_set_header  X-LID                 $uid_any;
			proxy_set_header  X-Splits              banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header  Referer               $scheme://$http_host$request_uri;
			proxy_set_header  Rereferer             $http_referer;
			proxy_set_header  X-City-ID             $city_id;
			proxy_set_header  X-Region-ID           $region_id;
			proxy_pass http://bs.beta.local/hit/;
			error_page 404 = @zero;
			log_subrequest on;
			access_log /var/log/nginx/bbbaaa.beta.bs.hit.access_log subtimed;
		}
		location /err/ {
			internal;
			alias /data/site/misc/;
		}
		location = /favicon.ico {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timeds;
			root /data/site/misc;
		}
		location /flat/ {
						### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://site_beta_bs_upstream;
		}
		location = /localstorage.html {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timeds;
			root /data/site/misc;
		}
		# denying access to qiwi payments from anywhere except qiwi - task LAMODA-2620
		# http://jira.bbbaaa.ru/browse/SITE-236
		# http://jira.bbbaaa.ru/browse/LAMODA-6200
		location /qiwipayment/ {
			allow 91.232.230.0/23;
			deny all;
			proxy_set_header Host app.site-beta.bbbaaa.ru;
			proxy_pass http://app.site-beta.bbbaaa.ru/exchange/service/qiwi-payment/;
		}
		# http://jira.bbbaaa.ru/browse/LAMODA-6201
		location /paymentassist/response/notification/ {
			proxy_set_header Host app.site-beta.bbbaaa.ru;
			proxy_pass http://app.site-beta.bbbaaa.ru/pluginassist/order/?method=notification;
		}
		location = /nt {
			return 204;
		}
		location = /robots.txt {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timeds;
			root /data/site/misc;
		}
		location = /ssi/exp.html {
			internal;
			error_page 403 404 = @zero;
			alias /data/split/${split_dir}/${split_bbbaaa5}/${split_bbbaaa_ranking}/${split_bbbaaa_mobile}.html;
		}
		location /static/ {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timeds;
			proxy_set_header Host www.bbbaaa.ru;
			proxy_pass http://site_beta_bs_static_upstream;
		}
	} # ]]]
	# end bs ]]]
# citizen [[[
server { # citizen.local [[[
	listen 10.233.32.219:80; # carp219
	listen 10.233.32.220:80; # carp220
	server_name citizen.local
	            back.sort.local
	;
	access_log /var/log/nginx/citizen.access_log timed;
			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###
	location / {
		proxy_pass http://citizen_head_upstream;
	}
} # ]]]
server { # tail.citizen.local [[[
	listen 10.233.32.219:80; # carp219
	listen 10.233.32.220:80; # carp220
	server_name tail.citizen.local;
	access_log /var/log/nginx/citizen.tail.access_log timed;
	location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.citizen.local
        - host: back09.citizen.local
    lolek:
        - host: back101.citizen.local
        - host: back109.citizen.local
head: lolek
super: super.back.citizen.local
tail: bolek
';}
			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###
    location / {
        proxy_pass http://citizen_tail_upstream;
    }
} # ]]]
# end citizen ]]]
	# company [[[
	server { # company.bbbaaa.kz [[[
		listen 31.13.33.72:80; # carp72
		listen 31.13.33.73:80; # carp73
		listen 10.233.32.243:80; # carp243
		listen 10.233.32.244:80; # carp244
		listen 31.13.33.72:443 ssl;
		listen 31.13.33.73:443 ssl;
		listen 10.233.32.243:443 ssl;
		listen 10.233.32.244:443 ssl;
		server_name company.bbbaaa.kz;
		access_log /var/log/nginx/company.kz.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.kz.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.kz.key;

		if ( $https ) {
			return 301 http://$host$request_uri;
		}

		proxy_set_header  Host                  company.bbbaaa.kz;
		proxy_set_header  X-Real-IP             $remote_addr;
		proxy_set_header  X-Forwarded-For       $remote_addr;
		proxy_set_header  X-Forwarded-Host      company.bbbaaa.kz;
		proxy_set_header  X-Forwarded-Port      $server_port;
		proxy_set_header  X-Forwarded-Protocol  $scheme;

		proxy_read_timeout  10s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://corp_head_upstream;
		}
		location = /favicon.ico {
			root  /data/corp/20/;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
		}
		location /media/ {
			proxy_next_upstream error
			                    http_404
			                    invalid_header
			                    timeout
			;
			proxy_pass http://corp_media_head_upstream;
		}
		location /static/ {
			alias /data/corp/;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
		}
	} # ]]]
	server { # tail.company.bbbaaa.kz [[[
		listen 10.233.32.243:80; # carp243
		listen 10.233.32.244:80; # carp244
		server_name tail.company.bbbaaa.kz;
		access_log /var/log/nginx/company.kz.tail.access_log timeds;

		proxy_set_header  Host                  company.bbbaaa.kz;
		proxy_set_header  X-Real-IP             $remote_addr;
		proxy_set_header  X-Forwarded-For       $remote_addr;
		proxy_set_header  X-Forwarded-Host      company.bbbaaa.kz;
		proxy_set_header  X-Forwarded-Port      $server_port;
		proxy_set_header  X-Forwarded-Protocol  $scheme;

		proxy_read_timeout  10s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.corp.local
          halt: true
        - host: back02.corp.local
          halt: true
        - host: back03.corp.local
        - host: back04.corp.local
        - host: back05.corp.local
          halt: true
        - host: back06.corp.local
          halt: true
        - host: back07.corp.local
          halt: true
        - host: back08.corp.local
          halt: true
        - host: back09.corp.local
          halt: true
        - host: back10.corp.local
          halt: true
    lolek:
        - host: back101.corp.local
          halt: true
        - host: back102.corp.local
          halt: true
        - host: back103.corp.local
        - host: back104.corp.local
        - host: back105.corp.local
          halt: true
        - host: back106.corp.local
          halt: true
        - host: back107.corp.local
          halt: true
        - host: back108.corp.local
          halt: true
        - host: back109.corp.local
          halt: true
        - host: back110.corp.local
          halt: true
head: lolek
super: super.back.corp.local
tail: bolek
';}

		location / {
			proxy_pass http://corp_tail_upstream;
		}
		location = /favicon.ico {
			root  /data/corp/20/;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
		}
		location /media/ {
			proxy_next_upstream error
			                    http_404
			                    invalid_header
			                    timeout
			;
			proxy_pass http://corp_media_tail_upstream;
		}
		location /static/ {
			alias /data/corp/;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
		}
	} # ]]]
	server { # company.bbbaaa.ru [[[
		listen 31.13.33.70:80; # carp70
		listen 31.13.33.71:80; # carp71
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		listen 31.13.33.70:443 ssl;
		listen 31.13.33.71:443 ssl;
		listen 10.233.32.219:443 ssl;
		listen 10.233.32.220:443 ssl;
		server_name company.bbbaaa.ru;
		access_log /var/log/nginx/company.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ru.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ru.key;

		if ( $https ) {
			return 301 http://$host$request_uri;
		}

		proxy_set_header  Host                  company.bbbaaa.ru;
		proxy_set_header  X-Real-IP             $remote_addr;
		proxy_set_header  X-Forwarded-For       $remote_addr;
		proxy_set_header  X-Forwarded-Host      company.bbbaaa.ru;
		proxy_set_header  X-Forwarded-Port      $server_port;
		proxy_set_header  X-Forwarded-Protocol  $scheme;

		proxy_read_timeout  10s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://corp_head_upstream;
		}
		location = /favicon.ico {
			root  /data/corp/20/;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
		}
		location /media/ {
			proxy_next_upstream error
			                    http_404
			                    invalid_header
			                    timeout
			;
			proxy_pass http://corp_media_head_upstream;
		}
		location /static/ {
			alias /data/corp/;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
		}
	} # ]]]
	server { # tail.company.bbbaaa.ru [[[
		listen 10.233.32.219:80; # carp119
		listen 10.233.32.220:80; # carp120
		server_name tail.company.bbbaaa.ru;
		access_log /var/log/nginx/company.tail.access_log timeds;

		proxy_set_header  Host                  company.bbbaaa.ru;
		proxy_set_header  X-Real-IP             $remote_addr;
		proxy_set_header  X-Forwarded-For       $remote_addr;
		proxy_set_header  X-Forwarded-Host      company.bbbaaa.ru;
		proxy_set_header  X-Forwarded-Port      $server_port;
		proxy_set_header  X-Forwarded-Protocol  $scheme;

		proxy_read_timeout  10s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.corp.local
          halt: true
        - host: back02.corp.local
          halt: true
        - host: back03.corp.local
        - host: back04.corp.local
        - host: back05.corp.local
          halt: true
        - host: back06.corp.local
          halt: true
        - host: back07.corp.local
          halt: true
        - host: back08.corp.local
          halt: true
        - host: back09.corp.local
          halt: true
        - host: back10.corp.local
          halt: true
    lolek:
        - host: back101.corp.local
          halt: true
        - host: back102.corp.local
          halt: true
        - host: back103.corp.local
        - host: back104.corp.local
        - host: back105.corp.local
          halt: true
        - host: back106.corp.local
          halt: true
        - host: back107.corp.local
          halt: true
        - host: back108.corp.local
          halt: true
        - host: back109.corp.local
          halt: true
        - host: back110.corp.local
          halt: true
head: lolek
super: super.back.corp.local
tail: bolek
';}

		location / {
			proxy_pass http://corp_tail_upstream;
		}
		location = /favicon.ico {
			root  /data/corp/20/;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
		}
		location /media/ {
			proxy_next_upstream error
			                    http_404
			                    invalid_header
			                    timeout
			;
			proxy_pass http://corp_media_tail_upstream;
		}
		location /static/ {
			alias /data/corp/;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
		}
	} # ]]]
	server { # company.bbbaaa.ua [[[
		listen 31.13.33.74:80; # carp74
		listen 31.13.33.75:80; # carp75
		listen 10.233.32.245:80; # carp245
		listen 10.233.32.246:80; # carp246
		listen 31.13.33.74:443 ssl;
		listen 31.13.33.75:443 ssl;
		listen 10.233.32.245:443 ssl;
		listen 10.233.32.246:443 ssl;
		server_name company.bbbaaa.ua;
		access_log /var/log/nginx/company.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ua.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ua.key;

		if ( $https ) {
			return 301 http://$host$request_uri;
		}

		proxy_set_header  Host                  company.bbbaaa.ua;
		proxy_set_header  X-Real-IP             $remote_addr;
		proxy_set_header  X-Forwarded-For       $remote_addr;
		proxy_set_header  X-Forwarded-Host      company.bbbaaa.ua;
		proxy_set_header  X-Forwarded-Port      $server_port;
		proxy_set_header  X-Forwarded-Protocol  $scheme;

		proxy_read_timeout  10s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://corp_head_upstream;
		}
		location = /favicon.ico {
			root  /data/corp/20/;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
		}
		location /media/ {
			proxy_next_upstream error
			                    http_404
			                    invalid_header
			                    timeout
			;
			proxy_pass http://corp_media_head_upstream;
		}
		location /static/ {
			alias /data/corp/;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
		}
	} # ]]]
	server { # tail.company.bbbaaa.ua [[[
		listen 10.233.32.245:80; # carp245
		listen 10.233.32.246:80; # carp246
		server_name tail.company.bbbaaa.ua;
		access_log /var/log/nginx/company.tail.access_log timeds;

		proxy_set_header  Host                  company.bbbaaa.ua;
		proxy_set_header  X-Real-IP             $remote_addr;
		proxy_set_header  X-Forwarded-For       $remote_addr;
		proxy_set_header  X-Forwarded-Host      company.bbbaaa.ua;
		proxy_set_header  X-Forwarded-Port      $server_port;
		proxy_set_header  X-Forwarded-Protocol  $scheme;

		proxy_read_timeout  10s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.corp.local
          halt: true
        - host: back02.corp.local
          halt: true
        - host: back03.corp.local
        - host: back04.corp.local
        - host: back05.corp.local
          halt: true
        - host: back06.corp.local
          halt: true
        - host: back07.corp.local
          halt: true
        - host: back08.corp.local
          halt: true
        - host: back09.corp.local
          halt: true
        - host: back10.corp.local
          halt: true
    lolek:
        - host: back101.corp.local
          halt: true
        - host: back102.corp.local
          halt: true
        - host: back103.corp.local
        - host: back104.corp.local
        - host: back105.corp.local
          halt: true
        - host: back106.corp.local
          halt: true
        - host: back107.corp.local
          halt: true
        - host: back108.corp.local
          halt: true
        - host: back109.corp.local
          halt: true
        - host: back110.corp.local
          halt: true
head: lolek
super: super.back.corp.local
tail: bolek
';}

		location / {
			proxy_pass http://corp_tail_upstream;
		}
		location = /favicon.ico {
			root  /data/corp/20/;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
		}
		location /media/ {
			proxy_next_upstream error
			                    http_404
			                    invalid_header
			                    timeout
			;
			proxy_pass http://corp_media_tail_upstream;
		}
		location /static/ {
			alias /data/corp/;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
		}
	} # ]]]
	# end company ]]]
	# content [[[
	server { # content.leos.bbbaaa.ru [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name content.leos.bbbaaa.ru;
		access_log /var/log/nginx/content.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://content_head_upstream;
		}
	} # ]]]
	server { # tail.content.leos.bbbaaa.ru [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name tail.content.leos.bbbaaa.ru;
		access_log /var/log/nginx/content.tail.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.content.local
        - host: back02.content.local
    lolek:
        - host: back101.content.local
        - host: back102.content.local
head: bolek
super: super.back.content.local
tail: lolek
';}

		location / {
			proxy_pass http://content_tail_upstream;
		}
	} # ]]]
	# end content ]]]
	# converter [[[
	server { # converter.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name converter.local;
		access_log /var/log/nginx/converter.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://converter_head_upstream;
		}
		location = /favicon.ico {
			return 404;
		}
	} # ]]]
	server { # tail.converter.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name tail.converter.local;
		access_log /var/log/nginx/converter.tail.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.converter.local
          halt: true
        - host: back02.converter.local
          halt: true
        - host: back03.converter.local
          halt: true
        - host: back04.converter.local
          halt: true
        - host: back05.converter.local
        - host: back06.converter.local
        - host: back07.converter.local
          halt: true
        - host: back08.converter.local
          halt: true
        - host: back09.converter.local
          halt: true
        - host: back10.converter.local
          halt: true
    lolek:
        - host: back101.converter.local
          halt: true
        - host: back102.converter.local
          halt: true
        - host: back103.converter.local
          halt: true
        - host: back104.converter.local
          halt: true
        - host: back105.converter.local
        - host: back106.converter.local
        - host: back107.converter.local
          halt: true
        - host: back108.converter.local
          halt: true
        - host: back109.converter.local
          halt: true
        - host: back110.converter.local
          halt: true
head: lolek
super: super.back.converter.local
tail: bolek
';}

		location / {
			proxy_pass http://converter_tail_upstream;
		}
		location = /favicon.ico {
			return 404;
		}
	} # ]]]
	server { # b2b.bbbaaa.ru [[[
		listen 31.13.33.70:80; # carp70
		listen 31.13.33.71:80; # carp71
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		listen 31.13.33.70:443 ssl;
		listen 31.13.33.71:443 ssl;
		listen 10.233.32.219:443 ssl;
		listen 10.233.32.220:443 ssl;
		server_name b2b.bbbaaa.ru;
		access_log /var/log/nginx/b2b.bbbaaa.access_log timed;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ru.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ru.key;

		proxy_read_timeout 60s;

			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			auth_basic "b2b";
			auth_basic_user_file passwd/b2b.converter;
			satisfy any;

			proxy_pass http://converter_head_upstream;
		}
	} # ]]]
	server { # beta.converter.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name beta.converter.local;
		access_log /var/log/nginx/converter.beta.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://converter_beta_upstream;
		}
	} # ]]]
	server { # beta.b2b.converter.local [[[
		listen 31.13.33.70:80; # carp70
		listen 31.13.33.71:80; # carp71
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		listen 31.13.33.70:443 ssl;
		listen 31.13.33.71:443 ssl;
		listen 10.233.32.219:443 ssl;
		listen 10.233.32.220:443 ssl;
		server_name b2b-test.bbbaaa.ru;
		access_log /var/log/nginx/converter.b2b.beta.access_log timed;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ru.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ru.key;

			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			auth_basic "b2b";
			auth_basic_user_file passwd/beta.b2b.converter;
			satisfy any;

			proxy_pass http://converter_b2b_beta_upstream;
		}
	} # ]]]
	server { # beta.uat.converter.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name beta.uat.converter.local;
		access_log /var/log/nginx/converter.uat.beta.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://converter_uat_beta_upstream;
		}
	} # ]]]
	# end converter ]]]
	# cpa [[[
	server { # market-cpa.bbbaaa.ru [[[
		listen 31.13.33.70:80; # carp70
		listen 31.13.33.71:80; # carp71
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		listen 31.13.33.70:443 ssl;
		listen 31.13.33.71:443 ssl;
		listen 10.233.32.219:443 ssl;
		listen 10.233.32.220:443 ssl;
		server_name market-cpa.bbbaaa.ru;
		access_log /var/log/nginx/cpa.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ru.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ru.key;

		set_real_ip_from 10.233.32.0/24;
		# QRator pool
		set_real_ip_from 64.48.224.8;
		set_real_ip_from 64.48.224.9;
		set_real_ip_from 64.48.224.10;
		set_real_ip_from 64.48.224.11;
		set_real_ip_from 66.110.32.128;
		set_real_ip_from 66.110.32.129;
		set_real_ip_from 66.110.32.130;
		set_real_ip_from 66.110.32.131;
		set_real_ip_from 87.245.197.192;
		set_real_ip_from 87.245.197.193;
		set_real_ip_from 87.245.197.194;
		set_real_ip_from 87.245.197.195;
		set_real_ip_from 87.245.197.196;
		set_real_ip_from 134.90.144.224;
		set_real_ip_from 134.90.144.225;
		set_real_ip_from 134.90.144.226;
		set_real_ip_from 134.90.144.227;
		set_real_ip_from 83.234.15.112;
		set_real_ip_from 83.234.15.113;
		set_real_ip_from 83.234.15.114;
		set_real_ip_from 83.234.15.115;
		set_real_ip_from 83.234.15.116;
		set_real_ip_from 128.177.119.64;
		set_real_ip_from 128.177.119.65;
		set_real_ip_from 128.177.119.66;
		set_real_ip_from 128.177.119.67;
		set_real_ip_from 178.248.232.128/28;
		set_real_ip_from 178.248.233.128/28;
		set_real_ip_from 178.248.234.128/28;
		set_real_ip_from 178.248.235.128/28;
		set_real_ip_from 178.248.236.128/28;
		set_real_ip_from 178.248.237.128/28;
		set_real_ip_from 178.248.239.128/28;

#		if ( $https = '' ) {
#			return 301 https://$host$request_uri;
#		}

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://cpa.mdev.local:8080;
		}
	} # ]]]
	# end cpa ]]]
	# curr [[[
	server { # curr.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name curr.local
		            currency.leos.bbbaaa.ru
		;
		access_log /var/log/nginx/curr.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://curr_head_upstream;
		}

		location /api {
			satisfy any;

						allow 10.233.0.49;
						allow 10.233.1.49;
						allow 10.233.7.49;
						allow 10.233.8.49;
						allow 10.233.9.49;
						allow 10.233.2.49;
						allow 10.233.3.49;
						allow 10.233.4.49;
						allow 10.233.10.49;
						allow 10.233.11.49;
						allow 10.233.0.50;
						allow 10.233.1.50;
						allow 10.233.7.50;
						allow 10.233.8.50;
						allow 10.233.9.50;
						allow 10.233.2.50;
						allow 10.233.3.50;
						allow 10.233.4.50;
						allow 10.233.10.50;
						allow 10.233.11.50;
			
			deny all;
			auth_basic "Restricted";
			auth_basic_user_file passwd/curr;

			proxy_pass http://curr_head_upstream;
		}
	} # ]]]
	server { # tail.curr.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name tail.curr.local;
		access_log /var/log/nginx/curr.tail.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.curr.local
        - host: back02.curr.local
        - host: back03.curr.local
          halt: true
        - host: back04.curr.local
          halt: true
        - host: back05.curr.local
          halt: true
        - host: back06.curr.local
          halt: true
        - host: back07.curr.local
          halt: true
        - host: back08.curr.local
          halt: true
        - host: back09.curr.local
          halt: true
        - host: back10.curr.local
          halt: true
    lolek:
        - host: back101.curr.local
        - host: back102.curr.local
        - host: back103.curr.local
          halt: true
        - host: back104.curr.local
          halt: true
        - host: back105.curr.local
          halt: true
        - host: back106.curr.local
          halt: true
        - host: back107.curr.local
          halt: true
        - host: back108.curr.local
          halt: true
        - host: back109.curr.local
          halt: true
        - host: back110.curr.local
          halt: true
head: lolek
super: super.back.curr.local
tail: bolek
';}

		location / {
			proxy_pass http://curr_tail_upstream;
		}
	} # ]]]
	# end curr ]]]
	# customer [[[
	server { # customer.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name customer.local;
		access_log /var/log/nginx/customer.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://customer_head_upstream;
		}
	} # ]]]
	server { # tail.customer.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name tail.customer.local;
		access_log /var/log/nginx/customer.tail.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.customer.local
        - host: back02.customer.local
        - host: back03.customer.local
        - host: back04.customer.local
        - host: back05.customer.local
        - host: back06.customer.local
        - host: back07.customer.local
        - host: back08.customer.local
        - host: back09.customer.local
          halt: true
        - host: back10.customer.local
          halt: true
    lolek:
        - host: back101.customer.local
        - host: back102.customer.local
        - host: back103.customer.local
        - host: back104.customer.local
        - host: back105.customer.local
        - host: back106.customer.local
        - host: back107.customer.local
        - host: back108.customer.local
        - host: back109.customer.local
          halt: true
        - host: back110.customer.local
          halt: true
head: bolek
super: super.back.customer.local
tail: lolek
';}

		location / {
			proxy_pass http://customer_tail_upstream;
		}
	} # ]]]
	server { # customer.beta.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name customer.beta.local;
		access_log /var/log/nginx/customer.beta.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://customer_beta_upstream;
		}
		location /static/ {
			proxy_pass http://customer_beta_static_upstream;
		}
	} # ]]]
	# end customer ]]]
	# delivery [[[
	server { # delivery.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name delivery.local;
		access_log /var/log/nginx/delivery.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://delivery_head_upstream;
		}
	} # ]]]
	server { # dav.delivery.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name dav.delivery.local;
		access_log /var/log/nginx/dav.delivery.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			return 403;
		}
		location /pup/ {
			root /data/delivery/dav;
			autoindex on;
			autoindex_localtime on;
			create_full_put_path on;
			dav_access user:rw group:r all:r;
			dav_methods COPY DELETE MKCOL MOVE PUT;
		}
	} # ]]]
	server { # tail.delivery.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name tail.delivery.local;
		access_log /var/log/nginx/delivery.tail.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.delivery.local
        - host: back02.delivery.local
        - host: back03.delivery.local
        - host: back04.delivery.local
        - host: back05.delivery.local
        - host: back06.delivery.local
          halt: true
        - host: back07.delivery.local
          halt: true
        - host: back08.delivery.local
          halt: true
        - host: back09.delivery.local
          halt: true
        - host: back10.delivery.local
          halt: true
    lolek:
        - host: back101.delivery.local
        - host: back102.delivery.local
        - host: back103.delivery.local
        - host: back104.delivery.local
        - host: back105.delivery.local
        - host: back106.delivery.local
          halt: true
        - host: back107.delivery.local
          halt: true
        - host: back108.delivery.local
          halt: true
        - host: back109.delivery.local
          halt: true
        - host: back110.delivery.local
          halt: true
head: lolek
super: super.back.delivery.local
tail: bolek
';}

		location / {
			proxy_pass http://delivery_tail_upstream;
		}
	} # ]]]
	server { # delivery.by.local [[[
		listen 10.233.32.251:80; # carp251
		listen 10.233.32.252:80; # carp252
		server_name delivery.by.local;
		access_log /var/log/nginx/delivery.by.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://delivery_by_head_upstream;
		}
	} # ]]]
	server { # dav.delivery.by.local [[[
		listen 10.233.32.251:80; # carp251
		listen 10.233.32.252:80; # carp252
		server_name dav.delivery.by.local;
		access_log /var/log/nginx/dav.delivery.by.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			return 403;
		}
		location /pup/ {
			root /data/delivery-by/dav;
			autoindex on;
			autoindex_localtime on;
			create_full_put_path on;
			dav_access user:rw group:r all:r;
			dav_methods COPY DELETE MKCOL MOVE PUT;
		}
	} # ]]]
	server { # tail.delivery.by.local [[[
		listen 10.233.32.251:80; # carp251
		listen 10.233.32.252:80; # carp252
		server_name tail.delivery.by.local;
		access_log /var/log/nginx/delivery.by.tail.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back05.delivery.by.local
        - host: back06.delivery.by.local
    lolek:
        - host: back105.delivery.by.local
        - host: back106.delivery.by.local
head: bolek
super: super.back.delivery.by.local
tail: lolek
';}

		location / {
			proxy_pass http://delivery_by_tail_upstream;
		}
	} # ]]]
	server { # delivery.kz.local [[[
		listen 10.233.32.243:80; # carp243
		listen 10.233.32.244:80; # carp244
		server_name delivery.kz.local;
		access_log /var/log/nginx/delivery.kz.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://delivery_kz_head_upstream;
		}
	} # ]]]
	server { # dav.delivery.kz.local [[[
		listen 10.233.32.243:80; # carp243
		listen 10.233.32.244:80; # carp244
		server_name dav.delivery.kz.local;
		access_log /var/log/nginx/dav.delivery.kz.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			return 403;
		}
		location /pup/ {
			root /data/delivery-kz/dav;
			autoindex on;
			autoindex_localtime on;
			create_full_put_path on;
			dav_access user:rw group:r all:r;
			dav_methods COPY DELETE MKCOL MOVE PUT;
		}
	} # ]]]
	server { # tail.delivery.kz.local [[[
		listen 10.233.32.243:80; # carp243
		listen 10.233.32.244:80; # carp244
		server_name tail.delivery.kz.local;
		access_log /var/log/nginx/delivery.kz.tail.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.delivery.kz.local
          halt: true
        - host: back02.delivery.kz.local
          halt: true
        - host: back03.delivery.kz.local
          halt: true
        - host: back04.delivery.kz.local
          halt: true
        - host: back05.delivery.kz.local
        - host: back06.delivery.kz.local
        - host: back07.delivery.kz.local
          halt: true
        - host: back08.delivery.kz.local
          halt: true
        - host: back09.delivery.kz.local
          halt: true
        - host: back10.delivery.kz.local
          halt: true
    lolek:
        - host: back101.delivery.kz.local
          halt: true
        - host: back102.delivery.kz.local
          halt: true
        - host: back103.delivery.kz.local
          halt: true
        - host: back104.delivery.kz.local
          halt: true
        - host: back105.delivery.kz.local
        - host: back106.delivery.kz.local
        - host: back107.delivery.kz.local
          halt: true
        - host: back108.delivery.kz.local
          halt: true
        - host: back109.delivery.kz.local
          halt: true
        - host: back110.delivery.kz.local
          halt: true
head: bolek
super: super.back.delivery.kz.local
tail: lolek
';}

		location / {
			proxy_pass http://delivery_kz_tail_upstream;
		}
	} # ]]]
	server { # delivery.ua.local [[[
		listen 10.233.32.245:80; # carp245
		listen 10.233.32.246:80; # carp246
		server_name delivery.ua.local;
		access_log /var/log/nginx/delivery.ua.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://delivery_ua_head_upstream;
		}
	} # ]]]
	server { # dav.delivery.ua.local [[[
		listen 10.233.32.245:80; # carp245
		listen 10.233.32.246:80; # carp246
		server_name dav.delivery.ua.local;
		access_log /var/log/nginx/dav.delivery.ua.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			return 403;
		}
		location /pup/ {
			root /data/delivery-ua/dav;
			autoindex on;
			autoindex_localtime on;
			create_full_put_path on;
			dav_access user:rw group:r all:r;
			dav_methods COPY DELETE MKCOL MOVE PUT;
		}
	} # ]]]
	server { # tail.delivery.ua.local [[[
		listen 10.233.32.245:80; # carp245
		listen 10.233.32.246:80; # carp246
		server_name tail.delivery.ua.local;
		access_log /var/log/nginx/delivery.ua.tail.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.delivery.ua.local
          halt: true
        - host: back02.delivery.ua.local
          halt: true
        - host: back03.delivery.ua.local
          halt: true
        - host: back04.delivery.ua.local
          halt: true
        - host: back05.delivery.ua.local
          halt: true
        - host: back06.delivery.ua.local
          halt: true
        - host: back07.delivery.ua.local
        - host: back08.delivery.ua.local
        - host: back09.delivery.ua.local
          halt: true
        - host: back10.delivery.ua.local
          halt: true
    lolek:
        - host: back101.delivery.ua.local
          halt: true
        - host: back102.delivery.ua.local
          halt: true
        - host: back103.delivery.ua.local
          halt: true
        - host: back104.delivery.ua.local
          halt: true
        - host: back105.delivery.ua.local
          halt: true
        - host: back106.delivery.ua.local
          halt: true
        - host: back107.delivery.ua.local
        - host: back108.delivery.ua.local
        - host: back109.delivery.ua.local
          halt: true
        - host: back110.delivery.ua.local
          halt: true
head: bolek
super: super.back.delivery.ua.local
tail: lolek
';}

		location / {
			proxy_pass http://delivery_ua_tail_upstream;
		}
	} # ]]]
	# end delivery ]]]
	# expconfig [[[
	server { # expconfig.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name expconfig.local;
		access_log /var/log/nginx/expconfig.access_log timed;

		proxy_read_timeout  10s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://expconfig_head_upstream;
		}
		location /static/ {
			proxy_pass http://expconfig_media_head_upstream;
		}
	} # ]]]
	server { # tail.expconfig.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name tail.expconfig.local;
		access_log /var/log/nginx/expconfig.tail.access_log timed;

		proxy_read_timeout  10s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: web01.expconfig.local
        - host: web09.expconfig.local
    lolek:
        - host: web101.expconfig.local
        - host: web109.expconfig.local
head: bolek
super: super.web.expconfig.local
tail: lolek
';}

		location / {
			proxy_pass http://expconfig_tail_upstream;
		}
		location /static/ {
			proxy_pass http://expconfig_media_tail_upstream;
		}
	} # ]]]
	# end expconfig ]]]
	# express [[[
	server { # express.master.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name express.master.local;
		access_log /var/log/nginx/express.master.access_log timed;

		# http://jira.bbbaaa.ru/browse/EXPRESS-2921
		proxy_send_timeout    600;
		proxy_read_timeout    600;
		proxy_connect_timeout 600;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://express_master_head_upstream;
		}
		location = /favicon.ico {
			return 404;
		}
	} # ]]]
	server { # tail.express.master.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name tail.express.master.local;
		access_log /var/log/nginx/express.master.tail.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.express.master.local
        - host: back02.express.master.local
        - host: back03.express.master.local
          halt: true
        - host: back04.express.master.local
          halt: true
        - host: back05.express.master.local
          halt: true
        - host: back06.express.master.local
          halt: true
        - host: back07.express.master.local
          halt: true
        - host: back08.express.master.local
          halt: true
        - host: back09.express.master.local
          halt: true
        - host: back10.express.master.local
          halt: true
    lolek:
        - host: back101.express.master.local
        - host: back102.express.master.local
        - host: back103.express.master.local
          halt: true
        - host: back104.express.master.local
          halt: true
        - host: back105.express.master.local
          halt: true
        - host: back106.express.master.local
          halt: true
        - host: back107.express.master.local
          halt: true
        - host: back108.express.master.local
          halt: true
        - host: back109.express.master.local
          halt: true
        - host: back110.express.master.local
          halt: true
head: bolek
super: super.back.express.master.local
tail: lolek
';}

		location / {
			proxy_pass http://express_master_tail_upstream;
		}
		location = /favicon.ico {
			return 404;
		}
	} # ]]]
	# end express ]]]
	# site by [[[
	server { # www.bbbaaa.by [[[
		listen 31.13.33.78:80;       # carp78
		listen 31.13.33.79:80;       # carp79
		listen 10.233.32.251:80;      # carp251
		listen 10.233.32.252:80;      # carp252
		listen 31.13.33.78:443 ssl;  # carp78
		listen 31.13.33.79:443 ssl;  # carp79
		listen 10.233.32.251:443 ssl; # carp251
		listen 10.233.32.252:443 ssl; # carp252
		server_name www.bbbaaa.by;
		access_log /var/log/nginx/bbbaaa.by.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.by.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.by.key;

		set_real_ip_from 10.233.32.0/24;
		# MyraCloud pool
		set_real_ip_from 31.7.176.0/24;
		set_real_ip_from 31.7.184.0/24;
		set_real_ip_from 80.255.12.96/27;
		set_real_ip_from 82.199.130.0/27;
		set_real_ip_from 91.201.214.218;
		set_real_ip_from 93.190.71.0/25;
		set_real_ip_from 109.75.179.0/24;
		set_real_ip_from 109.234.104.192/27;
		set_real_ip_from 141.105.64.0/28;
		set_real_ip_from 158.255.7.192/27;
		set_real_ip_from 178.89.156.96/28;
		set_real_ip_from 195.210.46.68;
		set_real_ip_from 31.130.201.64/27;

		userid_domain  .bbbaaa.by;
		userid_service 1031;
		userid         on;

		ssi on;

		proxy_set_header Host     $host;
		proxy_set_header X-DDoS   $ddos;
		proxy_set_header X-LID    $uid_any;
		proxy_set_header X-Splits banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;

		proxy_set_header X-Forwarded-For      $remote_addr;
		proxy_set_header X-Forwarded-Host     $host;
		proxy_set_header X-Forwarded-Port     $server_port;
		proxy_set_header X-Forwarded-Protocol $detected_protocol;
		proxy_set_header X-Real-IP            $remote_addr;

		proxy_intercept_errors on;

		proxy_cache_key $detected_protocol://site_upstream/v11.10$uri?$norm_args;

		error_page 401 402 404 /err/404.html;
		error_page 403 /err/403.html;
		error_page 500 /err/500.html;
		error_page 502 /err/502.html;
		error_page 503 /err/503.html;
		error_page 504 /err/504.html;

		if ( $arg_split_bbbaaa5 ) {
			set $split_bbbaaa5 $arg_split_bbbaaa5;
		}
		if ( $arg_split_bbbaaa_banner ) {
			set $split_bbbaaa_banner $arg_split_bbbaaa_banner;
		}
		if ( $arg_split_bbbaaa_mobile ) {
			set $split_bbbaaa_mobile $arg_split_bbbaaa_mobile;
		}
		if ( $arg_split_bbbaaa_perm ) {
			set $split_bbbaaa_perm $arg_split_bbbaaa_perm;
		}
		if ( $arg_split_bbbaaa_ranking ) {
			set $split_bbbaaa_ranking $arg_split_bbbaaa_ranking;
		}

		# seo redirect
		if ( $ui2086 ) {
			return 301 $detected_protocol://$host$uri;
		}

		### bs-locations begin ###
		location /bs-click/ {
			proxy_pass http://bs_head_upstream/click/;
		}
		location /bs-hit/ {
			internal;
			error_page 400 401 403 404 500 502 503 504 = @zero;

			proxy_connect_timeout 100ms;
			proxy_read_timeout    200ms;
			proxy_pass_request_headers off;

			proxy_next_upstream   error
			                      timeout
			;

			proxy_set_header  Host                  bs.local;
			proxy_set_header  X-Real-IP             $remote_addr;
			proxy_set_header  X-Forwarded-For       $remote_addr;
			proxy_set_header  X-Forwarded-Host      $host;
			proxy_set_header  X-Forwarded-Port      $server_port;
			proxy_set_header  X-Forwarded-Protocol  $scheme;
			proxy_set_header  X-LID                 $uid_any;
			proxy_set_header  X-Splits              banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header  Referer               $scheme://$http_host$request_uri;
			proxy_set_header  Rereferer             $http_referer;
			proxy_set_header  X-City-ID             $city_id;
			proxy_set_header  X-Region-ID           $region_id;

			proxy_pass http://bs_head_upstream/hit/;
		}
		location /bs-ssi/ {
			internal;
			alias /data/bs/ssi/;
		}
		### bs-locations end   ###
		### sorting-location begin ###
		location = /sf {
			internal;

			log_subrequest on;
			access_log /var/log/nginx/sort.access_log subtimed;

			proxy_connect_timeout 10ms;
			proxy_read_timeout    50ms;

			proxy_pass_request_headers off;

			proxy_set_header Host         sort.local;
			proxy_set_header X-LID        $uid_val;
			proxy_set_header X-Splits     banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header X-URL        $scheme://$host$request_uri;
			# geo
			proxy_set_header X-Geo        $geo;
			proxy_set_header X-City-ID    $city_id;
			proxy_set_header X-Country-ID $country_id;
			proxy_set_header X-Region-ID  $region_id;

			proxy_pass http://sort_head_upstream/mapping/sorting_factor_simple/;
		}
		### sorting-location end   ###
		### uakari-locations begin ###
		location = /uakari-redis {
			internal;
			redis2_connect_timeout 3s;
			redis2_read_timeout    1s;
			redis2_send_timeout    1s;
			redis2_query get $arg_key;
			redis2_pass uakari_redis_upstream;
		}
		location /s/ {
			location /s/ {
				return 404;
			}
			location ~ ^/s/(?<key>[^/]+)$ {
				content_by_lua '
					local res = ngx.location.capture( "/uakari-redis?key=" .. ngx.var["key"] )
					if res.status ~= 200 then
						ngx.status = 500
						ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
					end
					local uri = string.match( res.body, "\\n([^\\n]+)" )
					if not uri then
						ngx.status = 404
						ngx.exit(ngx.HTTP_NOT_FOUND)
					end
					ngx.redirect( "http://" .. ngx.var.host .. uri, 301 )
				';
			}
		}
		### uakari-locations end   ###
		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###
		### whoami-location begin ###
		location = /whoami {

			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###

			ssi off;

			content_by_lua '
							ngx.header.content_type = "text/html"
							local uid_any = ngx.var.uid_any or "Undefined"
							local split_bbbaaa5 = ngx.var.split_bbbaaa5 or "Undefined"
							local split_bbbaaa_banner = ngx.var.split_bbbaaa_banner or "Undefined"
							local split_bbbaaa_mobile = ngx.var.split_bbbaaa_mobile or "Undefined"
							local split_bbbaaa_ranking = ngx.var.split_bbbaaa_ranking or "Undefined"
							local split_bbbaaa_perm = ngx.var.split_bbbaaa_perm or "Undefined"
							local split_madmin = ngx.var.split_madmin or "Undefined"
							ngx.say( "<h4>Parameters</h4><ul>" )
							ngx.say( "<li> lid" .. string.sub(uid_any,4) )
							ngx.say( "<li> split_bbbaaa5=" .. split_bbbaaa5 )
							ngx.say( "<li> split_bbbaaa_banner=" .. split_bbbaaa_banner )
							ngx.say( "<li> split_bbbaaa_mobile=" .. split_bbbaaa_mobile )
							ngx.say( "<li> split_bbbaaa_ranking=" .. split_bbbaaa_ranking  )
							ngx.say( "<li> split_bbbaaa_perm=" .. split_bbbaaa_perm  )
							ngx.say( "<li> split_madmin=" .. split_madmin  )
							ngx.say( "</ul>" )

							ngx.say( "<h4>Your visible cookies</h4><ul>" )
							for x in string.gmatch(ngx.req.get_headers()["cookie"] or "", "[^;]+") do
							    ngx.say(string.format("<li>%s",x))
							end
							ngx.say( "</ul>" )

							local fldr_name = ngx.var.split_dir

							local ssi_file_path = "/data/split/".. fldr_name .. "/" .. split_bbbaaa5 .. "/" .. split_bbbaaa_ranking .. "/" .. split_bbbaaa_mobile .. ".html"
							ngx.say( "<h4> Filepath: " .. ssi_file_path .. "</h4><ul>" )

							local fh = io.open(ssi_file_path)
							if fh then
							    ngx.say( "<plaintext>" )
							    for line in fh:lines() do
							        ngx.say( line )
							    end
							    fh:close()
							end
			';
		}
		### whoami-location end ###
		### z-pass-locations begin ###
		location /z/pass/ {
			internal;
	### proxy-set-headers begin ###
	proxy_set_header  Host                  $host;
	proxy_set_header  X-Real-IP             $remote_addr;
	proxy_set_header  X-Forwarded-For       $remote_addr;
	proxy_set_header  X-Forwarded-Host      $host;
	proxy_set_header  X-Forwarded-Port      $server_port;
	proxy_set_header  X-Forwarded-Protocol  $scheme;
	### proxy-set-headers end ###
			proxy_set_header Connection '';
			proxy_set_header X-CMR      $cookie_LM_REMAIL;
			proxy_set_header X-UID-Got  $uid_got;
			proxy_set_header X-UID-Set  $uid_set;

			proxy_connect_timeout 100ms;
			proxy_send_timeout    100ms;
			proxy_read_timeout    100ms;

			proxy_http_version 1.1;

			error_page 400 401 403 404 500 502 503 504 = @zero;

			location = /z/pass/analytics {
				proxy_pass http://z_analytics_upstream/z;
			}
			location = /z/pass/prism {
				proxy_pass http://z_prism_upstream/z;
			}
		}
		### z-pass-locations end ###
		### zero-location begin ###
		location @zero {
			return 204;
		}
		### zero-locations end  ###

		location = / {
			proxy_pass http://site_by_head_upstream/comingsoon/;
		}
		location / {
			return 302 $scheme://$host/;
		}
		location /subscribe/newsletter/ {
			proxy_pass http://site_by_head_upstream;
		}


#		location / {
#			access_log /var/log/nginx/bbbaaa.by.access_log timeds;
#			access_log /var/log/nginx/bbbaaa.by.misc.access_log timed;
#			proxy_pass http://site_by_head_upstream;
#		}
#		location = / {
#			access_log /var/log/nginx/bbbaaa.by.access_log timeds;
#			access_log /var/log/nginx/bbbaaa.by.index.access_log timedc;
#			proxy_pass http://site_by_head_upstream;
#			proxy_cache_valid 200 5m;
#			proxy_cache pages-by;
#			proxy_cache_key $detected_protocol://site_upstream/v11.10$uri;
#		}
#		location /action/ {
#			include 'templates/nginx/frontXX/inc/sorting.rewrite.conf'
#			access_log /var/log/nginx/bbbaaa.by.access_log timeds;
#			access_log /var/log/nginx/bbbaaa.by.catalog.access_log timedc;
#			proxy_pass http://site_by_head_upstream;
#			proxy_cache_key $detected_protocol://site_upstream/v11.10$uri?$norm_args:sf=$sf;
#			proxy_cache_valid 200 10m;
#			proxy_cache catalog-by;
#		}
		location = /apple-touch-icon.png {
			access_log /var/log/nginx/bbbaaa.by.static.access_log timed;
			root /data/site-by/misc;
		}
		location = /apple-touch-icon-72x72.png {
			access_log /var/log/nginx/bbbaaa.by.static.access_log timed;
			root /data/site-by/misc;
		}
		location = /apple-touch-icon-72x72-precomposed.png {
			access_log /var/log/nginx/bbbaaa.by.static.access_log timed;
			root /data/site-by/misc;
		}
		location = /apple-touch-icon-76x76.png {
			access_log /var/log/nginx/bbbaaa.by.static.access_log timed;
			root /data/site-by/misc;
		}
		location = /apple-touch-icon-76x76-precomposed.png {
			access_log /var/log/nginx/bbbaaa.by.static.access_log timed;
			root /data/site-by/misc;
		}
		location = /apple-touch-icon-114x114.png {
			access_log /var/log/nginx/bbbaaa.by.static.access_log timed;
			root /data/site-by/misc;
		}
		location = /apple-touch-icon-114x114-precomposed.png {
			access_log /var/log/nginx/bbbaaa.by.static.access_log timed;
			root /data/site-by/misc;
		}
		location = /apple-touch-icon-120x120.png {
			access_log /var/log/nginx/bbbaaa.by.static.access_log timed;
			root /data/site-by/misc;
		}
		location = /apple-touch-icon-120x120-precomposed.png {
			access_log /var/log/nginx/bbbaaa.by.static.access_log timed;
			root /data/site-by/misc;
		}
		location = /apple-touch-icon-144x144.png {
			access_log /var/log/nginx/bbbaaa.by.static.access_log timed;
			root /data/site-by/misc;
		}
		location = /apple-touch-icon-144x144-precomposed.png {
			access_log /var/log/nginx/bbbaaa.by.static.access_log timed;
			root /data/site-by/misc;
		}
		location = /apple-touch-icon-152x152-precomposed.png {
			access_log /var/log/nginx/bbbaaa.by.static.access_log timed;
			alias /data/site-by/misc/apple-touch-icon-precomposed.png;
		}
		location = /apple-touch-icon-precomposed.png {
			access_log /var/log/nginx/bbbaaa.by.static.access_log timed;
			root /data/site-by/misc;
		}
#		location /b/ {
#			include 'templates/nginx/frontXX/inc/sorting.rewrite.conf'
#			access_log /var/log/nginx/bbbaaa.by.access_log timeds;
#			access_log /var/log/nginx/bbbaaa.by.catalog.access_log timed;
#			proxy_pass http://site_by_head_upstream;
#			proxy_cache_key $detected_protocol://site_upstream/v11.10$uri?$norm_args:sf=$sf;
#			proxy_cache_valid 200 10m;
#			proxy_cache catalog-by;
#		}
#		location /brands/ {
#			access_log /var/log/nginx/bbbaaa.by.access_log timeds;
#			access_log /var/log/nginx/bbbaaa.by.pages.access_log timedc;
#			proxy_pass http://site_by_head_upstream;
#			proxy_cache_valid 200 3h;
#			proxy_cache pages-by;
#		}
#		location /c/ {
#			include 'templates/nginx/frontXX/inc/sorting.rewrite.conf'
#			access_log /var/log/nginx/bbbaaa.by.access_log timeds;
#			access_log /var/log/nginx/bbbaaa.by.catalog.access_log timedc;
#			proxy_pass http://site_by_head_upstream;
#			proxy_cache_key $detected_protocol://site_upstream/v11.10$uri?$norm_args:sf=$sf;
#			proxy_cache_valid 200 10m;
#			proxy_cache catalog-by;
#		}
#		location /cart/ {
#			access_log /var/log/nginx/bbbaaa.by.access_log timeds;
#			access_log /var/log/nginx/bbbaaa.by.cart-actions.access_log timed;
#			proxy_pass http://site_by_head_upstream;
#		}
#		location /catalogsearch/suggest/ {
#			access_log /var/log/nginx/bbbaaa.by.access_log timeds;
#			access_log /var/log/nginx/bbbaaa.by.suggest.access_log timed;
#			proxy_pass http://site_by_head_upstream;
#			proxy_cache_valid 200 1d;
#			proxy_cache suggest-by;
#		}
#		location /cb/ {
#			access_log /var/log/nginx/bbbaaa.by.access_log timeds;
#			access_log /var/log/nginx/bbbaaa.by.catalog.access_log timedc;
#			proxy_pass http://site_by_head_upstream;
#			proxy_cache_valid 200 10m;
#			proxy_cache catalog-by;
#		}
#		location /checkout/ {
#			access_log /var/log/nginx/bbbaaa.by.access_log timeds;
#			access_log /var/log/nginx/bbbaaa.by.checkout.access_log timed;
#			proxy_pass http://site_by_head_upstream;
#		}
#		location /checkout/cart/ {
#			access_log /var/log/nginx/bbbaaa.by.access_log timeds;
#			access_log /var/log/nginx/bbbaaa.by.cart.access_log timed;
#			proxy_pass http://site_by_head_upstream;
#		}
		location /e/pup/ {
			alias /data/delivery/dav-by/pup/;
			access_log /var/log/nginx/bbbaaa.by.static.access_log timed;
		}
		location /e/refund/ {
			alias /data/bob/dav-by/refund/;
			access_log /var/log/nginx/bbbaaa.by.static.access_log timed;
		}
		location /err/ {
			internal;
			alias /data/site-by/misc/;
		}
		location = /favicon.ico {
			access_log /var/log/nginx/bbbaaa.by.static.access_log timed;
			root /data/site-by/misc;
		}
		location /files/ {
			access_log /var/log/nginx/bbbaaa.by.static.access_log timed;
			root /data/site-by/misc;
		}
		location /flat/ {
			access_log off;
						### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://site_by_head_upstream;
		}
		location /landing/ {
			access_log /var/log/nginx/bbbaaa.by.access_log timeds;
			access_log /var/log/nginx/bbbaaa.by.pages.access_log timed;
			proxy_pass http://site_by_head_upstream;
			proxy_cache_valid 200 3h;
			proxy_cache pages-by;
		}
		location = /localstorage.html {
			access_log /var/log/nginx/bbbaaa.by.static.access_log timed;
			root /data/site-by/misc;
		}
		location = /nt {
			access_log /var/log/nginx/bbbaaa.by.nt.access_log timed;
			return 204;
		}
#		location /p/ {
#			access_log /var/log/nginx/bbbaaa.by.access_log timeds;
#			access_log /var/log/nginx/bbbaaa.by.product.access_log timedc;
#			proxy_pass http://site_by_head_upstream;
#			proxy_cache_valid 200 6h;
#			proxy_cache product-by;
#		}
#		location /p/quick/ {
#			access_log /var/log/nginx/bbbaaa.by.access_log timeds;
#			access_log /var/log/nginx/bbbaaa.by.quickview.access_log timedc;
#			proxy_pass http://site_by_head_upstream;
#			proxy_cache_valid 200 6h;
#			proxy_cache quick-by;
#		}
		location = /robots.txt {
			access_log /var/log/nginx/bbbaaa.by.static.access_log timed;
			root /data/site-by/misc;
		}
		location /sitemap/ {
			access_log /var/log/nginx/bbbaaa.by.static.access_log timed;
			alias /data/site-by/map/;
		}
		location = /sitemap.xml {
			access_log /var/log/nginx/bbbaaa.by.static.access_log timed;
			root /data/site-by/map;
		}
		location = /social-logo.jpg {
			access_log /var/log/nginx/bbbaaa.by.static.access_log timed;
			root /data/site-by/misc;
		}
		location /ssi/ {
			internal;
			log_subrequest on;
			error_page 400 401 403 404 500 502 503 504 = @zero;
			proxy_cache_key $scheme://site_upstream/v11.10$uri$is_args$args;
			proxy_pass http://site_by_head_upstream;
			access_log /var/log/nginx/bbbaaa.by.ssi.access_log subtimed;

			location /ssi/comments/ {
				proxy_pass http://site_by_head_upstream;
				access_log /var/log/nginx/bbbaaa.by.ssi.comments.access_log subtimed;
			}
			location = /ssi/exp.html {
				alias /data/split/${split_dir}/${split_bbbaaa5}/${split_bbbaaa_ranking}/${split_bbbaaa_mobile}.html;
				access_log /var/log/nginx/bbbaaa.by.ssi.exp.access_log subtimed;
			}
			location /ssi/menu/ {
				proxy_pass http://site_by_head_upstream;
				access_log /var/log/nginx/bbbaaa.by.ssi.menu.access_log subtimedc;
				proxy_cache_valid 200 3h;
				proxy_cache ssi-menu-by;
			}
			location /ssi/recommend/ {
				proxy_pass http://site_by_head_upstream;
				access_log /var/log/nginx/bbbaaa.by.ssi.recommend.access_log subtimed;
				proxy_cache_valid 200 5m;
				proxy_cache ssi-recommend-by;
			}
			location = /ssi/recommend/product-product {
				proxy_pass http://site_by_head_upstream;
				access_log /var/log/nginx/bbbaaa.by.ssi.recommend.access_log subtimed;
			}
			location = /ssi/recommend/topsellers {
				proxy_pass http://site_by_head_upstream;
				access_log /var/log/nginx/bbbaaa.by.ssi.recommend.access_log subtimed;
			}
			location /ssi/sizes/ {
				proxy_pass http://site_by_head_upstream;
				access_log /var/log/nginx/bbbaaa.by.ssi.sizes.access_log subtimedc;
				proxy_cache_valid 200 1m;
				proxy_cache ssi-sizes-by;
			}
			location /ssi/userdata/ {
				proxy_pass http://site_by_head_upstream;
				access_log /var/log/nginx/bbbaaa.by.ssi.userdata.access_log subtimed;
			}
		}
		location /static/ {
			access_log /var/log/nginx/bbbaaa.by.static.access_log timed;
			alias /data/site-by/static/;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
			error_page  404 = @static-proxy;
		}
		location @static-proxy {
			proxy_pass http://site_by_head_static_upstream;
			access_log /var/log/nginx/bbbaaa.static-proxy.access_log timeds;
		}
		location = /yandex_585dac57c384c42f.txt {
			return 200 ' ';
		}
		location = /z {
			access_log /var/log/nginx/bbbaaa.by.z.access_log timeds;
			content_by_lua '
				ngx.location.capture_multi({ {"/z/pass/analytics",{args = ngx.req.get_uri_args()}},{"/z/pass/prism",{args = ngx.req.get_uri_args()}} })
				ngx.status = 204;
			';
		}
	} # ]]]
	server { # tail.bbbaaa.by [[[
		listen 10.233.32.251:80; # carp251
		listen 10.233.32.252:80; # carp252
		listen 10.233.32.251:443 ssl;
		listen 10.233.32.252:443 ssl;
		server_name tail.bbbaaa.by;
		access_log /var/log/nginx/bbbaaa.by.tail.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.by.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.by.key;

		userid_domain  .bbbaaa.by;
		userid_service 1028;
		userid         on;

		ssi on;

		proxy_set_header Host     $host;
		proxy_set_header X-DDoS   $ddos;
		proxy_set_header X-LID    $uid_any;
		proxy_set_header X-Splits banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;

		proxy_set_header X-Forwarded-For      $remote_addr;
		proxy_set_header X-Forwarded-Host     $host;
		proxy_set_header X-Forwarded-Port     $server_port;
		proxy_set_header X-Forwarded-Protocol $detected_protocol;
		proxy_set_header X-Real-IP            $remote_addr;

		proxy_intercept_errors on;

		error_page 401 402 404 /err/404.html;
		error_page 403 /err/403.html;
		error_page 500 /err/500.html;
		error_page 502 /err/502.html;
		error_page 503 /err/503.html;
		error_page 504 /err/504.html;

		if ( $arg_split_bbbaaa5 ) {
			set $split_bbbaaa5 $arg_split_bbbaaa5;
		}
		if ( $arg_split_bbbaaa_banner ) {
			set $split_bbbaaa_banner $arg_split_bbbaaa_banner;
		}
		if ( $arg_split_bbbaaa_mobile ) {
			set $split_bbbaaa_mobile $arg_split_bbbaaa_mobile;
		}
		if ( $arg_split_bbbaaa_perm ) {
			set $split_bbbaaa_perm $arg_split_bbbaaa_perm;
		}
		if ( $arg_split_bbbaaa_ranking ) {
			set $split_bbbaaa_ranking $arg_split_bbbaaa_ranking;
		}

		# seo redirect
		if ( $ui2086 ) {
			return 301 $detected_protocol://$host$uri;
		}

		### bs-locations begin ###
		location /bs-click/ {
			proxy_pass http://bs_head_upstream/click/;
		}
		location /bs-hit/ {
			internal;
			error_page 400 401 403 404 500 502 503 504 = @zero;

			proxy_connect_timeout 100ms;
			proxy_read_timeout    200ms;
			proxy_pass_request_headers off;

			proxy_next_upstream   error
			                      timeout
			;

			proxy_set_header  Host                  bs.local;
			proxy_set_header  X-Real-IP             $remote_addr;
			proxy_set_header  X-Forwarded-For       $remote_addr;
			proxy_set_header  X-Forwarded-Host      $host;
			proxy_set_header  X-Forwarded-Port      $server_port;
			proxy_set_header  X-Forwarded-Protocol  $scheme;
			proxy_set_header  X-LID                 $uid_any;
			proxy_set_header  X-Splits              banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header  Referer               $scheme://$http_host$request_uri;
			proxy_set_header  Rereferer             $http_referer;
			proxy_set_header  X-City-ID             $city_id;
			proxy_set_header  X-Region-ID           $region_id;

			proxy_pass http://bs_head_upstream/hit/;
		}
		location /bs-ssi/ {
			internal;
			alias /data/bs/ssi/;
		}
		### bs-locations end   ###
		### sorting-location begin ###
		location = /sf {
			internal;

			log_subrequest on;
			access_log /var/log/nginx/sort.access_log subtimed;

			proxy_connect_timeout 10ms;
			proxy_read_timeout    50ms;

			proxy_pass_request_headers off;

			proxy_set_header Host         sort.local;
			proxy_set_header X-LID        $uid_val;
			proxy_set_header X-Splits     banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header X-URL        $scheme://$host$request_uri;
			# geo
			proxy_set_header X-Geo        $geo;
			proxy_set_header X-City-ID    $city_id;
			proxy_set_header X-Country-ID $country_id;
			proxy_set_header X-Region-ID  $region_id;

			proxy_pass http://sort_head_upstream/mapping/sorting_factor_simple/;
		}
		### sorting-location end   ###
		### uakari-locations begin ###
		location = /uakari-redis {
			internal;
			redis2_connect_timeout 3s;
			redis2_read_timeout    1s;
			redis2_send_timeout    1s;
			redis2_query get $arg_key;
			redis2_pass uakari_redis_upstream;
		}
		location /s/ {
			location /s/ {
				return 404;
			}
			location ~ ^/s/(?<key>[^/]+)$ {
				content_by_lua '
					local res = ngx.location.capture( "/uakari-redis?key=" .. ngx.var["key"] )
					if res.status ~= 200 then
						ngx.status = 500
						ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
					end
					local uri = string.match( res.body, "\\n([^\\n]+)" )
					if not uri then
						ngx.status = 404
						ngx.exit(ngx.HTTP_NOT_FOUND)
					end
					ngx.redirect( "http://" .. ngx.var.host .. uri, 301 )
				';
			}
		}
		### uakari-locations end   ###
		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###
		### whoami-location begin ###
		location = /whoami {

			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###

			ssi off;

			content_by_lua '
							ngx.header.content_type = "text/html"
							local uid_any = ngx.var.uid_any or "Undefined"
							local split_bbbaaa5 = ngx.var.split_bbbaaa5 or "Undefined"
							local split_bbbaaa_banner = ngx.var.split_bbbaaa_banner or "Undefined"
							local split_bbbaaa_mobile = ngx.var.split_bbbaaa_mobile or "Undefined"
							local split_bbbaaa_ranking = ngx.var.split_bbbaaa_ranking or "Undefined"
							local split_bbbaaa_perm = ngx.var.split_bbbaaa_perm or "Undefined"
							local split_madmin = ngx.var.split_madmin or "Undefined"
							ngx.say( "<h4>Parameters</h4><ul>" )
							ngx.say( "<li> lid" .. string.sub(uid_any,4) )
							ngx.say( "<li> split_bbbaaa5=" .. split_bbbaaa5 )
							ngx.say( "<li> split_bbbaaa_banner=" .. split_bbbaaa_banner )
							ngx.say( "<li> split_bbbaaa_mobile=" .. split_bbbaaa_mobile )
							ngx.say( "<li> split_bbbaaa_ranking=" .. split_bbbaaa_ranking  )
							ngx.say( "<li> split_bbbaaa_perm=" .. split_bbbaaa_perm  )
							ngx.say( "<li> split_madmin=" .. split_madmin  )
							ngx.say( "</ul>" )

							ngx.say( "<h4>Your visible cookies</h4><ul>" )
							for x in string.gmatch(ngx.req.get_headers()["cookie"] or "", "[^;]+") do
							    ngx.say(string.format("<li>%s",x))
							end
							ngx.say( "</ul>" )

							local fldr_name = ngx.var.split_dir

							local ssi_file_path = "/data/split/".. fldr_name .. "/" .. split_bbbaaa5 .. "/" .. split_bbbaaa_ranking .. "/" .. split_bbbaaa_mobile .. ".html"
							ngx.say( "<h4> Filepath: " .. ssi_file_path .. "</h4><ul>" )

							local fh = io.open(ssi_file_path)
							if fh then
							    ngx.say( "<plaintext>" )
							    for line in fh:lines() do
							        ngx.say( line )
							    end
							    fh:close()
							end
			';
		}
		### whoami-location end ###
		### z-pass-locations begin ###
		location /z/pass/ {
			internal;
	### proxy-set-headers begin ###
	proxy_set_header  Host                  $host;
	proxy_set_header  X-Real-IP             $remote_addr;
	proxy_set_header  X-Forwarded-For       $remote_addr;
	proxy_set_header  X-Forwarded-Host      $host;
	proxy_set_header  X-Forwarded-Port      $server_port;
	proxy_set_header  X-Forwarded-Protocol  $scheme;
	### proxy-set-headers end ###
			proxy_set_header Connection '';
			proxy_set_header X-CMR      $cookie_LM_REMAIL;
			proxy_set_header X-UID-Got  $uid_got;
			proxy_set_header X-UID-Set  $uid_set;

			proxy_connect_timeout 100ms;
			proxy_send_timeout    100ms;
			proxy_read_timeout    100ms;

			proxy_http_version 1.1;

			error_page 400 401 403 404 500 502 503 504 = @zero;

			location = /z/pass/analytics {
				proxy_pass http://z_analytics_upstream/z;
			}
			location = /z/pass/prism {
				proxy_pass http://z_prism_upstream/z;
			}
		}
		### z-pass-locations end ###
		### zero-location begin ###
		location @zero {
			return 204;
		}
		### zero-locations end  ###
		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back07.site.by.local
        - host: back08.site.by.local
    lolek:
        - host: back107.site.by.local
        - host: back108.site.by.local
head: lolek
super: super.back.site.by.local
tail: bolek
';}

		location = / {
			proxy_pass http://site_by_tail_upstream/comingsoon/;
		}
		location / {
			return 302 $scheme://$host/;
		}
		location /subscribe/newsletter/ {
			proxy_pass http://site_by_tail_upstream;
		}

#		location / {
#			access_log /var/log/nginx/bbbaaa.by.tail.access_log timeds;
#			proxy_pass http://site_by_tail_upstream;
#		}
#		location = / {
#			access_log /var/log/nginx/bbbaaa.by.tail.access_log timeds;
#			proxy_pass http://site_by_tail_upstream;
#		}
#		location /action/ {
#			include 'templates/nginx/frontXX/inc/sorting.rewrite.conf'
#			access_log /var/log/nginx/bbbaaa.by.tail.access_log timeds;
#			proxy_pass http://site_by_tail_upstream;
#		}
		location = /apple-touch-icon.png {
			access_log /var/log/nginx/bbbaaa.by.tail.static.access_log timed;
			root /data/site-by/misc;
		}
		location = /apple-touch-icon-72x72.png {
			access_log /var/log/nginx/bbbaaa.by.tail.static.access_log timed;
			root /data/site-by/misc;
		}
		location = /apple-touch-icon-72x72-precomposed.png {
			access_log /var/log/nginx/bbbaaa.by.tail.static.access_log timed;
			root /data/site-by/misc;
		}
		location = /apple-touch-icon-76x76.png {
			access_log /var/log/nginx/bbbaaa.by.tail.static.access_log timed;
			root /data/site-by/misc;
		}
		location = /apple-touch-icon-76x76-precomposed.png {
			access_log /var/log/nginx/bbbaaa.by.tail.static.access_log timed;
			root /data/site-by/misc;
		}
		location = /apple-touch-icon-114x114.png {
			access_log /var/log/nginx/bbbaaa.by.tail.static.access_log timed;
			root /data/site-by/misc;
		}
		location = /apple-touch-icon-114x114-precomposed.png {
			access_log /var/log/nginx/bbbaaa.by.tail.static.access_log timed;
			root /data/site-by/misc;
		}
		location = /apple-touch-icon-120x120.png {
			access_log /var/log/nginx/bbbaaa.by.tail.static.access_log timed;
			root /data/site-by/misc;
		}
		location = /apple-touch-icon-120x120-precomposed.png {
			access_log /var/log/nginx/bbbaaa.by.tail.static.access_log timed;
			root /data/site-by/misc;
		}
		location = /apple-touch-icon-144x144.png {
			access_log /var/log/nginx/bbbaaa.by.tail.static.access_log timed;
			root /data/site-by/misc;
		}
		location = /apple-touch-icon-144x144-precomposed.png {
			access_log /var/log/nginx/bbbaaa.by.tail.static.access_log timed;
			root /data/site-by/misc;
		}
		location = /apple-touch-icon-152x152-precomposed.png {
			access_log /var/log/nginx/bbbaaa.by.tail.static.access_log timed;
			alias /data/site-by/misc/apple-touch-icon-precomposed.png;
		}
		location = /apple-touch-icon-precomposed.png {
			access_log /var/log/nginx/bbbaaa.by.tail.static.access_log timed;
			root /data/site-by/misc;
		}
#		location /b/ {
#			include 'templates/nginx/frontXX/inc/sorting.rewrite.conf'
#			proxy_pass http://site_by_tail_upstream;
#		}
#		location /brands/ {
#			proxy_pass http://site_by_tail_upstream;
#		}
#		location /c/ {
#			include 'templates/nginx/frontXX/inc/sorting.rewrite.conf'
#			proxy_pass http://site_by_tail_upstream;
#		}
#		location /cart/ {
#			proxy_pass http://site_by_tail_upstream;
#		}
#		location /catalogsearch/suggest/ {
#			proxy_pass http://site_by_tail_upstream;
#		}
#		location /cb/ {
#			proxy_pass http://site_by_tail_upstream;
#		}
#		location /checkout/ {
#			proxy_pass http://site_by_tail_upstream;
#		}
#		location /checkout/cart/ {
#			proxy_pass http://site_by_tail_upstream;
#		}
		location /e/pup/ {
			alias /data/delivery/dav-by/pup/;
			access_log /var/log/nginx/bbbaaa.by.tail.static.access_log timed;
		}
		location /e/refund/ {
			alias /data/bob/dav-by/refund/;
			access_log /var/log/nginx/bbbaaa.by.tail.static.access_log timed;
		}
		location /err/ {
			internal;
			alias /data/site-by/misc/;
		}
		location = /favicon.ico {
			access_log /var/log/nginx/bbbaaa.by.tail.static.access_log timed;
			root /data/site-by/misc;
		}
		location /files/ {
			access_log /var/log/nginx/bbbaaa.by.tail.static.access_log timed;
			root /data/site-by/misc;
		}
		location /flat/ {
			access_log off;
						### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://site_by_tail_upstream;
		}
		location /landing/ {
			proxy_pass http://site_by_tail_upstream;
		}
		location = /localstorage.html {
			access_log /var/log/nginx/bbbaaa.by.tail.static.access_log timed;
			root /data/site-by/misc;
		}
		location = /nt {
			access_log /var/log/nginx/bbbaaa.by.tail.nt.access_log timed;
			return 204;
		}
#		location /p/ {
#			proxy_pass http://site_by_tail_upstream;
#		}
#		location /p/quick/ {
#			proxy_pass http://site_by_tail_upstream;
#		}
		location = /robots.txt {
			access_log /var/log/nginx/bbbaaa.by.tail.static.access_log timed;
			root /data/site-by/misc;
		}
		location /sitemap/ {
			access_log /var/log/nginx/bbbaaa.by.tail.static.access_log timed;
			alias /data/site-by/map/;
		}
		location = /sitemap.xml {
			access_log /var/log/nginx/bbbaaa.by.tail.static.access_log timed;
			root /data/site-by/map;
		}
		location = /social-logo.jpg {
			access_log /var/log/nginx/bbbaaa.by.tail.static.access_log timed;
			root /data/site-by/misc;
		}
		location /ssi/ {
			internal;
			log_subrequest on;
			error_page 400 401 403 404 500 502 503 504 = @zero;
			proxy_pass http://site_by_tail_upstream;
			access_log /var/log/nginx/bbbaaa.by.tail.ssi.access_log subtimed;

			location /ssi/comments/ {
				proxy_pass http://site_by_tail_upstream;
			}
			location = /ssi/exp.html {
				alias /data/split/${split_dir}/${split_bbbaaa5}/${split_bbbaaa_ranking}/${split_bbbaaa_mobile}.html;
			}
			location /ssi/menu/ {
				proxy_pass http://site_by_tail_upstream;
			}
			location /ssi/recommend/ {
				proxy_pass http://site_by_tail_upstream;
			}
			location = /ssi/recommend/product-product {
				proxy_pass http://site_by_tail_upstream;
			}
			location = /ssi/recommend/topsellers {
				proxy_pass http://site_by_tail_upstream;
			}
			location /ssi/sizes/ {
				proxy_pass http://site_by_tail_upstream;
			}
			location /ssi/userdata/ {
				proxy_pass http://site_by_tail_upstream;
			}
		}
		location /static/ {
			access_log /var/log/nginx/bbbaaa.by.tail.static.access_log timed;
			alias /data/site-by/static/;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
			error_page  404 = @static-proxy;
		}
		location @static-proxy {
			proxy_pass http://site_by_tail_static_upstream;
			access_log /var/log/nginx/bbbaaa.static-proxy.access_log timeds;
		}
		location = /yandex_585dac57c384c42f.txt {
			return 200 ' ';
		}
		location = /z {
			access_log /var/log/nginx/bbbaaa.by.tail.static.access_log timeds;
			content_by_lua '
				ngx.location.capture_multi({ {"/z/pass/analytics",{args = ngx.req.get_uri_args()}},{"/z/pass/prism",{args = ngx.req.get_uri_args()}} })
				ngx.status = 204;
			';
		}
	} # ]]]
	# end site by ]]]
	# site kz [[[
	server { # bbbaaa.kz [[[
		listen 31.13.33.72:80; # carp72
		listen 31.13.33.73:80; # carp73
		listen 10.233.32.243:80; # carp243
		listen 10.233.32.244:80; # carp244
		listen 31.13.33.72:443 ssl;
		listen 31.13.33.73:443 ssl;
		listen 10.233.32.243:443 ssl;
		listen 10.233.32.244:443 ssl;
		server_name bbbaaa.kz;
		access_log /var/log/nginx/bbbaaa.kz.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.kz.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.kz.key;

		return 301 $detected_protocol://www.bbbaaa.kz$request_uri;
	} # ]]]
	server { # www.bbbaaa.kz [[[
		listen 31.13.33.72:80; # carp72
		listen 31.13.33.73:80; # carp73
		listen 10.233.32.243:80; # carp243
		listen 10.233.32.244:80; # carp244
		listen 31.13.33.72:443 ssl;
		listen 31.13.33.73:443 ssl;
		listen 10.233.32.243:443 ssl;
		listen 10.233.32.244:443 ssl;
		server_name www.bbbaaa.kz;
		access_log /var/log/nginx/bbbaaa.kz.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.kz.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.kz.key;

		set_real_ip_from 10.233.32.0/24;
		# MyraCloud pool
		set_real_ip_from 31.7.176.0/24;
		set_real_ip_from 31.7.184.0/24;
		set_real_ip_from 80.255.12.96/27;
		set_real_ip_from 82.199.130.0/27;
		set_real_ip_from 91.201.214.218;
		set_real_ip_from 93.190.71.0/25;
		set_real_ip_from 109.75.179.0/24;
		set_real_ip_from 109.234.104.192/27;
		set_real_ip_from 141.105.64.0/28;
		set_real_ip_from 158.255.7.192/27;
		set_real_ip_from 178.89.156.96/28;
		set_real_ip_from 195.210.46.68;
		set_real_ip_from 31.130.201.64/27;

		userid_domain  .bbbaaa.kz;
		userid_service 1028;
		userid         on;

		ssi on;

		proxy_set_header Host     $host;
		proxy_set_header X-DDoS   $ddos;
		proxy_set_header X-LID    $uid_any;
		proxy_set_header X-Splits banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;

		proxy_set_header X-Forwarded-For      $remote_addr;
		proxy_set_header X-Forwarded-Host     $host;
		proxy_set_header X-Forwarded-Port     $server_port;
		proxy_set_header X-Forwarded-Protocol $detected_protocol;
		proxy_set_header X-Real-IP            $remote_addr;

		proxy_intercept_errors on;

		proxy_cache_key $detected_protocol://site_upstream/v11.11$uri?$norm_args;

		error_page 401 402 404 /err/404.html;
		error_page 403 /err/403.html;
		error_page 500 /err/500.html;
		error_page 502 /err/502.html;
		error_page 503 /err/503.html;
		error_page 504 /err/504.html;

		if ( $arg_split_bbbaaa5 ) {
			set $split_bbbaaa5 $arg_split_bbbaaa5;
		}
		if ( $arg_split_bbbaaa_banner ) {
			set $split_bbbaaa_banner $arg_split_bbbaaa_banner;
		}
		if ( $arg_split_bbbaaa_mobile ) {
			set $split_bbbaaa_mobile $arg_split_bbbaaa_mobile;
		}
		if ( $arg_split_bbbaaa_perm ) {
			set $split_bbbaaa_perm $arg_split_bbbaaa_perm;
		}
		if ( $arg_split_bbbaaa_ranking ) {
			set $split_bbbaaa_ranking $arg_split_bbbaaa_ranking;
		}

		# mobile site redirect
		add_header Set-Cookie $mobile_cookie_kz;
		if ( $mobile_site = 1 ) {
			return 302 $detected_protocol://m.bbbaaa.kz$request_uri;
		}

		# seo redirect
		if ( $ui2086 ) {
			return 301 $detected_protocol://$host$uri;
		}

		### bs-locations begin ###
		location /bs-click/ {
			proxy_pass http://bs_head_upstream/click/;
		}
		location /bs-hit/ {
			internal;
			error_page 400 401 403 404 500 502 503 504 = @zero;

			proxy_connect_timeout 100ms;
			proxy_read_timeout    200ms;
			proxy_pass_request_headers off;

			proxy_next_upstream   error
			                      timeout
			;

			proxy_set_header  Host                  bs.local;
			proxy_set_header  X-Real-IP             $remote_addr;
			proxy_set_header  X-Forwarded-For       $remote_addr;
			proxy_set_header  X-Forwarded-Host      $host;
			proxy_set_header  X-Forwarded-Port      $server_port;
			proxy_set_header  X-Forwarded-Protocol  $scheme;
			proxy_set_header  X-LID                 $uid_any;
			proxy_set_header  X-Splits              banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header  Referer               $scheme://$http_host$request_uri;
			proxy_set_header  Rereferer             $http_referer;
			proxy_set_header  X-City-ID             $city_id;
			proxy_set_header  X-Region-ID           $region_id;

			proxy_pass http://bs_head_upstream/hit/;
		}
		location /bs-ssi/ {
			internal;
			alias /data/bs/ssi/;
		}
		### bs-locations end   ###
		### sorting-location begin ###
		location = /sf {
			internal;

			log_subrequest on;
			access_log /var/log/nginx/sort.access_log subtimed;

			proxy_connect_timeout 10ms;
			proxy_read_timeout    50ms;

			proxy_pass_request_headers off;

			proxy_set_header Host         sort.local;
			proxy_set_header X-LID        $uid_val;
			proxy_set_header X-Splits     banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header X-URL        $scheme://$host$request_uri;
			# geo
			proxy_set_header X-Geo        $geo;
			proxy_set_header X-City-ID    $city_id;
			proxy_set_header X-Country-ID $country_id;
			proxy_set_header X-Region-ID  $region_id;

			proxy_pass http://sort_head_upstream/mapping/sorting_factor_simple/;
		}
		### sorting-location end   ###
		### uakari-locations begin ###
		location = /uakari-redis {
			internal;
			redis2_connect_timeout 3s;
			redis2_read_timeout    1s;
			redis2_send_timeout    1s;
			redis2_query get $arg_key;
			redis2_pass uakari_redis_upstream;
		}
		location /s/ {
			location /s/ {
				return 404;
			}
			location ~ ^/s/(?<key>[^/]+)$ {
				content_by_lua '
					local res = ngx.location.capture( "/uakari-redis?key=" .. ngx.var["key"] )
					if res.status ~= 200 then
						ngx.status = 500
						ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
					end
					local uri = string.match( res.body, "\\n([^\\n]+)" )
					if not uri then
						ngx.status = 404
						ngx.exit(ngx.HTTP_NOT_FOUND)
					end
					ngx.redirect( "http://" .. ngx.var.host .. uri, 301 )
				';
			}
		}
		### uakari-locations end   ###
		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###
		### whoami-location begin ###
		location = /whoami {

			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###

			ssi off;

			content_by_lua '
							ngx.header.content_type = "text/html"
							local uid_any = ngx.var.uid_any or "Undefined"
							local split_bbbaaa5 = ngx.var.split_bbbaaa5 or "Undefined"
							local split_bbbaaa_banner = ngx.var.split_bbbaaa_banner or "Undefined"
							local split_bbbaaa_mobile = ngx.var.split_bbbaaa_mobile or "Undefined"
							local split_bbbaaa_ranking = ngx.var.split_bbbaaa_ranking or "Undefined"
							local split_bbbaaa_perm = ngx.var.split_bbbaaa_perm or "Undefined"
							local split_madmin = ngx.var.split_madmin or "Undefined"
							ngx.say( "<h4>Parameters</h4><ul>" )
							ngx.say( "<li> lid" .. string.sub(uid_any,4) )
							ngx.say( "<li> split_bbbaaa5=" .. split_bbbaaa5 )
							ngx.say( "<li> split_bbbaaa_banner=" .. split_bbbaaa_banner )
							ngx.say( "<li> split_bbbaaa_mobile=" .. split_bbbaaa_mobile )
							ngx.say( "<li> split_bbbaaa_ranking=" .. split_bbbaaa_ranking  )
							ngx.say( "<li> split_bbbaaa_perm=" .. split_bbbaaa_perm  )
							ngx.say( "<li> split_madmin=" .. split_madmin  )
							ngx.say( "</ul>" )

							ngx.say( "<h4>Your visible cookies</h4><ul>" )
							for x in string.gmatch(ngx.req.get_headers()["cookie"] or "", "[^;]+") do
							    ngx.say(string.format("<li>%s",x))
							end
							ngx.say( "</ul>" )

							local fldr_name = ngx.var.split_dir

							local ssi_file_path = "/data/split/".. fldr_name .. "/" .. split_bbbaaa5 .. "/" .. split_bbbaaa_ranking .. "/" .. split_bbbaaa_mobile .. ".html"
							ngx.say( "<h4> Filepath: " .. ssi_file_path .. "</h4><ul>" )

							local fh = io.open(ssi_file_path)
							if fh then
							    ngx.say( "<plaintext>" )
							    for line in fh:lines() do
							        ngx.say( line )
							    end
							    fh:close()
							end
			';
		}
		### whoami-location end ###
		### z-pass-locations begin ###
		location /z/pass/ {
			internal;
	### proxy-set-headers begin ###
	proxy_set_header  Host                  $host;
	proxy_set_header  X-Real-IP             $remote_addr;
	proxy_set_header  X-Forwarded-For       $remote_addr;
	proxy_set_header  X-Forwarded-Host      $host;
	proxy_set_header  X-Forwarded-Port      $server_port;
	proxy_set_header  X-Forwarded-Protocol  $scheme;
	### proxy-set-headers end ###
			proxy_set_header Connection '';
			proxy_set_header X-CMR      $cookie_LM_REMAIL;
			proxy_set_header X-UID-Got  $uid_got;
			proxy_set_header X-UID-Set  $uid_set;

			proxy_connect_timeout 100ms;
			proxy_send_timeout    100ms;
			proxy_read_timeout    100ms;

			proxy_http_version 1.1;

			error_page 400 401 403 404 500 502 503 504 = @zero;

			location = /z/pass/analytics {
				proxy_pass http://z_analytics_upstream/z;
			}
			location = /z/pass/prism {
				proxy_pass http://z_prism_upstream/z;
			}
		}
		### z-pass-locations end ###
		### zero-location begin ###
		location @zero {
			return 204;
		}
		### zero-locations end  ###
		location / {
			access_log /var/log/nginx/bbbaaa.kz.access_log timeds;
			access_log /var/log/nginx/bbbaaa.kz.misc.access_log timed;
			proxy_pass http://site_kz_head_upstream;
		}
		location = / {
			access_log /var/log/nginx/bbbaaa.kz.access_log timeds;
			access_log /var/log/nginx/bbbaaa.kz.index.access_log timedc;
			proxy_pass http://site_kz_head_upstream;
			proxy_cache_valid 200 5m;
			proxy_cache pages-kz;
			proxy_cache_key $detected_protocol://site_upstream/v11.11$uri;
		}
		location /action/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			access_log /var/log/nginx/bbbaaa.kz.access_log timeds;
			access_log /var/log/nginx/bbbaaa.kz.catalog.access_log timedc;
			proxy_pass http://site_kz_head_upstream;
			proxy_cache_key $detected_protocol://site_upstream/v11.11$uri?$norm_args:sf=$sf;
			proxy_cache_valid 200 10m;
			proxy_cache catalog-kz;
		}
		location = /apple-touch-icon.png {
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-72x72.png {
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-72x72-precomposed.png {
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-76x76.png {
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-76x76-precomposed.png {
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-114x114.png {
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-114x114-precomposed.png {
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-120x120.png {
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-120x120-precomposed.png {
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-144x144.png {
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-144x144-precomposed.png {
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-152x152-precomposed.png {
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
			alias /data/site-kz/misc/apple-touch-icon-precomposed.png;
		}
		location = /apple-touch-icon-precomposed.png {
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location /b/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			access_log /var/log/nginx/bbbaaa.kz.access_log timeds;
			access_log /var/log/nginx/bbbaaa.kz.catalog.access_log timed;
			proxy_pass http://site_kz_head_upstream;
			proxy_cache_key $detected_protocol://site_upstream/v11.11$uri?$norm_args:sf=$sf;
			proxy_cache_valid 200 10m;
			proxy_cache catalog-kz;
		}
		location /brands/ {
			access_log /var/log/nginx/bbbaaa.kz.access_log timeds;
			access_log /var/log/nginx/bbbaaa.kz.pages.access_log timedc;
			proxy_pass http://site_kz_head_upstream;
			proxy_cache_valid 200 3h;
			proxy_cache pages-kz;
		}
		location /c/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			access_log /var/log/nginx/bbbaaa.kz.access_log timeds;
			access_log /var/log/nginx/bbbaaa.kz.catalog.access_log timedc;
			proxy_pass http://site_kz_head_upstream;
			proxy_cache_key $detected_protocol://site_upstream/v11.11$uri?$norm_args:sf=$sf;
			proxy_cache_valid 200 10m;
			proxy_cache catalog-kz;
		}
		location /cart/ {
			access_log /var/log/nginx/bbbaaa.kz.access_log timeds;
			access_log /var/log/nginx/bbbaaa.kz.cart-actions.access_log timed;
			proxy_pass http://site_kz_head_upstream;
		}
		location /catalogsearch/suggest/ {
			access_log /var/log/nginx/bbbaaa.kz.access_log timeds;
			access_log /var/log/nginx/bbbaaa.kz.suggest.access_log timed;
			proxy_pass http://site_kz_head_upstream;
			proxy_cache_valid 200 1d;
			proxy_cache suggest-kz;
		}
		location /cb/ {
			access_log /var/log/nginx/bbbaaa.kz.access_log timeds;
			access_log /var/log/nginx/bbbaaa.kz.catalog.access_log timedc;
			proxy_pass http://site_kz_head_upstream;
			proxy_cache_valid 200 10m;
			proxy_cache catalog-kz;
		}
		location /checkout/ {
			access_log /var/log/nginx/bbbaaa.kz.access_log timeds;
			access_log /var/log/nginx/bbbaaa.kz.checkout.access_log timed;
			proxy_pass http://site_kz_head_upstream;
		}
		location /checkout/cart/ {
			access_log /var/log/nginx/bbbaaa.kz.access_log timeds;
			access_log /var/log/nginx/bbbaaa.kz.cart.access_log timed;
			proxy_pass http://site_kz_head_upstream;
		}
		location /e/pup/ {
			alias /data/delivery/dav-kz/pup/;
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
		}
		location /e/refund/ {
			alias /data/bob/dav-kz/refund/;
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
		}
		location /err/ {
			internal;
			alias /data/site-kz/misc/;
		}
		location = /favicon.ico {
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location /files/ {
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location /flat/ {
			access_log off;
						### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://site_kz_head_upstream;
		}
		location = /google9ec4ddc966290005.html {
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /googlee51abce20097eee4.html {
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /googledefe250e2141dd06.html {
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /helpcenter/ {
			return 301 https://bbbaaaru.zendesk.com/hc/ru/?locale_id=kz;
		}
		location /landing/ {
			access_log /var/log/nginx/bbbaaa.kz.access_log timeds;
			access_log /var/log/nginx/bbbaaa.kz.pages.access_log timed;
			proxy_pass http://site_kz_head_upstream;
			proxy_cache_valid 200 3h;
			proxy_cache pages-kz;
		}
		location = /localstorage.html {
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /nt {
			access_log /var/log/nginx/bbbaaa.kz.nt.access_log timed;
			return 204;
		}
		location /p/ {
			access_log /var/log/nginx/bbbaaa.kz.access_log timeds;
			access_log /var/log/nginx/bbbaaa.kz.product.access_log timedc;
			proxy_pass http://site_kz_head_upstream;
			proxy_cache_valid 200 6h;
			proxy_cache product-kz;
		}
		location /p2/ {
			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
	
			access_log /var/log/nginx/bbbaaa.kz.access_log timeds;
			access_log /var/log/nginx/bbbaaa.kz.product.access_log timedc;
			proxy_pass http://site_kz_head_upstream;
			proxy_cache_valid 200 6h;
			proxy_cache product-kz;
		}
		location /p/quick/ {
			access_log /var/log/nginx/bbbaaa.kz.access_log timeds;
			access_log /var/log/nginx/bbbaaa.kz.quickview.access_log timedc;
			proxy_pass http://site_kz_head_upstream;
			proxy_cache_valid 200 6h;
			proxy_cache quick-kz;
		}
		location = /robots.txt {
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location /sitemap/ {
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
			alias /data/site-kz/map/;
		}
		location = /sitemap.xml {
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
			root /data/site-kz/map;
		}
		location = /social-logo.jpg {
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location /ssi/ {
			internal;
			log_subrequest on;
			error_page 400 401 403 404 500 502 503 504 = @zero;
			proxy_cache_key $scheme://site_upstream/v11.11$uri$is_args$args;
			proxy_pass http://site_kz_head_upstream;
			access_log /var/log/nginx/bbbaaa.kz.ssi.access_log subtimed;

			location /ssi/comments/ {
				proxy_pass http://site_kz_head_upstream;
				access_log /var/log/nginx/bbbaaa.kz.ssi.comments.access_log subtimed;
			}
			location = /ssi/exp.html {
				alias /data/split/${split_dir}/${split_bbbaaa5}/${split_bbbaaa_ranking}/${split_bbbaaa_mobile}.html;
				access_log /var/log/nginx/bbbaaa.kz.ssi.exp.access_log subtimed;
			}
			location /ssi/menu/ {
				proxy_pass http://site_kz_head_upstream;
				access_log /var/log/nginx/bbbaaa.kz.ssi.menu.access_log subtimedc;
				proxy_cache_valid 200 3h;
				proxy_cache ssi-menu-kz;
			}
			location /ssi/recommend/ {
				proxy_pass http://site_kz_head_upstream;
				access_log /var/log/nginx/bbbaaa.kz.ssi.recommend.access_log subtimed;
				proxy_cache_valid 200 5m;
				proxy_cache ssi-recommend-kz;
			}
			location = /ssi/recommend/product-product {
				proxy_pass http://site_kz_head_upstream;
				access_log /var/log/nginx/bbbaaa.kz.ssi.recommend.access_log subtimed;
			}
			location = /ssi/recommend/topsellers {
				proxy_pass http://site_kz_head_upstream;
				access_log /var/log/nginx/bbbaaa.kz.ssi.recommend.access_log subtimed;
			}
			location /ssi/sizes/ {
				proxy_pass http://site_kz_head_upstream;
				access_log /var/log/nginx/bbbaaa.kz.ssi.sizes.access_log subtimedc;
				proxy_cache_valid 200 1m;
				proxy_cache ssi-sizes-kz;
			}
			location /ssi/userdata/ {
				proxy_pass http://site_kz_head_upstream;
				access_log /var/log/nginx/bbbaaa.kz.ssi.userdata.access_log subtimed;
			}
		}
		location /static/ {
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
			alias /data/site-kz/static/;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
			error_page  404 = @static-proxy;
		}
		location @static-proxy {
			proxy_pass http://site_kz_head_static_upstream;
			access_log /var/log/nginx/bbbaaa.static-proxy.access_log timeds;
		}
		location = /strucr47bbe68c04a7e677499f3fef1bdc858b7a8ec97e.html {
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location /ymlexport/ {
			alias /data/yml/serve/;
			access_log /var/log/nginx/bbbaaa.kz.static.access_log timedc;
		}
		location = /yandex_51cbbf37e2279238.txt {
			return 200 ' ';
		}
		location = /z {
			access_log /var/log/nginx/bbbaaa.kz.z.access_log timeds;
			content_by_lua '
				ngx.location.capture_multi({ {"/z/pass/analytics",{args = ngx.req.get_uri_args()}},{"/z/pass/prism",{args = ngx.req.get_uri_args()}} })
				ngx.status = 204;
			';
		}
	} # ]]]
	server { # tail.bbbaaa.kz [[[
		listen 10.233.32.243:80; # carp243
		listen 10.233.32.244:80; # carp244
		listen 10.233.32.243:443 ssl;
		listen 10.233.32.244:443 ssl;
		server_name tail.bbbaaa.kz;
		access_log /var/log/nginx/bbbaaa.kz.tail.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.kz.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.kz.key;

		set_real_ip_from 10.233.32.0/24;
		# MyraCloud pool
		set_real_ip_from 31.7.176.0/24;
		set_real_ip_from 31.7.184.0/24;
		set_real_ip_from 80.255.12.96/27;
		set_real_ip_from 82.199.130.0/27;
		set_real_ip_from 91.201.214.218;
		set_real_ip_from 93.190.71.0/25;
		set_real_ip_from 109.75.179.0/24;
		set_real_ip_from 109.234.104.192/27;
		set_real_ip_from 141.105.64.0/28;
		set_real_ip_from 158.255.7.192/27;
		set_real_ip_from 178.89.156.96/28;
		set_real_ip_from 195.210.46.68;
		set_real_ip_from 31.130.201.64/27;

		userid_domain  .bbbaaa.kz;
		userid_service 1028;
		userid         on;

		ssi on;

		proxy_set_header Host     $host;
		proxy_set_header X-DDoS   $ddos;
		proxy_set_header X-LID    $uid_any;
		proxy_set_header X-Splits banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;

		proxy_set_header X-Forwarded-For      $remote_addr;
		proxy_set_header X-Forwarded-Host     $host;
		proxy_set_header X-Forwarded-Port     $server_port;
		proxy_set_header X-Forwarded-Protocol $detected_protocol;
		proxy_set_header X-Real-IP            $remote_addr;

		proxy_intercept_errors on;

		error_page 401 402 404 /err/404.html;
		error_page 403 /err/403.html;
		error_page 500 /err/500.html;
		error_page 502 /err/502.html;
		error_page 503 /err/503.html;
		error_page 504 /err/504.html;

		if ( $arg_split_bbbaaa5 ) {
			set $split_bbbaaa5 $arg_split_bbbaaa5;
		}
		if ( $arg_split_bbbaaa_banner ) {
			set $split_bbbaaa_banner $arg_split_bbbaaa_banner;
		}
		if ( $arg_split_bbbaaa_mobile ) {
			set $split_bbbaaa_mobile $arg_split_bbbaaa_mobile;
		}
		if ( $arg_split_bbbaaa_perm ) {
			set $split_bbbaaa_perm $arg_split_bbbaaa_perm;
		}
		if ( $arg_split_bbbaaa_ranking ) {
			set $split_bbbaaa_ranking $arg_split_bbbaaa_ranking;
		}

		# mobile site redirect
		add_header Set-Cookie $mobile_cookie_kz;
		if ( $mobile_site = 1 ) {
			return 302 $detected_protocol://m.bbbaaa.kz$request_uri;
		}

		# seo redirect
		if ( $ui2086 ) {
			return 301 $detected_protocol://$host$uri;
		}

		### bs-locations begin ###
		location /bs-click/ {
			proxy_pass http://bs_head_upstream/click/;
		}
		location /bs-hit/ {
			internal;
			error_page 400 401 403 404 500 502 503 504 = @zero;

			proxy_connect_timeout 100ms;
			proxy_read_timeout    200ms;
			proxy_pass_request_headers off;

			proxy_next_upstream   error
			                      timeout
			;

			proxy_set_header  Host                  bs.local;
			proxy_set_header  X-Real-IP             $remote_addr;
			proxy_set_header  X-Forwarded-For       $remote_addr;
			proxy_set_header  X-Forwarded-Host      $host;
			proxy_set_header  X-Forwarded-Port      $server_port;
			proxy_set_header  X-Forwarded-Protocol  $scheme;
			proxy_set_header  X-LID                 $uid_any;
			proxy_set_header  X-Splits              banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header  Referer               $scheme://$http_host$request_uri;
			proxy_set_header  Rereferer             $http_referer;
			proxy_set_header  X-City-ID             $city_id;
			proxy_set_header  X-Region-ID           $region_id;

			proxy_pass http://bs_head_upstream/hit/;
		}
		location /bs-ssi/ {
			internal;
			alias /data/bs/ssi/;
		}
		### bs-locations end   ###
		### sorting-location begin ###
		location = /sf {
			internal;

			log_subrequest on;
			access_log /var/log/nginx/sort.access_log subtimed;

			proxy_connect_timeout 10ms;
			proxy_read_timeout    50ms;

			proxy_pass_request_headers off;

			proxy_set_header Host         sort.local;
			proxy_set_header X-LID        $uid_val;
			proxy_set_header X-Splits     banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header X-URL        $scheme://$host$request_uri;
			# geo
			proxy_set_header X-Geo        $geo;
			proxy_set_header X-City-ID    $city_id;
			proxy_set_header X-Country-ID $country_id;
			proxy_set_header X-Region-ID  $region_id;

			proxy_pass http://sort_head_upstream/mapping/sorting_factor_simple/;
		}
		### sorting-location end   ###
		### uakari-locations begin ###
		location = /uakari-redis {
			internal;
			redis2_connect_timeout 3s;
			redis2_read_timeout    1s;
			redis2_send_timeout    1s;
			redis2_query get $arg_key;
			redis2_pass uakari_redis_upstream;
		}
		location /s/ {
			location /s/ {
				return 404;
			}
			location ~ ^/s/(?<key>[^/]+)$ {
				content_by_lua '
					local res = ngx.location.capture( "/uakari-redis?key=" .. ngx.var["key"] )
					if res.status ~= 200 then
						ngx.status = 500
						ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
					end
					local uri = string.match( res.body, "\\n([^\\n]+)" )
					if not uri then
						ngx.status = 404
						ngx.exit(ngx.HTTP_NOT_FOUND)
					end
					ngx.redirect( "http://" .. ngx.var.host .. uri, 301 )
				';
			}
		}
		### uakari-locations end   ###
		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###
		### whoami-location begin ###
		location = /whoami {

			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###

			ssi off;

			content_by_lua '
							ngx.header.content_type = "text/html"
							local uid_any = ngx.var.uid_any or "Undefined"
							local split_bbbaaa5 = ngx.var.split_bbbaaa5 or "Undefined"
							local split_bbbaaa_banner = ngx.var.split_bbbaaa_banner or "Undefined"
							local split_bbbaaa_mobile = ngx.var.split_bbbaaa_mobile or "Undefined"
							local split_bbbaaa_ranking = ngx.var.split_bbbaaa_ranking or "Undefined"
							local split_bbbaaa_perm = ngx.var.split_bbbaaa_perm or "Undefined"
							local split_madmin = ngx.var.split_madmin or "Undefined"
							ngx.say( "<h4>Parameters</h4><ul>" )
							ngx.say( "<li> lid" .. string.sub(uid_any,4) )
							ngx.say( "<li> split_bbbaaa5=" .. split_bbbaaa5 )
							ngx.say( "<li> split_bbbaaa_banner=" .. split_bbbaaa_banner )
							ngx.say( "<li> split_bbbaaa_mobile=" .. split_bbbaaa_mobile )
							ngx.say( "<li> split_bbbaaa_ranking=" .. split_bbbaaa_ranking  )
							ngx.say( "<li> split_bbbaaa_perm=" .. split_bbbaaa_perm  )
							ngx.say( "<li> split_madmin=" .. split_madmin  )
							ngx.say( "</ul>" )

							ngx.say( "<h4>Your visible cookies</h4><ul>" )
							for x in string.gmatch(ngx.req.get_headers()["cookie"] or "", "[^;]+") do
							    ngx.say(string.format("<li>%s",x))
							end
							ngx.say( "</ul>" )

							local fldr_name = ngx.var.split_dir

							local ssi_file_path = "/data/split/".. fldr_name .. "/" .. split_bbbaaa5 .. "/" .. split_bbbaaa_ranking .. "/" .. split_bbbaaa_mobile .. ".html"
							ngx.say( "<h4> Filepath: " .. ssi_file_path .. "</h4><ul>" )

							local fh = io.open(ssi_file_path)
							if fh then
							    ngx.say( "<plaintext>" )
							    for line in fh:lines() do
							        ngx.say( line )
							    end
							    fh:close()
							end
			';
		}
		### whoami-location end ###
		### z-pass-locations begin ###
		location /z/pass/ {
			internal;
	### proxy-set-headers begin ###
	proxy_set_header  Host                  $host;
	proxy_set_header  X-Real-IP             $remote_addr;
	proxy_set_header  X-Forwarded-For       $remote_addr;
	proxy_set_header  X-Forwarded-Host      $host;
	proxy_set_header  X-Forwarded-Port      $server_port;
	proxy_set_header  X-Forwarded-Protocol  $scheme;
	### proxy-set-headers end ###
			proxy_set_header Connection '';
			proxy_set_header X-CMR      $cookie_LM_REMAIL;
			proxy_set_header X-UID-Got  $uid_got;
			proxy_set_header X-UID-Set  $uid_set;

			proxy_connect_timeout 100ms;
			proxy_send_timeout    100ms;
			proxy_read_timeout    100ms;

			proxy_http_version 1.1;

			error_page 400 401 403 404 500 502 503 504 = @zero;

			location = /z/pass/analytics {
				proxy_pass http://z_analytics_upstream/z;
			}
			location = /z/pass/prism {
				proxy_pass http://z_prism_upstream/z;
			}
		}
		### z-pass-locations end ###
		### zero-location begin ###
		location @zero {
			return 204;
		}
		### zero-locations end  ###
		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.site.kz.local
          halt: true
        - host: back02.site.kz.local
          halt: true
        - host: back03.site.kz.local
          halt: true
        - host: back04.site.kz.local
          halt: true
        - host: back05.site.kz.local
        - host: back06.site.kz.local
        - host: back07.site.kz.local
        - host: back08.site.kz.local
        - host: back09.site.kz.local
          halt: true
        - host: back10.site.kz.local
          halt: true
    lolek:
        - host: back101.site.kz.local
          halt: true
        - host: back102.site.kz.local
          halt: true
        - host: back103.site.kz.local
          halt: true
        - host: back104.site.kz.local
          halt: true
        - host: back105.site.kz.local
        - host: back106.site.kz.local
        - host: back107.site.kz.local
        - host: back108.site.kz.local
        - host: back109.site.kz.local
          halt: true
        - host: back110.site.kz.local
          halt: true
head: lolek
super: super.back.site.kz.local
tail: bolek
';}

		location / {
			proxy_pass http://site_kz_tail_upstream;
		}
		location = / {
			proxy_pass http://site_kz_tail_upstream;
		}
		location /action/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			proxy_pass http://site_kz_tail_upstream;
		}
		location = /apple-touch-icon.png {
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-72x72.png {
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-72x72-precomposed.png {
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-76x76.png {
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-76x76-precomposed.png {
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-114x114.png {
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-114x114-precomposed.png {
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-120x120.png {
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-120x120-precomposed.png {
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-144x144.png {
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-144x144-precomposed.png {
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-152x152-precomposed.png {
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
			alias /data/site-kz/misc/apple-touch-icon-precomposed.png;
		}
		location = /apple-touch-icon-precomposed.png {
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
			root /data/site-kz/misc;
		}
		location /b/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			proxy_pass http://site_kz_tail_upstream;
		}
		location /brands/ {
			proxy_pass http://site_kz_tail_upstream;
		}
		location /c/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			proxy_pass http://site_kz_tail_upstream;
		}
		location /cart/ {
			proxy_pass http://site_kz_tail_upstream;
		}
		location /catalogsearch/suggest/ {
			proxy_pass http://site_kz_tail_upstream;
		}
		location /cb/ {
			proxy_pass http://site_kz_tail_upstream;
		}
		location /checkout/ {
			proxy_pass http://site_kz_tail_upstream;
		}
		location /checkout/cart/ {
			proxy_pass http://site_kz_tail_upstream;
		}
		location /e/pup/ {
			alias /data/delivery/dav-kz/pup/;
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
		}
		location /e/refund/ {
			alias /data/bob/dav-kz/refund/;
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
		}
		location /err/ {
			internal;
			alias /data/site-kz/misc/;
		}
		location = /favicon.ico {
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
			root /data/site-kz/misc;
		}
		location /files/ {
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
			root /data/site-kz/misc;
		}
		location /flat/ {
			access_log off;
						### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://site_kz_tail_upstream;
		}
		location = /google9ec4ddc966290005.html {
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /googlee51abce20097eee4.html {
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /googledefe250e2141dd06.html {
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
			root /data/site-kz/misc;
		}
		location /landing/ {
			proxy_pass http://site_kz_tail_upstream;
		}
		location = /localstorage.html {
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /nt {
			access_log /var/log/nginx/bbbaaa.kz.tail.nt.access_log timed;
			return 204;
		}
		location /p/ {
			proxy_pass http://site_kz_tail_upstream;
		}
		location /p2/ {
			proxy_pass http://site_kz_tail_upstream;
		}
		location /p/quick/ {
			proxy_pass http://site_kz_tail_upstream;
		}
		location = /robots.txt {
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
			root /data/site-kz/misc;
		}
		location /sitemap/ {
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
			alias /data/site-kz/map/;
		}
		location = /sitemap.xml {
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
			root /data/site-kz/map;
		}
		location = /social-logo.jpg {
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
			root /data/site-kz/misc;
		}
		location /ssi/ {
#			internal;
			log_subrequest on;
			error_page 400 401 403 404 500 502 503 504 = @zero;
			proxy_pass http://site_kz_tail_upstream;
			access_log /var/log/nginx/bbbaaa.kz.tail.ssi.access_log subtimed;

			location /ssi/comments/ {
				proxy_pass http://site_kz_tail_upstream;
			}
			location = /ssi/exp.html {
				alias /data/split/${split_dir}/${split_bbbaaa5}/${split_bbbaaa_ranking}/${split_bbbaaa_mobile}.html;
			}
			location /ssi/menu/ {
				proxy_pass http://site_kz_tail_upstream;
			}
			location /ssi/recommend/ {
				proxy_pass http://site_kz_tail_upstream;
			}
			location = /ssi/recommend/product-product {
				proxy_pass http://site_kz_tail_upstream;
			}
			location = /ssi/recommend/topsellers {
				proxy_pass http://site_kz_tail_upstream;
			}
			location /ssi/sizes/ {
				proxy_pass http://site_kz_tail_upstream;
			}
			location /ssi/userdata/ {
				proxy_pass http://site_kz_tail_upstream;
			}
		}
		location /static/ {
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
			alias /data/site-kz/static/;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
			error_page  404 = @static-proxy;
		}
		location @static-proxy {
			proxy_pass http://site_kz_tail_static_upstream;
			access_log /var/log/nginx/bbbaaa.static-proxy.access_log timeds;
		}
		location = /strucr47bbe68c04a7e677499f3fef1bdc858b7a8ec97e.html {
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timed;
			root /data/site-kz/misc;
		}
		location /ymlexport/ {
			alias /data/yml/serve/;
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timedc;
		}
		location = /yandex_51cbbf37e2279238.txt {
			return 200 ' ';
		}
		location = /z {
			access_log /var/log/nginx/bbbaaa.kz.tail.static.access_log timeds;
			content_by_lua '
				ngx.location.capture_multi({ {"/z/pass/analytics",{args = ngx.req.get_uri_args()}},{"/z/pass/prism",{args = ngx.req.get_uri_args()}} })
				ngx.status = 204;
			';
		}
	} # ]]]
	server { # site-beta.bbbaaa.kz [[[
		listen 10.233.32.243:80; # carp243
		listen 10.233.32.244:80; # carp244
		listen 10.233.32.243:443 ssl;
		listen 10.233.32.244:443 ssl;
		server_name site-beta.bbbaaa.kz;
		access_log /var/log/nginx/bbbaaa.kz.beta.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.kz.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.kz.key;

		set_real_ip_from 10.233.32.0/24;
		# MyraCloud pool
		set_real_ip_from 31.7.176.0/24;
		set_real_ip_from 31.7.184.0/24;
		set_real_ip_from 80.255.12.96/27;
		set_real_ip_from 82.199.130.0/27;
		set_real_ip_from 91.201.214.218;
		set_real_ip_from 93.190.71.0/25;
		set_real_ip_from 109.75.179.0/24;
		set_real_ip_from 109.234.104.192/27;
		set_real_ip_from 141.105.64.0/28;
		set_real_ip_from 158.255.7.192/27;
		set_real_ip_from 178.89.156.96/28;
		set_real_ip_from 195.210.46.68;
		set_real_ip_from 31.130.201.64/27;

		userid_domain  .bbbaaa.kz;
		userid_service 1028;
		userid         on;

		ssi on;

		proxy_set_header Host     $host;
		proxy_set_header X-DDoS   $ddos;
		proxy_set_header X-LID    $uid_any;
		proxy_set_header X-Splits banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;

		proxy_set_header X-Forwarded-For      $remote_addr;
		proxy_set_header X-Forwarded-Host     $host;
		proxy_set_header X-Forwarded-Port     $server_port;
		proxy_set_header X-Forwarded-Protocol $detected_protocol;
		proxy_set_header X-Real-IP            $remote_addr;

		proxy_intercept_errors on;

		error_page 401 402 404 /err/404.html;
		error_page 403 /err/403.html;
		error_page 500 /err/500.html;
		error_page 502 /err/502.html;
		error_page 503 /err/503.html;
		error_page 504 /err/504.html;

		if ( $arg_split_bbbaaa5 ) {
			set $split_bbbaaa5 $arg_split_bbbaaa5;
		}
		if ( $arg_split_bbbaaa_banner ) {
			set $split_bbbaaa_banner $arg_split_bbbaaa_banner;
		}
		if ( $arg_split_bbbaaa_mobile ) {
			set $split_bbbaaa_mobile $arg_split_bbbaaa_mobile;
		}
		if ( $arg_split_bbbaaa_perm ) {
			set $split_bbbaaa_perm $arg_split_bbbaaa_perm;
		}
		if ( $arg_split_bbbaaa_ranking ) {
			set $split_bbbaaa_ranking $arg_split_bbbaaa_ranking;
		}

		# mobile site redirect
		add_header Set-Cookie $mobile_cookie_kz;
		if ( $mobile_site = 1 ) {
			return 302 $detected_protocol://m.bbbaaa.kz$request_uri;
		}

		# seo redirect
		if ( $ui2086 ) {
			return 301 $detected_protocol://$host$uri;
		}

		set $easycheckout 1;
		set $fullcheckout 1;

#			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###

		### bs-locations begin ###
		location /bs-click/ {
			proxy_pass http://bs_head_upstream/click/;
		}
		location /bs-hit/ {
			internal;
			error_page 400 401 403 404 500 502 503 504 = @zero;

			proxy_connect_timeout 100ms;
			proxy_read_timeout    200ms;
			proxy_pass_request_headers off;

			proxy_next_upstream   error
			                      timeout
			;

			proxy_set_header  Host                  bs.local;
			proxy_set_header  X-Real-IP             $remote_addr;
			proxy_set_header  X-Forwarded-For       $remote_addr;
			proxy_set_header  X-Forwarded-Host      $host;
			proxy_set_header  X-Forwarded-Port      $server_port;
			proxy_set_header  X-Forwarded-Protocol  $scheme;
			proxy_set_header  X-LID                 $uid_any;
			proxy_set_header  X-Splits              banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header  Referer               $scheme://$http_host$request_uri;
			proxy_set_header  Rereferer             $http_referer;
			proxy_set_header  X-City-ID             $city_id;
			proxy_set_header  X-Region-ID           $region_id;

			proxy_pass http://bs_head_upstream/hit/;
		}
		location /bs-ssi/ {
			internal;
			alias /data/bs/ssi/;
		}
		### bs-locations end   ###
		### sorting-location begin ###
		location = /sf {
			internal;

			log_subrequest on;
			access_log /var/log/nginx/sort.access_log subtimed;

			proxy_connect_timeout 10ms;
			proxy_read_timeout    50ms;

			proxy_pass_request_headers off;

			proxy_set_header Host         sort.local;
			proxy_set_header X-LID        $uid_val;
			proxy_set_header X-Splits     banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header X-URL        $scheme://$host$request_uri;
			# geo
			proxy_set_header X-Geo        $geo;
			proxy_set_header X-City-ID    $city_id;
			proxy_set_header X-Country-ID $country_id;
			proxy_set_header X-Region-ID  $region_id;

			proxy_pass http://sort_head_upstream/mapping/sorting_factor_simple/;
		}
		### sorting-location end   ###
		### uakari-locations begin ###
		location = /uakari-redis {
			internal;
			redis2_connect_timeout 3s;
			redis2_read_timeout    1s;
			redis2_send_timeout    1s;
			redis2_query get $arg_key;
			redis2_pass uakari_redis_upstream;
		}
		location /s/ {
			location /s/ {
				return 404;
			}
			location ~ ^/s/(?<key>[^/]+)$ {
				content_by_lua '
					local res = ngx.location.capture( "/uakari-redis?key=" .. ngx.var["key"] )
					if res.status ~= 200 then
						ngx.status = 500
						ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
					end
					local uri = string.match( res.body, "\\n([^\\n]+)" )
					if not uri then
						ngx.status = 404
						ngx.exit(ngx.HTTP_NOT_FOUND)
					end
					ngx.redirect( "http://" .. ngx.var.host .. uri, 301 )
				';
			}
		}
		### uakari-locations end   ###
		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###
		### whoami-location begin ###
		location = /whoami {

			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###

			ssi off;

			content_by_lua '
							ngx.header.content_type = "text/html"
							local uid_any = ngx.var.uid_any or "Undefined"
							local split_bbbaaa5 = ngx.var.split_bbbaaa5 or "Undefined"
							local split_bbbaaa_banner = ngx.var.split_bbbaaa_banner or "Undefined"
							local split_bbbaaa_mobile = ngx.var.split_bbbaaa_mobile or "Undefined"
							local split_bbbaaa_ranking = ngx.var.split_bbbaaa_ranking or "Undefined"
							local split_bbbaaa_perm = ngx.var.split_bbbaaa_perm or "Undefined"
							local split_madmin = ngx.var.split_madmin or "Undefined"
							ngx.say( "<h4>Parameters</h4><ul>" )
							ngx.say( "<li> lid" .. string.sub(uid_any,4) )
							ngx.say( "<li> split_bbbaaa5=" .. split_bbbaaa5 )
							ngx.say( "<li> split_bbbaaa_banner=" .. split_bbbaaa_banner )
							ngx.say( "<li> split_bbbaaa_mobile=" .. split_bbbaaa_mobile )
							ngx.say( "<li> split_bbbaaa_ranking=" .. split_bbbaaa_ranking  )
							ngx.say( "<li> split_bbbaaa_perm=" .. split_bbbaaa_perm  )
							ngx.say( "<li> split_madmin=" .. split_madmin  )
							ngx.say( "</ul>" )

							ngx.say( "<h4>Your visible cookies</h4><ul>" )
							for x in string.gmatch(ngx.req.get_headers()["cookie"] or "", "[^;]+") do
							    ngx.say(string.format("<li>%s",x))
							end
							ngx.say( "</ul>" )

							local fldr_name = ngx.var.split_dir

							local ssi_file_path = "/data/split/".. fldr_name .. "/" .. split_bbbaaa5 .. "/" .. split_bbbaaa_ranking .. "/" .. split_bbbaaa_mobile .. ".html"
							ngx.say( "<h4> Filepath: " .. ssi_file_path .. "</h4><ul>" )

							local fh = io.open(ssi_file_path)
							if fh then
							    ngx.say( "<plaintext>" )
							    for line in fh:lines() do
							        ngx.say( line )
							    end
							    fh:close()
							end
			';
		}
		### whoami-location end ###
		### z-pass-locations begin ###
		location /z/pass/ {
			internal;
	### proxy-set-headers begin ###
	proxy_set_header  Host                  $host;
	proxy_set_header  X-Real-IP             $remote_addr;
	proxy_set_header  X-Forwarded-For       $remote_addr;
	proxy_set_header  X-Forwarded-Host      $host;
	proxy_set_header  X-Forwarded-Port      $server_port;
	proxy_set_header  X-Forwarded-Protocol  $scheme;
	### proxy-set-headers end ###
			proxy_set_header Connection '';
			proxy_set_header X-CMR      $cookie_LM_REMAIL;
			proxy_set_header X-UID-Got  $uid_got;
			proxy_set_header X-UID-Set  $uid_set;

			proxy_connect_timeout 100ms;
			proxy_send_timeout    100ms;
			proxy_read_timeout    100ms;

			proxy_http_version 1.1;

			error_page 400 401 403 404 500 502 503 504 = @zero;

			location = /z/pass/analytics {
				proxy_pass http://z_analytics_upstream/z;
			}
			location = /z/pass/prism {
				proxy_pass http://z_prism_upstream/z;
			}
		}
		### z-pass-locations end ###
		### zero-location begin ###
		location @zero {
			return 204;
		}
		### zero-locations end  ###
		location / {
			proxy_pass http://site_kz_beta_upstream;
		}
		location = / {
			proxy_pass http://site_kz_beta_upstream;
		}
		location /action/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			proxy_pass http://site_kz_beta_upstream;
		}
		location = /apple-touch-icon.png {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-72x72.png {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-72x72-precomposed.png {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-76x76.png {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-76x76-precomposed.png {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-114x114.png {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-114x114-precomposed.png {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-120x120.png {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-120x120-precomposed.png {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-144x144.png {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-144x144-precomposed.png {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-152x152-precomposed.png {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timed;
			alias /data/site-kz/misc/apple-touch-icon-precomposed.png;
		}
		location = /apple-touch-icon-precomposed.png {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timed;
			root /data/site-kz/misc;
		}
		location /b/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			proxy_pass http://site_kz_beta_upstream;
		}
		location /brands/ {
			proxy_pass http://site_kz_beta_upstream;
		}
		location /c/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			proxy_pass http://site_kz_beta_upstream;
		}
		location /cart/ {
			proxy_pass http://site_kz_beta_upstream;
		}
		location /catalogsearch/suggest/ {
			proxy_pass http://site_kz_beta_upstream;
		}
		location /cb/ {
			proxy_pass http://site_kz_beta_upstream;
		}
		location /checkout/ {
			proxy_pass http://site_kz_beta_upstream;
		}
		location /checkout/cart/ {
			proxy_pass http://site_kz_beta_upstream;
		}
		location /e/pup/ {
			alias /data/delivery/dav-kz/pup/;
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timed;
		}
		location /e/refund/ {
			alias /data/bob/dav-kz/refund/;
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timed;
		}
		location /err/ {
			internal;
			alias /data/site-kz/misc/;
		}
		location = /favicon.ico {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timeds;
			root /data/site-kz/misc;
		}
		location /files/ {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timed;
			root /data/site-kz/misc;
		}
		location /flat/ {
			access_log off;
						### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://site_kz_beta_upstream;
		}
		location = /google9ec4ddc966290005.html {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /googlee51abce20097eee4.html {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /googledefe250e2141dd06.html {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timed;
			root /data/site-kz/misc;
		}
		location /landing/ {
			proxy_pass http://site_kz_beta_upstream;
		}
		location = /localstorage.html {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timeds;
			root /data/site-kz/misc;
		}
		location = /nt {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timeds;
			return 204;
		}
		location /p/ {
			proxy_pass http://site_kz_beta_upstream;
		}
		location /p2/ {
			proxy_pass http://site_kz_beta_upstream;
		}
		location /p/quick/ {
			proxy_pass http://site_kz_beta_upstream;
		}
		location = /robots.txt {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timeds;
			root /data/site-kz/misc;
		}
		location /sitemap/ {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timed;
			alias /data/site-kz/map/;
		}
		location = /sitemap.xml {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timed;
			root /data/site-kz/map;
		}
		location = /social-logo.jpg {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timed;
			root /data/site-kz/misc;
		}
		location /ssi/ {
#			internal;
			log_subrequest on;
			error_page 400 401 403 404 500 502 503 504 = @zero;
			proxy_pass http://site_kz_beta_upstream;
			access_log /var/log/nginx/bbbaaa.kz.beta.ssi.access_log subtimed;

			location /ssi/comments/ {
				proxy_pass http://site_kz_beta_upstream;
			}
			location = /ssi/exp.html {
				alias /data/split/${split_dir}/${split_bbbaaa5}/${split_bbbaaa_ranking}/${split_bbbaaa_mobile}.html;
			}
			location /ssi/recommend/ {
				proxy_pass http://site_kz_beta_upstream;
			}
			location = /ssi/recommend/product-product {
				proxy_pass http://site_kz_beta_upstream;
			}
			location = /ssi/recommend/topsellers {
				proxy_pass http://site_kz_beta_upstream;
			}
			location /ssi/sizes/ {
				proxy_pass http://site_kz_beta_upstream;
			}
			location /ssi/userdata/ {
				proxy_pass http://site_kz_beta_upstream;
			}
			}
		location /static/ {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timed;
			proxy_pass http://site_kz_beta_static_upstream;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
		}
		location @static-proxy {
			proxy_pass http://site_kz_beta_static_upstream;
			access_log /var/log/nginx/bbbaaa.static-proxy.access_log timeds;
		}
		location = /strucr47bbe68c04a7e677499f3fef1bdc858b7a8ec97e.html {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timed;
			root /data/site-kz/misc;
		}
		location /ymlexport/ {
			alias /data/yml/serve/;
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timedc;
		}
		location = /z {
			access_log /var/log/nginx/bbbaaa.kz.beta.static.access_log timeds;
			content_by_lua '
				ngx.location.capture_multi({ {"/z/pass/analytics",{args = ngx.req.get_uri_args()}},{"/z/pass/prism",{args = ngx.req.get_uri_args()}} })
				ngx.status = 204;
			';
		}
	} # ]]]
	server { # m.bbbaaa.kz [[[
		listen 31.13.33.72:80; # carp72
		listen 31.13.33.73:80; # carp73
		listen 10.233.32.243:80; # carp243
		listen 10.233.32.244:80; # carp244
		listen 31.13.33.72:443 ssl;
		listen 31.13.33.73:443 ssl;
		listen 10.233.32.243:443 ssl;
		listen 10.233.32.244:443 ssl;
		server_name m.bbbaaa.kz;
		access_log /var/log/nginx/m.kz.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.kz.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.kz.key;

		set_real_ip_from 10.233.32.0/24;
		# MyraCloud pool
		set_real_ip_from 31.7.176.0/24;
		set_real_ip_from 31.7.184.0/24;
		set_real_ip_from 80.255.12.96/27;
		set_real_ip_from 82.199.130.0/27;
		set_real_ip_from 91.201.214.218;
		set_real_ip_from 93.190.71.0/25;
		set_real_ip_from 109.75.179.0/24;
		set_real_ip_from 109.234.104.192/27;
		set_real_ip_from 141.105.64.0/28;
		set_real_ip_from 158.255.7.192/27;
		set_real_ip_from 178.89.156.96/28;
		set_real_ip_from 195.210.46.68;
		set_real_ip_from 31.130.201.64/27;

		userid_domain  .bbbaaa.kz;
		userid_service 1028;
		userid         on;

		ssi on;

		proxy_set_header Host     $host;
		proxy_set_header X-DDoS   $ddos;
		proxy_set_header X-LID    $uid_any;
		proxy_set_header X-Mobile yes;
		proxy_set_header X-Splits banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;

		proxy_set_header X-Forwarded-For      $remote_addr;
		proxy_set_header X-Forwarded-Host     $host;
		proxy_set_header X-Forwarded-Port     $server_port;
		proxy_set_header X-Forwarded-Protocol $detected_protocol;
		proxy_set_header X-Real-IP            $remote_addr;

		proxy_intercept_errors on;

		proxy_cache_key $detected_protocol://site_upstream/v11.11$uri?$norm_args;

		error_page 401 402 404 /err/404.html;
		error_page 403 /err/403.html;
		error_page 500 /err/500.html;
		error_page 502 /err/502.html;
		error_page 503 /err/503.html;
		error_page 504 /err/504.html;

		if ( $arg_split_bbbaaa5 ) {
			set $split_bbbaaa5 $arg_split_bbbaaa5;
		}
		if ( $arg_split_bbbaaa_banner ) {
			set $split_bbbaaa_banner $arg_split_bbbaaa_banner;
		}
		if ( $arg_split_bbbaaa_mobile ) {
			set $split_bbbaaa_mobile $arg_split_bbbaaa_mobile;
		}
		if ( $arg_split_bbbaaa_perm ) {
			set $split_bbbaaa_perm $arg_split_bbbaaa_perm;
		}
		if ( $arg_split_bbbaaa_ranking ) {
			set $split_bbbaaa_ranking $arg_split_bbbaaa_ranking;
		}

		# desktop site redirect
		add_header Set-Cookie $mobile_cookie_kz;
		if ( $mobile_site = 2 ) {
			return 302 $detected_protocol://www.bbbaaa.kz$request_uri;
		}

		### uakari-locations begin ###
		location = /uakari-redis {
			internal;
			redis2_connect_timeout 3s;
			redis2_read_timeout    1s;
			redis2_send_timeout    1s;
			redis2_query get $arg_key;
			redis2_pass uakari_redis_upstream;
		}
		location /s/ {
			location /s/ {
				return 404;
			}
			location ~ ^/s/(?<key>[^/]+)$ {
				content_by_lua '
					local res = ngx.location.capture( "/uakari-redis?key=" .. ngx.var["key"] )
					if res.status ~= 200 then
						ngx.status = 500
						ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
					end
					local uri = string.match( res.body, "\\n([^\\n]+)" )
					if not uri then
						ngx.status = 404
						ngx.exit(ngx.HTTP_NOT_FOUND)
					end
					ngx.redirect( "http://" .. ngx.var.host .. uri, 301 )
				';
			}
		}
		### uakari-locations end   ###
		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###
		### whoami-location begin ###
		location = /whoami {

			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###

			ssi off;

			content_by_lua '
							ngx.header.content_type = "text/html"
							local uid_any = ngx.var.uid_any or "Undefined"
							local split_bbbaaa5 = ngx.var.split_bbbaaa5 or "Undefined"
							local split_bbbaaa_banner = ngx.var.split_bbbaaa_banner or "Undefined"
							local split_bbbaaa_mobile = ngx.var.split_bbbaaa_mobile or "Undefined"
							local split_bbbaaa_ranking = ngx.var.split_bbbaaa_ranking or "Undefined"
							local split_bbbaaa_perm = ngx.var.split_bbbaaa_perm or "Undefined"
							local split_madmin = ngx.var.split_madmin or "Undefined"
							ngx.say( "<h4>Parameters</h4><ul>" )
							ngx.say( "<li> lid" .. string.sub(uid_any,4) )
							ngx.say( "<li> split_bbbaaa5=" .. split_bbbaaa5 )
							ngx.say( "<li> split_bbbaaa_banner=" .. split_bbbaaa_banner )
							ngx.say( "<li> split_bbbaaa_mobile=" .. split_bbbaaa_mobile )
							ngx.say( "<li> split_bbbaaa_ranking=" .. split_bbbaaa_ranking  )
							ngx.say( "<li> split_bbbaaa_perm=" .. split_bbbaaa_perm  )
							ngx.say( "<li> split_madmin=" .. split_madmin  )
							ngx.say( "</ul>" )

							ngx.say( "<h4>Your visible cookies</h4><ul>" )
							for x in string.gmatch(ngx.req.get_headers()["cookie"] or "", "[^;]+") do
							    ngx.say(string.format("<li>%s",x))
							end
							ngx.say( "</ul>" )

							local fldr_name = ngx.var.split_dir

							local ssi_file_path = "/data/split/".. fldr_name .. "/" .. split_bbbaaa5 .. "/" .. split_bbbaaa_ranking .. "/" .. split_bbbaaa_mobile .. ".html"
							ngx.say( "<h4> Filepath: " .. ssi_file_path .. "</h4><ul>" )

							local fh = io.open(ssi_file_path)
							if fh then
							    ngx.say( "<plaintext>" )
							    for line in fh:lines() do
							        ngx.say( line )
							    end
							    fh:close()
							end
			';
		}
		### whoami-location end ###
		### z-pass-locations begin ###
		location /z/pass/ {
			internal;
	### proxy-set-headers begin ###
	proxy_set_header  Host                  $host;
	proxy_set_header  X-Real-IP             $remote_addr;
	proxy_set_header  X-Forwarded-For       $remote_addr;
	proxy_set_header  X-Forwarded-Host      $host;
	proxy_set_header  X-Forwarded-Port      $server_port;
	proxy_set_header  X-Forwarded-Protocol  $scheme;
	### proxy-set-headers end ###
			proxy_set_header Connection '';
			proxy_set_header X-CMR      $cookie_LM_REMAIL;
			proxy_set_header X-UID-Got  $uid_got;
			proxy_set_header X-UID-Set  $uid_set;

			proxy_connect_timeout 100ms;
			proxy_send_timeout    100ms;
			proxy_read_timeout    100ms;

			proxy_http_version 1.1;

			error_page 400 401 403 404 500 502 503 504 = @zero;

			location = /z/pass/analytics {
				proxy_pass http://z_analytics_upstream/z;
			}
			location = /z/pass/prism {
				proxy_pass http://z_prism_upstream/z;
			}
		}
		### z-pass-locations end ###
		### zero-location begin ###
		location @zero {
			return 204;
		}
		### zero-locations end  ###
		location / {
			access_log /var/log/nginx/m.kz.access_log timeds;
			access_log /var/log/nginx/m.kz.misc.access_log timed;
			proxy_pass http://site_kz_head_upstream;
		}
		location = / {
			access_log /var/log/nginx/m.kz.access_log timeds;
			access_log /var/log/nginx/m.kz.index.access_log timedc;
			proxy_pass http://site_kz_head_upstream;
			proxy_cache_valid 200 5m;
			proxy_cache m-pages-kz;
			proxy_cache_key $detected_protocol://site_upstream/v11.11$uri;
		}
		location /action/ {
			access_log /var/log/nginx/m.kz.access_log timeds;
			access_log /var/log/nginx/m.kz.catalog.access_log timedc;
			proxy_pass http://site_kz_head_upstream;
			proxy_cache_valid 200 10m;
			proxy_cache m-catalog-kz;
		}
		location = /apple-touch-icon.png {
			access_log /var/log/nginx/m.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-72x72.png {
			access_log /var/log/nginx/m.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-72x72-precomposed.png {
			access_log /var/log/nginx/m.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-76x76.png {
			access_log /var/log/nginx/m.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-76x76-precomposed.png {
			access_log /var/log/nginx/m.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-114x114.png {
			access_log /var/log/nginx/m.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-114x114-precomposed.png {
			access_log /var/log/nginx/m.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-120x120.png {
			access_log /var/log/nginx/m.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-120x120-precomposed.png {
			access_log /var/log/nginx/m.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-144x144.png {
			access_log /var/log/nginx/m.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-144x144-precomposed.png {
			access_log /var/log/nginx/m.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-152x152-precomposed.png {
			access_log /var/log/nginx/m.kz.static.access_log timed;
			alias /data/site-kz/misc/apple-touch-icon-precomposed.png;
		}
		location = /apple-touch-icon-precomposed.png {
			access_log /var/log/nginx/m.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location /b/ {
			access_log /var/log/nginx/m.kz.access_log timeds;
			access_log /var/log/nginx/m.kz.catalog.access_log timed;
			proxy_pass http://site_kz_head_upstream;
			proxy_cache_valid 200 10m;
			proxy_cache m-catalog-kz;
		}
		location /brands/ {
			access_log /var/log/nginx/m.kz.access_log timeds;
			access_log /var/log/nginx/m.kz.pages.access_log timedc;
			proxy_pass http://site_kz_head_upstream;
			proxy_cache_valid 200 3h;
			proxy_cache m-pages-kz;
		}
		location /c/ {
			access_log /var/log/nginx/m.kz.access_log timeds;
			access_log /var/log/nginx/m.kz.catalog.access_log timedc;
			proxy_pass http://site_kz_head_upstream;
			proxy_cache_valid 200 10m;
			proxy_cache m-catalog-kz;
		}
		location /cb/ {
			access_log /var/log/nginx/m.kz.access_log timeds;
			access_log /var/log/nginx/m.kz.catalog.access_log timedc;
			proxy_pass http://site_kz_head_upstream;
			proxy_cache_valid 200 10m;
			proxy_cache m-catalog-kz;
		}
		location /catalogsearch/suggest/ {
			access_log /var/log/nginx/m.kz.access_log timeds;
			access_log /var/log/nginx/m.kz.suggest.access_log timed;
			proxy_pass http://site_kz_head_upstream;
			proxy_cache_valid 200 1d;
			proxy_cache m-suggest-kz;
		}
		location /checkout/ {
			access_log /var/log/nginx/m.kz.access_log timeds;
			access_log /var/log/nginx/m.kz.checkout.access_log timed;
			proxy_pass http://site_kz_head_upstream;
		}
		location /checkout/cart/ {
			access_log /var/log/nginx/m.kz.access_log timeds;
			access_log /var/log/nginx/m.kz.cart.access_log timed;
			proxy_pass http://site_kz_head_upstream;
		}
		location /err/ {
			internal;
			alias /data/site-kz/misc/;
		}
		location = /favicon.ico {
			access_log /var/log/nginx/m.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location /files/ {
			access_log /var/log/nginx/m.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location /flat/ {
			access_log off;
						### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://site_kz_head_upstream;
		}
		location /landing/ {
			access_log /var/log/nginx/m.kz.access_log timeds;
			access_log /var/log/nginx/m.kz.pages.access_log timed;
			proxy_pass http://site_kz_head_upstream;
			proxy_cache_valid 200 3h;
			proxy_cache m-pages-kz;
		}
		location = /localstorage.html {
			access_log /var/log/nginx/m.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /nt {
			access_log /var/log/nginx/m.kz.nt.access_log timed;
			return 204;
		}
		location /p/ {
			access_log /var/log/nginx/m.kz.access_log timeds;
			access_log /var/log/nginx/m.kz.product.access_log timedc;
			proxy_pass http://site_kz_head_upstream;
			proxy_cache_valid 200 6h;
			proxy_cache m-product-kz;
		}
		location /p2/ {
			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
	
			access_log /var/log/nginx/m.kz.access_log timeds;
			access_log /var/log/nginx/m.kz.product.access_log timedc;
			proxy_pass http://site_kz_head_upstream;
			proxy_cache_valid 200 6h;
			proxy_cache m-product-kz;
		}
		location = /robots.txt {
			access_log /var/log/nginx/m.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location /ssi/ {
			internal;
			log_subrequest on;
			error_page 400 401 403 404 500 502 503 504 = @zero;
			proxy_cache_key $scheme://site_upstream/v11.11$uri$is_args$args;
			proxy_pass http://site_kz_head_upstream;
			access_log /var/log/nginx/m.kz.ssi.access_log subtimed;

			location /ssi/comments/ {
				proxy_pass http://site_kz_head_upstream;
				access_log /var/log/nginx/m.kz.ssi.comments.access_log subtimed;
			}
			location = /ssi/exp.html {
				alias /data/split/${split_dir}/${split_bbbaaa5}/${split_bbbaaa_ranking}/${split_bbbaaa_mobile}.html;
				access_log /var/log/nginx/m.kz.ssi.exp.access_log subtimed;
			}
			location /ssi/recommend/ {
				proxy_pass http://site_kz_head_upstream;
				access_log /var/log/nginx/m.kz.ssi.recommend.access_log subtimed;
				proxy_cache_valid 200 5m;
				proxy_cache m-ssi-recommend-kz;
			}
			location = /ssi/recommend/product-product {
				proxy_pass http://site_kz_head_upstream;
				access_log /var/log/nginx/m.kz.ssi.recommend.access_log subtimed;
			}
			location = /ssi/recommend/topsellers {
				proxy_pass http://site_kz_head_upstream;
				access_log /var/log/nginx/m.kz.ssi.recommend.access_log subtimed;
			}
			location /ssi/sizes/ {
				proxy_pass http://site_kz_head_upstream;
				access_log /var/log/nginx/m.kz.ssi.sizes.access_log subtimedc;
				proxy_cache_valid 200 1m;
				proxy_cache m-ssi-sizes-kz;
			}
			location /ssi/userdata_full/ {
				proxy_pass http://site_kz_head_upstream;
				access_log /var/log/nginx/m.kz.ssi.userdata.access_log subtimed;
			}
		}
		location /static/ {
			access_log /var/log/nginx/m.kz.static.access_log timed;
			alias /data/m-kz/static/;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
			error_page  404 = @static-proxy;
		}
		location @static-proxy {
			proxy_pass http://site_kz_head_static_upstream;
			access_log /var/log/nginx/bbbaaa.static-proxy.access_log timeds;
		}
		location = /z {
			access_log /var/log/nginx/m.z.kz.access_log timeds;
			content_by_lua '
				ngx.location.capture_multi({ {"/z/pass/analytics",{args = ngx.req.get_uri_args()}},{"/z/pass/prism",{args = ngx.req.get_uri_args()}} })
				ngx.status = 204;
			';
		}
	} # ]]]
	server { # tail-m.bbbaaa.kz [[[
		listen 10.233.32.243:80; # carp243
		listen 10.233.32.244:80; # carp244
		listen 10.233.32.243:443 ssl;
		listen 10.233.32.244:443 ssl;
		server_name tail-m.bbbaaa.kz;
		access_log /var/log/nginx/m.tail.kz.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.kz.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.kz.key;

		ssi on;

		proxy_set_header Host     $host;
		proxy_set_header X-DDoS   $ddos;
		proxy_set_header X-LID    $uid_any;
		proxy_set_header X-Mobile yes;
		proxy_set_header X-Splits banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;

		proxy_set_header X-Forwarded-For      $remote_addr;
		proxy_set_header X-Forwarded-Host     $host;
		proxy_set_header X-Forwarded-Port     $server_port;
		proxy_set_header X-Forwarded-Protocol $detected_protocol;
		proxy_set_header X-Real-IP            $remote_addr;

		proxy_intercept_errors on;

		error_page 401 402 404 /err/404.html;
		error_page 403 /err/403.html;
		error_page 500 /err/500.html;
		error_page 502 /err/502.html;
		error_page 503 /err/503.html;
		error_page 504 /err/504.html;

		if ( $arg_split_bbbaaa5 ) {
			set $split_bbbaaa5 $arg_split_bbbaaa5;
		}
		if ( $arg_split_bbbaaa_banner ) {
			set $split_bbbaaa_banner $arg_split_bbbaaa_banner;
		}
		if ( $arg_split_bbbaaa_mobile ) {
			set $split_bbbaaa_mobile $arg_split_bbbaaa_mobile;
		}
		if ( $arg_split_bbbaaa_perm ) {
			set $split_bbbaaa_perm $arg_split_bbbaaa_perm;
		}
		if ( $arg_split_bbbaaa_ranking ) {
			set $split_bbbaaa_ranking $arg_split_bbbaaa_ranking;
		}

		# desktop site redirect
		add_header Set-Cookie $mobile_cookie_kz;
		if ( $mobile_site = 2 ) {
			return 302 $detected_protocol://www.bbbaaa.kz$request_uri;
		}

		### uakari-locations begin ###
		location = /uakari-redis {
			internal;
			redis2_connect_timeout 3s;
			redis2_read_timeout    1s;
			redis2_send_timeout    1s;
			redis2_query get $arg_key;
			redis2_pass uakari_redis_upstream;
		}
		location /s/ {
			location /s/ {
				return 404;
			}
			location ~ ^/s/(?<key>[^/]+)$ {
				content_by_lua '
					local res = ngx.location.capture( "/uakari-redis?key=" .. ngx.var["key"] )
					if res.status ~= 200 then
						ngx.status = 500
						ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
					end
					local uri = string.match( res.body, "\\n([^\\n]+)" )
					if not uri then
						ngx.status = 404
						ngx.exit(ngx.HTTP_NOT_FOUND)
					end
					ngx.redirect( "http://" .. ngx.var.host .. uri, 301 )
				';
			}
		}
		### uakari-locations end   ###
		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###
		### whoami-location begin ###
		location = /whoami {

			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###

			ssi off;

			content_by_lua '
							ngx.header.content_type = "text/html"
							local uid_any = ngx.var.uid_any or "Undefined"
							local split_bbbaaa5 = ngx.var.split_bbbaaa5 or "Undefined"
							local split_bbbaaa_banner = ngx.var.split_bbbaaa_banner or "Undefined"
							local split_bbbaaa_mobile = ngx.var.split_bbbaaa_mobile or "Undefined"
							local split_bbbaaa_ranking = ngx.var.split_bbbaaa_ranking or "Undefined"
							local split_bbbaaa_perm = ngx.var.split_bbbaaa_perm or "Undefined"
							local split_madmin = ngx.var.split_madmin or "Undefined"
							ngx.say( "<h4>Parameters</h4><ul>" )
							ngx.say( "<li> lid" .. string.sub(uid_any,4) )
							ngx.say( "<li> split_bbbaaa5=" .. split_bbbaaa5 )
							ngx.say( "<li> split_bbbaaa_banner=" .. split_bbbaaa_banner )
							ngx.say( "<li> split_bbbaaa_mobile=" .. split_bbbaaa_mobile )
							ngx.say( "<li> split_bbbaaa_ranking=" .. split_bbbaaa_ranking  )
							ngx.say( "<li> split_bbbaaa_perm=" .. split_bbbaaa_perm  )
							ngx.say( "<li> split_madmin=" .. split_madmin  )
							ngx.say( "</ul>" )

							ngx.say( "<h4>Your visible cookies</h4><ul>" )
							for x in string.gmatch(ngx.req.get_headers()["cookie"] or "", "[^;]+") do
							    ngx.say(string.format("<li>%s",x))
							end
							ngx.say( "</ul>" )

							local fldr_name = ngx.var.split_dir

							local ssi_file_path = "/data/split/".. fldr_name .. "/" .. split_bbbaaa5 .. "/" .. split_bbbaaa_ranking .. "/" .. split_bbbaaa_mobile .. ".html"
							ngx.say( "<h4> Filepath: " .. ssi_file_path .. "</h4><ul>" )

							local fh = io.open(ssi_file_path)
							if fh then
							    ngx.say( "<plaintext>" )
							    for line in fh:lines() do
							        ngx.say( line )
							    end
							    fh:close()
							end
			';
		}
		### whoami-location end ###
		### z-pass-locations begin ###
		location /z/pass/ {
			internal;
	### proxy-set-headers begin ###
	proxy_set_header  Host                  $host;
	proxy_set_header  X-Real-IP             $remote_addr;
	proxy_set_header  X-Forwarded-For       $remote_addr;
	proxy_set_header  X-Forwarded-Host      $host;
	proxy_set_header  X-Forwarded-Port      $server_port;
	proxy_set_header  X-Forwarded-Protocol  $scheme;
	### proxy-set-headers end ###
			proxy_set_header Connection '';
			proxy_set_header X-CMR      $cookie_LM_REMAIL;
			proxy_set_header X-UID-Got  $uid_got;
			proxy_set_header X-UID-Set  $uid_set;

			proxy_connect_timeout 100ms;
			proxy_send_timeout    100ms;
			proxy_read_timeout    100ms;

			proxy_http_version 1.1;

			error_page 400 401 403 404 500 502 503 504 = @zero;

			location = /z/pass/analytics {
				proxy_pass http://z_analytics_upstream/z;
			}
			location = /z/pass/prism {
				proxy_pass http://z_prism_upstream/z;
			}
		}
		### z-pass-locations end ###
		### zero-location begin ###
		location @zero {
			return 204;
		}
		### zero-locations end  ###
		location / {
			proxy_pass http://site_kz_tail_upstream;
		}
		location = / {
			proxy_pass http://site_kz_tail_upstream;
		}
		location /action/ {
			proxy_pass http://site_kz_tail_upstream;
		}
		location = /apple-touch-icon.png {
			access_log /var/log/nginx/m.tail.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-72x72.png {
			access_log /var/log/nginx/m.tail.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-72x72-precomposed.png {
			access_log /var/log/nginx/m.tail.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-76x76.png {
			access_log /var/log/nginx/m.tail.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-76x76-precomposed.png {
			access_log /var/log/nginx/m.tail.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-114x114.png {
			access_log /var/log/nginx/m.tail.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-114x114-precomposed.png {
			access_log /var/log/nginx/m.tail.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-120x120.png {
			access_log /var/log/nginx/m.tail.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-120x120-precomposed.png {
			access_log /var/log/nginx/m.tail.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-144x144.png {
			access_log /var/log/nginx/m.tail.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-144x144-precomposed.png {
			access_log /var/log/nginx/m.tail.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /apple-touch-icon-152x152-precomposed.png {
			access_log /var/log/nginx/m.tail.kz.static.access_log timed;
			alias /data/site-kz/misc/apple-touch-icon-precomposed.png;
		}
		location = /apple-touch-icon-precomposed.png {
			access_log /var/log/nginx/m.tail.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location /b/ {
			proxy_pass http://site_kz_tail_upstream;
		}
		location /brands/ {
			proxy_pass http://site_kz_tail_upstream;
		}
		location /c/ {
			proxy_pass http://site_kz_tail_upstream;
		}
		location /cb/ {
			proxy_pass http://site_kz_tail_upstream;
		}
		location /catalogsearch/suggest/ {
			proxy_pass http://site_kz_tail_upstream;
		}
		location /checkout/ {
			proxy_pass http://site_kz_tail_upstream;
		}
		location /checkout/cart/ {
			proxy_pass http://site_kz_tail_upstream;
		}
		location /err/ {
			internal;
			alias /data/site-kz/misc/;
		}
		location = /favicon.ico {
			access_log /var/log/nginx/m.tail.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location /files/ {
			access_log /var/log/nginx/m.tail.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location /flat/ {
			access_log off;
						### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://site_kz_tail_upstream;
		}
		location /landing/ {
			proxy_pass http://site_kz_tail_upstream;
		}
		location = /localstorage.html {
			access_log /var/log/nginx/m.tail.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location = /nt {
			access_log /var/log/nginx/m.tail.kz.static.access_log timed;
			return 204;
		}
		location /p/ {
			proxy_pass http://site_kz_tail_upstream;
		}
		location /p2/ {
			proxy_pass http://site_kz_tail_upstream;
		}
		location = /robots.txt {
			access_log /var/log/nginx/m.tail.kz.static.access_log timed;
			root /data/site-kz/misc;
		}
		location /ssi/ {
#			internal;
			log_subrequest on;
			error_page 400 401 403 404 500 502 503 504 = @zero;
			proxy_pass http://site_kz_tail_upstream;
			access_log /var/log/nginx/m.tail.kz.ssi.access_log subtimed;

			location /ssi/comments/ {
				proxy_pass http://site_kz_tail_upstream;
			}
			location = /ssi/exp.html {
				alias /data/split/${split_dir}/${split_bbbaaa5}/${split_bbbaaa_ranking}/${split_bbbaaa_mobile}.html;
			}
			location /ssi/recommend/ {
				proxy_pass http://site_kz_tail_upstream;
			}
			location = /ssi/recommend/product-product {
				proxy_pass http://site_kz_tail_upstream;
			}
			location = /ssi/recommend/topsellers {
				proxy_pass http://site_kz_tail_upstream;
			}
			location /ssi/sizes/ {
				proxy_pass http://site_kz_tail_upstream;
			}
			location /ssi/userdata_full/ {
				proxy_pass http://site_kz_tail_upstream;
			}
		}
		location /static/ {
			access_log /var/log/nginx/m.tail.kz.static.access_log timed;
			alias /data/m-kz/static/;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
			error_page  404 = @static-proxy;
		}
		location @static-proxy {
			proxy_pass http://site_kz_tail_static_upstream;
			access_log /var/log/nginx/bbbaaa.static-proxy.access_log timeds;
		}
		location = /z {
			access_log /var/log/nginx/m.tail.kz.static.access_log timed;
			content_by_lua '
				ngx.location.capture_multi({ {"/z/pass/analytics",{args = ngx.req.get_uri_args()}},{"/z/pass/prism",{args = ngx.req.get_uri_args()}} })
				ngx.status = 204;
			';
		}
	} # ]]]
	# end site kz ]]]
	# site ru [[[
	server { # bbbaaa.ru [[[
		listen 31.13.33.70:80; # carp70
		listen 31.13.33.71:80; # carp71
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		listen 31.13.33.70:443 ssl;
		listen 31.13.33.71:443 ssl;
		listen 10.233.32.219:443 ssl;
		listen 10.233.32.220:443 ssl;
		server_name bbbaaa.ru;
		access_log /var/log/nginx/bbbaaa.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ru.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ru.key;

		return 301 $detected_protocol://www.bbbaaa.ru$request_uri;
	} # ]]]
	server { # www.bbbaaa.ru [[[
		listen 31.13.33.70:80; # carp70
		listen 31.13.33.71:80; # carp71
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		listen 31.13.33.70:443 ssl;
		listen 31.13.33.71:443 ssl;
		listen 10.233.32.219:443 ssl;
		listen 10.233.32.220:443 ssl;
		server_name www.bbbaaa.ru;
		access_log /var/log/nginx/bbbaaa.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ru.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ru.key;

		set_real_ip_from 10.233.32.0/24;
		# QRator pool
		set_real_ip_from 64.48.224.8;
		set_real_ip_from 64.48.224.9;
		set_real_ip_from 64.48.224.10;
		set_real_ip_from 64.48.224.11;
		set_real_ip_from 66.110.32.128;
		set_real_ip_from 66.110.32.129;
		set_real_ip_from 66.110.32.130;
		set_real_ip_from 66.110.32.131;
		set_real_ip_from 87.245.197.192;
		set_real_ip_from 87.245.197.193;
		set_real_ip_from 87.245.197.194;
		set_real_ip_from 87.245.197.195;
		set_real_ip_from 87.245.197.196;
		set_real_ip_from 134.90.144.224;
		set_real_ip_from 134.90.144.225;
		set_real_ip_from 134.90.144.226;
		set_real_ip_from 134.90.144.227;
		set_real_ip_from 83.234.15.112;
		set_real_ip_from 83.234.15.113;
		set_real_ip_from 83.234.15.114;
		set_real_ip_from 83.234.15.115;
		set_real_ip_from 83.234.15.116;
		set_real_ip_from 128.177.119.64;
		set_real_ip_from 128.177.119.65;
		set_real_ip_from 128.177.119.66;
		set_real_ip_from 128.177.119.67;
		set_real_ip_from 178.248.232.128/28;
		set_real_ip_from 178.248.233.128/28;
		set_real_ip_from 178.248.234.128/28;
		set_real_ip_from 178.248.235.128/28;
		set_real_ip_from 178.248.236.128/28;
		set_real_ip_from 178.248.237.128/28;
		set_real_ip_from 178.248.239.128/28;

		userid_service 1024;
		userid         on;

		ssi on;

		proxy_set_header Host     $host;
		proxy_set_header X-DDoS   $ddos;
		proxy_set_header X-LID    $uid_any;
		proxy_set_header X-Splits banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;

		proxy_set_header X-Forwarded-For      $remote_addr;
		proxy_set_header X-Forwarded-Host     $host;
		proxy_set_header X-Forwarded-Port     $server_port;
		proxy_set_header X-Forwarded-Protocol $detected_protocol;
		proxy_set_header X-Real-IP            $remote_addr;

		proxy_intercept_errors on;

		proxy_cache_key $detected_protocol://site_upstream/v11.11$uri?$norm_args;

		error_page 401 402 404 /err/404.html;
		error_page 403 /err/403.html;
		error_page 500 /err/500.html;
		error_page 502 /err/502.html;
		error_page 503 /err/503.html;
		error_page 504 /err/504.html;

		if ( $arg_split_bbbaaa5 ) {
			set $split_bbbaaa5 $arg_split_bbbaaa5;
		}
		if ( $arg_split_bbbaaa_banner ) {
			set $split_bbbaaa_banner $arg_split_bbbaaa_banner;
		}
		if ( $arg_split_bbbaaa_mobile ) {
			set $split_bbbaaa_mobile $arg_split_bbbaaa_mobile;
		}
		if ( $arg_split_bbbaaa_perm ) {
			set $split_bbbaaa_perm $arg_split_bbbaaa_perm;
		}
		if ( $arg_split_bbbaaa_ranking ) {
			set $split_bbbaaa_ranking $arg_split_bbbaaa_ranking;
		}

		if ( $site585 ) {
			return 302 http://$host$site585?$args&rdr585=1;
		}

		# mobile site redirect
		add_header Set-Cookie $mobile_cookie;
		if ( $mobile_site = 1 ) {
			return 302 $detected_protocol://m.bbbaaa.ru$request_uri;
		}

		# seo redirect
		if ( $ui2086 ) {
			return 301 $detected_protocol://$host$uri;
		}

		### bs-locations begin ###
		location /bs-click/ {
			proxy_pass http://bs_head_upstream/click/;
		}
		location /bs-hit/ {
			internal;
			error_page 400 401 403 404 500 502 503 504 = @zero;

			proxy_connect_timeout 100ms;
			proxy_read_timeout    200ms;
			proxy_pass_request_headers off;

			proxy_next_upstream   error
			                      timeout
			;

			proxy_set_header  Host                  bs.local;
			proxy_set_header  X-Real-IP             $remote_addr;
			proxy_set_header  X-Forwarded-For       $remote_addr;
			proxy_set_header  X-Forwarded-Host      $host;
			proxy_set_header  X-Forwarded-Port      $server_port;
			proxy_set_header  X-Forwarded-Protocol  $scheme;
			proxy_set_header  X-LID                 $uid_any;
			proxy_set_header  X-Splits              banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header  Referer               $scheme://$http_host$request_uri;
			proxy_set_header  Rereferer             $http_referer;
			proxy_set_header  X-City-ID             $city_id;
			proxy_set_header  X-Region-ID           $region_id;

			proxy_pass http://bs_head_upstream/hit/;
		}
		location /bs-ssi/ {
			internal;
			alias /data/bs/ssi/;
		}
		### bs-locations end   ###
		### sorting-location begin ###
		location = /sf {
			internal;

			log_subrequest on;
			access_log /var/log/nginx/sort.access_log subtimed;

			proxy_connect_timeout 10ms;
			proxy_read_timeout    50ms;

			proxy_pass_request_headers off;

			proxy_set_header Host         sort.local;
			proxy_set_header X-LID        $uid_val;
			proxy_set_header X-Splits     banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header X-URL        $scheme://$host$request_uri;
			# geo
			proxy_set_header X-Geo        $geo;
			proxy_set_header X-City-ID    $city_id;
			proxy_set_header X-Country-ID $country_id;
			proxy_set_header X-Region-ID  $region_id;

			proxy_pass http://sort_head_upstream/mapping/sorting_factor_simple/;
		}
		### sorting-location end   ###
		### uakari-locations begin ###
		location = /uakari-redis {
			internal;
			redis2_connect_timeout 3s;
			redis2_read_timeout    1s;
			redis2_send_timeout    1s;
			redis2_query get $arg_key;
			redis2_pass uakari_redis_upstream;
		}
		location /s/ {
			location /s/ {
				return 404;
			}
			location ~ ^/s/(?<key>[^/]+)$ {
				content_by_lua '
					local res = ngx.location.capture( "/uakari-redis?key=" .. ngx.var["key"] )
					if res.status ~= 200 then
						ngx.status = 500
						ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
					end
					local uri = string.match( res.body, "\\n([^\\n]+)" )
					if not uri then
						ngx.status = 404
						ngx.exit(ngx.HTTP_NOT_FOUND)
					end
					ngx.redirect( "http://" .. ngx.var.host .. uri, 301 )
				';
			}
		}
		### uakari-locations end   ###
		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###
		### whoami-location begin ###
		location = /whoami {

			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###

			ssi off;

			content_by_lua '
							ngx.header.content_type = "text/html"
							local uid_any = ngx.var.uid_any or "Undefined"
							local split_bbbaaa5 = ngx.var.split_bbbaaa5 or "Undefined"
							local split_bbbaaa_banner = ngx.var.split_bbbaaa_banner or "Undefined"
							local split_bbbaaa_mobile = ngx.var.split_bbbaaa_mobile or "Undefined"
							local split_bbbaaa_ranking = ngx.var.split_bbbaaa_ranking or "Undefined"
							local split_bbbaaa_perm = ngx.var.split_bbbaaa_perm or "Undefined"
							local split_madmin = ngx.var.split_madmin or "Undefined"
							ngx.say( "<h4>Parameters</h4><ul>" )
							ngx.say( "<li> lid" .. string.sub(uid_any,4) )
							ngx.say( "<li> split_bbbaaa5=" .. split_bbbaaa5 )
							ngx.say( "<li> split_bbbaaa_banner=" .. split_bbbaaa_banner )
							ngx.say( "<li> split_bbbaaa_mobile=" .. split_bbbaaa_mobile )
							ngx.say( "<li> split_bbbaaa_ranking=" .. split_bbbaaa_ranking  )
							ngx.say( "<li> split_bbbaaa_perm=" .. split_bbbaaa_perm  )
							ngx.say( "<li> split_madmin=" .. split_madmin  )
							ngx.say( "</ul>" )

							ngx.say( "<h4>Your visible cookies</h4><ul>" )
							for x in string.gmatch(ngx.req.get_headers()["cookie"] or "", "[^;]+") do
							    ngx.say(string.format("<li>%s",x))
							end
							ngx.say( "</ul>" )

							local fldr_name = ngx.var.split_dir

							local ssi_file_path = "/data/split/".. fldr_name .. "/" .. split_bbbaaa5 .. "/" .. split_bbbaaa_ranking .. "/" .. split_bbbaaa_mobile .. ".html"
							ngx.say( "<h4> Filepath: " .. ssi_file_path .. "</h4><ul>" )

							local fh = io.open(ssi_file_path)
							if fh then
							    ngx.say( "<plaintext>" )
							    for line in fh:lines() do
							        ngx.say( line )
							    end
							    fh:close()
							end
			';
		}
		### whoami-location end ###
		### z-pass-locations begin ###
		location /z/pass/ {
			internal;
	### proxy-set-headers begin ###
	proxy_set_header  Host                  $host;
	proxy_set_header  X-Real-IP             $remote_addr;
	proxy_set_header  X-Forwarded-For       $remote_addr;
	proxy_set_header  X-Forwarded-Host      $host;
	proxy_set_header  X-Forwarded-Port      $server_port;
	proxy_set_header  X-Forwarded-Protocol  $scheme;
	### proxy-set-headers end ###
			proxy_set_header Connection '';
			proxy_set_header X-CMR      $cookie_LM_REMAIL;
			proxy_set_header X-UID-Got  $uid_got;
			proxy_set_header X-UID-Set  $uid_set;

			proxy_connect_timeout 100ms;
			proxy_send_timeout    100ms;
			proxy_read_timeout    100ms;

			proxy_http_version 1.1;

			error_page 400 401 403 404 500 502 503 504 = @zero;

			location = /z/pass/analytics {
				proxy_pass http://z_analytics_upstream/z;
			}
			location = /z/pass/prism {
				proxy_pass http://z_prism_upstream/z;
			}
		}
		### z-pass-locations end ###
		### zero-location begin ###
		location @zero {
			return 204;
		}
		### zero-locations end  ###
		location / {
			access_log /var/log/nginx/bbbaaa.access_log timeds;
			access_log /var/log/nginx/bbbaaa.misc.access_log timed;
			proxy_pass http://site_head_upstream;
		}
		location = / {
			access_log /var/log/nginx/bbbaaa.access_log timeds;
			access_log /var/log/nginx/bbbaaa.index.access_log timedc;
			proxy_pass http://site_head_upstream;
			proxy_cache_valid 200 5m;
			proxy_cache pages;
			proxy_cache_key $detected_protocol://site_upstream/v11.11$uri;
		}
		location /action/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			access_log /var/log/nginx/bbbaaa.access_log timeds;
			access_log /var/log/nginx/bbbaaa.catalog.access_log timedc;
			proxy_pass http://site_head_upstream;
			proxy_cache_key $detected_protocol://site_upstream/v11.11$uri?$norm_args:sf=$sf;
			proxy_cache_valid 200 10m;
			proxy_cache catalog;
		}
		location = /apple-touch-icon.png {
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-72x72.png {
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-72x72-precomposed.png {
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-76x76.png {
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-76x76-precomposed.png {
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-114x114.png {
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-114x114-precomposed.png {
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-120x120.png {
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-120x120-precomposed.png {
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-144x144.png {
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-144x144-precomposed.png {
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-152x152-precomposed.png {
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
			alias /data/site/misc/apple-touch-icon-precomposed.png;
		}
		location = /apple-touch-icon-precomposed.png {
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
			root /data/site/misc;
		}
		location /b/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			access_log /var/log/nginx/bbbaaa.access_log timeds;
			access_log /var/log/nginx/bbbaaa.catalog.access_log timedc;
			proxy_pass http://site_head_upstream;
			proxy_cache_key $detected_protocol://site_upstream/v11.11$uri?$norm_args:sf=$sf;
			proxy_cache_valid 200 10m;
			proxy_cache catalog;
		}
		location /brands/ {
			access_log /var/log/nginx/bbbaaa.access_log timeds;
			access_log /var/log/nginx/bbbaaa.pages.access_log timedc;
			proxy_pass http://site_head_upstream;
			proxy_cache_valid 200 3h;
			proxy_cache pages;
		}
		location /c/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			access_log /var/log/nginx/bbbaaa.access_log timeds;
			access_log /var/log/nginx/bbbaaa.catalog.access_log timedc;
			proxy_pass http://site_head_upstream;
			proxy_cache_key $detected_protocol://site_upstream/v11.11$uri?$norm_args:sf=$sf;
			proxy_cache_valid 200 10m;
			proxy_cache catalog;
		}
		location /cart/ {
			access_log /var/log/nginx/bbbaaa.access_log timeds;
			access_log /var/log/nginx/bbbaaa.cart-actions.access_log timed;
			proxy_pass http://site_head_upstream;
		}
		location /cb/ {
			access_log /var/log/nginx/bbbaaa.access_log timeds;
			access_log /var/log/nginx/bbbaaa.catalog.access_log timedc;
			proxy_pass http://site_head_upstream;
			proxy_cache_valid 200 10m;
			proxy_cache catalog;
		}
		location /catalogsearch/suggest/ {
			access_log /var/log/nginx/bbbaaa.access_log timeds;
			access_log /var/log/nginx/bbbaaa.suggest.access_log timedc;
			proxy_pass http://site_head_upstream;
			proxy_cache_valid 200 1d;
			proxy_cache suggest;
		}
		location /checkout/ {
			access_log /var/log/nginx/bbbaaa.access_log timeds;
			access_log /var/log/nginx/bbbaaa.checkout.access_log timed;
			proxy_pass http://site_head_upstream;
		}
		location /checkout/cart/ {
			access_log /var/log/nginx/bbbaaa.access_log timeds;
			access_log /var/log/nginx/bbbaaa.cart.access_log timed;

			proxy_set_header Host     $host;
			proxy_set_header X-DDoS   $ddos;
			proxy_set_header X-LID    $uid_any;
			proxy_set_header X-Splits banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;

			proxy_set_header X-Forwarded-For      $remote_addr;
			proxy_set_header X-Forwarded-Host     $host;
			proxy_set_header X-Forwarded-Port     $server_port;
			proxy_set_header X-Forwarded-Protocol $detected_protocol;
			proxy_set_header X-Real-IP            $remote_addr;
			proxy_set_header X-Geo                $geo;

			proxy_pass http://site_head_upstream;
		}
		location /e/pup/ {
			alias /data/delivery/dav/pup/;
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
		}
		location /e/refund/ {
			alias /data/bob/dav/refund/;
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
		}
		location /err/ {
			internal;
			alias /data/site/misc/;
		}
		location = /favicon.ico {
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
			root /data/site/misc;
		}
		location /files/ {
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
			root /data/site/misc;
		}
		location /flat/ {
			access_log off;
						### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://site_head_upstream;
		}
		location = /googled0733206de50c577.html {
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
			root /data/site/misc;
		}
		location = /google1878ddce86933217.html {
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
			root /data/site/misc;
		}
		location = /googledefe250e2141dd06.html {
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
			root /data/site/misc;
		}
		location = /helpcenter/ {
			return 301 https://bbbaaaru.zendesk.com/hc/ru/?locale_id=ru;
		}
		location /landing/ {
			access_log /var/log/nginx/bbbaaa.access_log timeds;
			access_log /var/log/nginx/bbbaaa.pages.access_log timedc;
			proxy_pass http://site_head_upstream;
			proxy_cache_valid 200 3h;
			proxy_cache pages;
		}
		location /landing/banners-test/ {
						### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			access_log /var/log/nginx/bbbaaa.access_log timeds;
			access_log /var/log/nginx/bbbaaa.pages.access_log timed;
			proxy_pass http://site_head_upstream;
		}
		location = /localstorage.html {
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
			root /data/site/misc;
		}
		location = /nt {
			access_log /var/log/nginx/bbbaaa.nt.access_log timed;
			return 204;
		}
		location /p/ {
			access_log /var/log/nginx/bbbaaa.access_log timeds;
			access_log /var/log/nginx/bbbaaa.product.access_log timedp2;
			if ( $split_p2 ) {
				rewrite ^/p/(.*) /p2/$1 break;
			}
			proxy_pass http://site_head_upstream;
			proxy_cache_valid 200 6h;
			proxy_cache product;
		}
		location /p2/ {
			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
	
			access_log /var/log/nginx/bbbaaa.access_log timeds;
			access_log /var/log/nginx/bbbaaa.product.access_log timedc;
			proxy_pass http://site_head_upstream;
			proxy_cache_valid 200 6h;
			proxy_cache product;
		}
		location /p/quick/ {
			access_log /var/log/nginx/bbbaaa.access_log timeds;
			access_log /var/log/nginx/bbbaaa.quickview.access_log timedc;
			proxy_pass http://site_head_upstream;
			proxy_cache_valid 200 6h;
			proxy_cache quick;
		}
		# denying access to qiwi payments from anywhere except qiwi - task LAMODA-2620
		# http://jira.bbbaaa.ru/browse/SITE-236
		# http://jira.bbbaaa.ru/browse/LAMODA-6200
		location /qiwipayment/ {
			allow 91.232.230.0/23;
			deny all;
			proxy_set_header Host bob.local;
			proxy_pass http://bob.local/exchange/service/qiwi-payment/;
		}
		# http://jira.bbbaaa.ru/browse/LAMODA-6201
		location /paymentassist/response/notification/ {
			proxy_set_header Host bob.local;
			proxy_pass http://bob.local/pluginassist/order/?method=notification;
		}
		location = /payturepayment/ {
			allow 93.91.18.128/28;
			allow 195.122.19.192/28;
			deny all;
			proxy_set_header Host bob.local;
			proxy_pass http://bob.local/pluginassist/order/notification-payture$is_args$args;
		}
		location = /payturepayment-test/ {
			allow 93.91.18.128/28;
			allow 195.122.19.192/28;
			deny all;
			proxy_set_header Host app.site-beta.bbbaaa.ru;
			proxy_pass http://app.site-beta.bbbaaa.ru/pluginassist/order/notification-payture$is_args$args;
		}
		location /prism/ {
			proxy_set_header Host $proxy_host;
			location /prism/ {
				return 404;
			}
			location = /prism/lid-info {
				proxy_pass http://prism.local/lid-info;
			}
			location = /prism/lid-marketing-segment {
				proxy_pass http://prism.local/lid-marketing-segment;
			}
			location = /prism/sku-size {
				proxy_pass http://prism.local/sku-size;
			}
			location = /prism/sku-size-by-gender {
				proxy_pass http://prism.local/sku-size-by-gender;
			}
		}
		location = /robots.txt {
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
			root /data/site/misc;
		}
		location /sitemap/ {
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
			alias /data/site/map/;
		}
		location = /sitemap.xml {
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
			root /data/site/map;
		}
		location = /social-logo.jpg {
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
			root /data/site/misc;
		}
		location /ssi/ {
			internal;
			log_subrequest on;
			error_page 400 401 403 404 500 502 503 504 = @zero;
			proxy_cache_key $scheme://site_upstream/v11.11$uri$is_args$args;
			proxy_pass http://site_head_upstream;
			access_log /var/log/nginx/bbbaaa.ssi.access_log subtimed;

			location /ssi/comments/ {
				proxy_pass http://site_head_upstream;
				access_log /var/log/nginx/bbbaaa.ssi.comments.access_log subtimed;
			}
			location = /ssi/exp.html {
				alias /data/split/${split_dir}/${split_bbbaaa5}/${split_bbbaaa_ranking}/${split_bbbaaa_mobile}.html;
				access_log /var/log/nginx/bbbaaa.ssi.exp.access_log subtimed;
			}
			location /ssi/menu/ {
				proxy_pass http://site_head_upstream;
				access_log /var/log/nginx/bbbaaa.ssi.menu.access_log subtimedc;
				proxy_cache_valid 200 3h;
				proxy_cache ssi-menu;
			}
			location /ssi/recommend/ {
				proxy_pass http://site_head_upstream;
				access_log /var/log/nginx/bbbaaa.ssi.recommend.access_log subtimedc;
				proxy_cache_valid 200 5m;
				proxy_cache ssi-recommend;
			}
			location = /ssi/recommend/product-product {
				proxy_pass http://site_head_upstream;
				access_log /var/log/nginx/bbbaaa.ssi.recommend.access_log subtimed;
			}
			location = /ssi/recommend/topsellers {
				proxy_pass http://site_head_upstream;
				access_log /var/log/nginx/bbbaaa.ssi.recommend.access_log subtimed;
			}
			location /ssi/sizes/ {
				proxy_pass http://site_head_upstream;
				access_log /var/log/nginx/bbbaaa.ssi.sizes.access_log subtimedc;
				proxy_cache_valid 200 1m;
				proxy_cache ssi-sizes;
			}
			location /ssi/userdata/ {
				proxy_pass http://site_head_upstream;
				access_log /var/log/nginx/bbbaaa.ssi.userdata.access_log subtimed;
			}
		}
		location /static/ {
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
			alias /data/site/static/;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
			error_page  404 = @static-proxy;
		}
		location @static-proxy {
			proxy_pass http://site_head_static_upstream;
			access_log /var/log/nginx/bbbaaa.static-proxy.access_log timeds;
		}
		location = /strucr28da435b8192f28127be2751f802d1e93e7d8ad7.html {
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
			root /data/site/misc;
		}
		location = /wmail_c7f6d0aa0b31b6fc.html {
			access_log /var/log/nginx/bbbaaa.static.access_log timed;
			root /data/site/misc;
		}
		location /ymlexport/ {
			alias /data/yml/serve/;
			access_log /var/log/nginx/bbbaaa.static.access_log timedc;
		}
		location = /yandex_6872d4afea2de963.txt {
			return 200 ' ';
		}
		location = /z {
			access_log /var/log/nginx/bbbaaa.z.access_log timeds;
			content_by_lua '
				ngx.location.capture_multi({ {"/z/pass/analytics",{args = ngx.req.get_uri_args()}},{"/z/pass/prism",{args = ngx.req.get_uri_args()}} })
				ngx.status = 204;
			';
		}
	} # ]]]
	server { # tail.bbbaaa.ru [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		listen 10.233.32.219:443 ssl;
		listen 10.233.32.220:443 ssl;
		server_name tail.bbbaaa.ru;
		access_log /var/log/nginx/bbbaaa.tail.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ru.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ru.key;

		set_real_ip_from 10.233.32.0/24;
		# QRator pool
		set_real_ip_from 64.48.224.8;
		set_real_ip_from 64.48.224.9;
		set_real_ip_from 64.48.224.10;
		set_real_ip_from 64.48.224.11;
		set_real_ip_from 66.110.32.128;
		set_real_ip_from 66.110.32.129;
		set_real_ip_from 66.110.32.130;
		set_real_ip_from 66.110.32.131;
		set_real_ip_from 87.245.197.192;
		set_real_ip_from 87.245.197.193;
		set_real_ip_from 87.245.197.194;
		set_real_ip_from 87.245.197.195;
		set_real_ip_from 87.245.197.196;
		set_real_ip_from 134.90.144.224;
		set_real_ip_from 134.90.144.225;
		set_real_ip_from 134.90.144.226;
		set_real_ip_from 134.90.144.227;
		set_real_ip_from 83.234.15.112;
		set_real_ip_from 83.234.15.113;
		set_real_ip_from 83.234.15.114;
		set_real_ip_from 83.234.15.115;
		set_real_ip_from 83.234.15.116;
		set_real_ip_from 128.177.119.64;
		set_real_ip_from 128.177.119.65;
		set_real_ip_from 128.177.119.66;
		set_real_ip_from 128.177.119.67;
		set_real_ip_from 178.248.232.128/28;
		set_real_ip_from 178.248.233.128/28;
		set_real_ip_from 178.248.234.128/28;
		set_real_ip_from 178.248.235.128/28;
		set_real_ip_from 178.248.236.128/28;
		set_real_ip_from 178.248.237.128/28;
		set_real_ip_from 178.248.239.128/28;

		userid_service 1024;
		userid         on;

		ssi on;

		proxy_set_header Host     $host;
		proxy_set_header X-DDoS   $ddos;
		proxy_set_header X-LID    $uid_any;
		proxy_set_header X-Splits banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;

		proxy_set_header X-Forwarded-For      $remote_addr;
		proxy_set_header X-Forwarded-Host     $host;
		proxy_set_header X-Forwarded-Port     $server_port;
		proxy_set_header X-Forwarded-Protocol $detected_protocol;
		proxy_set_header X-Real-IP            $remote_addr;

		proxy_intercept_errors on;

		error_page 401 402 404 /err/404.html;
		error_page 403 /err/403.html;
		error_page 500 /err/500.html;
		error_page 502 /err/502.html;
		error_page 503 /err/503.html;
		error_page 504 /err/504.html;

		if ( $arg_split_bbbaaa5 ) {
			set $split_bbbaaa5 $arg_split_bbbaaa5;
		}
		if ( $arg_split_bbbaaa_banner ) {
			set $split_bbbaaa_banner $arg_split_bbbaaa_banner;
		}
		if ( $arg_split_bbbaaa_mobile ) {
			set $split_bbbaaa_mobile $arg_split_bbbaaa_mobile;
		}
		if ( $arg_split_bbbaaa_perm ) {
			set $split_bbbaaa_perm $arg_split_bbbaaa_perm;
		}
		if ( $arg_split_bbbaaa_ranking ) {
			set $split_bbbaaa_ranking $arg_split_bbbaaa_ranking;
		}

		if ( $site585 ) {
			return 302 http://$host$site585?$args&rdr585=1;
		}

		# mobile site redirect
		add_header Set-Cookie $mobile_cookie;
		if ( $mobile_site = 1 ) {
			return 302 $detected_protocol://m.bbbaaa.ru$request_uri;
		}

		# seo redirect
		if ( $ui2086 ) {
			return 301 $detected_protocol://$host$uri;
		}

		### bs-locations begin ###
		location /bs-click/ {
			proxy_pass http://bs_head_upstream/click/;
		}
		location /bs-hit/ {
			internal;
			error_page 400 401 403 404 500 502 503 504 = @zero;

			proxy_connect_timeout 100ms;
			proxy_read_timeout    200ms;
			proxy_pass_request_headers off;

			proxy_next_upstream   error
			                      timeout
			;

			proxy_set_header  Host                  bs.local;
			proxy_set_header  X-Real-IP             $remote_addr;
			proxy_set_header  X-Forwarded-For       $remote_addr;
			proxy_set_header  X-Forwarded-Host      $host;
			proxy_set_header  X-Forwarded-Port      $server_port;
			proxy_set_header  X-Forwarded-Protocol  $scheme;
			proxy_set_header  X-LID                 $uid_any;
			proxy_set_header  X-Splits              banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header  Referer               $scheme://$http_host$request_uri;
			proxy_set_header  Rereferer             $http_referer;
			proxy_set_header  X-City-ID             $city_id;
			proxy_set_header  X-Region-ID           $region_id;

			proxy_pass http://bs_head_upstream/hit/;
		}
		location /bs-ssi/ {
			internal;
			alias /data/bs/ssi/;
		}
		### bs-locations end   ###
		### sorting-location begin ###
		location = /sf {
			internal;

			log_subrequest on;
			access_log /var/log/nginx/sort.access_log subtimed;

			proxy_connect_timeout 10ms;
			proxy_read_timeout    50ms;

			proxy_pass_request_headers off;

			proxy_set_header Host         sort.local;
			proxy_set_header X-LID        $uid_val;
			proxy_set_header X-Splits     banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header X-URL        $scheme://$host$request_uri;
			# geo
			proxy_set_header X-Geo        $geo;
			proxy_set_header X-City-ID    $city_id;
			proxy_set_header X-Country-ID $country_id;
			proxy_set_header X-Region-ID  $region_id;

			proxy_pass http://sort_head_upstream/mapping/sorting_factor_simple/;
		}
		### sorting-location end   ###
		### uakari-locations begin ###
		location = /uakari-redis {
			internal;
			redis2_connect_timeout 3s;
			redis2_read_timeout    1s;
			redis2_send_timeout    1s;
			redis2_query get $arg_key;
			redis2_pass uakari_redis_upstream;
		}
		location /s/ {
			location /s/ {
				return 404;
			}
			location ~ ^/s/(?<key>[^/]+)$ {
				content_by_lua '
					local res = ngx.location.capture( "/uakari-redis?key=" .. ngx.var["key"] )
					if res.status ~= 200 then
						ngx.status = 500
						ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
					end
					local uri = string.match( res.body, "\\n([^\\n]+)" )
					if not uri then
						ngx.status = 404
						ngx.exit(ngx.HTTP_NOT_FOUND)
					end
					ngx.redirect( "http://" .. ngx.var.host .. uri, 301 )
				';
			}
		}
		### uakari-locations end   ###
		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###
		### whoami-location begin ###
		location = /whoami {

			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###

			ssi off;

			content_by_lua '
							ngx.header.content_type = "text/html"
							local uid_any = ngx.var.uid_any or "Undefined"
							local split_bbbaaa5 = ngx.var.split_bbbaaa5 or "Undefined"
							local split_bbbaaa_banner = ngx.var.split_bbbaaa_banner or "Undefined"
							local split_bbbaaa_mobile = ngx.var.split_bbbaaa_mobile or "Undefined"
							local split_bbbaaa_ranking = ngx.var.split_bbbaaa_ranking or "Undefined"
							local split_bbbaaa_perm = ngx.var.split_bbbaaa_perm or "Undefined"
							local split_madmin = ngx.var.split_madmin or "Undefined"
							ngx.say( "<h4>Parameters</h4><ul>" )
							ngx.say( "<li> lid" .. string.sub(uid_any,4) )
							ngx.say( "<li> split_bbbaaa5=" .. split_bbbaaa5 )
							ngx.say( "<li> split_bbbaaa_banner=" .. split_bbbaaa_banner )
							ngx.say( "<li> split_bbbaaa_mobile=" .. split_bbbaaa_mobile )
							ngx.say( "<li> split_bbbaaa_ranking=" .. split_bbbaaa_ranking  )
							ngx.say( "<li> split_bbbaaa_perm=" .. split_bbbaaa_perm  )
							ngx.say( "<li> split_madmin=" .. split_madmin  )
							ngx.say( "</ul>" )

							ngx.say( "<h4>Your visible cookies</h4><ul>" )
							for x in string.gmatch(ngx.req.get_headers()["cookie"] or "", "[^;]+") do
							    ngx.say(string.format("<li>%s",x))
							end
							ngx.say( "</ul>" )

							local fldr_name = ngx.var.split_dir

							local ssi_file_path = "/data/split/".. fldr_name .. "/" .. split_bbbaaa5 .. "/" .. split_bbbaaa_ranking .. "/" .. split_bbbaaa_mobile .. ".html"
							ngx.say( "<h4> Filepath: " .. ssi_file_path .. "</h4><ul>" )

							local fh = io.open(ssi_file_path)
							if fh then
							    ngx.say( "<plaintext>" )
							    for line in fh:lines() do
							        ngx.say( line )
							    end
							    fh:close()
							end
			';
		}
		### whoami-location end ###
		### z-pass-locations begin ###
		location /z/pass/ {
			internal;
	### proxy-set-headers begin ###
	proxy_set_header  Host                  $host;
	proxy_set_header  X-Real-IP             $remote_addr;
	proxy_set_header  X-Forwarded-For       $remote_addr;
	proxy_set_header  X-Forwarded-Host      $host;
	proxy_set_header  X-Forwarded-Port      $server_port;
	proxy_set_header  X-Forwarded-Protocol  $scheme;
	### proxy-set-headers end ###
			proxy_set_header Connection '';
			proxy_set_header X-CMR      $cookie_LM_REMAIL;
			proxy_set_header X-UID-Got  $uid_got;
			proxy_set_header X-UID-Set  $uid_set;

			proxy_connect_timeout 100ms;
			proxy_send_timeout    100ms;
			proxy_read_timeout    100ms;

			proxy_http_version 1.1;

			error_page 400 401 403 404 500 502 503 504 = @zero;

			location = /z/pass/analytics {
				proxy_pass http://z_analytics_upstream/z;
			}
			location = /z/pass/prism {
				proxy_pass http://z_prism_upstream/z;
			}
		}
		### z-pass-locations end ###
		### zero-location begin ###
		location @zero {
			return 204;
		}
		### zero-locations end  ###
		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.site.local
        - host: back02.site.local
        - host: back03.site.local
        - host: back04.site.local
        - host: back05.site.local
        - host: back06.site.local
        - host: back07.site.local
        - host: back08.site.local
        - host: back09.site.local
        - host: back10.site.local
    lolek:
        - host: back101.site.local
        - host: back102.site.local
        - host: back103.site.local
        - host: back104.site.local
        - host: back105.site.local
        - host: back106.site.local
        - host: back107.site.local
        - host: back108.site.local
        - host: back109.site.local
        - host: back110.site.local
head: lolek
super: super.back.site.local
tail: bolek
';}

		location / {
			proxy_pass http://site_tail_upstream;
		}
		location /action/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			proxy_pass http://site_tail_upstream;
		}
		location = /apple-touch-icon.png {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-72x72.png {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-72x72-precomposed.png {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-76x76.png {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-76x76-precomposed.png {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-114x114.png {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-114x114-precomposed.png {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-120x120.png {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-120x120-precomposed.png {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-144x144.png {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-144x144-precomposed.png {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-152x152-precomposed.png {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timed;
			alias /data/site/misc/apple-touch-icon-precomposed.png;
		}
		location = /apple-touch-icon-precomposed.png {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timed;
			root /data/site/misc;
		}
		location /b/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			proxy_pass http://site_tail_upstream;
		}
		location /brands/ {
			proxy_pass http://site_tail_upstream;
		}
		location /c/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			proxy_pass http://site_tail_upstream;
		}
		location /cart/ {
			proxy_pass http://site_tail_upstream;
		}
		location /cb/ {
			proxy_pass http://site_tail_upstream;
		}
		location /catalogsearch/suggest/ {
			proxy_pass http://site_tail_upstream;
		}
		location /checkout/ {
			proxy_pass http://site_tail_upstream;
		}
		location /checkout/cart/ {
			proxy_set_header Host     $host;
			proxy_set_header X-DDoS   $ddos;
			proxy_set_header X-LID    $uid_any;
			proxy_set_header X-Splits banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;

			proxy_set_header X-Forwarded-For      $remote_addr;
			proxy_set_header X-Forwarded-Host     $host;
			proxy_set_header X-Forwarded-Port     $server_port;
			proxy_set_header X-Forwarded-Protocol $detected_protocol;
			proxy_set_header X-Real-IP            $remote_addr;
			proxy_set_header X-Geo                $geo;

			proxy_pass http://site_tail_upstream;
		}
		location /e/pup/ {
			alias /data/delivery/dav/pup/;
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timed;
		}
		location /e/refund/ {
			alias /data/bob/dav/refund/;
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timed;
		}
		location /err/ {
			internal;
			alias /data/site/misc/;
		}
		location = /favicon.ico {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timeds;
			root /data/site/misc;
		}
		location /files/ {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timed;
			root /data/site/misc;
		}
		location /flat/ {
						### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://site_tail_upstream;
		}
		location = /googled0733206de50c577.html {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /google1878ddce86933217.html {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /googledefe250e2141dd06.html {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /helpcenter/ {
			return 301 https://bbbaaaru.zendesk.com/hc/ru/categories/200086292-locale-ru;
		}
		location /landing/ {
			proxy_pass http://site_tail_upstream;
		}
		location /landing/banners-test/ {
						### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://site_tail_upstream;
		}
		location = /localstorage.html {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timeds;
			root /data/site/misc;
		}
		location = /nt {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timeds;
			return 204;
		}
		location /p/ {
			proxy_pass http://site_tail_upstream;
		}
		location /p2/ {
			proxy_pass http://site_tail_upstream;
		}
		location /p/quick/ {
			proxy_pass http://site_tail_upstream;
		}
		# denying access to qiwi payments from anywhere except qiwi - task LAMODA-2620
		# http://jira.bbbaaa.ru/browse/SITE-236
		# http://jira.bbbaaa.ru/browse/LAMODA-6200
		location /qiwipayment/ {
			allow 91.232.230.0/23;
			deny all;
			proxy_set_header Host bob.local;
			proxy_pass http://bob.local/exchange/service/qiwi-payment/;
		}
		# http://jira.bbbaaa.ru/browse/LAMODA-6201
		location /paymentassist/response/notification/ {
			proxy_set_header Host bob.local;
			proxy_pass http://bob.local/pluginassist/order/?method=notification;
		}
		location = /payturepayment/ {
			allow 93.91.18.128/28;
			allow 195.122.19.192/28;
			deny all;
			proxy_set_header Host bob.local;
			proxy_pass http://bob.local/pluginassist/order/notification-payture$is_args$args;
		}
		location = /payturepayment-test/ {
			allow 93.91.18.128/28;
			allow 195.122.19.192/28;
			deny all;
			proxy_set_header Host app.site-beta.bbbaaa.ru;
			proxy_pass http://app.site-beta.bbbaaa.ru/pluginassist/order/notification-payture$is_args$args;
		}
		location /prism/ {
			proxy_set_header Host $proxy_host;
			location /prism/ {
				return 404;
			}
			location = /prism/lid-info {
				proxy_pass http://prism.local/lid-info;
			}
			location = /prism/lid-marketing-segment {
				proxy_pass http://prism.local/lid-marketing-segment;
			}
			location = /prism/sku-size {
				proxy_pass http://prism.local/sku-size;
			}
			location = /prism/sku-size-by-gender {
				proxy_pass http://prism.local/sku-size-by-gender;
			}
		}
		location = /robots.txt {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timeds;
			root /data/site/misc;
		}
		location /sitemap/ {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timed;
			alias /data/site/map/;
		}
		location = /sitemap.xml {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timed;
			root /data/site/map;
		}
		location = /social-logo.jpg {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timed;
			root /data/site/misc;
		}
		location /ssi/ {
#			internal;
			log_subrequest on;
			error_page 400 401 403 404 500 502 503 504 = @zero;
			proxy_pass http://site_tail_upstream;
			access_log /var/log/nginx/bbbaaa.tail.ssi.access_log subtimed;

			location /ssi/comments/ {
				proxy_pass http://site_tail_upstream;
			}
			location = /ssi/exp.html {
				alias /data/split/${split_dir}/${split_bbbaaa5}/${split_bbbaaa_ranking}/${split_bbbaaa_mobile}.html;
			}
			location /ssi/menu/ {
				proxy_pass http://site_tail_upstream;
			}
			location /ssi/recommend/ {
				proxy_pass http://site_tail_upstream;
			}
			location = /ssi/recommend/product-product {
				proxy_pass http://site_tail_upstream;
			}
			location = /ssi/recommend/topsellers {
				proxy_pass http://site_tail_upstream;
			}
			location /ssi/sizes/ {
				proxy_pass http://site_tail_upstream;
			}
			location /ssi/userdata/ {
				proxy_pass http://site_tail_upstream;
			}
		}
		location /static/ {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timeds;
			alias /data/site/static/;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
			error_page  404 = @static-proxy;
		}
		location @static-proxy {
			proxy_pass http://site_tail_static_upstream;
			access_log /var/log/nginx/bbbaaa.static-proxy.access_log timeds;
		}
		location = /strucr28da435b8192f28127be2751f802d1e93e7d8ad7.html {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /wmail_c7f6d0aa0b31b6fc.html {
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timed;
			root /data/site/misc;
		}
		location /ymlexport/ {
			alias /data/yml/serve/;
			access_log /var/log/nginx/bbbaaa.tail.static.access_log timedc;
		}
		location = /yandex_6872d4afea2de963.txt {
			return 200 ' ';
		}
		location = /z {
			access_log /var/log/nginx/bbbaaa.tail.z.access_log timeds;
			content_by_lua '
				ngx.location.capture_multi({ {"/z/pass/analytics",{args = ngx.req.get_uri_args()}},{"/z/pass/prism",{args = ngx.req.get_uri_args()}} })
				ngx.status = 204;
			';
		}
	} # ]]]
	server { # m.bbbaaa.ru [[[
		listen 31.13.33.70:80; # carp70
		listen 31.13.33.71:80; # carp71
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		listen 31.13.33.70:443 ssl;
		listen 31.13.33.71:443 ssl;
		listen 10.233.32.219:443 ssl;
		listen 10.233.32.220:443 ssl;
		server_name m.bbbaaa.ru;
		access_log /var/log/nginx/m.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ru.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ru.key;

		set_real_ip_from 10.233.32.0/24;
		# QRator pool
		set_real_ip_from 64.48.224.8;
		set_real_ip_from 64.48.224.9;
		set_real_ip_from 64.48.224.10;
		set_real_ip_from 64.48.224.11;
		set_real_ip_from 66.110.32.128;
		set_real_ip_from 66.110.32.129;
		set_real_ip_from 66.110.32.130;
		set_real_ip_from 66.110.32.131;
		set_real_ip_from 87.245.197.192;
		set_real_ip_from 87.245.197.193;
		set_real_ip_from 87.245.197.194;
		set_real_ip_from 87.245.197.195;
		set_real_ip_from 87.245.197.196;
		set_real_ip_from 134.90.144.224;
		set_real_ip_from 134.90.144.225;
		set_real_ip_from 134.90.144.226;
		set_real_ip_from 134.90.144.227;
		set_real_ip_from 83.234.15.112;
		set_real_ip_from 83.234.15.113;
		set_real_ip_from 83.234.15.114;
		set_real_ip_from 83.234.15.115;
		set_real_ip_from 83.234.15.116;
		set_real_ip_from 128.177.119.64;
		set_real_ip_from 128.177.119.65;
		set_real_ip_from 128.177.119.66;
		set_real_ip_from 128.177.119.67;
		set_real_ip_from 178.248.232.128/28;
		set_real_ip_from 178.248.233.128/28;
		set_real_ip_from 178.248.234.128/28;
		set_real_ip_from 178.248.235.128/28;
		set_real_ip_from 178.248.236.128/28;
		set_real_ip_from 178.248.237.128/28;
		set_real_ip_from 178.248.239.128/28;

		userid_service 1027;
		userid         on;

		ssi on;

		proxy_set_header Host     $host;
		proxy_set_header X-DDoS   $ddos;
		proxy_set_header X-LID    $uid_any;
		proxy_set_header X-Mobile yes;
		proxy_set_header X-Splits banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;

		proxy_set_header X-Forwarded-For      $remote_addr;
		proxy_set_header X-Forwarded-Host     $host;
		proxy_set_header X-Forwarded-Port     $server_port;
		proxy_set_header X-Forwarded-Protocol $detected_protocol;
		proxy_set_header X-Real-IP            $remote_addr;

		proxy_intercept_errors on;

		proxy_cache_key $detected_protocol://site_upstream/v11.11$uri?$norm_args;

		error_page 401 402 404 /err/404.html;
		error_page 403 /err/403.html;
		error_page 500 /err/500.html;
		error_page 502 /err/502.html;
		error_page 503 /err/503.html;
		error_page 504 /err/504.html;

		if ( $arg_split_bbbaaa5 ) {
			set $split_bbbaaa5 $arg_split_bbbaaa5;
		}
		if ( $arg_split_bbbaaa_banner ) {
			set $split_bbbaaa_banner $arg_split_bbbaaa_banner;
		}
		if ( $arg_split_bbbaaa_mobile ) {
			set $split_bbbaaa_mobile $arg_split_bbbaaa_mobile;
		}
		if ( $arg_split_bbbaaa_perm ) {
			set $split_bbbaaa_perm $arg_split_bbbaaa_perm;
		}
		if ( $arg_split_bbbaaa_ranking ) {
			set $split_bbbaaa_ranking $arg_split_bbbaaa_ranking;
		}

		# desktop site redirect
		add_header Set-Cookie $mobile_cookie;
		if ( $mobile_site = 2 ) {
			return 302 $detected_protocol://www.bbbaaa.ru$request_uri;
		}

		### uakari-locations begin ###
		location = /uakari-redis {
			internal;
			redis2_connect_timeout 3s;
			redis2_read_timeout    1s;
			redis2_send_timeout    1s;
			redis2_query get $arg_key;
			redis2_pass uakari_redis_upstream;
		}
		location /s/ {
			location /s/ {
				return 404;
			}
			location ~ ^/s/(?<key>[^/]+)$ {
				content_by_lua '
					local res = ngx.location.capture( "/uakari-redis?key=" .. ngx.var["key"] )
					if res.status ~= 200 then
						ngx.status = 500
						ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
					end
					local uri = string.match( res.body, "\\n([^\\n]+)" )
					if not uri then
						ngx.status = 404
						ngx.exit(ngx.HTTP_NOT_FOUND)
					end
					ngx.redirect( "http://" .. ngx.var.host .. uri, 301 )
				';
			}
		}
		### uakari-locations end   ###
		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###
		### whoami-location begin ###
		location = /whoami {

			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###

			ssi off;

			content_by_lua '
							ngx.header.content_type = "text/html"
							local uid_any = ngx.var.uid_any or "Undefined"
							local split_bbbaaa5 = ngx.var.split_bbbaaa5 or "Undefined"
							local split_bbbaaa_banner = ngx.var.split_bbbaaa_banner or "Undefined"
							local split_bbbaaa_mobile = ngx.var.split_bbbaaa_mobile or "Undefined"
							local split_bbbaaa_ranking = ngx.var.split_bbbaaa_ranking or "Undefined"
							local split_bbbaaa_perm = ngx.var.split_bbbaaa_perm or "Undefined"
							local split_madmin = ngx.var.split_madmin or "Undefined"
							ngx.say( "<h4>Parameters</h4><ul>" )
							ngx.say( "<li> lid" .. string.sub(uid_any,4) )
							ngx.say( "<li> split_bbbaaa5=" .. split_bbbaaa5 )
							ngx.say( "<li> split_bbbaaa_banner=" .. split_bbbaaa_banner )
							ngx.say( "<li> split_bbbaaa_mobile=" .. split_bbbaaa_mobile )
							ngx.say( "<li> split_bbbaaa_ranking=" .. split_bbbaaa_ranking  )
							ngx.say( "<li> split_bbbaaa_perm=" .. split_bbbaaa_perm  )
							ngx.say( "<li> split_madmin=" .. split_madmin  )
							ngx.say( "</ul>" )

							ngx.say( "<h4>Your visible cookies</h4><ul>" )
							for x in string.gmatch(ngx.req.get_headers()["cookie"] or "", "[^;]+") do
							    ngx.say(string.format("<li>%s",x))
							end
							ngx.say( "</ul>" )

							local fldr_name = ngx.var.split_dir

							local ssi_file_path = "/data/split/".. fldr_name .. "/" .. split_bbbaaa5 .. "/" .. split_bbbaaa_ranking .. "/" .. split_bbbaaa_mobile .. ".html"
							ngx.say( "<h4> Filepath: " .. ssi_file_path .. "</h4><ul>" )

							local fh = io.open(ssi_file_path)
							if fh then
							    ngx.say( "<plaintext>" )
							    for line in fh:lines() do
							        ngx.say( line )
							    end
							    fh:close()
							end
			';
		}
		### whoami-location end ###
		### z-pass-locations begin ###
		location /z/pass/ {
			internal;
	### proxy-set-headers begin ###
	proxy_set_header  Host                  $host;
	proxy_set_header  X-Real-IP             $remote_addr;
	proxy_set_header  X-Forwarded-For       $remote_addr;
	proxy_set_header  X-Forwarded-Host      $host;
	proxy_set_header  X-Forwarded-Port      $server_port;
	proxy_set_header  X-Forwarded-Protocol  $scheme;
	### proxy-set-headers end ###
			proxy_set_header Connection '';
			proxy_set_header X-CMR      $cookie_LM_REMAIL;
			proxy_set_header X-UID-Got  $uid_got;
			proxy_set_header X-UID-Set  $uid_set;

			proxy_connect_timeout 100ms;
			proxy_send_timeout    100ms;
			proxy_read_timeout    100ms;

			proxy_http_version 1.1;

			error_page 400 401 403 404 500 502 503 504 = @zero;

			location = /z/pass/analytics {
				proxy_pass http://z_analytics_upstream/z;
			}
			location = /z/pass/prism {
				proxy_pass http://z_prism_upstream/z;
			}
		}
		### z-pass-locations end ###
		### zero-location begin ###
		location @zero {
			return 204;
		}
		### zero-locations end  ###
		location / {
			access_log /var/log/nginx/m.access_log timeds;
			access_log /var/log/nginx/m.misc.access_log timed;
			proxy_pass http://site_head_upstream;
		}
		location = / {
			access_log /var/log/nginx/m.access_log timeds;
			access_log /var/log/nginx/m.index.access_log timedc;
			proxy_pass http://site_head_upstream;
			proxy_cache_valid 200 5m;
			proxy_cache m-pages;
			proxy_cache_key $detected_protocol://site_upstream/v11.11$uri;
		}
		location /action/ {
			access_log /var/log/nginx/m.access_log timeds;
			access_log /var/log/nginx/m.catalog.access_log timedc;
			proxy_pass http://site_head_upstream;
			proxy_cache_valid 200 10m;
			proxy_cache m-catalog;
		}
		location = /apple-touch-icon.png {
			access_log /var/log/nginx/m.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-72x72.png {
			access_log /var/log/nginx/m.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-72x72-precomposed.png {
			access_log /var/log/nginx/m.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-76x76.png {
			access_log /var/log/nginx/m.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-76x76-precomposed.png {
			access_log /var/log/nginx/m.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-114x114.png {
			access_log /var/log/nginx/m.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-114x114-precomposed.png {
			access_log /var/log/nginx/m.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-120x120.png {
			access_log /var/log/nginx/m.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-120x120-precomposed.png {
			access_log /var/log/nginx/m.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-144x144.png {
			access_log /var/log/nginx/m.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-144x144-precomposed.png {
			access_log /var/log/nginx/m.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-152x152-precomposed.png {
			access_log /var/log/nginx/m.static.access_log timed;
			alias /data/site/misc/apple-touch-icon-precomposed.png;
		}
		location = /apple-touch-icon-precomposed.png {
			access_log /var/log/nginx/m.static.access_log timed;
			root /data/site/misc;
		}
		location /b/ {
			access_log /var/log/nginx/m.access_log timeds;
			access_log /var/log/nginx/m.catalog.access_log timedc;
			proxy_pass http://site_head_upstream;
			proxy_cache_valid 200 10m;
			proxy_cache m-catalog;
		}
		location = /BingSiteAuth.xml {
			access_log /var/log/nginx/m.static.access_log timed;
			root /data/site/misc;
		}
		location /brands/ {
			access_log /var/log/nginx/m.access_log timeds;
			access_log /var/log/nginx/m.pages.access_log timedc;
			proxy_pass http://site_head_upstream;
			proxy_cache_valid 200 3h;
			proxy_cache m-pages;
		}
		location /c/ {
			access_log /var/log/nginx/m.access_log timeds;
			access_log /var/log/nginx/m.catalog.access_log timedc;
			proxy_pass http://site_head_upstream;
			proxy_cache_valid 200 10m;
			proxy_cache m-catalog;
		}
		location /cb/ {
			access_log /var/log/nginx/m.access_log timeds;
			access_log /var/log/nginx/m.catalog.access_log timedc;
			proxy_pass http://site_head_upstream;
			proxy_cache_valid 200 10m;
			proxy_cache m-catalog;
		}
		location /catalogsearch/suggest/ {
			access_log /var/log/nginx/m.access_log timeds;
			access_log /var/log/nginx/m.suggest.access_log timedc;
			proxy_pass http://site_head_upstream;
			proxy_cache_valid 200 1d;
			proxy_cache m-suggest;
		}
		location /checkout/ {
			access_log /var/log/nginx/m.access_log timeds;
			access_log /var/log/nginx/m.checkout.access_log timed;
			proxy_pass http://site_head_upstream;
		}
		location /checkout/cart/ {
			access_log /var/log/nginx/m.access_log timeds;
			access_log /var/log/nginx/m.cart.access_log timed;
			proxy_pass http://site_head_upstream;
		}
		location /err/ {
			internal;
			alias /data/site/misc/;
		}
		location = /favicon.ico {
			access_log /var/log/nginx/m.static.access_log timed;
			root /data/site/misc;
		}
		location /files/ {
			access_log /var/log/nginx/m.static.access_log timed;
			root /data/site/misc;
		}
		location /flat/ {
			access_log off;
						### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://site_head_upstream;
		}
		location /landing/ {
			access_log /var/log/nginx/m.access_log timeds;
			access_log /var/log/nginx/m.pages.access_log timedc;
			proxy_pass http://site_head_upstream;
			proxy_cache_valid 200 3h;
			proxy_cache m-pages;
		}
		location = /localstorage.html {
			access_log /var/log/nginx/m.static.access_log timed;
			root /data/site/misc;
		}
		location = /nt {
			access_log /var/log/nginx/m.nt.access_log timed;
			return 204;
		}
		location /p/ {
			access_log /var/log/nginx/m.access_log timeds;
			access_log /var/log/nginx/m.product.access_log timedc;
			proxy_pass http://site_head_upstream;
			proxy_cache_valid 200 6h;
			proxy_cache m-product;
		}
		location /p2/ {
			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
	
			access_log /var/log/nginx/m.access_log timeds;
			access_log /var/log/nginx/m.product.access_log timedc;
			proxy_pass http://site_head_upstream;
			proxy_cache_valid 200 6h;
			proxy_cache m-product;
		}
		location = /robots.txt {
			access_log /var/log/nginx/m.static.access_log timed;
			root /data/site/misc;
		}
		location /ssi/ {
			internal;
			log_subrequest on;
			error_page 400 401 403 404 500 502 503 504 = @zero;
			proxy_cache_key $scheme://site_upstream/v11.11$uri$is_args$args;
			proxy_pass http://site_head_upstream;
			access_log /var/log/nginx/m.ssi.access_log subtimed;

			location /ssi/comments/ {
				proxy_pass http://site_head_upstream;
				access_log /var/log/nginx/m.ssi.comments.access_log subtimed;
			}
			location = /ssi/exp.html {
				alias /data/split/${split_dir}/${split_bbbaaa5}/${split_bbbaaa_ranking}/${split_bbbaaa_mobile}.html;
				access_log /var/log/nginx/m.ssi.exp.access_log subtimed;
			}
			location /ssi/recommend/ {
				proxy_pass http://site_head_upstream;
				access_log /var/log/nginx/m.ssi.recommend.access_log subtimedc;
				proxy_cache_valid 200 5m;
				proxy_cache m-ssi-recommend;
			}
			location = /ssi/recommend/product-product {
				proxy_pass http://site_head_upstream;
				access_log /var/log/nginx/m.ssi.recommend.access_log subtimed;
			}
			location = /ssi/recommend/topsellers {
				proxy_pass http://site_head_upstream;
				access_log /var/log/nginx/m.ssi.recommend.access_log subtimed;
			}
			location /ssi/sizes/ {
				proxy_pass http://site_head_upstream;
				access_log /var/log/nginx/m.ssi.sizes.access_log subtimedc;
				proxy_cache_valid 200 1m;
				proxy_cache m-ssi-sizes;
			}
			location /ssi/userdata_full/ {
				proxy_pass http://site_head_upstream;
				access_log /var/log/nginx/m.ssi.userdata.access_log subtimed;
			}
		}
		location /static/ {
			access_log /var/log/nginx/m.static.access_log timed;
			alias /data/m/static/;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
			error_page  404 = @static-proxy;
		}
		location @static-proxy {
			proxy_pass http://site_head_static_upstream;
			access_log /var/log/nginx/bbbaaa.static-proxy.access_log timeds;
		}
		location = /yandex_483611c07e81061f.html {
			access_log /var/log/nginx/m.static.access_log timed;
			root /data/site/misc;
		}
		location = /z {
			access_log /var/log/nginx/m.z.access_log timeds;
			content_by_lua '
				ngx.location.capture_multi({ {"/z/pass/analytics",{args = ngx.req.get_uri_args()}},{"/z/pass/prism",{args = ngx.req.get_uri_args()}} })
				ngx.status = 204;
			';
		}
	} # ]]]
	server { # tail-m.bbbaaa.ru [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		listen 10.233.32.219:443 ssl;
		listen 10.233.32.220:443 ssl;
		server_name tail-m.bbbaaa.ru;
		access_log /var/log/nginx/m.tail.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ru.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ru.key;

		ssi on;

		proxy_set_header Host     $host;
		proxy_set_header X-DDoS   $ddos;
		proxy_set_header X-LID    $uid_any;
		proxy_set_header X-Mobile yes;
		proxy_set_header X-Splits banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;

		proxy_set_header X-Forwarded-For      $remote_addr;
		proxy_set_header X-Forwarded-Host     $host;
		proxy_set_header X-Forwarded-Port     $server_port;
		proxy_set_header X-Forwarded-Protocol $detected_protocol;
		proxy_set_header X-Real-IP            $remote_addr;

		proxy_intercept_errors on;

		error_page 401 402 404 /err/404.html;
		error_page 403 /err/403.html;
		error_page 500 /err/500.html;
		error_page 502 /err/502.html;
		error_page 503 /err/503.html;
		error_page 504 /err/504.html;

		if ( $arg_split_bbbaaa5 ) {
			set $split_bbbaaa5 $arg_split_bbbaaa5;
		}
		if ( $arg_split_bbbaaa_banner ) {
			set $split_bbbaaa_banner $arg_split_bbbaaa_banner;
		}
		if ( $arg_split_bbbaaa_mobile ) {
			set $split_bbbaaa_mobile $arg_split_bbbaaa_mobile;
		}
		if ( $arg_split_bbbaaa_perm ) {
			set $split_bbbaaa_perm $arg_split_bbbaaa_perm;
		}
		if ( $arg_split_bbbaaa_ranking ) {
			set $split_bbbaaa_ranking $arg_split_bbbaaa_ranking;
		}

		# desktop site redirect
		add_header Set-Cookie $mobile_cookie;
		if ( $mobile_site = 2 ) {
			return 302 $detected_protocol://www.bbbaaa.ru$request_uri;
		}

		### uakari-locations begin ###
		location = /uakari-redis {
			internal;
			redis2_connect_timeout 3s;
			redis2_read_timeout    1s;
			redis2_send_timeout    1s;
			redis2_query get $arg_key;
			redis2_pass uakari_redis_upstream;
		}
		location /s/ {
			location /s/ {
				return 404;
			}
			location ~ ^/s/(?<key>[^/]+)$ {
				content_by_lua '
					local res = ngx.location.capture( "/uakari-redis?key=" .. ngx.var["key"] )
					if res.status ~= 200 then
						ngx.status = 500
						ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
					end
					local uri = string.match( res.body, "\\n([^\\n]+)" )
					if not uri then
						ngx.status = 404
						ngx.exit(ngx.HTTP_NOT_FOUND)
					end
					ngx.redirect( "http://" .. ngx.var.host .. uri, 301 )
				';
			}
		}
		### uakari-locations end   ###
		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###
		### whoami-location begin ###
		location = /whoami {

			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###

			ssi off;

			content_by_lua '
							ngx.header.content_type = "text/html"
							local uid_any = ngx.var.uid_any or "Undefined"
							local split_bbbaaa5 = ngx.var.split_bbbaaa5 or "Undefined"
							local split_bbbaaa_banner = ngx.var.split_bbbaaa_banner or "Undefined"
							local split_bbbaaa_mobile = ngx.var.split_bbbaaa_mobile or "Undefined"
							local split_bbbaaa_ranking = ngx.var.split_bbbaaa_ranking or "Undefined"
							local split_bbbaaa_perm = ngx.var.split_bbbaaa_perm or "Undefined"
							local split_madmin = ngx.var.split_madmin or "Undefined"
							ngx.say( "<h4>Parameters</h4><ul>" )
							ngx.say( "<li> lid" .. string.sub(uid_any,4) )
							ngx.say( "<li> split_bbbaaa5=" .. split_bbbaaa5 )
							ngx.say( "<li> split_bbbaaa_banner=" .. split_bbbaaa_banner )
							ngx.say( "<li> split_bbbaaa_mobile=" .. split_bbbaaa_mobile )
							ngx.say( "<li> split_bbbaaa_ranking=" .. split_bbbaaa_ranking  )
							ngx.say( "<li> split_bbbaaa_perm=" .. split_bbbaaa_perm  )
							ngx.say( "<li> split_madmin=" .. split_madmin  )
							ngx.say( "</ul>" )

							ngx.say( "<h4>Your visible cookies</h4><ul>" )
							for x in string.gmatch(ngx.req.get_headers()["cookie"] or "", "[^;]+") do
							    ngx.say(string.format("<li>%s",x))
							end
							ngx.say( "</ul>" )

							local fldr_name = ngx.var.split_dir

							local ssi_file_path = "/data/split/".. fldr_name .. "/" .. split_bbbaaa5 .. "/" .. split_bbbaaa_ranking .. "/" .. split_bbbaaa_mobile .. ".html"
							ngx.say( "<h4> Filepath: " .. ssi_file_path .. "</h4><ul>" )

							local fh = io.open(ssi_file_path)
							if fh then
							    ngx.say( "<plaintext>" )
							    for line in fh:lines() do
							        ngx.say( line )
							    end
							    fh:close()
							end
			';
		}
		### whoami-location end ###
		### z-pass-locations begin ###
		location /z/pass/ {
			internal;
	### proxy-set-headers begin ###
	proxy_set_header  Host                  $host;
	proxy_set_header  X-Real-IP             $remote_addr;
	proxy_set_header  X-Forwarded-For       $remote_addr;
	proxy_set_header  X-Forwarded-Host      $host;
	proxy_set_header  X-Forwarded-Port      $server_port;
	proxy_set_header  X-Forwarded-Protocol  $scheme;
	### proxy-set-headers end ###
			proxy_set_header Connection '';
			proxy_set_header X-CMR      $cookie_LM_REMAIL;
			proxy_set_header X-UID-Got  $uid_got;
			proxy_set_header X-UID-Set  $uid_set;

			proxy_connect_timeout 100ms;
			proxy_send_timeout    100ms;
			proxy_read_timeout    100ms;

			proxy_http_version 1.1;

			error_page 400 401 403 404 500 502 503 504 = @zero;

			location = /z/pass/analytics {
				proxy_pass http://z_analytics_upstream/z;
			}
			location = /z/pass/prism {
				proxy_pass http://z_prism_upstream/z;
			}
		}
		### z-pass-locations end ###
		### zero-location begin ###
		location @zero {
			return 204;
		}
		### zero-locations end  ###
		location / {
			proxy_pass http://site_tail_upstream;
		}
		location = / {
			proxy_pass http://site_tail_upstream;
		}
		location /action/ {
			proxy_pass http://site_tail_upstream;
		}
		location = /apple-touch-icon.png {
			access_log /var/log/nginx/m.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-72x72.png {
			access_log /var/log/nginx/m.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-72x72-precomposed.png {
			access_log /var/log/nginx/m.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-76x76.png {
			access_log /var/log/nginx/m.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-76x76-precomposed.png {
			access_log /var/log/nginx/m.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-114x114.png {
			access_log /var/log/nginx/m.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-114x114-precomposed.png {
			access_log /var/log/nginx/m.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-120x120.png {
			access_log /var/log/nginx/m.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-120x120-precomposed.png {
			access_log /var/log/nginx/m.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-144x144.png {
			access_log /var/log/nginx/m.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-144x144-precomposed.png {
			access_log /var/log/nginx/m.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-152x152-precomposed.png {
			access_log /var/log/nginx/m.tail.static.access_log timed;
			alias /data/site/misc/apple-touch-icon-precomposed.png;
		}
		location = /apple-touch-icon-precomposed.png {
			access_log /var/log/nginx/m.tail.static.access_log timed;
			root /data/site/misc;
		}
		location /b/ {
			proxy_pass http://site_tail_upstream;
		}
		location /brands/ {
			proxy_pass http://site_tail_upstream;
		}
		location /c/ {
			proxy_pass http://site_tail_upstream;
		}
		location /cb/ {
			proxy_pass http://site_tail_upstream;
		}
		location /catalogsearch/suggest/ {
			proxy_pass http://site_tail_upstream;
		}
		location /checkout/ {
			proxy_pass http://site_tail_upstream;
		}
		location /checkout/cart/ {
			proxy_pass http://site_tail_upstream;
		}
		location /err/ {
			internal;
			alias /data/site/misc/;
		}
		location = /favicon.ico {
			access_log /var/log/nginx/m.tail.static.access_log timed;
			root /data/site/misc;
		}
		location /files/ {
			access_log /var/log/nginx/m.tail.static.access_log timed;
			root /data/site/misc;
		}
		location /flat/ {
			access_log off;
						### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://site_tail_upstream;
		}
		location /landing/ {
			proxy_pass http://site_tail_upstream;
		}
		location = /localstorage.html {
			access_log /var/log/nginx/m.tail.static.access_log timed;
			root /data/site/misc;
		}
		location = /nt {
			access_log /var/log/nginx/m.tail.static.access_log timed;
			return 204;
		}
		location /p/ {
			proxy_pass http://site_tail_upstream;
		}
		location /p2/ {
			proxy_pass http://site_tail_upstream;
		}
		location = /robots.txt {
			access_log /var/log/nginx/m.tail.static.access_log timed;
			root /data/site/misc;
		}
		location /ssi/ {
#			internal;
			log_subrequest on;
			error_page 400 401 403 404 500 502 503 504 = @zero;
			proxy_pass http://site_tail_upstream;
			access_log /var/log/nginx/m.tail.ssi.access_log subtimed;

			location /ssi/comments/ {
				proxy_pass http://site_tail_upstream;
			}
			location = /ssi/exp.html {
				alias /data/split/${split_dir}/${split_bbbaaa5}/${split_bbbaaa_ranking}/${split_bbbaaa_mobile}.html;
			}
			location /ssi/recommend/ {
				proxy_pass http://site_tail_upstream;
			}
			location = /ssi/recommend/product-product {
				proxy_pass http://site_tail_upstream;
			}
			location = /ssi/recommend/topsellers {
				proxy_pass http://site_tail_upstream;
			}
			location /ssi/sizes/ {
				proxy_pass http://site_tail_upstream;
			}
			location /ssi/userdata_full/ {
				proxy_pass http://site_tail_upstream;
			}
		}
		location /static/ {
			access_log /var/log/nginx/m.tail.static.access_log timed;
			alias /data/m/static/;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
			error_page  404 = @static-proxy;
		}
		location @static-proxy {
			proxy_pass http://site_tail_static_upstream;
			access_log /var/log/nginx/bbbaaa.static-proxy.access_log timeds;
		}
		location = /z {
			access_log /var/log/nginx/m.tail.static.access_log timed;
			content_by_lua '
				ngx.location.capture_multi({ {"/z/pass/analytics",{args = ngx.req.get_uri_args()}},{"/z/pass/prism",{args = ngx.req.get_uri_args()}} })
				ngx.status = 204;
			';
		}
	} # ]]]
	server { # m-site-beta.bbbaaa.ru [[[
		listen 31.13.33.70:80; # carp70
		listen 31.13.33.71:80; # carp71
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		listen 31.13.33.70:443 ssl;
		listen 31.13.33.71:443 ssl;
		listen 10.233.32.219:443 ssl;
		listen 10.233.32.220:443 ssl;
		server_name m-site-beta.bbbaaa.ru;
		access_log /var/log/nginx/bbbaaa.mobile.beta.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ru.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ru.key;

		if ( $arg_split_bbbaaa5 ) {
			set $split_bbbaaa5 $arg_split_bbbaaa5;
		}
		if ( $arg_split_bbbaaa_banner ) {
			set $split_bbbaaa_banner $arg_split_bbbaaa_banner;
		}
		if ( $arg_split_bbbaaa_mobile ) {
			set $split_bbbaaa_mobile $arg_split_bbbaaa_mobile;
		}
		if ( $arg_split_bbbaaa_perm ) {
			set $split_bbbaaa_perm $arg_split_bbbaaa_perm;
		}
		if ( $arg_split_bbbaaa_ranking ) {
			set $split_bbbaaa_ranking $arg_split_bbbaaa_ranking;
		}

		# desktop site redirect
		add_header Set-Cookie $mobile_cookie;
		if ( $mobile_site = 2 ) {
			return 302 $detected_protocol://www.bbbaaa.ru$request_uri;
		}

			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
		### whoami-location begin ###
		location = /whoami {

			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###

			ssi off;

			content_by_lua '
							ngx.header.content_type = "text/html"
							local uid_any = ngx.var.uid_any or "Undefined"
							local split_bbbaaa5 = ngx.var.split_bbbaaa5 or "Undefined"
							local split_bbbaaa_banner = ngx.var.split_bbbaaa_banner or "Undefined"
							local split_bbbaaa_mobile = ngx.var.split_bbbaaa_mobile or "Undefined"
							local split_bbbaaa_ranking = ngx.var.split_bbbaaa_ranking or "Undefined"
							local split_bbbaaa_perm = ngx.var.split_bbbaaa_perm or "Undefined"
							local split_madmin = ngx.var.split_madmin or "Undefined"
							ngx.say( "<h4>Parameters</h4><ul>" )
							ngx.say( "<li> lid" .. string.sub(uid_any,4) )
							ngx.say( "<li> split_bbbaaa5=" .. split_bbbaaa5 )
							ngx.say( "<li> split_bbbaaa_banner=" .. split_bbbaaa_banner )
							ngx.say( "<li> split_bbbaaa_mobile=" .. split_bbbaaa_mobile )
							ngx.say( "<li> split_bbbaaa_ranking=" .. split_bbbaaa_ranking  )
							ngx.say( "<li> split_bbbaaa_perm=" .. split_bbbaaa_perm  )
							ngx.say( "<li> split_madmin=" .. split_madmin  )
							ngx.say( "</ul>" )

							ngx.say( "<h4>Your visible cookies</h4><ul>" )
							for x in string.gmatch(ngx.req.get_headers()["cookie"] or "", "[^;]+") do
							    ngx.say(string.format("<li>%s",x))
							end
							ngx.say( "</ul>" )

							local fldr_name = ngx.var.split_dir

							local ssi_file_path = "/data/split/".. fldr_name .. "/" .. split_bbbaaa5 .. "/" .. split_bbbaaa_ranking .. "/" .. split_bbbaaa_mobile .. ".html"
							ngx.say( "<h4> Filepath: " .. ssi_file_path .. "</h4><ul>" )

							local fh = io.open(ssi_file_path)
							if fh then
							    ngx.say( "<plaintext>" )
							    for line in fh:lines() do
							        ngx.say( line )
							    end
							    fh:close()
							end
			';
		}
		### whoami-location end ###

		userid_service 1024;
		userid         on;

		ssi on;

	### proxy-set-headers begin ###
	proxy_set_header  Host                  $host;
	proxy_set_header  X-Real-IP             $remote_addr;
	proxy_set_header  X-Forwarded-For       $remote_addr;
	proxy_set_header  X-Forwarded-Host      $host;
	proxy_set_header  X-Forwarded-Port      $server_port;
	proxy_set_header  X-Forwarded-Protocol  $scheme;
	### proxy-set-headers end ###
		proxy_set_header X-DDoS   $ddos;
		proxy_set_header X-Mobile yes;
		proxy_set_header X-LID    $uid_any;
		proxy_set_header X-Splits banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;

		proxy_intercept_errors on;

		error_page 401 402 404 /err/404.html;
		error_page 403 /err/403.html;
		error_page 500 /err/500.html;
		error_page 502 /err/502.html;
		error_page 503 /err/503.html;
		error_page 504 /err/504.html;

		### uakari-locations begin ###
		location = /uakari-redis {
			internal;
			redis2_connect_timeout 3s;
			redis2_read_timeout    1s;
			redis2_send_timeout    1s;
			redis2_query get $arg_key;
			redis2_pass uakari_redis_upstream;
		}
		location /s/ {
			location /s/ {
				return 404;
			}
			location ~ ^/s/(?<key>[^/]+)$ {
				content_by_lua '
					local res = ngx.location.capture( "/uakari-redis?key=" .. ngx.var["key"] )
					if res.status ~= 200 then
						ngx.status = 500
						ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
					end
					local uri = string.match( res.body, "\\n([^\\n]+)" )
					if not uri then
						ngx.status = 404
						ngx.exit(ngx.HTTP_NOT_FOUND)
					end
					ngx.redirect( "http://" .. ngx.var.host .. uri, 301 )
				';
			}
		}
		### uakari-locations end   ###
		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###
		### zero-location begin ###
		location @zero {
			return 204;
		}
		### zero-locations end  ###
		location / {
			proxy_pass http://site_beta_upstream;
		}
		location = /apple-touch-icon.png {
			access_log /var/log/nginx/bbbaaa.mobile.beta.static.access_log timeds;
			root /data/site/misc;
		}
		location /err/ {
			internal;
			alias /data/site/misc/;
		}
		location = /favicon.ico {
			access_log /var/log/nginx/bbbaaa.mobile.beta.static.access_log timeds;
			root /data/site/misc;
		}
		location /files/ {
			access_log /var/log/nginx/bbbaaa.mobile.beta.static.access_log timeds;
			root /data/site/misc;
		}
		location /flat/ {
						### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://site_beta_upstream;
		}
		location = /localstorage.html {
			access_log /var/log/nginx/bbbaaa.mobile.beta.static.access_log timeds;
			root /data/site/misc;
		}
		location = /nt {
			return 204;
		}
		location = /robots.txt {
			access_log /var/log/nginx/bbbaaa.mobile.beta.static.access_log timeds;
			root /data/site/misc;
		}
		location = /ssi/exp.html {
			internal;
			error_page 403 404 = @zero;
			alias /data/split/${split_dir}/${split_bbbaaa5}/${split_bbbaaa_ranking}/${split_bbbaaa_mobile}.html;
		}
		location /static/ {
			access_log /var/log/nginx/bbbaaa.mobile.beta.static.access_log timeds;
			proxy_pass http://site_beta_static_upstream;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
			rewrite     ^/static/(m|d)/(ru|kz|ua)/(.*) /static_mobile/$3 break;
		}
	} # ]]]
	server { # site-beta.bbbaaa.ru [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		listen 10.233.32.219:443 ssl;
		listen 10.233.32.220:443 ssl;
		server_name site-beta.bbbaaa.ru;
		access_log /var/log/nginx/bbbaaa.beta.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ru.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ru.key;

		set_real_ip_from 10.233.32.0/24;
		# QRator pool
		set_real_ip_from 64.48.224.8;
		set_real_ip_from 64.48.224.9;
		set_real_ip_from 64.48.224.10;
		set_real_ip_from 64.48.224.11;
		set_real_ip_from 66.110.32.128;
		set_real_ip_from 66.110.32.129;
		set_real_ip_from 66.110.32.130;
		set_real_ip_from 66.110.32.131;
		set_real_ip_from 87.245.197.192;
		set_real_ip_from 87.245.197.193;
		set_real_ip_from 87.245.197.194;
		set_real_ip_from 87.245.197.195;
		set_real_ip_from 87.245.197.196;
		set_real_ip_from 134.90.144.224;
		set_real_ip_from 134.90.144.225;
		set_real_ip_from 134.90.144.226;
		set_real_ip_from 134.90.144.227;
		set_real_ip_from 83.234.15.112;
		set_real_ip_from 83.234.15.113;
		set_real_ip_from 83.234.15.114;
		set_real_ip_from 83.234.15.115;
		set_real_ip_from 83.234.15.116;
		set_real_ip_from 128.177.119.64;
		set_real_ip_from 128.177.119.65;
		set_real_ip_from 128.177.119.66;
		set_real_ip_from 128.177.119.67;
		set_real_ip_from 178.248.232.128/28;
		set_real_ip_from 178.248.233.128/28;
		set_real_ip_from 178.248.234.128/28;
		set_real_ip_from 178.248.235.128/28;
		set_real_ip_from 178.248.236.128/28;
		set_real_ip_from 178.248.237.128/28;
		set_real_ip_from 178.248.239.128/28;

		userid_service 1024;
		userid         on;

		ssi on;

		proxy_set_header Host     $host;
		proxy_set_header X-DDoS   $ddos;
		proxy_set_header X-LID    $uid_any;
		proxy_set_header X-Splits banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;

		proxy_set_header X-Forwarded-For      $remote_addr;
		proxy_set_header X-Forwarded-Host     $host;
		proxy_set_header X-Forwarded-Port     $server_port;
		proxy_set_header X-Forwarded-Protocol $detected_protocol;
		proxy_set_header X-Real-IP            $remote_addr;

		proxy_intercept_errors on;

		error_page 401 402 404 /err/404.html;
		error_page 403 /err/403.html;
		error_page 500 /err/500.html;
		error_page 502 /err/502.html;
		error_page 503 /err/503.html;
		error_page 504 /err/504.html;

		if ( $arg_split_bbbaaa5 ) {
			set $split_bbbaaa5 $arg_split_bbbaaa5;
		}
		if ( $arg_split_bbbaaa_banner ) {
			set $split_bbbaaa_banner $arg_split_bbbaaa_banner;
		}
		if ( $arg_split_bbbaaa_mobile ) {
			set $split_bbbaaa_mobile $arg_split_bbbaaa_mobile;
		}
		if ( $arg_split_bbbaaa_perm ) {
			set $split_bbbaaa_perm $arg_split_bbbaaa_perm;
		}
		if ( $arg_split_bbbaaa_ranking ) {
			set $split_bbbaaa_ranking $arg_split_bbbaaa_ranking;
		}

		if ( $site585 ) {
			return 302 http://$host$site585?$args&rdr585=1;
		}

		# mobile site redirect
		add_header Set-Cookie $mobile_cookie;
		if ( $mobile_site = 1 ) {
			return 302 $detected_protocol://m.bbbaaa.ru$request_uri;
		}

		# seo redirect
		if ( $ui2086 ) {
			return 301 $detected_protocol://$host$uri;
		}

		set $easycheckout 1;
		set $fullcheckout 1;

		### bs-locations begin ###
		location /bs-click/ {
			proxy_pass http://bs_head_upstream/click/;
		}
		location /bs-hit/ {
			internal;
			error_page 400 401 403 404 500 502 503 504 = @zero;

			proxy_connect_timeout 100ms;
			proxy_read_timeout    200ms;
			proxy_pass_request_headers off;

			proxy_next_upstream   error
			                      timeout
			;

			proxy_set_header  Host                  bs.local;
			proxy_set_header  X-Real-IP             $remote_addr;
			proxy_set_header  X-Forwarded-For       $remote_addr;
			proxy_set_header  X-Forwarded-Host      $host;
			proxy_set_header  X-Forwarded-Port      $server_port;
			proxy_set_header  X-Forwarded-Protocol  $scheme;
			proxy_set_header  X-LID                 $uid_any;
			proxy_set_header  X-Splits              banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header  Referer               $scheme://$http_host$request_uri;
			proxy_set_header  Rereferer             $http_referer;
			proxy_set_header  X-City-ID             $city_id;
			proxy_set_header  X-Region-ID           $region_id;

			proxy_pass http://bs_head_upstream/hit/;
		}
		location /bs-ssi/ {
			internal;
			alias /data/bs/ssi/;
		}
		### bs-locations end   ###
		### sorting-location begin ###
		location = /sf {
			internal;

			log_subrequest on;
			access_log /var/log/nginx/sort.access_log subtimed;

			proxy_connect_timeout 10ms;
			proxy_read_timeout    50ms;

			proxy_pass_request_headers off;

			proxy_set_header Host         sort.local;
			proxy_set_header X-LID        $uid_val;
			proxy_set_header X-Splits     banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header X-URL        $scheme://$host$request_uri;
			# geo
			proxy_set_header X-Geo        $geo;
			proxy_set_header X-City-ID    $city_id;
			proxy_set_header X-Country-ID $country_id;
			proxy_set_header X-Region-ID  $region_id;

			proxy_pass http://sort_head_upstream/mapping/sorting_factor_simple/;
		}
		### sorting-location end   ###
		### uakari-locations begin ###
		location = /uakari-redis {
			internal;
			redis2_connect_timeout 3s;
			redis2_read_timeout    1s;
			redis2_send_timeout    1s;
			redis2_query get $arg_key;
			redis2_pass uakari_redis_upstream;
		}
		location /s/ {
			location /s/ {
				return 404;
			}
			location ~ ^/s/(?<key>[^/]+)$ {
				content_by_lua '
					local res = ngx.location.capture( "/uakari-redis?key=" .. ngx.var["key"] )
					if res.status ~= 200 then
						ngx.status = 500
						ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
					end
					local uri = string.match( res.body, "\\n([^\\n]+)" )
					if not uri then
						ngx.status = 404
						ngx.exit(ngx.HTTP_NOT_FOUND)
					end
					ngx.redirect( "http://" .. ngx.var.host .. uri, 301 )
				';
			}
		}
		### uakari-locations end   ###
		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###
		### whoami-location begin ###
		location = /whoami {

			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###

			ssi off;

			content_by_lua '
							ngx.header.content_type = "text/html"
							local uid_any = ngx.var.uid_any or "Undefined"
							local split_bbbaaa5 = ngx.var.split_bbbaaa5 or "Undefined"
							local split_bbbaaa_banner = ngx.var.split_bbbaaa_banner or "Undefined"
							local split_bbbaaa_mobile = ngx.var.split_bbbaaa_mobile or "Undefined"
							local split_bbbaaa_ranking = ngx.var.split_bbbaaa_ranking or "Undefined"
							local split_bbbaaa_perm = ngx.var.split_bbbaaa_perm or "Undefined"
							local split_madmin = ngx.var.split_madmin or "Undefined"
							ngx.say( "<h4>Parameters</h4><ul>" )
							ngx.say( "<li> lid" .. string.sub(uid_any,4) )
							ngx.say( "<li> split_bbbaaa5=" .. split_bbbaaa5 )
							ngx.say( "<li> split_bbbaaa_banner=" .. split_bbbaaa_banner )
							ngx.say( "<li> split_bbbaaa_mobile=" .. split_bbbaaa_mobile )
							ngx.say( "<li> split_bbbaaa_ranking=" .. split_bbbaaa_ranking  )
							ngx.say( "<li> split_bbbaaa_perm=" .. split_bbbaaa_perm  )
							ngx.say( "<li> split_madmin=" .. split_madmin  )
							ngx.say( "</ul>" )

							ngx.say( "<h4>Your visible cookies</h4><ul>" )
							for x in string.gmatch(ngx.req.get_headers()["cookie"] or "", "[^;]+") do
							    ngx.say(string.format("<li>%s",x))
							end
							ngx.say( "</ul>" )

							local fldr_name = ngx.var.split_dir

							local ssi_file_path = "/data/split/".. fldr_name .. "/" .. split_bbbaaa5 .. "/" .. split_bbbaaa_ranking .. "/" .. split_bbbaaa_mobile .. ".html"
							ngx.say( "<h4> Filepath: " .. ssi_file_path .. "</h4><ul>" )

							local fh = io.open(ssi_file_path)
							if fh then
							    ngx.say( "<plaintext>" )
							    for line in fh:lines() do
							        ngx.say( line )
							    end
							    fh:close()
							end
			';
		}
		### whoami-location end ###
		### z-pass-locations begin ###
		location /z/pass/ {
			internal;
	### proxy-set-headers begin ###
	proxy_set_header  Host                  $host;
	proxy_set_header  X-Real-IP             $remote_addr;
	proxy_set_header  X-Forwarded-For       $remote_addr;
	proxy_set_header  X-Forwarded-Host      $host;
	proxy_set_header  X-Forwarded-Port      $server_port;
	proxy_set_header  X-Forwarded-Protocol  $scheme;
	### proxy-set-headers end ###
			proxy_set_header Connection '';
			proxy_set_header X-CMR      $cookie_LM_REMAIL;
			proxy_set_header X-UID-Got  $uid_got;
			proxy_set_header X-UID-Set  $uid_set;

			proxy_connect_timeout 100ms;
			proxy_send_timeout    100ms;
			proxy_read_timeout    100ms;

			proxy_http_version 1.1;

			error_page 400 401 403 404 500 502 503 504 = @zero;

			location = /z/pass/analytics {
				proxy_pass http://z_analytics_upstream/z;
			}
			location = /z/pass/prism {
				proxy_pass http://z_prism_upstream/z;
			}
		}
		### z-pass-locations end ###
		### zero-location begin ###
		location @zero {
			return 204;
		}
		### zero-locations end  ###
		location / {
			proxy_pass http://site_beta_upstream;
		}
		location /action/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			proxy_pass http://site_beta_upstream;
		}
		location = /apple-touch-icon.png {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-72x72.png {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-72x72-precomposed.png {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-76x76.png {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-76x76-precomposed.png {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-114x114.png {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-114x114-precomposed.png {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-120x120.png {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-120x120-precomposed.png {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-144x144.png {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-144x144-precomposed.png {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timed;
			root /data/site/misc;
		}
		location = /apple-touch-icon-152x152-precomposed.png {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timed;
			alias /data/site/misc/apple-touch-icon-precomposed.png;
		}
		location = /apple-touch-icon-precomposed.png {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timed;
			root /data/site/misc;
		}
		location /b/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			proxy_pass http://site_beta_upstream;
		}
		location /brands/ {
			proxy_pass http://site_beta_upstream;
		}
		location /c/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			proxy_pass http://site_beta_upstream;
		}
		location /cart/ {
			proxy_pass http://site_beta_upstream;
		}
		location /cb/ {
			proxy_pass http://site_beta_upstream;
		}
		location /catalogsearch/suggest/ {
			proxy_pass http://site_beta_upstream;
		}
		location /checkout/ {
			proxy_pass http://site_beta_upstream;
		}
		location /checkout/cart/ {
			proxy_pass http://site_beta_upstream;
		}
		location /e/pup/ {
			alias /data/delivery/dav/pup/;
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timed;
		}
		location /e/refund/ {
			alias /data/bob/dav/refund/;
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timed;
		}
		location /err/ {
			internal;
			alias /data/site/misc/;
		}
		location = /favicon.ico {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timeds;
			root /data/site/misc;
		}
		location /files/ {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timed;
			root /data/site/misc;
		}
		location /flat/ {
						### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://site_beta_upstream;
		}
		location = /googled0733206de50c577.html {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timed;
			root /data/site/misc;
		}
		location = /google1878ddce86933217.html {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timed;
			root /data/site/misc;
		}
		location = /googledefe250e2141dd06.html {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timed;
			root /data/site/misc;
		}
		location = /helpcenter/ {
			return 301 https://bbbaaaru.zendesk.com/hc/ru/categories/200086292-locale-ru;
		}
		location /landing/ {
			proxy_pass http://site_beta_upstream;
		}
		location /landing/banners-test/ {
						### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://site_beta_upstream;
		}
		location = /localstorage.html {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timeds;
			root /data/site/misc;
		}
		location = /nt {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timeds;
			return 204;
		}
		location /p/ {
			proxy_pass http://site_beta_upstream;
		}
		location /p2/ {
			proxy_pass http://site_beta_upstream;
		}
		location /p/quick/ {
			proxy_pass http://site_beta_upstream;
		}
		# denying access to qiwi payments from anywhere except qiwi - task LAMODA-2620
		# http://jira.bbbaaa.ru/browse/SITE-236
		# http://jira.bbbaaa.ru/browse/LAMODA-6200
		location /qiwipayment/ {
			allow 91.232.230.0/23;
			deny all;
			proxy_set_header Host app.site-beta.bbbaaa.ru;
			proxy_pass http://app.site-beta.bbbaaa.ru/exchange/service/qiwi-payment/;
		}
		# http://jira.bbbaaa.ru/browse/LAMODA-6201
		location /paymentassist/response/notification/ {
			proxy_set_header Host app.site-beta.bbbaaa.ru;
			proxy_pass http://app.site-beta.bbbaaa.ru/pluginassist/order/?method=notification;
		}
		location = /payturepayment/ {
			allow 93.91.18.128/28;
			allow 195.122.19.192/28;
			deny all;
			proxy_set_header Host bob.local;
			proxy_pass http://bob.local/pluginassist/order/notification-payture$is_args$args;
		}
		location = /payturepayment-test/ {
			allow 93.91.18.128/28;
			allow 195.122.19.192/28;
			deny all;
			proxy_set_header Host app.site-beta.bbbaaa.ru;
			proxy_pass http://app.site-beta.bbbaaa.ru/pluginassist/order/notification-payture$is_args$args;
		}
		location /prism/ {
			proxy_set_header Host $proxy_host;
			location /prism/ {
				return 404;
			}
			location = /prism/lid-info {
				proxy_pass http://prism.local/lid-info;
			}
			location = /prism/lid-marketing-segment {
				proxy_pass http://prism.local/lid-marketing-segment;
			}
			location = /prism/sku-size {
				proxy_pass http://prism.local/sku-size;
			}
			location = /prism/sku-size-by-gender {
				proxy_pass http://prism.local/sku-size-by-gender;
			}
		}
		location = /robots.txt {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timeds;
			root /data/site/misc;
		}
		location /sitemap/ {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timed;
			alias /data/site/map/;
		}
		location = /sitemap.xml {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timed;
			root /data/site/map;
		}
		location = /social-logo.jpg {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timed;
			root /data/site/misc;
		}
		location /ssi/ {
#			internal;
			log_subrequest on;
			error_page 400 401 403 404 500 502 503 504 = @zero;
			proxy_pass http://site_beta_upstream;
			access_log /var/log/nginx/bbbaaa.tail.ssi.access_log subtimed;

			location /ssi/comments/ {
				proxy_pass http://site_beta_upstream;
			}
			location = /ssi/exp.html {
				alias /data/split/${split_dir}/${split_bbbaaa5}/${split_bbbaaa_ranking}/${split_bbbaaa_mobile}.html;
			}
			location /ssi/recommend/ {
				proxy_pass http://site_beta_upstream;
			}
			location = /ssi/recommend/product-product {
				proxy_pass http://site_beta_upstream;
			}
			location = /ssi/recommend/topsellers {
				proxy_pass http://site_beta_upstream;
			}
			location /ssi/sizes/ {
				proxy_pass http://site_beta_upstream;
			}
			location /ssi/userdata/ {
				proxy_pass http://site_beta_upstream;
			}
		}
		location /static/ {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timeds;
			proxy_pass http://site_beta_static_upstream;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
			rewrite     ^/static/(m|d)/(ru|kz|ua)/(.*) /static/$3 break;
		}
		location @static-proxy {
			proxy_pass http://site_beta_static_upstream;
			access_log /var/log/nginx/bbbaaa.static-proxy.access_log timeds;
		}
		location = /strucr28da435b8192f28127be2751f802d1e93e7d8ad7.html {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timed;
			root /data/site/misc;
		}
		location = /wmail_c7f6d0aa0b31b6fc.html {
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timed;
			root /data/site/misc;
		}
		location /ymlexport/ {
			alias /data/yml/serve/;
			access_log /var/log/nginx/bbbaaa.beta.static.access_log timedc;
		}
		location = /z {
			access_log /var/log/nginx/bbbaaa.beta.z.access_log timed;
			content_by_lua '
				ngx.location.capture_multi({ {"/z/pass/analytics",{args = ngx.req.get_uri_args()}},{"/z/pass/prism",{args = ngx.req.get_uri_args()}} })
				ngx.status = 204;
			';
		}
	} # ]]]
	# gazel.bbbaaa.ru [[[
	server {
		listen 31.13.33.70:80; # carp70
		listen 31.13.33.71:80; # carp71
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		listen 31.13.33.70:443 ssl;
		listen 31.13.33.71:443 ssl;
		listen 10.233.32.219:443 ssl;
		listen 10.233.32.220:443 ssl;
		server_name gazel.bbbaaa.ru;
		access_log /var/log/nginx/gazel.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ru.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ru.key;

		set_real_ip_from 10.233.32.0/24;
		# QRator pool
		set_real_ip_from 64.48.224.8;
		set_real_ip_from 64.48.224.9;
		set_real_ip_from 64.48.224.10;
		set_real_ip_from 64.48.224.11;
		set_real_ip_from 66.110.32.128;
		set_real_ip_from 66.110.32.129;
		set_real_ip_from 66.110.32.130;
		set_real_ip_from 66.110.32.131;
		set_real_ip_from 87.245.197.192;
		set_real_ip_from 87.245.197.193;
		set_real_ip_from 87.245.197.194;
		set_real_ip_from 87.245.197.195;
		set_real_ip_from 87.245.197.196;
		set_real_ip_from 134.90.144.224;
		set_real_ip_from 134.90.144.225;
		set_real_ip_from 134.90.144.226;
		set_real_ip_from 134.90.144.227;
		set_real_ip_from 83.234.15.112;
		set_real_ip_from 83.234.15.113;
		set_real_ip_from 83.234.15.114;
		set_real_ip_from 83.234.15.115;
		set_real_ip_from 83.234.15.116;
		set_real_ip_from 128.177.119.64;
		set_real_ip_from 128.177.119.65;
		set_real_ip_from 128.177.119.66;
		set_real_ip_from 128.177.119.67;
		set_real_ip_from 178.248.232.128/28;
		set_real_ip_from 178.248.233.128/28;
		set_real_ip_from 178.248.234.128/28;
		set_real_ip_from 178.248.235.128/28;
		set_real_ip_from 178.248.236.128/28;
		set_real_ip_from 178.248.237.128/28;
		set_real_ip_from 178.248.239.128/28;

		userid_service 1024;
		userid         on;

		ssi on;

		proxy_set_header Host     $host;
		proxy_set_header X-DDoS   $ddos;
		proxy_set_header X-LID    $uid_any;
		proxy_set_header X-Splits banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;

		proxy_set_header X-Forwarded-For      $remote_addr;
		proxy_set_header X-Forwarded-Host     $host;
		proxy_set_header X-Forwarded-Port     $server_port;
		proxy_set_header X-Forwarded-Protocol $detected_protocol;
		proxy_set_header X-Real-IP            $remote_addr;

		proxy_intercept_errors on;

#		proxy_cache_key $detected_protocol://site_upstream/v11.11$uri?$norm_args;

		error_page 401 402 404 /err/404.html;
		error_page 403 /err/403.html;
		error_page 500 /err/500.html;
		error_page 502 /err/502.html;
		error_page 503 /err/503.html;
		error_page 504 /err/504.html;

		if ( $arg_split_bbbaaa5 ) {
			set $split_bbbaaa5 $arg_split_bbbaaa5;
		}
		if ( $arg_split_bbbaaa_banner ) {
			set $split_bbbaaa_banner $arg_split_bbbaaa_banner;
		}
		if ( $arg_split_bbbaaa_mobile ) {
			set $split_bbbaaa_mobile $arg_split_bbbaaa_mobile;
		}
		if ( $arg_split_bbbaaa_perm ) {
			set $split_bbbaaa_perm $arg_split_bbbaaa_perm;
		}
		if ( $arg_split_bbbaaa_ranking ) {
			set $split_bbbaaa_ranking $arg_split_bbbaaa_ranking;
		}

		if ( $site585 ) {
			return 302 http://$host$site585?$args&rdr585=1;
		}

		# mobile site redirect
		add_header Set-Cookie $mobile_cookie;
		if ( $mobile_site = 1 ) {
			return 302 $detected_protocol://m.bbbaaa.ru$request_uri;
		}

		# seo redirect
		if ( $ui2086 ) {
			return 301 $detected_protocol://$host$uri;
		}

		### bs-locations begin ###
		location /bs-click/ {
			proxy_pass http://bs_head_upstream/click/;
		}
		location /bs-hit/ {
			internal;
			error_page 400 401 403 404 500 502 503 504 = @zero;

			proxy_connect_timeout 100ms;
			proxy_read_timeout    200ms;
			proxy_pass_request_headers off;

			proxy_next_upstream   error
			                      timeout
			;

			proxy_set_header  Host                  bs.local;
			proxy_set_header  X-Real-IP             $remote_addr;
			proxy_set_header  X-Forwarded-For       $remote_addr;
			proxy_set_header  X-Forwarded-Host      $host;
			proxy_set_header  X-Forwarded-Port      $server_port;
			proxy_set_header  X-Forwarded-Protocol  $scheme;
			proxy_set_header  X-LID                 $uid_any;
			proxy_set_header  X-Splits              banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header  Referer               $scheme://$http_host$request_uri;
			proxy_set_header  Rereferer             $http_referer;
			proxy_set_header  X-City-ID             $city_id;
			proxy_set_header  X-Region-ID           $region_id;

			proxy_pass http://bs_head_upstream/hit/;
		}
		location /bs-ssi/ {
			internal;
			alias /data/bs/ssi/;
		}
		### bs-locations end   ###
		### sorting-location begin ###
		location = /sf {
			internal;

			log_subrequest on;
			access_log /var/log/nginx/sort.access_log subtimed;

			proxy_connect_timeout 10ms;
			proxy_read_timeout    50ms;

			proxy_pass_request_headers off;

			proxy_set_header Host         sort.local;
			proxy_set_header X-LID        $uid_val;
			proxy_set_header X-Splits     banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header X-URL        $scheme://$host$request_uri;
			# geo
			proxy_set_header X-Geo        $geo;
			proxy_set_header X-City-ID    $city_id;
			proxy_set_header X-Country-ID $country_id;
			proxy_set_header X-Region-ID  $region_id;

			proxy_pass http://sort_head_upstream/mapping/sorting_factor_simple/;
		}
		### sorting-location end   ###
		### uakari-locations begin ###
		location = /uakari-redis {
			internal;
			redis2_connect_timeout 3s;
			redis2_read_timeout    1s;
			redis2_send_timeout    1s;
			redis2_query get $arg_key;
			redis2_pass uakari_redis_upstream;
		}
		location /s/ {
			location /s/ {
				return 404;
			}
			location ~ ^/s/(?<key>[^/]+)$ {
				content_by_lua '
					local res = ngx.location.capture( "/uakari-redis?key=" .. ngx.var["key"] )
					if res.status ~= 200 then
						ngx.status = 500
						ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
					end
					local uri = string.match( res.body, "\\n([^\\n]+)" )
					if not uri then
						ngx.status = 404
						ngx.exit(ngx.HTTP_NOT_FOUND)
					end
					ngx.redirect( "http://" .. ngx.var.host .. uri, 301 )
				';
			}
		}
		### uakari-locations end   ###
		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###
		### whoami-location begin ###
		location = /whoami {

			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###

			ssi off;

			content_by_lua '
							ngx.header.content_type = "text/html"
							local uid_any = ngx.var.uid_any or "Undefined"
							local split_bbbaaa5 = ngx.var.split_bbbaaa5 or "Undefined"
							local split_bbbaaa_banner = ngx.var.split_bbbaaa_banner or "Undefined"
							local split_bbbaaa_mobile = ngx.var.split_bbbaaa_mobile or "Undefined"
							local split_bbbaaa_ranking = ngx.var.split_bbbaaa_ranking or "Undefined"
							local split_bbbaaa_perm = ngx.var.split_bbbaaa_perm or "Undefined"
							local split_madmin = ngx.var.split_madmin or "Undefined"
							ngx.say( "<h4>Parameters</h4><ul>" )
							ngx.say( "<li> lid" .. string.sub(uid_any,4) )
							ngx.say( "<li> split_bbbaaa5=" .. split_bbbaaa5 )
							ngx.say( "<li> split_bbbaaa_banner=" .. split_bbbaaa_banner )
							ngx.say( "<li> split_bbbaaa_mobile=" .. split_bbbaaa_mobile )
							ngx.say( "<li> split_bbbaaa_ranking=" .. split_bbbaaa_ranking  )
							ngx.say( "<li> split_bbbaaa_perm=" .. split_bbbaaa_perm  )
							ngx.say( "<li> split_madmin=" .. split_madmin  )
							ngx.say( "</ul>" )

							ngx.say( "<h4>Your visible cookies</h4><ul>" )
							for x in string.gmatch(ngx.req.get_headers()["cookie"] or "", "[^;]+") do
							    ngx.say(string.format("<li>%s",x))
							end
							ngx.say( "</ul>" )

							local fldr_name = ngx.var.split_dir

							local ssi_file_path = "/data/split/".. fldr_name .. "/" .. split_bbbaaa5 .. "/" .. split_bbbaaa_ranking .. "/" .. split_bbbaaa_mobile .. ".html"
							ngx.say( "<h4> Filepath: " .. ssi_file_path .. "</h4><ul>" )

							local fh = io.open(ssi_file_path)
							if fh then
							    ngx.say( "<plaintext>" )
							    for line in fh:lines() do
							        ngx.say( line )
							    end
							    fh:close()
							end
			';
		}
		### whoami-location end ###
		### z-pass-locations begin ###
		location /z/pass/ {
			internal;
	### proxy-set-headers begin ###
	proxy_set_header  Host                  $host;
	proxy_set_header  X-Real-IP             $remote_addr;
	proxy_set_header  X-Forwarded-For       $remote_addr;
	proxy_set_header  X-Forwarded-Host      $host;
	proxy_set_header  X-Forwarded-Port      $server_port;
	proxy_set_header  X-Forwarded-Protocol  $scheme;
	### proxy-set-headers end ###
			proxy_set_header Connection '';
			proxy_set_header X-CMR      $cookie_LM_REMAIL;
			proxy_set_header X-UID-Got  $uid_got;
			proxy_set_header X-UID-Set  $uid_set;

			proxy_connect_timeout 100ms;
			proxy_send_timeout    100ms;
			proxy_read_timeout    100ms;

			proxy_http_version 1.1;

			error_page 400 401 403 404 500 502 503 504 = @zero;

			location = /z/pass/analytics {
				proxy_pass http://z_analytics_upstream/z;
			}
			location = /z/pass/prism {
				proxy_pass http://z_prism_upstream/z;
			}
		}
		### z-pass-locations end ###
		### zero-location begin ###
		location @zero {
			return 204;
		}
		### zero-locations end  ###
		auth_basic "Gazel";
		auth_basic_user_file passwd/gazel;

		location / {
			proxy_pass http://gazel_upstream;
		}
		location = / {
			proxy_pass http://gazel_upstream;
#			proxy_cache_valid 200 5m;
#			proxy_cache pages;
#			proxy_cache_key $detected_protocol://site_upstream/v11.11$uri;
		}
		location /action/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			proxy_pass http://gazel_upstream;
#			proxy_cache_key $detected_protocol://site_upstream/v11.11$uri?$norm_args:sf=$sf;
#			proxy_cache_valid 200 10m;
#			proxy_cache catalog;
		}
		location = /apple-touch-icon.png {
			root /data/site/misc;
		}
		location = /apple-touch-icon-72x72.png {
			root /data/site/misc;
		}
		location = /apple-touch-icon-72x72-precomposed.png {
			root /data/site/misc;
		}
		location = /apple-touch-icon-76x76.png {
			root /data/site/misc;
		}
		location = /apple-touch-icon-76x76-precomposed.png {
			root /data/site/misc;
		}
		location = /apple-touch-icon-114x114.png {
			root /data/site/misc;
		}
		location = /apple-touch-icon-114x114-precomposed.png {
			root /data/site/misc;
		}
		location = /apple-touch-icon-120x120.png {
			root /data/site/misc;
		}
		location = /apple-touch-icon-120x120-precomposed.png {
			root /data/site/misc;
		}
		location = /apple-touch-icon-144x144.png {
			root /data/site/misc;
		}
		location = /apple-touch-icon-144x144-precomposed.png {
			root /data/site/misc;
		}
		location = /apple-touch-icon-152x152-precomposed.png {
			alias /data/site/misc/apple-touch-icon-precomposed.png;
		}
		location = /apple-touch-icon-precomposed.png {
			root /data/site/misc;
		}
		location /b/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			proxy_pass http://gazel_upstream;
#			proxy_cache_key $detected_protocol://site_upstream/v11.11$uri?$norm_args:sf=$sf;
#			proxy_cache_valid 200 10m;
#			proxy_cache catalog;
		}
		location /brands/ {
			proxy_pass http://gazel_upstream;
#			proxy_cache_valid 200 3h;
#			proxy_cache pages;
		}
		location /c/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			proxy_pass http://gazel_upstream;
#			proxy_cache_key $detected_protocol://site_upstream/v11.11$uri?$norm_args:sf=$sf;
#			proxy_cache_valid 200 10m;
#			proxy_cache catalog;
		}
		location /cart/ {
			proxy_pass http://gazel_upstream;
		}
		location /cb/ {
			proxy_pass http://gazel_upstream;
#			proxy_cache_valid 200 10m;
#			proxy_cache catalog;
		}
		location /catalogsearch/suggest/ {
			proxy_pass http://gazel_upstream;
#			proxy_cache_valid 200 1d;
#			proxy_cache suggest;
		}
		location /checkout/ {
			proxy_pass http://gazel_upstream;
		}
		location /checkout/cart/ {
			proxy_pass http://gazel_upstream;
		}
		location /err/ {
			internal;
			alias /data/site/misc/;
		}
		location = /favicon.ico {
			root /data/site/misc;
		}
		location /files/ {
			root /data/site/misc;
		}
		location /flat/ {
			access_log off;
						### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://gazel_upstream;
		}
		location = /googled0733206de50c577.html {
			root /data/site/misc;
		}
		location = /google1878ddce86933217.html {
			root /data/site/misc;
		}
		location = /googledefe250e2141dd06.html {
			root /data/site/misc;
		}
		location = /helpcenter/ {
			return 301 https://bbbaaaru.zendesk.com/hc/ru/categories/200086292-locale-ru;
		}
		location /landing/ {
			proxy_pass http://gazel_upstream;
#			proxy_cache_valid 200 3h;
#			proxy_cache pages;
		}
		location /landing/banners-test/ {
						### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://gazel_upstream;
		}
		location = /localstorage.html {
			root /data/site/misc;
		}
		location = /nt {
			return 204;
		}
		location /p/ {
			proxy_pass http://gazel_upstream;
#			proxy_cache_valid 200 6h;
#			proxy_cache product;
		}
		location /p2/ {
			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
	
			proxy_pass http://gazel_upstream;
#			proxy_cache_valid 200 6h;
#			proxy_cache product;
		}
		location /p/quick/ {
			proxy_pass http://gazel_upstream;
#			proxy_cache_valid 200 6h;
#			proxy_cache quick;
		}
		# denying access to qiwi payments from anywhere except qiwi - task LAMODA-2620
		# http://jira.bbbaaa.ru/browse/SITE-236
		# http://jira.bbbaaa.ru/browse/LAMODA-6200
		location /qiwipayment/ {
			allow 91.232.230.0/23;
			deny all;
			proxy_set_header Host bob.local;
			proxy_pass http://bob.local/exchange/service/qiwi-payment/;
		}
		# http://jira.bbbaaa.ru/browse/LAMODA-6201
		location /paymentassist/response/notification/ {
			proxy_set_header Host bob.local;
			proxy_pass http://bob.local/pluginassist/order/?method=notification;
		}
		location = /payturepayment/ {
			allow 93.91.18.128/28;
			allow 195.122.19.192/28;
			deny all;
			proxy_set_header Host bob.local;
			proxy_pass http://bob.local/pluginassist/order/notification-payture$is_args$args;
		}
		location = /payturepayment-test/ {
			allow 93.91.18.128/28;
			allow 195.122.19.192/28;
			deny all;
			proxy_set_header Host app.site-beta.bbbaaa.ru;
			proxy_pass http://app.site-beta.bbbaaa.ru/pluginassist/order/notification-payture$is_args$args;
		}
		location /prism/ {
			proxy_set_header Host $proxy_host;
			location /prism/ {
				return 404;
			}
			location = /prism/lid-info {
				proxy_pass http://prism.local/lid-info;
			}
			location = /prism/lid-marketing-segment {
				proxy_pass http://prism.local/lid-marketing-segment;
			}
			location = /prism/sku-size {
				proxy_pass http://prism.local/sku-size;
			}
			location = /prism/sku-size-by-gender {
				proxy_pass http://prism.local/sku-size-by-gender;
			}
		}
		location = /robots.txt {
			default_type text/plain;
			return 200 'User-agent: *
Disallow: /
';
		}
		location /sitemap/ {
			alias /data/site/map/;
		}
		location = /sitemap.xml {
			root /data/site/map;
		}
		location = /social-logo.jpg {
			root /data/site/misc;
		}
		location /ssi/ {
			internal;
			error_page 400 401 403 404 500 502 503 504 = @zero;
#			proxy_cache_key $scheme://site_upstream/v11.11$uri$is_args$args;
			proxy_pass http://gazel_upstream;

			location /ssi/comments/ {
				proxy_pass http://gazel_upstream;
			}
			location = /ssi/exp.html {
				alias /data/split/${split_dir}/${split_bbbaaa5}/${split_bbbaaa_ranking}/${split_bbbaaa_mobile}.html;
			}
			location /ssi/recommend/ {
				proxy_pass http://gazel_upstream;
#				proxy_cache_valid 200 5m;
#				proxy_cache ssi-recommend;
			}
			location = /ssi/recommend/product-product {
				proxy_pass http://gazel_upstream;
			}
			location = /ssi/recommend/topsellers {
				proxy_pass http://gazel_upstream;
			}
			location /ssi/sizes/ {
				proxy_pass http://gazel_upstream;
#				proxy_cache_valid 200 1m;
#				proxy_cache ssi-sizes;
			}
			location /ssi/userdata/ {
				proxy_pass http://gazel_upstream;
			}
		}
		location /static/ {
			proxy_pass http://gazel_static_upstream;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
		}
		location = /strucr28da435b8192f28127be2751f802d1e93e7d8ad7.html {
			root /data/site/misc;
		}
		location = /wmail_c7f6d0aa0b31b6fc.html {
			root /data/site/misc;
		}
		location = /z {
			content_by_lua '
				ngx.location.capture_multi({ {"/z/pass/analytics",{args = ngx.req.get_uri_args()}},{"/z/pass/prism",{args = ngx.req.get_uri_args()}} })
				ngx.status = 204;
			';
		}
	}
	# end gazel.bbbaaa.ru ]]]
	# end site ru ]]]
	# site ua [[[
	server { # bbbaaa.ua [[[
		listen 31.13.33.74:80; # carp74
		listen 31.13.33.75:80; # carp75
		listen 10.233.32.245:80; # carp245
		listen 10.233.32.246:80; # carp246
		listen 31.13.33.74:443 ssl;
		listen 31.13.33.75:443 ssl;
		listen 10.233.32.245:443 ssl;
		listen 10.233.32.246:443 ssl;
		server_name bbbaaa.ua;
		access_log /var/log/nginx/bbbaaa.ua.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ua.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ua.key;

		return 301 $detected_protocol://www.bbbaaa.ua$request_uri;
	} # ]]]
	server { # www.bbbaaa.ua [[[
		listen 31.13.33.74:80; # carp74
		listen 31.13.33.75:80; # carp75
		listen 10.233.32.245:80; # carp245
		listen 10.233.32.246:80; # carp246
		listen 31.13.33.74:443 ssl;
		listen 31.13.33.75:443 ssl;
		listen 10.233.32.245:443 ssl;
		listen 10.233.32.246:443 ssl;
		server_name www.bbbaaa.ua;
		access_log /var/log/nginx/bbbaaa.ua.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ua.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ua.key;

		set_real_ip_from 10.233.32.0/24;
		# QRator pool
		set_real_ip_from 64.48.224.8;
		set_real_ip_from 64.48.224.9;
		set_real_ip_from 64.48.224.10;
		set_real_ip_from 64.48.224.11;
		set_real_ip_from 66.110.32.128;
		set_real_ip_from 66.110.32.129;
		set_real_ip_from 66.110.32.130;
		set_real_ip_from 66.110.32.131;
		set_real_ip_from 87.245.197.192;
		set_real_ip_from 87.245.197.193;
		set_real_ip_from 87.245.197.194;
		set_real_ip_from 87.245.197.195;
		set_real_ip_from 87.245.197.196;
		set_real_ip_from 134.90.144.224;
		set_real_ip_from 134.90.144.225;
		set_real_ip_from 134.90.144.226;
		set_real_ip_from 134.90.144.227;
		set_real_ip_from 83.234.15.112;
		set_real_ip_from 83.234.15.113;
		set_real_ip_from 83.234.15.114;
		set_real_ip_from 83.234.15.115;
		set_real_ip_from 83.234.15.116;
		set_real_ip_from 128.177.119.64;
		set_real_ip_from 128.177.119.65;
		set_real_ip_from 128.177.119.66;
		set_real_ip_from 128.177.119.67;
		set_real_ip_from 178.248.232.128/28;
		set_real_ip_from 178.248.233.128/28;
		set_real_ip_from 178.248.234.128/28;
		set_real_ip_from 178.248.235.128/28;
		set_real_ip_from 178.248.236.128/28;
		set_real_ip_from 178.248.237.128/28;
		set_real_ip_from 178.248.239.128/28;

		userid_domain  .bbbaaa.ua;
		userid_service 1026;
		userid         on;

		ssi on;

		proxy_set_header Host     $host;
		proxy_set_header X-DDoS   $ddos;
		proxy_set_header X-LID    $uid_any;
		proxy_set_header X-Splits banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;

		proxy_set_header X-Forwarded-For      $remote_addr;
		proxy_set_header X-Forwarded-Host     $host;
		proxy_set_header X-Forwarded-Port     $server_port;
		proxy_set_header X-Forwarded-Protocol $detected_protocol;
		proxy_set_header X-Real-IP            $remote_addr;

		proxy_intercept_errors on;

		proxy_cache_key $detected_protocol://site_upstream/v11.11$uri?$norm_args;

		error_page 401 402 404 /err/404.html;
		error_page 403 /err/403.html;
		error_page 500 /err/500.html;
		error_page 502 /err/502.html;
		error_page 503 /err/503.html;
		error_page 504 /err/504.html;

		if ( $arg_split_bbbaaa5 ) {
			set $split_bbbaaa5 $arg_split_bbbaaa5;
		}
		if ( $arg_split_bbbaaa_banner ) {
			set $split_bbbaaa_banner $arg_split_bbbaaa_banner;
		}
		if ( $arg_split_bbbaaa_mobile ) {
			set $split_bbbaaa_mobile $arg_split_bbbaaa_mobile;
		}
		if ( $arg_split_bbbaaa_perm ) {
			set $split_bbbaaa_perm $arg_split_bbbaaa_perm;
		}
		if ( $arg_split_bbbaaa_ranking ) {
			set $split_bbbaaa_ranking $arg_split_bbbaaa_ranking;
		}

		# mobile site redirect
		add_header Set-Cookie $mobile_cookie_ua;
		if ( $mobile_site = 1 ) {
			return 302 $detected_protocol://m.bbbaaa.ua$request_uri;
		}

		# seo redirect
		if ( $ui2086 ) {
			return 301 $detected_protocol://$host$uri;
		}

		### bs-locations begin ###
		location /bs-click/ {
			proxy_pass http://bs_head_upstream/click/;
		}
		location /bs-hit/ {
			internal;
			error_page 400 401 403 404 500 502 503 504 = @zero;

			proxy_connect_timeout 100ms;
			proxy_read_timeout    200ms;
			proxy_pass_request_headers off;

			proxy_next_upstream   error
			                      timeout
			;

			proxy_set_header  Host                  bs.local;
			proxy_set_header  X-Real-IP             $remote_addr;
			proxy_set_header  X-Forwarded-For       $remote_addr;
			proxy_set_header  X-Forwarded-Host      $host;
			proxy_set_header  X-Forwarded-Port      $server_port;
			proxy_set_header  X-Forwarded-Protocol  $scheme;
			proxy_set_header  X-LID                 $uid_any;
			proxy_set_header  X-Splits              banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header  Referer               $scheme://$http_host$request_uri;
			proxy_set_header  Rereferer             $http_referer;
			proxy_set_header  X-City-ID             $city_id;
			proxy_set_header  X-Region-ID           $region_id;

			proxy_pass http://bs_head_upstream/hit/;
		}
		location /bs-ssi/ {
			internal;
			alias /data/bs/ssi/;
		}
		### bs-locations end   ###
		### sorting-location begin ###
		location = /sf {
			internal;

			log_subrequest on;
			access_log /var/log/nginx/sort.access_log subtimed;

			proxy_connect_timeout 10ms;
			proxy_read_timeout    50ms;

			proxy_pass_request_headers off;

			proxy_set_header Host         sort.local;
			proxy_set_header X-LID        $uid_val;
			proxy_set_header X-Splits     banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header X-URL        $scheme://$host$request_uri;
			# geo
			proxy_set_header X-Geo        $geo;
			proxy_set_header X-City-ID    $city_id;
			proxy_set_header X-Country-ID $country_id;
			proxy_set_header X-Region-ID  $region_id;

			proxy_pass http://sort_head_upstream/mapping/sorting_factor_simple/;
		}
		### sorting-location end   ###
		### uakari-locations begin ###
		location = /uakari-redis {
			internal;
			redis2_connect_timeout 3s;
			redis2_read_timeout    1s;
			redis2_send_timeout    1s;
			redis2_query get $arg_key;
			redis2_pass uakari_redis_upstream;
		}
		location /s/ {
			location /s/ {
				return 404;
			}
			location ~ ^/s/(?<key>[^/]+)$ {
				content_by_lua '
					local res = ngx.location.capture( "/uakari-redis?key=" .. ngx.var["key"] )
					if res.status ~= 200 then
						ngx.status = 500
						ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
					end
					local uri = string.match( res.body, "\\n([^\\n]+)" )
					if not uri then
						ngx.status = 404
						ngx.exit(ngx.HTTP_NOT_FOUND)
					end
					ngx.redirect( "http://" .. ngx.var.host .. uri, 301 )
				';
			}
		}
		### uakari-locations end   ###
		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###
		### whoami-location begin ###
		location = /whoami {

			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###

			ssi off;

			content_by_lua '
							ngx.header.content_type = "text/html"
							local uid_any = ngx.var.uid_any or "Undefined"
							local split_bbbaaa5 = ngx.var.split_bbbaaa5 or "Undefined"
							local split_bbbaaa_banner = ngx.var.split_bbbaaa_banner or "Undefined"
							local split_bbbaaa_mobile = ngx.var.split_bbbaaa_mobile or "Undefined"
							local split_bbbaaa_ranking = ngx.var.split_bbbaaa_ranking or "Undefined"
							local split_bbbaaa_perm = ngx.var.split_bbbaaa_perm or "Undefined"
							local split_madmin = ngx.var.split_madmin or "Undefined"
							ngx.say( "<h4>Parameters</h4><ul>" )
							ngx.say( "<li> lid" .. string.sub(uid_any,4) )
							ngx.say( "<li> split_bbbaaa5=" .. split_bbbaaa5 )
							ngx.say( "<li> split_bbbaaa_banner=" .. split_bbbaaa_banner )
							ngx.say( "<li> split_bbbaaa_mobile=" .. split_bbbaaa_mobile )
							ngx.say( "<li> split_bbbaaa_ranking=" .. split_bbbaaa_ranking  )
							ngx.say( "<li> split_bbbaaa_perm=" .. split_bbbaaa_perm  )
							ngx.say( "<li> split_madmin=" .. split_madmin  )
							ngx.say( "</ul>" )

							ngx.say( "<h4>Your visible cookies</h4><ul>" )
							for x in string.gmatch(ngx.req.get_headers()["cookie"] or "", "[^;]+") do
							    ngx.say(string.format("<li>%s",x))
							end
							ngx.say( "</ul>" )

							local fldr_name = ngx.var.split_dir

							local ssi_file_path = "/data/split/".. fldr_name .. "/" .. split_bbbaaa5 .. "/" .. split_bbbaaa_ranking .. "/" .. split_bbbaaa_mobile .. ".html"
							ngx.say( "<h4> Filepath: " .. ssi_file_path .. "</h4><ul>" )

							local fh = io.open(ssi_file_path)
							if fh then
							    ngx.say( "<plaintext>" )
							    for line in fh:lines() do
							        ngx.say( line )
							    end
							    fh:close()
							end
			';
		}
		### whoami-location end ###
		### z-pass-locations begin ###
		location /z/pass/ {
			internal;
	### proxy-set-headers begin ###
	proxy_set_header  Host                  $host;
	proxy_set_header  X-Real-IP             $remote_addr;
	proxy_set_header  X-Forwarded-For       $remote_addr;
	proxy_set_header  X-Forwarded-Host      $host;
	proxy_set_header  X-Forwarded-Port      $server_port;
	proxy_set_header  X-Forwarded-Protocol  $scheme;
	### proxy-set-headers end ###
			proxy_set_header Connection '';
			proxy_set_header X-CMR      $cookie_LM_REMAIL;
			proxy_set_header X-UID-Got  $uid_got;
			proxy_set_header X-UID-Set  $uid_set;

			proxy_connect_timeout 100ms;
			proxy_send_timeout    100ms;
			proxy_read_timeout    100ms;

			proxy_http_version 1.1;

			error_page 400 401 403 404 500 502 503 504 = @zero;

			location = /z/pass/analytics {
				proxy_pass http://z_analytics_upstream/z;
			}
			location = /z/pass/prism {
				proxy_pass http://z_prism_upstream/z;
			}
		}
		### z-pass-locations end ###
		### zero-location begin ###
		location @zero {
			return 204;
		}
		### zero-locations end  ###
		location / {
			access_log /var/log/nginx/bbbaaa.ua.access_log timeds;
			access_log /var/log/nginx/bbbaaa.ua.misc.access_log timed;
			proxy_pass http://site_ua_head_upstream;
		}
		location = / {
			access_log /var/log/nginx/bbbaaa.ua.access_log timeds;
			access_log /var/log/nginx/bbbaaa.ua.index.access_log timedc;
			proxy_pass http://site_ua_head_upstream;
			proxy_cache_valid 200 5m;
			proxy_cache pages-ua;
			proxy_cache_key $detected_protocol://site_upstream/v11.11$uri;
		}
		location /action/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			access_log /var/log/nginx/bbbaaa.ua.access_log timeds;
			access_log /var/log/nginx/bbbaaa.ua.catalog.access_log timedc;
			proxy_pass http://site_ua_head_upstream;
			proxy_cache_key $detected_protocol://site_upstream/v11.11$uri?$norm_args:sf=$sf;
			proxy_cache_valid 200 10m;
			proxy_cache catalog-ua;
		}
		location = /apple-touch-icon.png {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-72x72.png {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-72x72-precomposed.png {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-76x76.png {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-76x76-precomposed.png {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-114x114.png {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-114x114-precomposed.png {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-120x120.png {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-120x120-precomposed.png {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-144x144.png {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-144x144-precomposed.png {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-152x152-precomposed.png {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			alias /data/site-ua/misc/apple-touch-icon-precomposed.png;
		}
		location = /apple-touch-icon-precomposed.png {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /b/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			access_log /var/log/nginx/bbbaaa.ua.access_log timeds;
			access_log /var/log/nginx/bbbaaa.ua.catalog.access_log timedc;
			proxy_pass http://site_ua_head_upstream;
			proxy_cache_key $detected_protocol://site_upstream/v11.11$uri?$norm_args:sf=$sf;
			proxy_cache_valid 200 10m;
			proxy_cache catalog-ua;
		}
		location /brands/ {
			access_log /var/log/nginx/bbbaaa.ua.access_log timeds;
			access_log /var/log/nginx/bbbaaa.ua.pages.access_log timedc;
			proxy_pass http://site_ua_head_upstream;
			proxy_cache_valid 200 3h;
			proxy_cache pages-ua;
		}
		location /c/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			access_log /var/log/nginx/bbbaaa.ua.access_log timeds;
			access_log /var/log/nginx/bbbaaa.ua.catalog.access_log timedc;
			proxy_pass http://site_ua_head_upstream;
			proxy_cache_key $detected_protocol://site_upstream/v11.11$uri?$norm_args:sf=$sf;
			proxy_cache_valid 200 10m;
			proxy_cache catalog-ua;
		}
		location /cart/ {
			access_log /var/log/nginx/bbbaaa.ua.access_log timeds;
			access_log /var/log/nginx/bbbaaa.ua.cart-actions.access_log timed;
			proxy_pass http://site_ua_head_upstream;
		}
		location /cb/ {
			access_log /var/log/nginx/bbbaaa.ua.access_log timeds;
			access_log /var/log/nginx/bbbaaa.ua.catalog.access_log timedc;
			proxy_pass http://site_ua_head_upstream;
			proxy_cache_valid 200 10m;
			proxy_cache catalog-ua;
		}
		location /catalogsearch/suggest/ {
			access_log /var/log/nginx/bbbaaa.ua.access_log timeds;
			access_log /var/log/nginx/bbbaaa.ua.suggest.access_log timedc;
			proxy_pass http://site_ua_head_upstream;
			proxy_cache_valid 200 1d;
			proxy_cache suggest-ua;
		}
		location /checkout/ {
			access_log /var/log/nginx/bbbaaa.ua.access_log timeds;
			access_log /var/log/nginx/bbbaaa.ua.checkout.access_log timed;
			proxy_pass http://site_ua_head_upstream;
		}
		location /checkout/cart/ {
			access_log /var/log/nginx/bbbaaa.ua.access_log timeds;
			access_log /var/log/nginx/bbbaaa.ua.cart.access_log timed;
			proxy_pass http://site_ua_head_upstream;
		}
		location /e/pup/ {
			alias /data/delivery/dav-ua/pup/;
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
		}
		location /e/refund/ {
			alias /data/bob/dav-ua/refund/;
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
		}
		location /err/ {
			internal;
			alias /data/site-ua/misc/;
		}
		location = /favicon.ico {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /files/ {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /flat/ {
			access_log off;
						### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://site_ua_head_upstream;
		}
		location = /google1878ddce86933217.html  {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /google41fa04835c19c370.html {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /googledefe250e2141dd06.html {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /landing/ {
			access_log /var/log/nginx/bbbaaa.ua.access_log timeds;
			access_log /var/log/nginx/bbbaaa.ua.pages.access_log timedc;
			proxy_pass http://site_ua_head_upstream;
			proxy_cache_valid 200 3h;
			proxy_cache pages-ua;
		}
		location = /localstorage.html {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /nt {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			return 204;
		}
		location /p/ {
			access_log /var/log/nginx/bbbaaa.ua.access_log timeds;
			access_log /var/log/nginx/bbbaaa.ua.product.access_log timedc;
			proxy_pass http://site_ua_head_upstream;
			proxy_cache_valid 200 6h;
			proxy_cache product-ua;
		}
		location /p2/ {
			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
	
			access_log /var/log/nginx/bbbaaa.ua.access_log timeds;
			access_log /var/log/nginx/bbbaaa.ua.product.access_log timedc;
			proxy_pass http://site_ua_head_upstream;
			proxy_cache_valid 200 6h;
			proxy_cache product-ua;
		}
		location /p/quick/ {
			access_log /var/log/nginx/bbbaaa.ua.access_log timeds;
			access_log /var/log/nginx/bbbaaa.ua.quickview.access_log timedc;
			proxy_pass http://site_ua_head_upstream;
			proxy_cache_valid 200 6h;
			proxy_cache quick-ua;
		}
		location = /robots.txt {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /sitemap/ {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			alias /data/site-ua/map/;
		}
		location = /sitemap.xml {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			root /data/site-ua/map;
		}
		location = /social-logo.jpg {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /ssi/ {
			internal;
			log_subrequest on;
			error_page 400 401 403 404 500 502 503 504 = @zero;
			proxy_cache_key $scheme://site_upstream/v11.11$uri$is_args$args;
			proxy_pass http://site_ua_head_upstream;
			access_log /var/log/nginx/bbbaaa.ua.ssi.access_log subtimed;

			location /ssi/comments/ {
				proxy_pass http://site_ua_head_upstream;
				access_log /var/log/nginx/bbbaaa.ua.ssi.comments.access_log subtimed;
			}
			location = /ssi/exp.html {
				alias /data/split/${split_dir}/${split_bbbaaa5}/${split_bbbaaa_ranking}/${split_bbbaaa_mobile}.html;
				access_log /var/log/nginx/bbbaaa.ua.ssi.exp.access_log subtimed;
			}
			location /ssi/menu/ {
				proxy_pass http://site_ua_head_upstream;
				access_log /var/log/nginx/bbbaaa.ua.ssi.menu.access_log subtimedc;
				proxy_cache_valid 200 3h;
				proxy_cache ssi-menu-ua;
			}
			location /ssi/recommend/ {
				proxy_pass http://site_ua_head_upstream;
				access_log /var/log/nginx/bbbaaa.ua.ssi.recommend.access_log subtimedc;
				proxy_cache_valid 200 5m;
				proxy_cache ssi-recommend-ua;
			}
			location = /ssi/recommend/product-product {
				proxy_pass http://site_ua_head_upstream;
				access_log /var/log/nginx/bbbaaa.ua.ssi.recommend.access_log subtimed;
			}
			location = /ssi/recommend/topsellers {
				proxy_pass http://site_ua_head_upstream;
				access_log /var/log/nginx/bbbaaa.ua.ssi.recommend.access_log subtimed;
			}
			location /ssi/sizes/ {
				proxy_pass http://site_ua_head_upstream;
				access_log /var/log/nginx/bbbaaa.ua.ssi.sizes.access_log subtimedc;
				proxy_cache_valid 200 1m;
				proxy_cache ssi-sizes-ua;
			}
			location /ssi/userdata/ {
				proxy_pass http://site_ua_head_upstream;
				access_log /var/log/nginx/bbbaaa.ua.ssi.userdata.access_log subtimed;
			}
		}
		location /static/ {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			alias /data/site-ua/static/;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
			error_page  404 = @static-proxy;
		}
		location @static-proxy {
			proxy_pass http://site_ua_head_static_upstream;
			access_log /var/log/nginx/bbbaaa.static-proxy.access_log timeds;
		}
		location = /strucre954057c8a49f37ca91147c34f9d819feaf88a64.html {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /wmail_c69660ec87f984c2.html  {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /ymlexport/ {
			alias /data/yml/serve/;
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timedc;
		}
		location = /yandex_71246a97861cce32.txt {
			return 200 ' ';
		}
		location = /z {
			access_log /var/log/nginx/bbbaaa.ua.z.access_log timeds;
			content_by_lua '
				ngx.location.capture_multi({ {"/z/pass/analytics",{args = ngx.req.get_uri_args()}},{"/z/pass/prism",{args = ngx.req.get_uri_args()}} })
				ngx.status = 204;
			';
		}
	} # ]]]
	server { # tail.bbbaaa.ua [[[
		listen 10.233.32.245:80; # carp245
		listen 10.233.32.246:80; # carp246
		listen 10.233.32.245:443 ssl;
		listen 10.233.32.246:443 ssl;
		server_name tail.bbbaaa.ua;
		access_log /var/log/nginx/bbbaaa.ua.tail.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ua.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ua.key;

		set_real_ip_from 10.233.32.0/24;
		# QRator pool
		set_real_ip_from 64.48.224.8;
		set_real_ip_from 64.48.224.9;
		set_real_ip_from 64.48.224.10;
		set_real_ip_from 64.48.224.11;
		set_real_ip_from 66.110.32.128;
		set_real_ip_from 66.110.32.129;
		set_real_ip_from 66.110.32.130;
		set_real_ip_from 66.110.32.131;
		set_real_ip_from 87.245.197.192;
		set_real_ip_from 87.245.197.193;
		set_real_ip_from 87.245.197.194;
		set_real_ip_from 87.245.197.195;
		set_real_ip_from 87.245.197.196;
		set_real_ip_from 134.90.144.224;
		set_real_ip_from 134.90.144.225;
		set_real_ip_from 134.90.144.226;
		set_real_ip_from 134.90.144.227;
		set_real_ip_from 83.234.15.112;
		set_real_ip_from 83.234.15.113;
		set_real_ip_from 83.234.15.114;
		set_real_ip_from 83.234.15.115;
		set_real_ip_from 83.234.15.116;
		set_real_ip_from 128.177.119.64;
		set_real_ip_from 128.177.119.65;
		set_real_ip_from 128.177.119.66;
		set_real_ip_from 128.177.119.67;
		set_real_ip_from 178.248.232.128/28;
		set_real_ip_from 178.248.233.128/28;
		set_real_ip_from 178.248.234.128/28;
		set_real_ip_from 178.248.235.128/28;
		set_real_ip_from 178.248.236.128/28;
		set_real_ip_from 178.248.237.128/28;
		set_real_ip_from 178.248.239.128/28;

		userid_domain  .bbbaaa.ua;
		userid_service 1026;
		userid         on;

		ssi on;

		proxy_set_header Host     $host;
		proxy_set_header X-DDoS   $ddos;
		proxy_set_header X-LID    $uid_any;
		proxy_set_header X-Splits banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;

		proxy_set_header X-Forwarded-For      $remote_addr;
		proxy_set_header X-Forwarded-Host     $host;
		proxy_set_header X-Forwarded-Port     $server_port;
		proxy_set_header X-Forwarded-Protocol $detected_protocol;
		proxy_set_header X-Real-IP            $remote_addr;

		proxy_intercept_errors on;

		error_page 401 402 404 /err/404.html;
		error_page 403 /err/403.html;
		error_page 500 /err/500.html;
		error_page 502 /err/502.html;
		error_page 503 /err/503.html;
		error_page 504 /err/504.html;

		if ( $arg_split_bbbaaa5 ) {
			set $split_bbbaaa5 $arg_split_bbbaaa5;
		}
		if ( $arg_split_bbbaaa_banner ) {
			set $split_bbbaaa_banner $arg_split_bbbaaa_banner;
		}
		if ( $arg_split_bbbaaa_mobile ) {
			set $split_bbbaaa_mobile $arg_split_bbbaaa_mobile;
		}
		if ( $arg_split_bbbaaa_perm ) {
			set $split_bbbaaa_perm $arg_split_bbbaaa_perm;
		}
		if ( $arg_split_bbbaaa_ranking ) {
			set $split_bbbaaa_ranking $arg_split_bbbaaa_ranking;
		}

		# mobile site redirect
		add_header Set-Cookie $mobile_cookie_ua;
		if ( $mobile_site = 1 ) {
			return 302 $detected_protocol://m.bbbaaa.ua$request_uri;
		}

		# seo redirect
		if ( $ui2086 ) {
			return 301 $detected_protocol://$host$uri;
		}

		### bs-locations begin ###
		location /bs-click/ {
			proxy_pass http://bs_head_upstream/click/;
		}
		location /bs-hit/ {
			internal;
			error_page 400 401 403 404 500 502 503 504 = @zero;

			proxy_connect_timeout 100ms;
			proxy_read_timeout    200ms;
			proxy_pass_request_headers off;

			proxy_next_upstream   error
			                      timeout
			;

			proxy_set_header  Host                  bs.local;
			proxy_set_header  X-Real-IP             $remote_addr;
			proxy_set_header  X-Forwarded-For       $remote_addr;
			proxy_set_header  X-Forwarded-Host      $host;
			proxy_set_header  X-Forwarded-Port      $server_port;
			proxy_set_header  X-Forwarded-Protocol  $scheme;
			proxy_set_header  X-LID                 $uid_any;
			proxy_set_header  X-Splits              banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header  Referer               $scheme://$http_host$request_uri;
			proxy_set_header  Rereferer             $http_referer;
			proxy_set_header  X-City-ID             $city_id;
			proxy_set_header  X-Region-ID           $region_id;

			proxy_pass http://bs_head_upstream/hit/;
		}
		location /bs-ssi/ {
			internal;
			alias /data/bs/ssi/;
		}
		### bs-locations end   ###
		### sorting-location begin ###
		location = /sf {
			internal;

			log_subrequest on;
			access_log /var/log/nginx/sort.access_log subtimed;

			proxy_connect_timeout 10ms;
			proxy_read_timeout    50ms;

			proxy_pass_request_headers off;

			proxy_set_header Host         sort.local;
			proxy_set_header X-LID        $uid_val;
			proxy_set_header X-Splits     banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header X-URL        $scheme://$host$request_uri;
			# geo
			proxy_set_header X-Geo        $geo;
			proxy_set_header X-City-ID    $city_id;
			proxy_set_header X-Country-ID $country_id;
			proxy_set_header X-Region-ID  $region_id;

			proxy_pass http://sort_head_upstream/mapping/sorting_factor_simple/;
		}
		### sorting-location end   ###
		### uakari-locations begin ###
		location = /uakari-redis {
			internal;
			redis2_connect_timeout 3s;
			redis2_read_timeout    1s;
			redis2_send_timeout    1s;
			redis2_query get $arg_key;
			redis2_pass uakari_redis_upstream;
		}
		location /s/ {
			location /s/ {
				return 404;
			}
			location ~ ^/s/(?<key>[^/]+)$ {
				content_by_lua '
					local res = ngx.location.capture( "/uakari-redis?key=" .. ngx.var["key"] )
					if res.status ~= 200 then
						ngx.status = 500
						ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
					end
					local uri = string.match( res.body, "\\n([^\\n]+)" )
					if not uri then
						ngx.status = 404
						ngx.exit(ngx.HTTP_NOT_FOUND)
					end
					ngx.redirect( "http://" .. ngx.var.host .. uri, 301 )
				';
			}
		}
		### uakari-locations end   ###
		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###
		### whoami-location begin ###
		location = /whoami {

			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###

			ssi off;

			content_by_lua '
							ngx.header.content_type = "text/html"
							local uid_any = ngx.var.uid_any or "Undefined"
							local split_bbbaaa5 = ngx.var.split_bbbaaa5 or "Undefined"
							local split_bbbaaa_banner = ngx.var.split_bbbaaa_banner or "Undefined"
							local split_bbbaaa_mobile = ngx.var.split_bbbaaa_mobile or "Undefined"
							local split_bbbaaa_ranking = ngx.var.split_bbbaaa_ranking or "Undefined"
							local split_bbbaaa_perm = ngx.var.split_bbbaaa_perm or "Undefined"
							local split_madmin = ngx.var.split_madmin or "Undefined"
							ngx.say( "<h4>Parameters</h4><ul>" )
							ngx.say( "<li> lid" .. string.sub(uid_any,4) )
							ngx.say( "<li> split_bbbaaa5=" .. split_bbbaaa5 )
							ngx.say( "<li> split_bbbaaa_banner=" .. split_bbbaaa_banner )
							ngx.say( "<li> split_bbbaaa_mobile=" .. split_bbbaaa_mobile )
							ngx.say( "<li> split_bbbaaa_ranking=" .. split_bbbaaa_ranking  )
							ngx.say( "<li> split_bbbaaa_perm=" .. split_bbbaaa_perm  )
							ngx.say( "<li> split_madmin=" .. split_madmin  )
							ngx.say( "</ul>" )

							ngx.say( "<h4>Your visible cookies</h4><ul>" )
							for x in string.gmatch(ngx.req.get_headers()["cookie"] or "", "[^;]+") do
							    ngx.say(string.format("<li>%s",x))
							end
							ngx.say( "</ul>" )

							local fldr_name = ngx.var.split_dir

							local ssi_file_path = "/data/split/".. fldr_name .. "/" .. split_bbbaaa5 .. "/" .. split_bbbaaa_ranking .. "/" .. split_bbbaaa_mobile .. ".html"
							ngx.say( "<h4> Filepath: " .. ssi_file_path .. "</h4><ul>" )

							local fh = io.open(ssi_file_path)
							if fh then
							    ngx.say( "<plaintext>" )
							    for line in fh:lines() do
							        ngx.say( line )
							    end
							    fh:close()
							end
			';
		}
		### whoami-location end ###
		### z-pass-locations begin ###
		location /z/pass/ {
			internal;
	### proxy-set-headers begin ###
	proxy_set_header  Host                  $host;
	proxy_set_header  X-Real-IP             $remote_addr;
	proxy_set_header  X-Forwarded-For       $remote_addr;
	proxy_set_header  X-Forwarded-Host      $host;
	proxy_set_header  X-Forwarded-Port      $server_port;
	proxy_set_header  X-Forwarded-Protocol  $scheme;
	### proxy-set-headers end ###
			proxy_set_header Connection '';
			proxy_set_header X-CMR      $cookie_LM_REMAIL;
			proxy_set_header X-UID-Got  $uid_got;
			proxy_set_header X-UID-Set  $uid_set;

			proxy_connect_timeout 100ms;
			proxy_send_timeout    100ms;
			proxy_read_timeout    100ms;

			proxy_http_version 1.1;

			error_page 400 401 403 404 500 502 503 504 = @zero;

			location = /z/pass/analytics {
				proxy_pass http://z_analytics_upstream/z;
			}
			location = /z/pass/prism {
				proxy_pass http://z_prism_upstream/z;
			}
		}
		### z-pass-locations end ###
		### zero-location begin ###
		location @zero {
			return 204;
		}
		### zero-locations end  ###
		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.site.ua.local
        - host: back02.site.ua.local
        - host: back03.site.ua.local
        - host: back04.site.ua.local
        - host: back05.site.ua.local
          halt: true
        - host: back06.site.ua.local
          halt: true
        - host: back07.site.ua.local
          halt: true
        - host: back08.site.ua.local
          halt: true
        - host: back09.site.ua.local
          halt: true
        - host: back10.site.ua.local
          halt: true
    lolek:
        - host: back101.site.ua.local
        - host: back102.site.ua.local
        - host: back103.site.ua.local
        - host: back104.site.ua.local
        - host: back105.site.ua.local
          halt: true
        - host: back106.site.ua.local
          halt: true
        - host: back107.site.ua.local
          halt: true
        - host: back108.site.ua.local
          halt: true
        - host: back109.site.ua.local
          halt: true
        - host: back110.site.ua.local
          halt: true
head: bolek
super: super.back.site.ua.local
tail: lolek
';}

		location / {
			proxy_pass http://site_ua_tail_upstream;
		}
		location = / {
			proxy_pass http://site_ua_tail_upstream;
		}
		location /action/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			proxy_pass http://site_ua_tail_upstream;
		}
		location = /apple-touch-icon.png {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-72x72.png {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-72x72-precomposed.png {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-76x76.png {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-76x76-precomposed.png {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-114x114.png {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-114x114-precomposed.png {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-120x120.png {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-120x120-precomposed.png {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-144x144.png {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-144x144-precomposed.png {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-152x152-precomposed.png {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			alias /data/site-ua/misc/apple-touch-icon-precomposed.png;
		}
		location = /apple-touch-icon-precomposed.png {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /b/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			proxy_pass http://site_ua_tail_upstream;
		}
		location /brands/ {
			proxy_pass http://site_ua_tail_upstream;
		}
		location /c/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			proxy_pass http://site_ua_tail_upstream;
		}
		location /cart/ {
			proxy_pass http://site_ua_tail_upstream;
		}
		location /cb/ {
			proxy_pass http://site_ua_tail_upstream;
		}
		location /catalogsearch/suggest/ {
			proxy_pass http://site_ua_tail_upstream;
		}
		location /checkout/ {
			proxy_pass http://site_ua_tail_upstream;
		}
		location /checkout/cart/ {
			proxy_pass http://site_ua_tail_upstream;
		}
		location /e/pup/ {
			alias /data/delivery/dav-ua/pup/;
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
		}
		location /e/refund/ {
			alias /data/bob/dav-ua/refund/;
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
		}
		location /err/ {
			internal;
			alias /data/site-ua/misc/;
		}
		location = /favicon.ico {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /files/ {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /flat/ {
			access_log off;
						### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://site_ua_tail_upstream;
		}
		location = /google1878ddce86933217.html  {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /google41fa04835c19c370.html {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /googledefe250e2141dd06.html {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /landing/ {
			proxy_pass http://site_ua_tail_upstream;
		}
		location = /localstorage.html {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /nt {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			return 204;
		}
		location /p/ {
			proxy_pass http://site_ua_tail_upstream;
		}
		location /p2/ {
			proxy_pass http://site_ua_tail_upstream;
		}
		location /p/quick/ {
			proxy_pass http://site_ua_tail_upstream;
		}
		location = /robots.txt {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /sitemap/ {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			alias /data/site-ua/map/;
		}
		location = /sitemap.xml {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			root /data/site-ua/map;
		}
		location = /social-logo.jpg {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /ssi/ {
#			internal;
			log_subrequest on;
			error_page 400 401 403 404 500 502 503 504 = @zero;
			proxy_pass http://site_ua_tail_upstream;
			access_log /var/log/nginx/bbbaaa.ua.tail.ssi.access_log subtimed;

			location /ssi/comments/ {
				proxy_pass http://site_ua_tail_upstream;
			}
			location = /ssi/exp.html {
				alias /data/split/${split_dir}/${split_bbbaaa5}/${split_bbbaaa_ranking}/${split_bbbaaa_mobile}.html;
			}
			location /ssi/menu/ {
				proxy_pass http://site_ua_tail_upstream;
			}
			location /ssi/recommend/ {
				proxy_pass http://site_ua_tail_upstream;
			}
			location = /ssi/recommend/product-product {
				proxy_pass http://site_ua_tail_upstream;
			}
			location = /ssi/recommend/topsellers {
				proxy_pass http://site_ua_tail_upstream;
			}
			location /ssi/sizes/ {
				proxy_pass http://site_ua_tail_upstream;
			}
			location /ssi/userdata/ {
				proxy_pass http://site_ua_tail_upstream;
			}
		}
		location /static/ {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			alias /data/site-ua/static/;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
			error_page  404 = @static-proxy;
		}
		location @static-proxy {
			proxy_pass http://site_ua_tail_static_upstream;
			access_log /var/log/nginx/bbbaaa.static-proxy.access_log timeds;
		}
		location = /strucre954057c8a49f37ca91147c34f9d819feaf88a64.html {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /wmail_c69660ec87f984c2.html  {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /ymlexport/ {
			alias /data/yml/serve/;
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timedc;
		}
		location = /yandex_71246a97861cce32.txt {
			return 200 ' ';
		}
		location = /z {
			access_log /var/log/nginx/bbbaaa.ua.tail.static.access_log timed;
			content_by_lua '
				ngx.location.capture_multi({ {"/z/pass/analytics",{args = ngx.req.get_uri_args()}},{"/z/pass/prism",{args = ngx.req.get_uri_args()}} })
				ngx.status = 204;
			';
		}
	} # ]]]
	server { # m.bbbaaa.ua [[[
		listen 31.13.33.74:80; # carp74
		listen 31.13.33.75:80; # carp75
		listen 10.233.32.245:80; # carp245
		listen 10.233.32.246:80; # carp246
		listen 31.13.33.74:443 ssl;
		listen 31.13.33.75:443 ssl;
		listen 10.233.32.245:443 ssl;
		listen 10.233.32.246:443 ssl;
		server_name m.bbbaaa.ua;
		access_log /var/log/nginx/m.ua.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ua.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ua.key;

		set_real_ip_from 10.233.32.0/24;

		# QRator pool
		set_real_ip_from 64.48.224.8;
		set_real_ip_from 64.48.224.9;
		set_real_ip_from 64.48.224.10;
		set_real_ip_from 64.48.224.11;
		set_real_ip_from 66.110.32.128;
		set_real_ip_from 66.110.32.129;
		set_real_ip_from 66.110.32.130;
		set_real_ip_from 66.110.32.131;
		set_real_ip_from 87.245.197.192;
		set_real_ip_from 87.245.197.193;
		set_real_ip_from 87.245.197.194;
		set_real_ip_from 87.245.197.195;
		set_real_ip_from 87.245.197.196;
		set_real_ip_from 134.90.144.224;
		set_real_ip_from 134.90.144.225;
		set_real_ip_from 134.90.144.226;
		set_real_ip_from 134.90.144.227;
		set_real_ip_from 83.234.15.112;
		set_real_ip_from 83.234.15.113;
		set_real_ip_from 83.234.15.114;
		set_real_ip_from 83.234.15.115;
		set_real_ip_from 83.234.15.116;
		set_real_ip_from 128.177.119.64;
		set_real_ip_from 128.177.119.65;
		set_real_ip_from 128.177.119.66;
		set_real_ip_from 128.177.119.67;
		set_real_ip_from 178.248.232.128/28;
		set_real_ip_from 178.248.233.128/28;
		set_real_ip_from 178.248.234.128/28;
		set_real_ip_from 178.248.235.128/28;
		set_real_ip_from 178.248.236.128/28;
		set_real_ip_from 178.248.237.128/28;
		set_real_ip_from 178.248.239.128/28;

		userid_domain  .bbbaaa.ua;
		userid_service 1028;
		userid         on;

		ssi on;

		proxy_set_header Host     $host;
		proxy_set_header X-DDoS   $ddos;
		proxy_set_header X-LID    $uid_any;
		proxy_set_header X-Mobile yes;
		proxy_set_header X-Splits banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;

		proxy_set_header X-Forwarded-For      $remote_addr;
		proxy_set_header X-Forwarded-Host     $host;
		proxy_set_header X-Forwarded-Port     $server_port;
		proxy_set_header X-Forwarded-Protocol $detected_protocol;
		proxy_set_header X-Real-IP            $remote_addr;

		proxy_intercept_errors on;

		proxy_cache_key $detected_protocol://site_upstream/v11.11$uri?$norm_args;

		error_page 401 402 404 /err/404.html;
		error_page 403 /err/403.html;
		error_page 500 /err/500.html;
		error_page 502 /err/502.html;
		error_page 503 /err/503.html;
		error_page 504 /err/504.html;

		if ( $arg_split_bbbaaa5 ) {
			set $split_bbbaaa5 $arg_split_bbbaaa5;
		}
		if ( $arg_split_bbbaaa_banner ) {
			set $split_bbbaaa_banner $arg_split_bbbaaa_banner;
		}
		if ( $arg_split_bbbaaa_mobile ) {
			set $split_bbbaaa_mobile $arg_split_bbbaaa_mobile;
		}
		if ( $arg_split_bbbaaa_perm ) {
			set $split_bbbaaa_perm $arg_split_bbbaaa_perm;
		}
		if ( $arg_split_bbbaaa_ranking ) {
			set $split_bbbaaa_ranking $arg_split_bbbaaa_ranking;
		}

		# desktop site redirect
		add_header Set-Cookie $mobile_cookie_ua;
		if ( $mobile_site = 2 ) {
			return 302 $detected_protocol://www.bbbaaa.ua$request_uri;
		}

		### uakari-locations begin ###
		location = /uakari-redis {
			internal;
			redis2_connect_timeout 3s;
			redis2_read_timeout    1s;
			redis2_send_timeout    1s;
			redis2_query get $arg_key;
			redis2_pass uakari_redis_upstream;
		}
		location /s/ {
			location /s/ {
				return 404;
			}
			location ~ ^/s/(?<key>[^/]+)$ {
				content_by_lua '
					local res = ngx.location.capture( "/uakari-redis?key=" .. ngx.var["key"] )
					if res.status ~= 200 then
						ngx.status = 500
						ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
					end
					local uri = string.match( res.body, "\\n([^\\n]+)" )
					if not uri then
						ngx.status = 404
						ngx.exit(ngx.HTTP_NOT_FOUND)
					end
					ngx.redirect( "http://" .. ngx.var.host .. uri, 301 )
				';
			}
		}
		### uakari-locations end   ###
		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###
		### whoami-location begin ###
		location = /whoami {

			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###

			ssi off;

			content_by_lua '
							ngx.header.content_type = "text/html"
							local uid_any = ngx.var.uid_any or "Undefined"
							local split_bbbaaa5 = ngx.var.split_bbbaaa5 or "Undefined"
							local split_bbbaaa_banner = ngx.var.split_bbbaaa_banner or "Undefined"
							local split_bbbaaa_mobile = ngx.var.split_bbbaaa_mobile or "Undefined"
							local split_bbbaaa_ranking = ngx.var.split_bbbaaa_ranking or "Undefined"
							local split_bbbaaa_perm = ngx.var.split_bbbaaa_perm or "Undefined"
							local split_madmin = ngx.var.split_madmin or "Undefined"
							ngx.say( "<h4>Parameters</h4><ul>" )
							ngx.say( "<li> lid" .. string.sub(uid_any,4) )
							ngx.say( "<li> split_bbbaaa5=" .. split_bbbaaa5 )
							ngx.say( "<li> split_bbbaaa_banner=" .. split_bbbaaa_banner )
							ngx.say( "<li> split_bbbaaa_mobile=" .. split_bbbaaa_mobile )
							ngx.say( "<li> split_bbbaaa_ranking=" .. split_bbbaaa_ranking  )
							ngx.say( "<li> split_bbbaaa_perm=" .. split_bbbaaa_perm  )
							ngx.say( "<li> split_madmin=" .. split_madmin  )
							ngx.say( "</ul>" )

							ngx.say( "<h4>Your visible cookies</h4><ul>" )
							for x in string.gmatch(ngx.req.get_headers()["cookie"] or "", "[^;]+") do
							    ngx.say(string.format("<li>%s",x))
							end
							ngx.say( "</ul>" )

							local fldr_name = ngx.var.split_dir

							local ssi_file_path = "/data/split/".. fldr_name .. "/" .. split_bbbaaa5 .. "/" .. split_bbbaaa_ranking .. "/" .. split_bbbaaa_mobile .. ".html"
							ngx.say( "<h4> Filepath: " .. ssi_file_path .. "</h4><ul>" )

							local fh = io.open(ssi_file_path)
							if fh then
							    ngx.say( "<plaintext>" )
							    for line in fh:lines() do
							        ngx.say( line )
							    end
							    fh:close()
							end
			';
		}
		### whoami-location end ###
		### z-pass-locations begin ###
		location /z/pass/ {
			internal;
	### proxy-set-headers begin ###
	proxy_set_header  Host                  $host;
	proxy_set_header  X-Real-IP             $remote_addr;
	proxy_set_header  X-Forwarded-For       $remote_addr;
	proxy_set_header  X-Forwarded-Host      $host;
	proxy_set_header  X-Forwarded-Port      $server_port;
	proxy_set_header  X-Forwarded-Protocol  $scheme;
	### proxy-set-headers end ###
			proxy_set_header Connection '';
			proxy_set_header X-CMR      $cookie_LM_REMAIL;
			proxy_set_header X-UID-Got  $uid_got;
			proxy_set_header X-UID-Set  $uid_set;

			proxy_connect_timeout 100ms;
			proxy_send_timeout    100ms;
			proxy_read_timeout    100ms;

			proxy_http_version 1.1;

			error_page 400 401 403 404 500 502 503 504 = @zero;

			location = /z/pass/analytics {
				proxy_pass http://z_analytics_upstream/z;
			}
			location = /z/pass/prism {
				proxy_pass http://z_prism_upstream/z;
			}
		}
		### z-pass-locations end ###
		### zero-location begin ###
		location @zero {
			return 204;
		}
		### zero-locations end  ###
		location / {
			access_log /var/log/nginx/m.ua.access_log timeds;
			access_log /var/log/nginx/m.ua.misc.access_log timed;
			proxy_pass http://site_ua_head_upstream;
		}
		location = / {
			access_log /var/log/nginx/m.ua.access_log timeds;
			access_log /var/log/nginx/m.ua.index.access_log timedc;
			proxy_pass http://site_ua_head_upstream;
			proxy_cache_valid 200 5m;
			proxy_cache m-pages-ua;
			proxy_cache_key $detected_protocol://site_upstream/v11.11$uri;
		}
		location /action/ {
			access_log /var/log/nginx/m.ua.access_log timeds;
			access_log /var/log/nginx/m.ua.catalog.access_log timedc;
			proxy_pass http://site_ua_head_upstream;
			proxy_cache_valid 200 10m;
			proxy_cache m-catalog-ua;
		}
		location = /apple-touch-icon.png {
			access_log /var/log/nginx/m.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-72x72.png {
			access_log /var/log/nginx/m.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-72x72-precomposed.png {
			access_log /var/log/nginx/m.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-76x76.png {
			access_log /var/log/nginx/m.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-76x76-precomposed.png {
			access_log /var/log/nginx/m.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-114x114.png {
			access_log /var/log/nginx/m.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-114x114-precomposed.png {
			access_log /var/log/nginx/m.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-120x120.png {
			access_log /var/log/nginx/m.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-120x120-precomposed.png {
			access_log /var/log/nginx/m.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-144x144.png {
			access_log /var/log/nginx/m.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-144x144-precomposed.png {
			access_log /var/log/nginx/m.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-152x152-precomposed.png {
			access_log /var/log/nginx/m.ua.static.access_log timed;
			alias /data/site-ua/misc/apple-touch-icon-precomposed.png;
		}
		location = /apple-touch-icon-precomposed.png {
			access_log /var/log/nginx/m.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /b/ {
			access_log /var/log/nginx/m.ua.access_log timeds;
			access_log /var/log/nginx/m.ua.catalog.access_log timed;
			proxy_pass http://site_ua_head_upstream;
			proxy_cache_valid 200 10m;
			proxy_cache m-catalog-ua;
		}
		location /brands/ {
			access_log /var/log/nginx/m.ua.access_log timeds;
			access_log /var/log/nginx/m.ua.pages.access_log timedc;
			proxy_pass http://site_ua_head_upstream;
			proxy_cache_valid 200 3h;
			proxy_cache m-pages-ua;
		}
		location /c/ {
			access_log /var/log/nginx/m.ua.access_log timeds;
			access_log /var/log/nginx/m.ua.catalog.access_log timedc;
			proxy_pass http://site_ua_head_upstream;
			proxy_cache_valid 200 10m;
			proxy_cache m-catalog-ua;
		}
		location /cb/ {
			access_log /var/log/nginx/m.ua.access_log timeds;
			access_log /var/log/nginx/m.ua.catalog.access_log timedc;
			proxy_pass http://site_ua_head_upstream;
			proxy_cache_valid 200 10m;
			proxy_cache m-catalog-ua;
		}
		location /catalogsearch/suggest/ {
			access_log /var/log/nginx/m.ua.access_log timeds;
			access_log /var/log/nginx/m.ua.suggest.access_log timed;
			proxy_pass http://site_ua_head_upstream;
			proxy_cache_valid 200 1d;
			proxy_cache m-suggest-ua;
		}
		location /checkout/ {
			access_log /var/log/nginx/m.ua.access_log timeds;
			access_log /var/log/nginx/m.ua.checkout.access_log timed;
			proxy_pass http://site_ua_head_upstream;
		}
		location /checkout/cart/ {
			access_log /var/log/nginx/m.ua.access_log timeds;
			access_log /var/log/nginx/m.ua.cart.access_log timed;
			proxy_pass http://site_ua_head_upstream;
		}
		location /err/ {
			internal;
			alias /data/site-ua/misc/;
		}
		location = /favicon.ico {
			access_log /var/log/nginx/m.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /files/ {
			access_log /var/log/nginx/m.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /flat/ {
			access_log off;
						### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://site_ua_head_upstream;
		}
		location /landing/ {
			access_log /var/log/nginx/m.ua.access_log timeds;
			access_log /var/log/nginx/m.ua.pages.access_log timed;
			proxy_pass http://site_ua_head_upstream;
			proxy_cache_valid 200 3h;
			proxy_cache m-pages-ua;
		}
		location = /localstorage.html {
			access_log /var/log/nginx/m.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /nt {
			access_log /var/log/nginx/m.ua.nt.access_log timed;
			return 204;
		}
		location /p/ {
			access_log /var/log/nginx/m.ua.access_log timeds;
			access_log /var/log/nginx/m.ua.product.access_log timedc;
			proxy_pass http://site_ua_head_upstream;
			proxy_cache_valid 200 6h;
			proxy_cache m-product-ua;
		}
		location /p2/ {
			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
	
			access_log /var/log/nginx/m.ua.access_log timeds;
			access_log /var/log/nginx/m.ua.product.access_log timedc;
			proxy_pass http://site_ua_head_upstream;
			proxy_cache_valid 200 6h;
			proxy_cache m-product-ua;
		}
		location = /robots.txt {
			access_log /var/log/nginx/m.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /ssi/ {
			internal;
			log_subrequest on;
			error_page 400 401 403 404 500 502 503 504 = @zero;
			proxy_cache_key $scheme://site_upstream/v11.11$uri$is_args$args;
			proxy_pass http://site_ua_head_upstream;
			access_log /var/log/nginx/m.ua.ssi.access_log subtimed;

			location /ssi/comments/ {
				proxy_pass http://site_ua_head_upstream;
				access_log /var/log/nginx/m.ua.ssi.comments.access_log subtimed;
			}
			location = /ssi/exp.html {
				alias /data/split/${split_dir}/${split_bbbaaa5}/${split_bbbaaa_ranking}/${split_bbbaaa_mobile}.html;
				access_log /var/log/nginx/m.ua.ssi.exp.access_log subtimed;
			}
			location /ssi/recommend/ {
				proxy_pass http://site_ua_head_upstream;
				access_log /var/log/nginx/m.ua.ssi.recommend.access_log subtimed;
				proxy_cache_valid 200 5m;
				proxy_cache m-ssi-recommend-ua;
			}
			location = /ssi/recommend/product-product {
				proxy_pass http://site_ua_head_upstream;
				access_log /var/log/nginx/m.ua.ssi.recommend.access_log subtimed;
			}
			location = /ssi/recommend/topsellers {
				proxy_pass http://site_ua_head_upstream;
				access_log /var/log/nginx/m.ua.ssi.recommend.access_log subtimed;
			}
			location /ssi/sizes/ {
				proxy_pass http://site_ua_head_upstream;
				access_log /var/log/nginx/m.ua.ssi.sizes.access_log subtimedc;
				proxy_cache_valid 200 1m;
				proxy_cache m-ssi-sizes-ua;
			}
			location /ssi/userdata_full/ {
				proxy_pass http://site_ua_head_upstream;
				access_log /var/log/nginx/m.ua.ssi.userdata.access_log subtimed;
			}
		}
		location /static/ {
			access_log /var/log/nginx/m.ua.static.access_log timed;
			alias /data/m-ua/static/;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
			error_page  404 = @static-proxy;
		}
		location @static-proxy {
			proxy_pass http://site_ua_head_static_upstream;
			access_log /var/log/nginx/bbbaaa.static-proxy.access_log timeds;
		}
		location = /z {
			access_log /var/log/nginx/m.z.ua.access_log timeds;
			content_by_lua '
				ngx.location.capture_multi({ {"/z/pass/analytics",{args = ngx.req.get_uri_args()}},{"/z/pass/prism",{args = ngx.req.get_uri_args()}} })
				ngx.status = 204;
			';
		}
	} # ]]]
	server { # m-site-beta.bbbaaa.ua [[[
		listen 10.233.32.245:80; # carp245
		listen 10.233.32.246:80; # carp246
		listen 10.233.32.245:443 ssl;
		listen 10.233.32.246:443 ssl;
		server_name m-site-beta.bbbaaa.ua;
		access_log /var/log/nginx/bbbaaa.ua.mobile.beta.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ua.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ua.key;

		if ( $arg_split_bbbaaa5 ) {
			set $split_bbbaaa5 $arg_split_bbbaaa5;
		}
		if ( $arg_split_bbbaaa_banner ) {
			set $split_bbbaaa_banner $arg_split_bbbaaa_banner;
		}
		if ( $arg_split_bbbaaa_mobile ) {
			set $split_bbbaaa_mobile $arg_split_bbbaaa_mobile;
		}
		if ( $arg_split_bbbaaa_perm ) {
			set $split_bbbaaa_perm $arg_split_bbbaaa_perm;
		}
		if ( $arg_split_bbbaaa_ranking ) {
			set $split_bbbaaa_ranking $arg_split_bbbaaa_ranking;
		}

		# desktop site redirect
		add_header Set-Cookie $mobile_cookie;
		if ( $mobile_site = 2 ) {
			return 302 $detected_protocol://www.bbbaaa.ua$request_uri;
		}

		### whoami-location begin ###
		location = /whoami {

			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###

			ssi off;

			content_by_lua '
							ngx.header.content_type = "text/html"
							local uid_any = ngx.var.uid_any or "Undefined"
							local split_bbbaaa5 = ngx.var.split_bbbaaa5 or "Undefined"
							local split_bbbaaa_banner = ngx.var.split_bbbaaa_banner or "Undefined"
							local split_bbbaaa_mobile = ngx.var.split_bbbaaa_mobile or "Undefined"
							local split_bbbaaa_ranking = ngx.var.split_bbbaaa_ranking or "Undefined"
							local split_bbbaaa_perm = ngx.var.split_bbbaaa_perm or "Undefined"
							local split_madmin = ngx.var.split_madmin or "Undefined"
							ngx.say( "<h4>Parameters</h4><ul>" )
							ngx.say( "<li> lid" .. string.sub(uid_any,4) )
							ngx.say( "<li> split_bbbaaa5=" .. split_bbbaaa5 )
							ngx.say( "<li> split_bbbaaa_banner=" .. split_bbbaaa_banner )
							ngx.say( "<li> split_bbbaaa_mobile=" .. split_bbbaaa_mobile )
							ngx.say( "<li> split_bbbaaa_ranking=" .. split_bbbaaa_ranking  )
							ngx.say( "<li> split_bbbaaa_perm=" .. split_bbbaaa_perm  )
							ngx.say( "<li> split_madmin=" .. split_madmin  )
							ngx.say( "</ul>" )

							ngx.say( "<h4>Your visible cookies</h4><ul>" )
							for x in string.gmatch(ngx.req.get_headers()["cookie"] or "", "[^;]+") do
							    ngx.say(string.format("<li>%s",x))
							end
							ngx.say( "</ul>" )

							local fldr_name = ngx.var.split_dir

							local ssi_file_path = "/data/split/".. fldr_name .. "/" .. split_bbbaaa5 .. "/" .. split_bbbaaa_ranking .. "/" .. split_bbbaaa_mobile .. ".html"
							ngx.say( "<h4> Filepath: " .. ssi_file_path .. "</h4><ul>" )

							local fh = io.open(ssi_file_path)
							if fh then
							    ngx.say( "<plaintext>" )
							    for line in fh:lines() do
							        ngx.say( line )
							    end
							    fh:close()
							end
			';
		}
		### whoami-location end ###

		userid_service 1024;
		userid         on;

		ssi on;

	### proxy-set-headers begin ###
	proxy_set_header  Host                  $host;
	proxy_set_header  X-Real-IP             $remote_addr;
	proxy_set_header  X-Forwarded-For       $remote_addr;
	proxy_set_header  X-Forwarded-Host      $host;
	proxy_set_header  X-Forwarded-Port      $server_port;
	proxy_set_header  X-Forwarded-Protocol  $scheme;
	### proxy-set-headers end ###
		proxy_set_header X-DDoS   $ddos;
		proxy_set_header X-Mobile yes;
		proxy_set_header X-LID    $uid_any;
		proxy_set_header X-Splits banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;

		proxy_intercept_errors on;

		error_page 401 402 404 /err/404.html;
		error_page 403 /err/403.html;
		error_page 500 /err/500.html;
		error_page 502 /err/502.html;
		error_page 503 /err/503.html;
		error_page 504 /err/504.html;

		### uakari-locations begin ###
		location = /uakari-redis {
			internal;
			redis2_connect_timeout 3s;
			redis2_read_timeout    1s;
			redis2_send_timeout    1s;
			redis2_query get $arg_key;
			redis2_pass uakari_redis_upstream;
		}
		location /s/ {
			location /s/ {
				return 404;
			}
			location ~ ^/s/(?<key>[^/]+)$ {
				content_by_lua '
					local res = ngx.location.capture( "/uakari-redis?key=" .. ngx.var["key"] )
					if res.status ~= 200 then
						ngx.status = 500
						ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
					end
					local uri = string.match( res.body, "\\n([^\\n]+)" )
					if not uri then
						ngx.status = 404
						ngx.exit(ngx.HTTP_NOT_FOUND)
					end
					ngx.redirect( "http://" .. ngx.var.host .. uri, 301 )
				';
			}
		}
		### uakari-locations end   ###
		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###
		### zero-location begin ###
		location @zero {
			return 204;
		}
		### zero-locations end  ###
		location / {
			proxy_pass http://site_ua_beta_upstream;
		}
		location = /apple-touch-icon.png {
			access_log /var/log/nginx/bbbaaa.ua.mobile.beta.static.access_log timeds;
			root /data/site-ua/misc;
		}
		location /err/ {
			internal;
			alias /data/site-ua/misc/;
		}
		location = /favicon.ico {
			access_log /var/log/nginx/bbbaaa.ua.mobile.beta.static.access_log timeds;
			root /data/site-ua/misc;
		}
		location /files/ {
			access_log /var/log/nginx/bbbaaa.ua.mobile.beta.static.access_log timeds;
			root /data/site-ua/misc;
		}
		location /flat/ {
						### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://site_ua_beta_upstream;
		}
		location = /localstorage.html {
			access_log /var/log/nginx/bbbaaa.ua.mobile.beta.static.access_log timeds;
			root /data/site-ua/misc;
		}
		location = /nt {
			return 204;
		}
		location = /robots.txt {
			access_log /var/log/nginx/bbbaaa.ua.mobile.beta.static.access_log timeds;
			root /data/site-ua/misc;
		}
		location = /ssi/exp.html {
			internal;
			error_page 403 404 = @zero;
			alias /data/split/${split_dir}/${split_bbbaaa5}/${split_bbbaaa_ranking}/${split_bbbaaa_mobile}.html;
		}
		location /static/ {
			access_log /var/log/nginx/bbbaaa.ua.mobile.beta.static.access_log timeds;
			proxy_set_header Host www.bbbaaa.ua;
			proxy_pass http://site_ua_beta_static_upstream/static_mobile/;
		}
	} # ]]]
	server { # site-beta.bbbaaa.ua [[[
		listen 10.233.32.245:80; # carp245
		listen 10.233.32.246:80; # carp246
		listen 10.233.32.245:443 ssl;
		listen 10.233.32.246:443 ssl;
		server_name site-beta.bbbaaa.ua;
		access_log /var/log/nginx/bbbaaa.ua.beta.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ua.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ua.key;

		set_real_ip_from 10.233.32.0/24;
		# QRator pool
		set_real_ip_from 64.48.224.8;
		set_real_ip_from 64.48.224.9;
		set_real_ip_from 64.48.224.10;
		set_real_ip_from 64.48.224.11;
		set_real_ip_from 66.110.32.128;
		set_real_ip_from 66.110.32.129;
		set_real_ip_from 66.110.32.130;
		set_real_ip_from 66.110.32.131;
		set_real_ip_from 87.245.197.192;
		set_real_ip_from 87.245.197.193;
		set_real_ip_from 87.245.197.194;
		set_real_ip_from 87.245.197.195;
		set_real_ip_from 87.245.197.196;
		set_real_ip_from 134.90.144.224;
		set_real_ip_from 134.90.144.225;
		set_real_ip_from 134.90.144.226;
		set_real_ip_from 134.90.144.227;
		set_real_ip_from 83.234.15.112;
		set_real_ip_from 83.234.15.113;
		set_real_ip_from 83.234.15.114;
		set_real_ip_from 83.234.15.115;
		set_real_ip_from 83.234.15.116;
		set_real_ip_from 128.177.119.64;
		set_real_ip_from 128.177.119.65;
		set_real_ip_from 128.177.119.66;
		set_real_ip_from 128.177.119.67;
		set_real_ip_from 178.248.232.128/28;
		set_real_ip_from 178.248.233.128/28;
		set_real_ip_from 178.248.234.128/28;
		set_real_ip_from 178.248.235.128/28;
		set_real_ip_from 178.248.236.128/28;
		set_real_ip_from 178.248.237.128/28;
		set_real_ip_from 178.248.239.128/28;

		userid_domain  .bbbaaa.ua;
		userid_service 1026;
		userid         on;

		ssi on;

		proxy_set_header Host     $host;
		proxy_set_header X-DDoS   $ddos;
		proxy_set_header X-LID    $uid_any;
		proxy_set_header X-Splits banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;

		proxy_set_header X-Forwarded-For      $remote_addr;
		proxy_set_header X-Forwarded-Host     $host;
		proxy_set_header X-Forwarded-Port     $server_port;
		proxy_set_header X-Forwarded-Protocol $detected_protocol;
		proxy_set_header X-Real-IP            $remote_addr;

		proxy_intercept_errors on;

		error_page 401 402 404 /err/404.html;
		error_page 403 /err/403.html;
		error_page 500 /err/500.html;
		error_page 502 /err/502.html;
		error_page 503 /err/503.html;
		error_page 504 /err/504.html;

		if ( $arg_split_bbbaaa5 ) {
			set $split_bbbaaa5 $arg_split_bbbaaa5;
		}
		if ( $arg_split_bbbaaa_banner ) {
			set $split_bbbaaa_banner $arg_split_bbbaaa_banner;
		}
		if ( $arg_split_bbbaaa_mobile ) {
			set $split_bbbaaa_mobile $arg_split_bbbaaa_mobile;
		}
		if ( $arg_split_bbbaaa_perm ) {
			set $split_bbbaaa_perm $arg_split_bbbaaa_perm;
		}
		if ( $arg_split_bbbaaa_ranking ) {
			set $split_bbbaaa_ranking $arg_split_bbbaaa_ranking;
		}

		# mobile site redirect
		add_header Set-Cookie $mobile_cookie_ua;
		if ( $mobile_site = 1 ) {
			return 302 $detected_protocol://m.bbbaaa.ua$request_uri;
		}

		# seo redirect
		if ( $ui2086 ) {
			return 301 $detected_protocol://$host$uri;
		}

		set $easycheckout 1;
		set $fullcheckout 1;

		### bs-locations begin ###
		location /bs-click/ {
			proxy_pass http://bs_head_upstream/click/;
		}
		location /bs-hit/ {
			internal;
			error_page 400 401 403 404 500 502 503 504 = @zero;

			proxy_connect_timeout 100ms;
			proxy_read_timeout    200ms;
			proxy_pass_request_headers off;

			proxy_next_upstream   error
			                      timeout
			;

			proxy_set_header  Host                  bs.local;
			proxy_set_header  X-Real-IP             $remote_addr;
			proxy_set_header  X-Forwarded-For       $remote_addr;
			proxy_set_header  X-Forwarded-Host      $host;
			proxy_set_header  X-Forwarded-Port      $server_port;
			proxy_set_header  X-Forwarded-Protocol  $scheme;
			proxy_set_header  X-LID                 $uid_any;
			proxy_set_header  X-Splits              banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header  Referer               $scheme://$http_host$request_uri;
			proxy_set_header  Rereferer             $http_referer;
			proxy_set_header  X-City-ID             $city_id;
			proxy_set_header  X-Region-ID           $region_id;

			proxy_pass http://bs_head_upstream/hit/;
		}
		location /bs-ssi/ {
			internal;
			alias /data/bs/ssi/;
		}
		### bs-locations end   ###
		### sorting-location begin ###
		location = /sf {
			internal;

			log_subrequest on;
			access_log /var/log/nginx/sort.access_log subtimed;

			proxy_connect_timeout 10ms;
			proxy_read_timeout    50ms;

			proxy_pass_request_headers off;

			proxy_set_header Host         sort.local;
			proxy_set_header X-LID        $uid_val;
			proxy_set_header X-Splits     banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;
			proxy_set_header X-URL        $scheme://$host$request_uri;
			# geo
			proxy_set_header X-Geo        $geo;
			proxy_set_header X-City-ID    $city_id;
			proxy_set_header X-Country-ID $country_id;
			proxy_set_header X-Region-ID  $region_id;

			proxy_pass http://sort_head_upstream/mapping/sorting_factor_simple/;
		}
		### sorting-location end   ###
		### uakari-locations begin ###
		location = /uakari-redis {
			internal;
			redis2_connect_timeout 3s;
			redis2_read_timeout    1s;
			redis2_send_timeout    1s;
			redis2_query get $arg_key;
			redis2_pass uakari_redis_upstream;
		}
		location /s/ {
			location /s/ {
				return 404;
			}
			location ~ ^/s/(?<key>[^/]+)$ {
				content_by_lua '
					local res = ngx.location.capture( "/uakari-redis?key=" .. ngx.var["key"] )
					if res.status ~= 200 then
						ngx.status = 500
						ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
					end
					local uri = string.match( res.body, "\\n([^\\n]+)" )
					if not uri then
						ngx.status = 404
						ngx.exit(ngx.HTTP_NOT_FOUND)
					end
					ngx.redirect( "http://" .. ngx.var.host .. uri, 301 )
				';
			}
		}
		### uakari-locations end   ###
		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###
		### whoami-location begin ###
		location = /whoami {

			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###

			ssi off;

			content_by_lua '
							ngx.header.content_type = "text/html"
							local uid_any = ngx.var.uid_any or "Undefined"
							local split_bbbaaa5 = ngx.var.split_bbbaaa5 or "Undefined"
							local split_bbbaaa_banner = ngx.var.split_bbbaaa_banner or "Undefined"
							local split_bbbaaa_mobile = ngx.var.split_bbbaaa_mobile or "Undefined"
							local split_bbbaaa_ranking = ngx.var.split_bbbaaa_ranking or "Undefined"
							local split_bbbaaa_perm = ngx.var.split_bbbaaa_perm or "Undefined"
							local split_madmin = ngx.var.split_madmin or "Undefined"
							ngx.say( "<h4>Parameters</h4><ul>" )
							ngx.say( "<li> lid" .. string.sub(uid_any,4) )
							ngx.say( "<li> split_bbbaaa5=" .. split_bbbaaa5 )
							ngx.say( "<li> split_bbbaaa_banner=" .. split_bbbaaa_banner )
							ngx.say( "<li> split_bbbaaa_mobile=" .. split_bbbaaa_mobile )
							ngx.say( "<li> split_bbbaaa_ranking=" .. split_bbbaaa_ranking  )
							ngx.say( "<li> split_bbbaaa_perm=" .. split_bbbaaa_perm  )
							ngx.say( "<li> split_madmin=" .. split_madmin  )
							ngx.say( "</ul>" )

							ngx.say( "<h4>Your visible cookies</h4><ul>" )
							for x in string.gmatch(ngx.req.get_headers()["cookie"] or "", "[^;]+") do
							    ngx.say(string.format("<li>%s",x))
							end
							ngx.say( "</ul>" )

							local fldr_name = ngx.var.split_dir

							local ssi_file_path = "/data/split/".. fldr_name .. "/" .. split_bbbaaa5 .. "/" .. split_bbbaaa_ranking .. "/" .. split_bbbaaa_mobile .. ".html"
							ngx.say( "<h4> Filepath: " .. ssi_file_path .. "</h4><ul>" )

							local fh = io.open(ssi_file_path)
							if fh then
							    ngx.say( "<plaintext>" )
							    for line in fh:lines() do
							        ngx.say( line )
							    end
							    fh:close()
							end
			';
		}
		### whoami-location end ###
		### z-pass-locations begin ###
		location /z/pass/ {
			internal;
	### proxy-set-headers begin ###
	proxy_set_header  Host                  $host;
	proxy_set_header  X-Real-IP             $remote_addr;
	proxy_set_header  X-Forwarded-For       $remote_addr;
	proxy_set_header  X-Forwarded-Host      $host;
	proxy_set_header  X-Forwarded-Port      $server_port;
	proxy_set_header  X-Forwarded-Protocol  $scheme;
	### proxy-set-headers end ###
			proxy_set_header Connection '';
			proxy_set_header X-CMR      $cookie_LM_REMAIL;
			proxy_set_header X-UID-Got  $uid_got;
			proxy_set_header X-UID-Set  $uid_set;

			proxy_connect_timeout 100ms;
			proxy_send_timeout    100ms;
			proxy_read_timeout    100ms;

			proxy_http_version 1.1;

			error_page 400 401 403 404 500 502 503 504 = @zero;

			location = /z/pass/analytics {
				proxy_pass http://z_analytics_upstream/z;
			}
			location = /z/pass/prism {
				proxy_pass http://z_prism_upstream/z;
			}
		}
		### z-pass-locations end ###
		### zero-location begin ###
		location @zero {
			return 204;
		}
		### zero-locations end  ###
		location / {
			proxy_pass http://site_ua_beta_upstream;
		}
		location = / {
			proxy_pass http://site_ua_beta_upstream;
		}
		location /action/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			proxy_pass http://site_ua_beta_upstream;
		}
		location = /apple-touch-icon.png {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-72x72.png {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-72x72-precomposed.png {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-76x76.png {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-76x76-precomposed.png {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-114x114.png {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-114x114-precomposed.png {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-120x120.png {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-120x120-precomposed.png {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-144x144.png {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-144x144-precomposed.png {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-152x152-precomposed.png {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timed;
			alias /data/site-ua/misc/apple-touch-icon-precomposed.png;
		}
		location = /apple-touch-icon-precomposed.png {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /b/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			proxy_pass http://site_ua_beta_upstream;
		}
		location /brands/ {
			proxy_pass http://site_ua_beta_upstream;
		}
		location /c/ {
			### sorting-rewrite begin ###
			set $sf '-';
			rewrite_by_lua '
				local hdrs = ngx.req.get_headers()
				if hdrs["X-SortingFactor"] then
					ngx.var["sf"] = hdrs["X-SortingFactor"]
				else
					res = ngx.location.capture("/sf");
					if res.status ~= ngx.HTTP_OK then
						return ngx.log( ngx.ERR, "bad status (" .. res.status .. ")" )
					end
					if res.truncated then
						return ngx.log( ngx.ERR, "body truncated" )
					end
					ngx.var["sf"] = res.body;
					ngx.req.set_header( "X-SortingFactor",res.body )
				end
			';
			### sorting-rewrite end   ###
			proxy_pass http://site_ua_beta_upstream;
		}
		location /cart/ {
			proxy_pass http://site_ua_beta_upstream;
		}
		location /cb/ {
			proxy_pass http://site_ua_beta_upstream;
		}
		location /catalogsearch/suggest/ {
			proxy_pass http://site_ua_beta_upstream;
		}
		location /checkout/ {
			proxy_pass http://site_ua_beta_upstream;
		}
		location /checkout/cart/ {
			proxy_pass http://site_ua_beta_upstream;
		}
		location /e/pup/ {
			alias /data/delivery/dav-ua/pup/;
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timed;
		}
		location /e/refund/ {
			alias /data/bob/dav-ua/refund/;
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timed;
		}
		location /err/ {
			internal;
			alias /data/site-ua/misc/;
		}
		location = /favicon.ico {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timeds;
			root /data/site-ua/misc;
		}
		location /files/ {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /flat/ {
			access_log off;
						### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://site_ua_beta_upstream;
		}
		location = /google1878ddce86933217.html  {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /google41fa04835c19c370.html {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /googledefe250e2141dd06.html {
			access_log /var/log/nginx/bbbaaa.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /landing/ {
			proxy_pass http://site_ua_beta_upstream;
		}
		location = /localstorage.html {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timeds;
			root /data/site-ua/misc;
		}
		location = /nt {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timeds;
			return 204;
		}
		location /p/ {
			proxy_pass http://site_ua_beta_upstream;
		}
		location /p2/ {
			proxy_pass http://site_ua_beta_upstream;
		}
		location /p/quick/ {
			proxy_pass http://site_ua_beta_upstream;
		}
		location = /robots.txt {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timeds;
			root /data/site-ua/misc;
		}
		location /sitemap/ {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timed;
			alias /data/site-ua/map/;
		}
		location = /sitemap.xml {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timed;
			root /data/site-ua/map;
		}
		location = /social-logo.jpg {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /ssi/ {
#			internal;
			log_subrequest on;
			error_page 400 401 403 404 500 502 503 504 = @zero;
			proxy_pass http://site_ua_beta_upstream;
			access_log /var/log/nginx/bbbaaa.ua.beta.ssi.access_log subtimed;

			location /ssi/comments/ {
				proxy_pass http://site_ua_beta_upstream;
			}
			location = /ssi/exp.html {
				alias /data/split/${split_dir}/${split_bbbaaa5}/${split_bbbaaa_ranking}/${split_bbbaaa_mobile}.html;
			}
			location /ssi/recommend/ {
				proxy_pass http://site_ua_beta_upstream;
			}
			location = /ssi/recommend/product-product {
				proxy_pass http://site_ua_beta_upstream;
			}
			location = /ssi/recommend/topsellers {
				proxy_pass http://site_ua_beta_upstream;
			}
			location /ssi/sizes/ {
				proxy_pass http://site_ua_beta_upstream;
			}
			location /ssi/userdata/ {
				proxy_pass http://site_ua_beta_upstream;
			}
		}
		location /static/ {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timed;
			proxy_pass http://site_ua_beta_static_upstream;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
		}
		location @static-proxy {
			proxy_pass http://site_ua_beta_static_upstream;
			access_log /var/log/nginx/bbbaaa.static-proxy.access_log timeds;
		}
		location = /strucre954057c8a49f37ca91147c34f9d819feaf88a64.html {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /wmail_c69660ec87f984c2.html  {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /ymlexport/ {
			alias /data/yml/serve/;
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timedc;
		}
		location = /z {
			access_log /var/log/nginx/bbbaaa.ua.beta.static.access_log timed;
			content_by_lua '
				ngx.location.capture_multi({ {"/z/pass/analytics",{args = ngx.req.get_uri_args()}},{"/z/pass/prism",{args = ngx.req.get_uri_args()}} })
				ngx.status = 204;
			';
		}
	} # ]]]
	server { # tail-m.bbbaaa.ua [[[
		listen 10.233.32.245:80; # carp245
		listen 10.233.32.246:80; # carp246
		listen 10.233.32.245:443 ssl;
		listen 10.233.32.246:443 ssl;
		server_name tail-m.bbbaaa.ua;
		access_log /var/log/nginx/m.tail.ua.access_log timeds;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ua.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ua.key;

		ssi on;

		proxy_set_header Host     $host;
		proxy_set_header X-DDoS   $ddos;
		proxy_set_header X-LID    $uid_any;
		proxy_set_header X-Mobile yes;
		proxy_set_header X-Splits banner=$split_bbbaaa_banner,bbbaaa5=$split_bbbaaa5,mobile=$split_bbbaaa_mobile,perm=$split_bbbaaa_perm,ranking=$split_bbbaaa_ranking;

		proxy_set_header X-Forwarded-For      $remote_addr;
		proxy_set_header X-Forwarded-Host     $host;
		proxy_set_header X-Forwarded-Port     $server_port;
		proxy_set_header X-Forwarded-Protocol $detected_protocol;
		proxy_set_header X-Real-IP            $remote_addr;

		proxy_intercept_errors on;

		error_page 401 402 404 /err/404.html;
		error_page 403 /err/403.html;
		error_page 500 /err/500.html;
		error_page 502 /err/502.html;
		error_page 503 /err/503.html;
		error_page 504 /err/504.html;

		if ( $arg_split_bbbaaa5 ) {
			set $split_bbbaaa5 $arg_split_bbbaaa5;
		}
		if ( $arg_split_bbbaaa_banner ) {
			set $split_bbbaaa_banner $arg_split_bbbaaa_banner;
		}
		if ( $arg_split_bbbaaa_mobile ) {
			set $split_bbbaaa_mobile $arg_split_bbbaaa_mobile;
		}
		if ( $arg_split_bbbaaa_perm ) {
			set $split_bbbaaa_perm $arg_split_bbbaaa_perm;
		}
		if ( $arg_split_bbbaaa_ranking ) {
			set $split_bbbaaa_ranking $arg_split_bbbaaa_ranking;
		}

		# desktop site redirect
		add_header Set-Cookie $mobile_cookie_ua;
		if ( $mobile_site = 2 ) {
			return 302 $detected_protocol://www.bbbaaa.ua$request_uri;
		}

		### uakari-locations begin ###
		location = /uakari-redis {
			internal;
			redis2_connect_timeout 3s;
			redis2_read_timeout    1s;
			redis2_send_timeout    1s;
			redis2_query get $arg_key;
			redis2_pass uakari_redis_upstream;
		}
		location /s/ {
			location /s/ {
				return 404;
			}
			location ~ ^/s/(?<key>[^/]+)$ {
				content_by_lua '
					local res = ngx.location.capture( "/uakari-redis?key=" .. ngx.var["key"] )
					if res.status ~= 200 then
						ngx.status = 500
						ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
					end
					local uri = string.match( res.body, "\\n([^\\n]+)" )
					if not uri then
						ngx.status = 404
						ngx.exit(ngx.HTTP_NOT_FOUND)
					end
					ngx.redirect( "http://" .. ngx.var.host .. uri, 301 )
				';
			}
		}
		### uakari-locations end   ###
		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###
		### whoami-location begin ###
		location = /whoami {

			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###

			ssi off;

			content_by_lua '
							ngx.header.content_type = "text/html"
							local uid_any = ngx.var.uid_any or "Undefined"
							local split_bbbaaa5 = ngx.var.split_bbbaaa5 or "Undefined"
							local split_bbbaaa_banner = ngx.var.split_bbbaaa_banner or "Undefined"
							local split_bbbaaa_mobile = ngx.var.split_bbbaaa_mobile or "Undefined"
							local split_bbbaaa_ranking = ngx.var.split_bbbaaa_ranking or "Undefined"
							local split_bbbaaa_perm = ngx.var.split_bbbaaa_perm or "Undefined"
							local split_madmin = ngx.var.split_madmin or "Undefined"
							ngx.say( "<h4>Parameters</h4><ul>" )
							ngx.say( "<li> lid" .. string.sub(uid_any,4) )
							ngx.say( "<li> split_bbbaaa5=" .. split_bbbaaa5 )
							ngx.say( "<li> split_bbbaaa_banner=" .. split_bbbaaa_banner )
							ngx.say( "<li> split_bbbaaa_mobile=" .. split_bbbaaa_mobile )
							ngx.say( "<li> split_bbbaaa_ranking=" .. split_bbbaaa_ranking  )
							ngx.say( "<li> split_bbbaaa_perm=" .. split_bbbaaa_perm  )
							ngx.say( "<li> split_madmin=" .. split_madmin  )
							ngx.say( "</ul>" )

							ngx.say( "<h4>Your visible cookies</h4><ul>" )
							for x in string.gmatch(ngx.req.get_headers()["cookie"] or "", "[^;]+") do
							    ngx.say(string.format("<li>%s",x))
							end
							ngx.say( "</ul>" )

							local fldr_name = ngx.var.split_dir

							local ssi_file_path = "/data/split/".. fldr_name .. "/" .. split_bbbaaa5 .. "/" .. split_bbbaaa_ranking .. "/" .. split_bbbaaa_mobile .. ".html"
							ngx.say( "<h4> Filepath: " .. ssi_file_path .. "</h4><ul>" )

							local fh = io.open(ssi_file_path)
							if fh then
							    ngx.say( "<plaintext>" )
							    for line in fh:lines() do
							        ngx.say( line )
							    end
							    fh:close()
							end
			';
		}
		### whoami-location end ###
		### z-pass-locations begin ###
		location /z/pass/ {
			internal;
	### proxy-set-headers begin ###
	proxy_set_header  Host                  $host;
	proxy_set_header  X-Real-IP             $remote_addr;
	proxy_set_header  X-Forwarded-For       $remote_addr;
	proxy_set_header  X-Forwarded-Host      $host;
	proxy_set_header  X-Forwarded-Port      $server_port;
	proxy_set_header  X-Forwarded-Protocol  $scheme;
	### proxy-set-headers end ###
			proxy_set_header Connection '';
			proxy_set_header X-CMR      $cookie_LM_REMAIL;
			proxy_set_header X-UID-Got  $uid_got;
			proxy_set_header X-UID-Set  $uid_set;

			proxy_connect_timeout 100ms;
			proxy_send_timeout    100ms;
			proxy_read_timeout    100ms;

			proxy_http_version 1.1;

			error_page 400 401 403 404 500 502 503 504 = @zero;

			location = /z/pass/analytics {
				proxy_pass http://z_analytics_upstream/z;
			}
			location = /z/pass/prism {
				proxy_pass http://z_prism_upstream/z;
			}
		}
		### z-pass-locations end ###
		### zero-location begin ###
		location @zero {
			return 204;
		}
		### zero-locations end  ###
		location / {
			proxy_pass http://site_ua_tail_upstream;
		}
		location = / {
			proxy_pass http://site_ua_tail_upstream;
		}
		location /action/ {
			proxy_pass http://site_ua_tail_upstream;
		}
		location = /apple-touch-icon.png {
			access_log /var/log/nginx/m.tail.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-72x72.png {
			access_log /var/log/nginx/m.tail.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-72x72-precomposed.png {
			access_log /var/log/nginx/m.tail.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-76x76.png {
			access_log /var/log/nginx/m.tail.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-76x76-precomposed.png {
			access_log /var/log/nginx/m.tail.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-114x114.png {
			access_log /var/log/nginx/m.tail.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-114x114-precomposed.png {
			access_log /var/log/nginx/m.tail.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-120x120.png {
			access_log /var/log/nginx/m.tail.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-120x120-precomposed.png {
			access_log /var/log/nginx/m.tail.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-144x144.png {
			access_log /var/log/nginx/m.tail.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-144x144-precomposed.png {
			access_log /var/log/nginx/m.tail.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /apple-touch-icon-152x152-precomposed.png {
			access_log /var/log/nginx/m.tail.ua.static.access_log timed;
			alias /data/site-ua/misc/apple-touch-icon-precomposed.png;
		}
		location = /apple-touch-icon-precomposed.png {
			access_log /var/log/nginx/m.tail.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /b/ {
			proxy_pass http://site_ua_tail_upstream;
		}
		location /brands/ {
			proxy_pass http://site_ua_tail_upstream;
		}
		location /c/ {
			proxy_pass http://site_ua_tail_upstream;
		}
		location /cb/ {
			proxy_pass http://site_ua_tail_upstream;
		}
		location /catalogsearch/suggest/ {
			proxy_pass http://site_ua_tail_upstream;
		}
		location /checkout/ {
			proxy_pass http://site_ua_tail_upstream;
		}
		location /checkout/cart/ {
			proxy_pass http://site_ua_tail_upstream;
		}
		location /err/ {
			internal;
			alias /data/site-ua/misc/;
		}
		location = /favicon.ico {
			access_log /var/log/nginx/m.tail.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /files/ {
			access_log /var/log/nginx/m.tail.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /flat/ {
			access_log off;
						### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###
			proxy_pass http://site_ua_tail_upstream;
		}
		location /landing/ {
			proxy_pass http://site_ua_tail_upstream;
		}
		location = /localstorage.html {
			access_log /var/log/nginx/m.tail.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location = /nt {
			access_log /var/log/nginx/m.tail.ua.static.access_log timed;
			return 204;
		}
		location /p/ {
			proxy_pass http://site_ua_tail_upstream;
		}
		location /p2/ {
			proxy_pass http://site_ua_tail_upstream;
		}
		location = /robots.txt {
			access_log /var/log/nginx/m.tail.ua.static.access_log timed;
			root /data/site-ua/misc;
		}
		location /ssi/ {
#			internal;
			log_subrequest on;
			error_page 400 401 403 404 500 502 503 504 = @zero;
			proxy_pass http://site_ua_tail_upstream;
			access_log /var/log/nginx/m.tail.ua.ssi.access_log subtimed;

			location /ssi/comments/ {
				proxy_pass http://site_ua_tail_upstream;
			}
			location = /ssi/exp.html {
				alias /data/split/${split_dir}/${split_bbbaaa5}/${split_bbbaaa_ranking}/${split_bbbaaa_mobile}.html;
			}
			location /ssi/recommend/ {
				proxy_pass http://site_ua_tail_upstream;
			}
			location = /ssi/recommend/product-product {
				proxy_pass http://site_ua_tail_upstream;
			}
			location = /ssi/recommend/topsellers {
				proxy_pass http://site_ua_tail_upstream;
			}
			location /ssi/sizes/ {
				proxy_pass http://site_ua_tail_upstream;
			}
			location /ssi/userdata_full/ {
				proxy_pass http://site_ua_tail_upstream;
			}
		}
		location /static/ {
			access_log /var/log/nginx/m.tail.ua.static.access_log timed;
			alias /data/m-ua/static/;
			add_header  Cache-Control  public;
			add_header  Vary  Accept-Encoding;
			expires     1y;
			error_page  404 = @static-proxy;
		}
		location @static-proxy {
			proxy_pass http://site_ua_tail_static_upstream;
			access_log /var/log/nginx/bbbaaa.static-proxy.access_log timeds;
		}
		location = /z {
			access_log /var/log/nginx/m.tail.ua.static.access_log timed;
			content_by_lua '
				ngx.location.capture_multi({ {"/z/pass/analytics",{args = ngx.req.get_uri_args()}},{"/z/pass/prism",{args = ngx.req.get_uri_args()}} })
				ngx.status = 204;
			';
		}
	} # ]]]
	# end site ua ]]]
	# lstat [[[
	server { # lstat.bbbaaa.ru [[[
		listen 31.13.33.70:80; # carp70
		listen 31.13.33.71:80; # carp71
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		listen 31.13.33.70:443 ssl;
		listen 31.13.33.71:443 ssl;
		listen 10.233.32.219:443 ssl;
		listen 10.233.32.220:443 ssl;
		server_name lstat.bbbaaa.ru;
		access_log /var/log/nginx/analytics.access_log timed;

			### restricts begin ###
			allow 127.0.0.1;
			allow 87.245.139.0/29;
			allow 87.245.139.80/28;
			allow 10.233.32.0/24;
			allow 10.233.0.0/20;
			allow 10.25.24.0/22;
			allow 10.10.36.0/24;
			allow 10.10.44.0/24;
			allow 10.21.21.0/24;
			allow 10.210.0.0/24;
			allow 10.23.20.0/22;
			allow 10.9.0.0/17;
			allow 10.20.20.0/22;
			allow 195.208.49.64/28;
			allow 10.233.34.0/24;
			allow 10.233.64.0/22;
			allow 10.233.75.0/24;
			allow 10.15.0.0/16;
			allow 5.20.223.100/32;
			allow 10.10.115.0/24;
			allow 10.10.119.0/24;
			allow 10.12.0.0/17;
			allow 62.117.123.48/29;
			allow 126.190.106.0/29;
			allow 185.9.230.96/27;
			allow 10.33.33.0/24;
			allow 10.10.122.0/24;
			allow 10.22.22.0/23;
			allow 10.5.124.0/23;
			allow 10.5.72.0/23;
			allow 185.3.140.58/32;
			deny all;
			### resctricts end  ###

		if ( $https = '' ) {
			return 301 https://$host$request_uri;
		}

		proxy_read_timeout  30s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://analytics_head_upstream;
		}
		location /static/ {
			proxy_pass http://analytics_media_head_upstream;
		}
	} # ]]]
	server { # tail.lstat.bbbaaa.ru [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		listen 10.233.32.219:443 ssl;
		listen 10.233.32.220:443 ssl;
		server_name tail.lstat.bbbaaa.ru;
		access_log /var/log/nginx/analytics.tail.access_log timed;

		if ( $https = '' ) {
			return 301 https://$host$request_uri;
		}

		proxy_read_timeout  10s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: web01.analytics.local
        - host: web09.analytics.local
    lolek:
        - host: web101.analytics.local
        - host: web109.analytics.local
head: bolek
super: super.web.analytics.local
tail: lolek
';}

		location / {
			proxy_pass http://analytics_tail_upstream;
		}
		location /static/ {
			proxy_pass http://analytics_media_tail_upstream;
		}
	} # ]]]
	# end lstat ]]]
	# madmin [[[
	server { # madmin.beta.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name madmin.beta.local;

		access_log /var/log/nginx/madmin.beta.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://madmin_beta_upstream;
		}
		location /report/ {
			internal;
			root /data/madmin.beta;
		}
		location /static/ {
			proxy_pass http://madmin_beta_static_upstream;
		}
	} # ]]]
	server { # madmin.bbbaaa.ru [[[
		listen 31.13.33.70:80; # carp70
		listen 31.13.33.71:80; # carp71
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		listen 31.13.33.70:443 ssl;
		listen 31.13.33.71:443 ssl;
		listen 10.233.32.219:443 ssl;
		listen 10.233.32.220:443 ssl;
		server_name madmin.bbbaaa.ru;
		access_log /var/log/nginx/madmin.access_log timed;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ru.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ru.key;

		if ( $external_trusted != 1 ) {
			return 302 http://madmin.local$request_uri;
		}
		if ( $https = '' ) {
			return 301 https://$host$request_uri;
		}

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://madmin_head_upstream;
		}
		location /api/ {
			return 403;
		}
		location /report/ {
			internal;
			root /data/madmin;
		}
		location /static/ {
			proxy_pass http://madmin_media_head_upstream;
		}
	} # ]]]
	server { # madmin.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name madmin.local head.madmin.local;
		access_log /var/log/nginx/madmin.local.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://madmin_head_upstream;
		}
		location /api/ {
			allow 10.10.37.120;  # callcenter: Ticket#2014082210000748
			allow 10.233.0.0/20;
			allow 10.233.32.0/24;
			allow 10.10.36.0/24;
			allow 10.233.31.0/24;
			deny all;
			proxy_pass http://madmin_head_upstream;
		}
		location /report/ {
			internal;
			root /data/madmin;
		}
		location /static/ {
			proxy_pass http://madmin_media_head_upstream;
		}
	} # ]]]
	server { # tail.madmin.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name tail.madmin.local;
		access_log /var/log/nginx/madmin.tail.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.madmin.local
        - host: back02.madmin.local
        - host: back03.madmin.local
        - host: back04.madmin.local
        - host: back05.madmin.local
        - host: back06.madmin.local
        - host: back07.madmin.local
        - host: back08.madmin.local
        - host: back09.madmin.local
        - host: back10.madmin.local
    lolek:
        - host: back101.madmin.local
        - host: back102.madmin.local
        - host: back103.madmin.local
        - host: back104.madmin.local
        - host: back105.madmin.local
        - host: back106.madmin.local
        - host: back107.madmin.local
        - host: back108.madmin.local
        - host: back109.madmin.local
        - host: back110.madmin.local
head: bolek
super: super.back.madmin.local
tail: lolek
';}

		location / {
			proxy_pass http://madmin_tail_upstream;
		}
		location /api/ {
			allow 10.10.37.120;  # callcenter: Ticket#2014082210000748
			allow 10.233.0.0/20;
			allow 10.233.32.0/24;
			allow 10.10.36.0/24;
			allow 10.233.31.0/24;
			deny all;
			proxy_pass http://madmin_tail_upstream;
		}
		location /report/ {
			internal;
			root /data/madmin;
		}
		location /static/ {
			proxy_pass http://madmin_media_tail_upstream;
		}
	} # ]]]
	server { # madmin.by.local [[[
		listen 10.233.32.251:80; # carp251
		listen 10.233.32.252:80; # carp252
		server_name madmin.by.local;
		access_log /var/log/nginx/madmin.by.local.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://madmin_by_head_upstream;
		}
		location /api/ {
			allow 10.10.37.120;  # callcenter: Ticket#2014082210000748
			allow 10.233.0.0/20;
			allow 10.233.32.0/24;
			allow 10.10.36.0/24;
			allow 10.233.31.0/24;
			deny all;
			proxy_pass http://madmin_by_head_upstream;
		}
		location /report/ {
			internal;
			root /data/madmin.by;
		}
		location /static/ {
			proxy_pass http://madmin_by_media_head_upstream;
		}
	} # ]]]
	server { # tail.madmin.by.local [[[
		listen 10.233.32.251:80; # carp251
		listen 10.233.32.252:80; # carp252
		server_name tail.madmin.by.local;
		access_log /var/log/nginx/madmin.by.tail.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back07.madmin.by.local
        - host: back08.madmin.by.local
    lolek:
        - host: back107.madmin.by.local
        - host: back108.madmin.by.local
head: bolek
super: super.back.madmin.by.local
tail: lolek
';}

		location / {
			proxy_pass http://madmin_by_tail_upstream;
		}
		location /api/ {
			allow 10.10.37.120;  # callcenter: Ticket#2014082210000748
			allow 10.233.0.0/20;
			allow 10.233.32.0/24;
			allow 10.10.36.0/24;
			allow 10.233.31.0/24;
			deny all;
			proxy_pass http://madmin_by_tail_upstream;
		}
		location /report/ {
			internal;
			root /data/madmin.by;
		}
		location /static/ {
			proxy_pass http://madmin_by_media_tail_upstream;
		}
	} # ]]]
	server { # madmin.bbbaaa.kz [[[
		listen 31.13.33.72:80; # carp72
		listen 31.13.33.73:80; # carp73
		listen 10.233.32.243:80; # carp243
		listen 10.233.32.244:80; # carp244
		listen 31.13.33.72:443 ssl;
		listen 31.13.33.73:443 ssl;
		listen 10.233.32.243:443 ssl;
		listen 10.233.32.244:443 ssl;
		server_name madmin.bbbaaa.kz;
		access_log /var/log/nginx/madmin.kz.access_log timed;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.kz.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.kz.key;

		if ( $external_trusted != 1 ) {
			return 302 http://madmin.kz.local$request_uri;
		}
		if ( $https = '' ) {
			return 301 https://$host$request_uri;
		}

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://madmin_kz_head_upstream;
		}
		location /api/ {
			return 403;
		}
		location /report/ {
			internal;
			root /data/madmin.kz;
		}
		location /static/ {
			proxy_pass http://madmin_kz_media_head_upstream;
		}
	} # ]]]
	server { # madmin.kz.local [[[
		listen 10.233.32.243:80; # carp243
		listen 10.233.32.244:80; # carp244
		server_name madmin.kz.local;
		access_log /var/log/nginx/madmin.kz.local.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://madmin_kz_head_upstream;
		}
		location /api/ {
			allow 10.10.37.120;  # callcenter: Ticket#2014082210000748
			allow 10.233.0.0/20;
			allow 10.233.32.0/24;
			allow 10.10.36.0/24;
			allow 10.233.31.0/24;
			deny all;
			proxy_pass http://madmin_kz_head_upstream;
		}
		location /report/ {
			internal;
			root /data/madmin.kz;
		}
		location /static/ {
			proxy_pass http://madmin_kz_media_head_upstream;
		}
	} # ]]]
	server { # tail.madmin.kz.local [[[
		listen 10.233.32.243:80; # carp243
		listen 10.233.32.244:80; # carp244
		server_name tail.madmin.kz.local;
		access_log /var/log/nginx/madmin.kz.tail.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.madmin.kz.local
          halt: true
        - host: back02.madmin.kz.local
          halt: true
        - host: back03.madmin.kz.local
          halt: true
        - host: back04.madmin.kz.local
          halt: true
        - host: back05.madmin.kz.local
        - host: back06.madmin.kz.local
        - host: back07.madmin.kz.local
        - host: back08.madmin.kz.local
        - host: back09.madmin.kz.local
          halt: true
        - host: back10.madmin.kz.local
          halt: true
    lolek:
        - host: back101.madmin.kz.local
          halt: true
        - host: back102.madmin.kz.local
          halt: true
        - host: back103.madmin.kz.local
          halt: true
        - host: back104.madmin.kz.local
          halt: true
        - host: back105.madmin.kz.local
        - host: back106.madmin.kz.local
        - host: back107.madmin.kz.local
        - host: back108.madmin.kz.local
        - host: back109.madmin.kz.local
          halt: true
        - host: back110.madmin.kz.local
          halt: true
head: bolek
super: super.back.madmin.kz.local
tail: lolek
';}

		location / {
			proxy_pass http://madmin_kz_tail_upstream;
		}
		location /api/ {
			allow 10.10.37.120;  # callcenter: Ticket#2014082210000748
			allow 10.233.0.0/20;
			allow 10.233.32.0/24;
			allow 10.10.36.0/24;
			allow 10.233.31.0/24;
			deny all;
			proxy_pass http://madmin_kz_tail_upstream;
		}
		location /report/ {
			internal;
			root /data/madmin.kz;
		}
		location /static/ {
			proxy_pass http://madmin_kz_media_tail_upstream;
		}
	} # ]]]
	server { # madmin.bbbaaa.ua [[[
		listen 31.13.33.74:80; # carp74
		listen 31.13.33.75:80; # carp75
		listen 10.233.32.245:80; # carp245
		listen 10.233.32.246:80; # carp246
		listen 31.13.33.74:443 ssl;
		listen 31.13.33.75:443 ssl;
		listen 10.233.32.245:443 ssl;
		listen 10.233.32.246:443 ssl;
		server_name madmin.bbbaaa.ua;
		access_log /var/log/nginx/madmin.ua.access_log timed;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ua.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ua.key;

		if ( $external_trusted != 1 ) {
			return 302 http://madmin.ua.local$request_uri;
		}
		if ( $https = '' ) {
			return 301 https://$host$request_uri;
		}

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://madmin_ua_head_upstream;
		}
		location /api/ {
			return 403;
		}
		location /report/ {
			internal;
			root /data/madmin.ua;
		}
		location /static/ {
			proxy_pass http://madmin_ua_media_head_upstream;
		}
	} # ]]]
	server { # madmin.ua.local [[[
		listen 10.233.32.245:80; # carp245
		listen 10.233.32.246:80; # carp246
		server_name madmin.ua.local;
		access_log /var/log/nginx/madmin.ua.local.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://madmin_ua_head_upstream;
		}
		location /api/ {
			allow 10.10.37.120;  # callcenter: Ticket#2014082210000748
			allow 10.233.0.0/20;
			allow 10.233.32.0/24;
			allow 10.10.36.0/24;
			allow 10.233.31.0/24;
			deny all;
			proxy_pass http://madmin_ua_head_upstream;
		}
		location /report/ {
			internal;
			root /data/madmin.ua;
		}
		location /static/ {
			proxy_pass http://madmin_ua_media_head_upstream;
		}
	} # ]]]
	server { # tail.madmin.ua.local [[[
		listen 10.233.32.245:80; # carp245
		listen 10.233.32.246:80; # carp246
		server_name tail.madmin.ua.local;
		access_log /var/log/nginx/madmin.ua.tail.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: back01.madmin.ua.local
        - host: back02.madmin.ua.local
        - host: back03.madmin.ua.local
        - host: back04.madmin.ua.local
        - host: back05.madmin.ua.local
          halt: true
        - host: back06.madmin.ua.local
          halt: true
        - host: back07.madmin.ua.local
          halt: true
        - host: back08.madmin.ua.local
          halt: true
        - host: back09.madmin.ua.local
          halt: true
        - host: back10.madmin.ua.local
          halt: true
    lolek:
        - host: back101.madmin.ua.local
        - host: back102.madmin.ua.local
        - host: back103.madmin.ua.local
        - host: back104.madmin.ua.local
        - host: back105.madmin.ua.local
          halt: true
        - host: back106.madmin.ua.local
          halt: true
        - host: back107.madmin.ua.local
          halt: true
        - host: back108.madmin.ua.local
          halt: true
        - host: back109.madmin.ua.local
          halt: true
        - host: back110.madmin.ua.local
          halt: true
head: bolek
super: super.back.madmin.ua.local
tail: lolek
';}

		location / {
			proxy_pass http://madmin_ua_tail_upstream;
		}
		location /api/ {
			allow 10.10.37.120;  # callcenter: Ticket#2014082210000748
			allow 10.233.0.0/20;
			allow 10.233.32.0/24;
			allow 10.10.36.0/24;
			allow 10.233.31.0/24;
			deny all;
			proxy_pass http://madmin_ua_tail_upstream;
		}
		location /report/ {
			internal;
			root /data/madmin.ua;
		}
		location /static/ {
			proxy_pass http://madmin_ua_media_tail_upstream;
		}
	} # ]]]
	server { # mapi.bbbaaa.ru [[[
		listen 31.13.33.70:80; # carp70
		listen 31.13.33.71:80; # carp71
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		listen 31.13.33.70:443 ssl;
		listen 31.13.33.71:443 ssl;
		listen 10.233.32.219:443 ssl;
		listen 10.233.32.220:443 ssl;
		server_name mapi.bbbaaa.ru;
		access_log /var/log/nginx/mapi.access_log timed;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ru.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ru.key;

		set_real_ip_from 10.233.32.0/24;
		# QRator pool
		set_real_ip_from 64.48.224.8;
		set_real_ip_from 64.48.224.9;
		set_real_ip_from 64.48.224.10;
		set_real_ip_from 64.48.224.11;
		set_real_ip_from 66.110.32.128;
		set_real_ip_from 66.110.32.129;
		set_real_ip_from 66.110.32.130;
		set_real_ip_from 66.110.32.131;
		set_real_ip_from 87.245.197.192;
		set_real_ip_from 87.245.197.193;
		set_real_ip_from 87.245.197.194;
		set_real_ip_from 87.245.197.195;
		set_real_ip_from 87.245.197.196;
		set_real_ip_from 134.90.144.224;
		set_real_ip_from 134.90.144.225;
		set_real_ip_from 134.90.144.226;
		set_real_ip_from 134.90.144.227;
		set_real_ip_from 83.234.15.112;
		set_real_ip_from 83.234.15.113;
		set_real_ip_from 83.234.15.114;
		set_real_ip_from 83.234.15.115;
		set_real_ip_from 83.234.15.116;
		set_real_ip_from 128.177.119.64;
		set_real_ip_from 128.177.119.65;
		set_real_ip_from 128.177.119.66;
		set_real_ip_from 128.177.119.67;
		set_real_ip_from 178.248.232.128/28;
		set_real_ip_from 178.248.233.128/28;
		set_real_ip_from 178.248.234.128/28;
		set_real_ip_from 178.248.235.128/28;
		set_real_ip_from 178.248.236.128/28;
		set_real_ip_from 178.248.237.128/28;
		set_real_ip_from 178.248.239.128/28;

		location / {
			return 403;
		}
		location /partnersubscriptions/0.1/ {
			proxy_pass http://madmin_head_upstream/api$request_uri;
		}
	} # end mapi.bbbaaa.ru ]]]
	# end madmin ]]]
	# prism [[[
	server { # prism.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name prism.local;
		access_log /var/log/nginx/prism.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://prism_head_upstream;
		}
	} # ]]]
	server { # tail.prism.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name tail.prism.local;
		access_log /var/log/nginx/prism.tail.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: web01.prism.local
        - host: web09.prism.local
    lolek:
        - host: web101.prism.local
        - host: web109.prism.local
head: lolek
super: super.web.prism.local
tail: bolek
';}

		location / {
			proxy_pass http://prism_tail_upstream;
		}
	} # ]]]
	# end prism ]]]
	# rec [[[
	server { # web.rec.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name web.rec.local;
		access_log /var/log/nginx/rec.access_log timed;

		proxy_read_timeout  10s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://rec_head_upstream;
		}
	} # ]]]
	server { # tail.web.rec.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name tail.web.rec.local;
		access_log /var/log/nginx/rec.tail.access_log timed;

		proxy_read_timeout  10s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: web01.rec.local
        - host: web09.rec.local
    lolek:
        - host: web101.rec.local
        - host: web109.rec.local
head: lolek
super: super.web.rec.local
tail: bolek
';}

		location / {
			proxy_pass http://rec_tail_upstream;
		}
	} # ]]]
	server { # rec.by.local [[[
		listen 10.233.32.251:80; # carp251
		listen 10.233.32.252:80; # carp252
		server_name rec.by.local;
		access_log /var/log/nginx/rec.by.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://rec_by_head_upstream;
		}
	} # ]]]
	server { # tail.rec.by.local [[[
		listen 10.233.32.251:80; # carp251
		listen 10.233.32.252:80; # carp252
		server_name tail.rec.by.local;
		access_log /var/log/nginx/rec.by.tail.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: web01.rec.by.local
        - host: web09.rec.by.local
    lolek:
        - host: web101.rec.by.local
        - host: web109.rec.by.local
head: bolek
super: super.web.rec.by.local
tail: lolek
';}

		location / {
			proxy_pass http://rec_by_tail_upstream;
		}
	} # ]]]
	server { # web.kz.rec.local [[[
		listen 10.233.32.243:80; # carp243
		listen 10.233.32.244:80; # carp244
		server_name web.kz.rec.local;
		access_log /var/log/nginx/rec.kz.access_log timed;

		proxy_read_timeout  10s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://rec_kz_head_upstream;
		}
	} # ]]]
	server { # tail.web.kz.rec.local [[[
		listen 10.233.32.243:80; # carp243
		listen 10.233.32.244:80; # carp244
		server_name tail.web.kz.rec.local;
		access_log /var/log/nginx/rec.kz.tail.access_log timed;

		proxy_read_timeout  10s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: web01.rec.kz.local
        - host: web09.rec.kz.local
    lolek:
        - host: web101.rec.kz.local
        - host: web109.rec.kz.local
head: lolek
super: super.web.rec.kz.local
tail: bolek
';}

		location / {
			proxy_pass http://rec_kz_tail_upstream;
		}
	} # ]]]
	server { # rec.ua.local [[[
		listen 10.233.32.245:80; # carp245
		listen 10.233.32.246:80; # carp246
		server_name rec.ua.local;
		access_log /var/log/nginx/rec.ua.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://rec_ua_head_upstream;
		}
	} # ]]]
	server { # tail.rec.ua.local [[[
		listen 10.233.32.245:80; # carp245
		listen 10.233.32.246:80; # carp246
		server_name tail.rec.ua.local;
		access_log /var/log/nginx/rec.ua.tail.access_log timed;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: web01.rec.ua.local
        - host: web09.rec.ua.local
    lolek:
        - host: web101.rec.ua.local
        - host: web109.rec.ua.local
head: bolek
super: super.web.rec.ua.local
tail: lolek
';}

		location / {
			proxy_pass http://rec_ua_tail_upstream;
		}
	} # ]]]
	# end rec ]]]
	# sort [[[
	server { # sort.local [[[
		listen 127.0.0.1:80; # localhost
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name sort.local;
		access_log /var/log/nginx/sort.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://sort_head_upstream;
		}
	} # ]]]
	server { # tail.sort.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name tail.sort.local;
		access_log /var/log/nginx/sort.tail.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location = /jset {
			default_type text/yaml;
			return 200 '---
groups:
    bolek:
        - host: web01.sort.local
        - host: web09.sort.local
    lolek:
        - host: web101.sort.local
        - host: web109.sort.local
head: lolek
super: super.web.sort.local
tail: bolek
';}

		location / {
			proxy_pass http://sort_tail_upstream;
		}


	} # ]]]
	server { # sort.beta.local [[[
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		server_name sort.beta.local;
		access_log /var/log/nginx/sort.beta.access_log timed;

		proxy_read_timeout 60s;

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://sort_beta_upstream;
		}
	} # ]]]
	# end sort ]]]
	# uakari [[[
	server { # uakari.bbbaaa.ru [[[
		listen 31.13.33.70:80; # carp70
		listen 31.13.33.71:80; # carp71
		listen 10.233.32.219:80; # carp219
		listen 10.233.32.220:80; # carp220
		listen 31.13.33.70:443 ssl;
		listen 31.13.33.71:443 ssl;
		listen 10.233.32.219:443 ssl;
		listen 10.233.32.220:443 ssl;
		server_name uakari.bbbaaa.ru;
		access_log /var/log/nginx/uakari.access_log timed;

		ssl_certificate     /usr/local/etc/nginx/ssl/bbbaaa.ru.crt;
		ssl_certificate_key /usr/local/etc/nginx/ssl/bbbaaa.ru.key;

		if ( $https = '' ) {
			return 301 https://$host$request_uri;
		}

		### deny-common-locations begin ###
		location /server-status {
		    return 404;
		}
		location ~ /\.(?:git|hg|svn)/ {
		    return 404;
		}
		### deny-common-locations end ###

		location / {
			proxy_pass http://uakari.mdev.local:8080;
		}
	} # ]]]
	# end uakari ]]]
	# ]]]
}
# ]]]

# vim:fdm=marker:fmr=[[[,]]]
